# ドリフト対応手順書

## 概要
EasyDKIM無効化によるCloudFormationドリフト問題への対応手順

## 問題の詳細

### ドリフトが発生する理由
1. **CloudFormationテンプレート**: DKIM設定なし（`DkimSigningAttributes`削除済み）
2. **実際のAWSリソース**: EasyDKIM無効化済み（手動で`SigningEnabled: false`）
3. **最終目標**: Phase 4以降でBYODKIM設定（カスタムセレクター）
4. **結果**: CloudFormationが「設定の不一致」を検出

### 発生するシナリオ
```bash
# Phase 3スタック更新時にドリフト検出
uv run sceptre update prod/phase-3-ses-byodkim.yaml --yes
# → CloudFormationが「DKIM設定を有効化しようとする」
# → 実際のリソースは「DKIM無効化済み」
# → ドリフト警告またはエラー
```

## 前提条件

### 必要な環境・ツール
- AWS CLI設定済み（適切な権限を持つ）
- CloudFormationスタックが存在
- EasyDKIM無効化が完了済み

### 確認方法
```bash
# 現在のドリフト状況確認
aws cloudformation detect-stack-drift --stack-name aws-byodmim-prod-prod-phase-3-ses-byodkim --region ap-northeast-1

# ドリフト詳細確認
aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id <DRIFT_DETECTION_ID> --region ap-northeast-1
```

## 対応手順

### 方法1: 現在の設定を受け入れる（推奨）

#### 1. ドリフト検出と現在の設定受け入れ
```bash
# ドリフト検出
aws cloudformation detect-stack-drift --stack-name aws-byodmim-prod-prod-phase-3-ses-byodkim --region ap-northeast-1

# 現在の設定を受け入れてスタック更新
aws cloudformation update-stack \
    --stack-name aws-byodmim-prod-prod-phase-3-ses-byodkim \
    --template-body file://sceptre/templates/ses-configuration.yaml \
    --parameters ParameterKey=ProjectName,ParameterValue=aws-byodmim \
                ParameterKey=Environment,ParameterValue=prod \
                ParameterKey=DomainName,ParameterValue=goo.ne.jp \
                ParameterKey=DKIMManagerFunctionArn,ParameterValue=<FUNCTION_ARN> \
                ParameterKey=DKIMSeparator,ParameterValue=gooid-21-pro \
    --region ap-northeast-1 \
    --accept-current-state
```

#### 2. Sceptreでの対応
```bash
# Sceptreで現在の設定を受け入れる
uv run sceptre update prod/phase-3-ses-byodkim.yaml --yes --accept-current-state
```

#### 3. 手動設定の維持
```bash
# EasyDKIM無効化を維持
./scripts/disable-easydkim.sh goo.ne.jp ap-northeast-1
```

### 方法2: テンプレートにドリフト対応を追加（未実装）

#### 1. テンプレートにコメント追加（提案）
```yaml
# SES Email Identity for the domain (DKIM configuration disabled - will be configured in Phase 4-7)
# Note: EasyDKIM is manually disabled after stack creation to avoid drift issues
EmailIdentity:
  Type: AWS::SES::EmailIdentity
  Properties:
    EmailIdentity: !Ref DomainName
    # DkimSigningAttributes completely removed - DKIM will be configured in Phase 4-7
    # Manual disable required: aws sesv2 put-email-identity-dkim-attributes --no-signing-enabled
```

**注意**: この方法は現在実装されていません。実装する場合は手動でテンプレートを修正する必要があります。

#### 2. ドリフト対応スクリプト
```bash
#!/bin/bash
# ドリフト対応スクリプト

STACK_NAME="aws-byodmim-prod-prod-phase-3-ses-byodkim"
REGION="ap-northeast-1"
EMAIL_IDENTITY="goo.ne.jp"

echo "=== ドリフト対応スクリプト ==="

# 1. ドリフト検出
echo "1. ドリフト検出..."
DRIFT_ID=$(aws cloudformation detect-stack-drift --stack-name $STACK_NAME --region $REGION --query "StackDriftDetectionId" --output text)
echo "ドリフト検出ID: $DRIFT_ID"

# 2. ドリフト状況確認
echo "2. ドリフト状況確認..."
sleep 10
DRIFT_STATUS=$(aws cloudformation describe-stack-drift-detection-status --stack-drift-detection-id $DRIFT_ID --region $REGION --query "StackDriftStatus" --output text)
echo "ドリフト状況: $DRIFT_STATUS"

if [ "$DRIFT_STATUS" = "IN_SYNC" ]; then
    echo "ドリフトは検出されませんでした。"
    exit 0
fi

# 3. EasyDKIM無効化の確認・実行
echo "3. EasyDKIM無効化の確認・実行..."
CURRENT_STATUS=$(aws sesv2 get-email-identity --email-identity $EMAIL_IDENTITY --region $REGION --query "DkimAttributes.SigningEnabled" --output text)

if [ "$CURRENT_STATUS" = "true" ]; then
    echo "EasyDKIMを無効化します..."
    aws sesv2 put-email-identity-dkim-attributes --email-identity $EMAIL_IDENTITY --no-signing-enabled --region $REGION
    echo "EasyDKIM無効化完了"
else
    echo "EasyDKIMは既に無効化されています。"
fi

echo "=== ドリフト対応完了 ==="
```

### 方法3: スタック再作成（最終手段）

#### 1. スタック削除
```bash
# 注意: 依存関係の問題で削除できない可能性がある
uv run sceptre delete prod/phase-3-ses-byodkim.yaml --yes
```

#### 2. スタック再作成
```bash
# スタック再作成
uv run sceptre create prod/phase-3-ses-byodkim.yaml --yes

# EasyDKIM無効化
./scripts/disable-easydkim.sh goo.ne.jp ap-northeast-1
```

## 推奨対応

### **方法1（現在の設定受け入れ）を推奨**

**理由:**
- CloudFormationが現在の設定を認識
- ドリフト問題が根本的に解決
- 今後のスタック更新で問題なし

**運用方針:**
- `--accept-current-state`オプションを使用
- EasyDKIM無効化状態をCloudFormationに認識させる
- Phase 4以降でBYODKIM設定（カスタムセレクター）
- **最終状態**: DKIM有効（BYODKIM）

## 注意事項
- **ドリフト検出**: CloudFormationが設定の不一致を検出
- **手動設定の維持**: EasyDKIM無効化を手動で維持
- **Phase 4以降**: BYODKIM設定で最終的な状態に

## トラブルシューティング
- **ドリフトエラー**: 手動設定を再実行
- **スタック更新失敗**: ドリフト対応スクリプトを実行
- **依存関係問題**: 方法3（スタック再作成）を検討
