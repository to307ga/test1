# AWS SES マイグレーション システム設計書

## 1. ドキュメント概要

### 1.1 文書の目的
本文書は、オンプレミスのPostfix + Cuenoteメール送信システムから AWS SES（Simple Email Service）への移行プロジェクトにおけるシステム設計の詳細を記載するものです。

### 1.2 対象読者
- システム設計者
- インフラエンジニア
- 開発エンジニア
- 運用担当者
- プロジェクトマネージャー

### 1.3 参考資料
- [AWS SES 開発者ガイド](https://docs.aws.amazon.com/ses/latest/dg/)
- [AWS Well-Architected Framework](https://aws.amazon.com/architecture/well-architected/)
- [AWS CloudFormation ユーザーガイド](https://docs.aws.amazon.com/cloudformation/)
- [Sceptre ドキュメント](https://sceptre.cloudreach.com/)

## 2. システム概要

### 2.1 プロジェクト背景
現在運用中のオンプレミス環境（Postfix Server 1-12台）によるメール送信システム（約5,300,000通/日）を、AWS SESに移行することで以下を実現する：
- 運用コストの削減（月額70万円 → 50万円以内）
- スケーラビリティの向上
- セキュリティの強化
- 運用負荷の軽減

### 2.2 移行対象
- **対象ドメイン**: goo.ne.jp
- **現在の送信量**: 約5,300,000通/日（約220,000通/時）
- **移行方式**: 段階的移行（10% → 50% → 100%）
- **移行期間**: 1か月

### 2.3 システム要件サマリー
- **可用性**: 99.9%以上
- **送信成功率**: 99.5%以上
- **処理能力**: 100,000通/時間
- **レイテンシ**: 1分以内
- **セキュリティ**: 転送時・保存時暗号化必須

## 3. アーキテクチャ設計

### 3.1 全体アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                    AWS Account                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                 ap-northeast-1                          │ │
│  │                                                         │ │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │ │
│  │  │     AZ-a    │    │     AZ-c    │    │     AZ-d    │  │ │
│  │  │             │    │             │    │             │  │ │
│  │  │ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │  │ │
│  │  │ │Lambda   │ │    │ │Lambda   │ │    │ │Lambda   │ │  │ │
│  │  │ │Function │ │    │ │Function │ │    │ │Function │ │  │ │
│  │  │ └─────────┘ │    │ └─────────┘ │    │ └─────────┘ │  │ │
│  │  └─────────────┘    └─────────────┘    └─────────────┘  │ │
│  │                                                         │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                 AWS SES                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────┐│ │ │
│  │  │  │          Configuration Set                      ││ │ │
│  │  │  │  - Event Publishing                             ││ │ │
│  │  │  │  - Reputation Tracking                          ││ │ │
│  │  │  │  - Delivery Options                             ││ │ │
│  │  │  └─────────────────────────────────────────────────┘│ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  │                                                         │ │
│  │  ┌─────────────────────────────────────────────────────┐ │ │
│  │  │                Storage Layer                        │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │ │ │
│  │  │  │     S3      │  │ CloudWatch  │  │   Secrets   │  │ │ │
│  │  │  │   Bucket    │  │    Logs     │  │   Manager   │  │ │ │
│  │  │  │             │  │             │  │             │  │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  │ │ │
│  │  └─────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Security & Monitoring                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │ │
│  │  │     IAM     │  │ CloudTrail  │  │   Config    │      │ │
│  │  │             │  │             │  │             │      │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘      │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 主要コンポーネント

#### 3.2.1 AWS SES
- **役割**: メール送信の中核サービス
- **設定**:
  - Configuration Set: メール送信の設定とイベント追跡
  - Identity Management: ドメイン認証（DKIM/SPF/DMARC）
  - Reputation Management: 送信評価の管理
  - Sending Quota: 送信制限の管理

#### 3.2.2 AWS Lambda
- **役割**: DKIM証明書の自動更新とアラート処理
- **機能**:
  - DKIM証明書の期限監視（月次実行）
  - 期限切れ1ヶ月前のアラート送信
  - 新しいDKIM証明書の生成
  - DNS更新用のCNAMEレコード情報の生成

#### 3.2.3 Amazon S3
- **役割**: ログとバックアップデータの長期保存
- **設定**:
  - ライフサイクル管理: 30日後にIA、90日後にGlacier
  - バージョニング有効
  - サーバーサイド暗号化（SSE-S3）

#### 3.2.4 Amazon CloudWatch
- **役割**: 監視・ログ・アラート
- **機能**:
  - メトリクス収集（送信成功率、バウンス率、苦情率）
  - ログ集約（構造化ログ）
  - アラート設定（閾値監視）

#### 3.2.5 AWS Secrets Manager
- **役割**: SMTP認証情報の安全な管理
- **設定**:
  - 自動ローテーション（90日間隔）
  - 暗号化（AWS KMS）
  - バージョン管理

## 4. AWSサービス設計詳細

### 4.1 Amazon SES設定

#### 4.1.1 Identity設定
```yaml
Domain Identity:
  Domain: goo.ne.jp
  DKIM:
    Type: BYODKIM  # Bring Your Own DKIM
    Enabled: false  # 初期状態では無効
    KeyLength: 2048-bit
    SigningEnabled: false  # Phase 7で有効化
    CustomSelectors: 3  # カスタムセレクター数
  SPF Record: "v=spf1 include:amazonses.com ~all"
  DMARC Record: "v=DMARC1; p=quarantine; rua=mailto:dmarc@goo.ne.jp"
```

#### 4.1.2 Configuration Set
```yaml
ConfigurationSet:
  Name: goo-ne-jp-email-config
  DeliveryOptions:
    TlsPolicy: Require
  ReputationMetricsEnabled: true
  SendingEnabled: true
  EventDestinations:
    - Name: cloudwatch-events
      Enabled: true
      MatchingEventTypes:
        - send
        - bounce
        - complaint
        - delivery
      CloudWatchDestination:
        DimensionConfigurations:
          - DimensionName: MessageTag
            DimensionValueSource: messageTag
            DefaultDimensionValue: default
```

#### 4.1.3 送信制限
```yaml
SendingQuota:
  MaxSendRate: 200  # メール/秒（段階的に引き上げ）
  Max24HourSend: 10000000  # 24時間あたりの上限
```

### 4.2 AWS Lambda設計

#### 4.2.1 DKIM管理Lambda
```yaml
Function:
  Runtime: python3.11
  MemorySize: 512
  Timeout: 300
  Environment:
    Variables:
      DOMAIN_NAME: goo.ne.jp
      SNS_TOPIC_ARN: !Ref DKIMAlertTopic
      LAMBDA_LAYER_ARN: !Ref CryptographyLayer
  Events:
    Phase4Trigger:
      Type: Schedule
      Properties:
        Schedule: "cron(0 9 1 * ? *)"  # 毎月1日 9:00 JST
    Phase7Trigger:
      Type: EventBridge
      Properties:
        EventPattern:
          source: ["aws.lambda"]
          detail-type: ["Phase 5 Completion"]
```

#### 4.2.2 メール処理Lambda
```yaml
Function:
  Runtime: python3.11
  MemorySize: 512
  Timeout: 900
  ReservedConcurrency: 100
  Environment:
    Variables:
      SES_CONFIG_SET: goo-ne-jp-email-config
      SECRET_ARN: !Ref SMTPCredentials
```

### 4.3 監視・ログ設計

#### 4.3.1 CloudWatchメトリクス
```yaml
CustomMetrics:
  - MetricName: EmailSendSuccess
    Unit: Count
    Dimensions:
      - Name: Domain
        Value: goo.ne.jp
  - MetricName: EmailBounceRate
    Unit: Percent
    Dimensions:
      - Name: Domain
        Value: goo.ne.jp
  - MetricName: EmailComplaintRate
    Unit: Percent
    Dimensions:
      - Name: Domain
        Value: goo.ne.jp
```

#### 4.3.2 アラート設定
```yaml
Alarms:
  BounceRateAlarm:
    MetricName: Bounce
    Threshold: 5.0
    ComparisonOperator: GreaterThanThreshold
    EvaluationPeriods: 2
    Period: 300
  ComplaintRateAlarm:
    MetricName: Complaint
    Threshold: 0.1
    ComparisonOperator: GreaterThanThreshold
    EvaluationPeriods: 2
    Period: 300
  SendingQuotaAlarm:
    MetricName: Send
    Threshold: 8000000  # 1日の80%
    ComparisonOperator: GreaterThanThreshold
    EvaluationPeriods: 1
    Period: 86400
```

## 5. セキュリティ設計

### 5.1 個人情報保護

#### 5.1.1 データマスキング
```python
# メールアドレスマスキング例
def mask_email(email):
    local, domain = email.split('@')
    masked_local = local[:3] + '*' * (len(local) - 3)
    domain_parts = domain.split('.')
    masked_domain = '.'.join(['***'] * len(domain_parts))
    return f"{masked_local}@{masked_domain}"

# IPアドレスマスキング例  
def mask_ip(ip):
    parts = ip.split('.')
    return f"{parts[0]}.{parts[1]}.***.***.***"
```

#### 5.1.2 アクセス制御
```yaml
IAMPolicy:
  AdminPolicy:
    Effect: Allow
    Principal:
      AWS: 
        - arn:aws:iam::ACCOUNT:user/admin-user
    Condition:
      IpAddress:
        aws:SourceIp:
          - "203.0.113.0/24"  # 管理者IP範囲
  
  ReadOnlyPolicy:
    Effect: Allow
    Principal:
      AWS:
        - arn:aws:iam::ACCOUNT:user/readonly-user
    Condition:
      IpAddress:
        aws:SourceIp:
          - "203.0.113.0/24"
          - "198.51.100.0/24"  # 監視担当者IP範囲
```

### 5.2 暗号化設定

#### 5.2.1 転送時暗号化
- SMTP over TLS 1.2以上
- HTTPS API通信
- VPC Endpoint使用

#### 5.2.2 保存時暗号化
- S3: SSE-S3
- Secrets Manager: AWS KMS
- CloudWatch Logs: AWS KMS

## 6. 可用性・災害復旧設計

### 6.1 マルチAZ構成
```yaml
AvailabilityZones:
  Primary: ap-northeast-1a
  Secondary: ap-northeast-1c
  Tertiary: ap-northeast-1d

LambdaDeployment:
  DeadLetterQueue: true
  RetryAttempts: 3
  ReservedConcurrency: 100
```

### 6.2 バックアップ戦略
```yaml
S3Backup:
  VersioningEnabled: true
  LifecyclePolicy:
    - Id: EmailLogsLifecycle
      Status: Enabled
      Transitions:
        - Days: 30
          StorageClass: STANDARD_IA
        - Days: 90
          StorageClass: GLACIER
        - Days: 2555  # 7年
          StorageClass: DEEP_ARCHIVE
```

### 6.3 障害復旧
- **RTO**: 4時間以内
- **RPO**: 1時間以内
- **自動フェイルオーバー**: Lambda関数の自動再試行
- **手動切り戻し**: CloudFormationスタックのロールバック

## 7. パフォーマンス設計

### 7.1 スループット設計
```yaml
Performance:
  TargetThroughput: 100000  # メール/時間
  PeakThroughput: 150000    # ピーク時
  SESQuota:
    SendingRate: 200        # メール/秒
    DailyQuota: 10000000    # 日次上限
  
LambdaConcurrency:
  EmailProcessor: 100       # 同時実行数
  DKIMManager: 1           # 単一実行
```

### 7.2 レイテンシ最適化
- Lambda関数のウォームアップ
- 接続プールの使用
- 非同期処理の活用

## 8. 運用設計

### 8.1 監視項目
```yaml
Monitoring:
  BusinessMetrics:
    - SendSuccessRate: "> 99.5%"
    - BounceRate: "< 5%"
    - ComplaintRate: "< 0.1%"
    - SendingLatency: "< 60秒"
  
  SystemMetrics:
    - LambdaDuration: "< 30秒"
    - LambdaErrors: "< 1%"
    - LambdaThrottles: "0件"
    
  SecurityMetrics:
    - UnauthorizedAccess: "0件"
    - DKIMValidation: "> 99%"
```

### 8.2 アラート設定
```yaml
AlertLevels:
  Critical:
    - BounceRate > 5%
    - ComplaintRate > 0.1%
    - SendSuccessRate < 95%
    - DKIMExpiry < 30日
  
  Warning:
    - SendingQuota > 80%
    - LambdaErrors > 0.5%
    - UnusualTrafficPattern
  
  Info:
    - DailyReport
    - WeeklyPerformanceReport
```

### 8.3 定期メンテナンス
- **月次**: DKIM証明書確認、パフォーマンスレビュー
- **四半期**: セキュリティ監査、コスト最適化
- **年次**: アーキテクチャレビュー、災害復旧テスト

## 9. コスト設計

### 9.1 コスト構造
```yaml
EstimatedMonthlyCosts:
  SES:
    SendingCost: "¥26,500"  # 5.3M通 × ¥0.005
    DataTransfer: "¥5,000"
  
  Lambda:
    Execution: "¥3,000"
    Storage: "¥500"
  
  S3:
    Storage: "¥2,000"
    Requests: "¥1,000"
  
  CloudWatch:
    Metrics: "¥3,000"
    Logs: "¥2,000"
    
  Other:
    SecretsManager: "¥1,000"
    KMS: "¥500"
    
  Total: "¥44,500"  # 予算50万円以内
```

### 9.2 コスト最適化
- Reserved Capacityの検討
- S3ライフサイクル管理
- CloudWatchログの適切な保持期間設定
- 不要なメトリクスの削除

## 10. 移行設計

### 10.1 移行フェーズ
```yaml
Phase1: # インフラ基盤構築（1週間）
  - AWS環境構築
  - IAMロール・KMSキー設定
  - S3バケット・Secrets Manager設定
  
Phase2: # DKIMシステム構築（1週間）
  - Lambda関数作成
  - EventBridge設定
  - Lambda Layer作成
  
Phase3: # SES設定（1週間）
  - Email Identity作成
  - EasyDKIM無効化
  - BYODKIM初期化
  
Phase4: # DKIM証明書生成（自動）
  - 3つのカスタムセレクター生成
  - TXTレコード作成
  - S3への保存
  
Phase5: # DNS管理チーム通知（自動）
  - メール・Slack通知
  - Phase 7自動実行トリガー
  
Phase6: # DNS設定完了待ち（約2週間）
  - 外部DNS管理チームによる作業
  - CloudFormationリソース不要
  
Phase7: # DNS検証・DKIM有効化（自動）
  - DNS伝播確認
  - BYODKIM有効化
  - 監視開始
  
Phase8: # 監視システム開始（自動）
  - 定期監視設定
  - アラート設定
```

### 10.2 移行時の監視強化
- リアルタイムダッシュボード
- 自動ロールバック機能
- 24時間監視体制

## 11. 制約・前提条件

### 11.1 技術的制約
- DNSの管理は別チーム（CNAME登録に約2週間）
- 既存のPostfixサーバーとの並行運用期間
- AWS SESの送信制限（段階的な引き上げが必要）

### 11.2 運用制約
- 予算上限: 月額50万円
- 移行期間: 1ヶ月
- ダウンタイム: 最小限（4時間以内）

## 12. 今後の拡張計画

### 12.1 短期拡張（3ヶ月以内）
- 高度な分析機能の追加
- 自動化機能の拡充
- パフォーマンス最適化

### 12.2 中長期拡張（6ヶ月～1年）
- AI/MLを活用した送信最適化
- マルチリージョン対応
- エッジコンピューティングの活用

---

**文書管理情報**
- 作成日: 2024年12月
- バージョン: 1.0
- 作成者: システム設計チーム
- 承認者: プロジェクトマネージャー
- 次回レビュー: 2025年1月
