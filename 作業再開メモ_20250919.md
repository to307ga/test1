# ä½œæ¥­å†é–‹ãƒ¡ãƒ¢ - 2025å¹´9æœˆ19æ—¥

## ğŸš¨ é‡è¦ãªå•é¡Œ - ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®æ¬ å¤±

### å•é¡Œã®æ¦‚è¦
Phase 8çµ±åˆæ™‚ã«ã€ç‹¬ç«‹ã—ãŸmonitoring.yamlã§æä¾›ã•ã‚Œã¦ã„ãŸ**ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãŒå®Œå…¨ã«å¤±ã‚ã‚Œã¾ã—ãŸ**ã€‚ã“ã‚Œã¯é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®æ¬ å¤±ã§ã™ã€‚

### å½±éŸ¿ç¯„å›²
- **DataMaskingFunctionArn**: å€‹äººæƒ…å ±ãƒã‚¹ã‚­ãƒ³ã‚°ç”¨Lambdaé–¢æ•°ãŒå­˜åœ¨ã—ãªã„
- **AdminQueryDefinitionName**: ç®¡ç†è€…ç”¨CloudWatch Logsã‚¯ã‚¨ãƒªå®šç¾©ãŒæœªå®Ÿè£…
- **MaskedQueryDefinitionName**: ãƒã‚¹ã‚¯æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ç”¨ã‚¯ã‚¨ãƒªå®šç¾©ãŒæœªå®Ÿè£…
- **Securityã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤**: ä¸Šè¨˜3ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³ã§ãƒ‡ãƒ—ãƒ­ã‚¤ä¸å¯

### è¨­è¨ˆä¸Šã®å•é¡Œç‚¹
```yaml
# å…ƒã€…ã®æ§‹æˆï¼ˆPhase 8çµ±åˆå‰ï¼‰
# - monitoring.yaml                           (ç›£è¦–ãƒ»ãƒã‚¹ã‚­ãƒ³ã‚°)  â† ã“ã‚ŒãŒå¤±ã‚ã‚ŒãŸ
# - security.yaml                             (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)

# ç¾åœ¨ã®æ§‹æˆï¼ˆPhase 8çµ±åˆå¾Œï¼‰  
# - phase-8-monitoring.yaml                   (çµ±åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ )  â† ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ãªã—
# - security.yaml                             (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡) â† ãƒ‡ãƒ—ãƒ­ã‚¤ä¸å¯
```

## ğŸ“‹ ç¾åœ¨ã®ä½œæ¥­çŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿é …ç›®
1. **ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯**
   - Lambdaé–¢æ•°: 5å€‹ï¼ˆcertificate-monitor, dns-notifier, dkim-manager-v2, layer-setup, data-maskingï¼‰
   - S3ãƒã‚±ãƒƒãƒˆ: 7å€‹ï¼ˆdkim-certificates, dkim-logs, error-logs, lambda-layers, masked-logs, raw-logs, templatesï¼‰
   - SNSãƒˆãƒ”ãƒƒã‚¯: 2å€‹ï¼ˆDNS ãƒãƒ¼ãƒ é€šçŸ¥, ä¸€èˆ¬é€šçŸ¥ï¼‰
   - CloudWatchãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: 3å€‹
   - EventBridgeãƒ«ãƒ¼ãƒ«: çµ±ä¸€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼ˆæ¯æ—¥9:00 AM JSTï¼‰

2. **ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆè¨­å®šçŠ¶æ³ç¢ºèª**
   - è¨¼æ˜æ›¸æœ‰åŠ¹æœŸé™: 2æ—¥ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
   - ã‚¢ãƒ©ãƒ¼ãƒˆ: 1æ—¥å‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
   - EventBridge: æ¯æ—¥9æ™‚å®Ÿè¡Œï¼ˆ`cron(0 9 * * ? *)`ï¼‰
   - **âš ï¸ é‡è¦**: æ˜æ—¥ï¼ˆ2025å¹´9æœˆ19æ—¥ï¼‰ã®æœ9:00 AM JST ã«ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹
   - **ç¾åœ¨ã®è¨¼æ˜æ›¸**: 2025å¹´9æœˆ18æ—¥ 19:08ä½œæˆï¼ˆgooid-21-pro-20250918-1ï¼‰
   - **è¨¼æ˜æ›¸æœŸé™**: 2025å¹´9æœˆ20æ—¥é ƒï¼ˆ2æ—¥å¾Œï¼‰
   - **ã‚¢ãƒ©ãƒ¼ãƒˆäºˆå®š**: 2025å¹´9æœˆ19æ—¥ï¼ˆ1æ—¥å‰ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰
   - **æ³¨æ„**: æœ¬ç•ªè¨­å®šã¸ã®ç§»è¡Œã¯æ˜ç¤ºçš„ãªæŒ‡ç¤ºãŒã‚ã‚‹ã¾ã§ä¿ç•™

3. **Enhanced Kinesisãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
   - Kinesis Data Firehoseã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆraw-logs, masked-logsï¼‰
   - ãƒ‡ãƒ¼ã‚¿å¤‰æ›Lambdaé–¢æ•°
   - S3çµ±åˆ
   - ã‚¹ã‚¿ãƒƒã‚¯çŠ¶æ…‹: CREATE_COMPLETE

### ğŸ”„ ç¾åœ¨é€²è¡Œä¸­ï¼ˆä¸­æ–­ï¼‰
4. **Phase 8ã«ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ** â† **æœ€å„ªå…ˆä½œæ¥­**
   - çŠ¶æ…‹: åˆ†æå®Œäº†ã€å®Ÿè£…æœªç€æ‰‹
   - å¿…è¦ãªæ©Ÿèƒ½:
     - DataMaskingLambdaé–¢æ•°
     - CloudWatch Insights ã‚¯ã‚¨ãƒªå®šç¾©ï¼ˆAdminç”¨ã€Maskedç”¨ï¼‰
     - Phase 8ã‚¹ã‚¿ãƒƒã‚¯ã®å‡ºåŠ›å€¤è¿½åŠ 

5. **Securityã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
   - çŠ¶æ…‹: ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®ä¾å­˜é–¢ä¿‚ã«ã‚ˆã‚Šä¿ç•™ä¸­
   - ç¾åœ¨ã®å•é¡Œ: å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³
   ```
   Parameters: [DataMaskingFunctionArn, AdminQueryDefinitionName, MaskedQueryDefinitionName] must have values
   ```

### â³ æœªç€æ‰‹é …ç›®
6. **ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆ**
7. **æœ€çµ‚æœ¬ç•ªåŒ–æº–å‚™**

## ğŸ”§ æ˜æ—¥ã®ä½œæ¥­è¨ˆç”»

### ã€æœ€å„ªå…ˆã€‘Phase 8ã«ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ 

#### Step 1: Phase 8ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ‹¡å¼µ
ãƒ•ã‚¡ã‚¤ãƒ«: `sceptre/templates/phase-8-monitoring.yaml`

è¿½åŠ ãŒå¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹:
```yaml
# 1. ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°ç”¨Lambdaé–¢æ•°
DataMaskingLambda:
  Type: AWS::Lambda::Function
  Properties:
    FunctionName: !Sub "${ProjectName}-${Environment}-data-masking"
    Runtime: python3.13
    Handler: index.handler
    Code:
      ZipFile: |
        import json
        import re
        def handler(event, context):
            # å€‹äººæƒ…å ±ãƒã‚¹ã‚­ãƒ³ã‚°å‡¦ç†
            # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é›»è©±ç•ªå·ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ã‚’ãƒã‚¹ã‚¯
            pass

# 2. CloudWatch Logs ã‚¯ã‚¨ãƒªå®šç¾©ï¼ˆç®¡ç†è€…ç”¨ï¼‰
AdminQueryDefinition:
  Type: AWS::Logs::QueryDefinition
  Properties:
    Name: !Sub "${ProjectName}-${Environment}-admin-logs-query"
    QueryString: |
      fields @timestamp, @message, @logStream
      | filter @message like /ERROR/ or @message like /WARNING/
      | sort @timestamp desc

# 3. CloudWatch Logs ã‚¯ã‚¨ãƒªå®šç¾©ï¼ˆãƒã‚¹ã‚¯æ¸ˆã¿ç”¨ï¼‰
MaskedQueryDefinition:
  Type: AWS::Logs::QueryDefinition  
  Properties:
    Name: !Sub "${ProjectName}-${Environment}-masked-logs-query"
    QueryString: |
      fields @timestamp, @message, @logStream
      | filter @message like /ERROR/ or @message like /WARNING/
      | sort @timestamp desc
```

#### Step 2: Phase 8ã®å‡ºåŠ›å€¤è¿½åŠ 
```yaml
Outputs:
  DataMaskingFunctionArn:
    Description: ARN of data masking Lambda function
    Value: !GetAtt DataMaskingLambda.Arn
    Export:
      Name: !Sub "${ProjectName}-${Environment}-DataMaskingFunctionArn"

  AdminQueryDefinitionName:
    Description: Name of admin CloudWatch Logs query definition
    Value: !Ref AdminQueryDefinition
    Export:
      Name: !Sub "${ProjectName}-${Environment}-AdminQueryDefinitionName"

  MaskedQueryDefinitionName:
    Description: Name of masked CloudWatch Logs query definition
    Value: !Ref MaskedQueryDefinition
    Export:
      Name: !Sub "${ProjectName}-${Environment}-MaskedQueryDefinitionName"
```

#### Step 3: Phase 8ã‚¹ã‚¿ãƒƒã‚¯ã®æ›´æ–°
```bash
cd sceptre
uv run sceptre update prod/phase-8-monitoring.yaml --yes
```

#### Step 4: Securityã‚¹ã‚¿ãƒƒã‚¯è¨­å®šã®æœ‰åŠ¹åŒ–
ãƒ•ã‚¡ã‚¤ãƒ«: `sceptre/config/prod/security.yaml`

ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æœ‰åŠ¹åŒ–:
```yaml
# ç¾åœ¨ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
# DataMaskingFunctionArn: !stack_output prod/phase-8-monitoring.yaml::DataMaskingFunctionArn
# AdminQueryDefinitionName: !stack_output prod/phase-8-monitoring.yaml::AdminQueryDefinitionName  
# MaskedQueryDefinitionName: !stack_output prod/phase-8-monitoring.yaml::MaskedQueryDefinitionName

# å¤‰æ›´å¾Œï¼ˆæœ‰åŠ¹åŒ–ï¼‰
DataMaskingFunctionArn: !stack_output prod/phase-8-monitoring.yaml::DataMaskingFunctionArn
AdminQueryDefinitionName: !stack_output prod/phase-8-monitoring.yaml::AdminQueryDefinitionName
MaskedQueryDefinitionName: !stack_output prod/phase-8-monitoring.yaml::MaskedQueryDefinitionName
```

#### Step 5: Securityã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
uv run sceptre create prod/security.yaml --yes
```

## ğŸ—‚ï¸ é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

### ç·¨é›†å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `sceptre/templates/phase-8-monitoring.yaml` - ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½è¿½åŠ 
- `sceptre/config/prod/security.yaml` - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœ‰åŠ¹åŒ–

### ç¢ºèªç”¨ãƒ•ã‚¡ã‚¤ãƒ«
- `sceptre/templates/security.yaml` - Securityã‚¹ã‚¿ãƒƒã‚¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- `sceptre/config/prod/phase-8-monitoring.yaml` - Phase 8è¨­å®š

## ğŸš¨ æ³¨æ„äº‹é …

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®é‡è¦æ€§
1. **å€‹äººæƒ…å ±ä¿è­·**: ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã¯æ³•çš„ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶
2. **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: é©åˆ‡ãªãƒ­ã‚°ã‚¯ã‚¨ãƒªåˆ¶é™ãŒå¿…è¦
3. **ç›£æŸ»å¯¾å¿œ**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã®å®Œå…¨æ€§ç¢ºä¿ãŒå¿…é ˆ

### ãƒ†ã‚¹ãƒˆç’°å¢ƒè¨­å®š
- è¨¼æ˜æ›¸æœ‰åŠ¹æœŸé™: 2æ—¥ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
- ã‚¢ãƒ©ãƒ¼ãƒˆ: 1æ—¥å‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
- **æœ¬ç•ªç§»è¡Œã¯æ˜ç¤ºçš„æŒ‡ç¤ºã¾ã§ä¿ç•™**

### ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œãƒ«ãƒ¼ãƒ«
- **å¿…é ˆ**: ã™ã¹ã¦ã®PythonãŠã‚ˆã³Sceptreã‚³ãƒãƒ³ãƒ‰ã¯ `uv run` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä½¿ç”¨
- **å¿…é ˆ**: Sceptreã‚³ãƒãƒ³ãƒ‰ã¯ sceptre ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ
- **å¿…é ˆ**: ãƒªã‚½ãƒ¼ã‚¹å¤‰æ›´ç³»ã‚³ãƒãƒ³ãƒ‰ã«ã¯ `--yes` ãƒ•ãƒ©ã‚°è¿½åŠ 

## ğŸ“Š ç¾åœ¨ã®ã‚¹ã‚¿ãƒƒã‚¯çŠ¶æ³

```json
{
    "prod/phase-1-infrastructure-foundation": "CREATE_COMPLETE",
    "prod/base": "CREATE_COMPLETE", 
    "prod/enhanced-kinesis": "CREATE_COMPLETE",
    "prod/phase-2-dkim-system": "UPDATE_COMPLETE",
    "prod/phase-3-ses-byodkim": "CREATE_COMPLETE",
    "prod/phase-4-dns-preparation": "CREATE_COMPLETE", 
    "prod/phase-5-dns-team-collaboration": "CREATE_COMPLETE",
    "prod/phase-8-monitoring": "UPDATE_COMPLETE",
    "prod/phase-7-dns-validation-dkim-activation": "CREATE_COMPLETE",
    "prod/security": "PENDING"  â† ãƒ‡ãƒ—ãƒ­ã‚¤å¾…ã¡
}
```

## ğŸ¯ æˆåŠŸã®åˆ¤å®šåŸºæº–

### Phase 8æ©Ÿèƒ½æ‹¡å¼µå®Œäº†
- [ ] DataMaskingLambdaé–¢æ•°ã®ä½œæˆ
- [ ] CloudWatch Logsã‚¯ã‚¨ãƒªå®šç¾©ã®ä½œæˆ
- [ ] Phase 8å‡ºåŠ›å€¤ã®è¿½åŠ 
- [ ] Phase 8ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°æˆåŠŸ

### Securityã‚¹ã‚¿ãƒƒã‚¯ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è§£æ±º
- [ ] IAMã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒãƒªã‚·ãƒ¼ã®ä½œæˆ
- [ ] IPåˆ¶é™ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®æœ‰åŠ¹åŒ–
- [ ] å€‹äººæƒ…å ±ä¿è­·æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

---

**æ¬¡å›ä½œæ¥­é–‹å§‹æ™‚ã¯ã€å¿…ãšã“ã®ãƒ¡ãƒ¢ã‚’å‚ç…§ã—ã¦Phase 8ã®ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æ©Ÿèƒ½è¿½åŠ ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„ã€‚**
