# S3バケットポリシー修正レポート: s3_raw.yaml → S3_raw_fix.yaml

## 概要

このレポートでは、`s3_raw.yaml`の問題点と`S3_raw_fix.yaml`での解決方法を詳細に説明します。

---

## 🔍 問題分析: s3_raw.yamlの課題

### ❌ **主要問題1: 無効なIP制限ポリシー**

#### 問題のあるコード
```json
{
    "Effect": "Deny",
    "Condition": {
        "IpAddressIfExists": {
            "aws:SourceIp": [
                "10.99.0.0/16", "10.88.80.0/20", 
                "10.80.11.0/28", "10.80.0.0/24",
                "10.99.0.0/24", "202.217.0.0/16"
            ]
        },
        "StringEquals": {
            "aws:PrincipalServiceName": "firehose.amazonaws.com"
        },
        "Bool": {
            "aws:ViaAWSService": "true"
        }
    }
}
```

#### 問題点
1. **条件の論理エラー**: AND条件により、以下3つが全て真でなければDenyが適用されない
   - IPアドレスが指定範囲内にある
   - AND プリンシパルがFirehoseサービスである  
   - AND AWSサービス経由である

2. **実際の動作**: 人間ユーザー（非Firehoseサービス）の場合
   - IPアドレス条件: 真（範囲外IP）
   - サービス条件: **偽**（Firehoseではない）
   - ViaAWSService条件: **偽**
   - **結果**: AND条件が偽となり、Denyが適用されない = **アクセス許可**

3. **`IpAddressIfExists`の誤用**: IP情報が存在する場合のみ評価されるため、期待通りに動作しない

### ❌ **主要問題2: 設計思想の混乱**

#### 問題点
- **AWSサービス向けIP制限**: AWSサービス（Firehose/Lambda）のIPアドレスは動的で制御不可能
- **意図不明**: 人間ユーザーを制限したいのか、AWSサービスを制限したいのか不明確
- **セキュリティホール**: IP制限が機能せず、実質的に無制限アクセス

### ❌ **主要問題3: 不完全なARN制限**

#### 問題のあるコード
```json
"ArnLike": {
    "aws:SourceArn": "arn:aws:firehose:ap-northeast-1:007773581311:deliverystream/*"
}
```

#### 問題点
- Lambdaサービスも許可しているが、LambdaのARN制限がない
- 一貫性のない制御

---

## ✅ 解決方法: S3_raw_fix.yamlでの修正

### 🎯 **解決1: 適切なIP制限の実装**

#### 修正されたコード
```json
{
    "Sid": "DenyHumanAccessFromUnauthorizedIPs",
    "Effect": "Deny",
    "Principal": "*",
    "Action": "s3:*",
    "Condition": {
        "NotIpAddress": {
            "aws:SourceIp": [
                "10.99.0.0/16", "10.88.80.0/20",
                "10.80.11.0/28", "10.80.0.0/24", 
                "202.217.0.0/16", "153.254.171.0/28",
                "203.138.153.247/32", "153.143.181.0/28",
                "153.143.181.16/28", "202.217.75.82/31",
                "202.217.75.84/30", "155.190.0.0/16"
            ]
        },
        "StringNotEquals": {
            "aws:PrincipalServiceName": [
                "firehose.amazonaws.com", "lambda.amazonaws.com",
                "s3.amazonaws.com", "cloudformation.amazonaws.com"
            ]
        }
    }
}
```

#### 解決内容
1. **`NotIpAddress`使用**: 許可IP範囲外からのアクセスを明示的に拒否
2. **`StringNotEquals`使用**: AWSサービス以外（人間ユーザー）のみをターゲット
3. **AND条件の適切な活用**: 
   - IP範囲外 AND 非AWSサービス = 人間ユーザーの不正アクセスを拒否
   - AWSサービスはIP制限を回避

### 🎯 **解決2: 明確な責任分離**

#### 修正されたポリシー構造
```
ポリシー1: 人間ユーザーのIP制限
ポリシー2: SSL強制（全アクセス）
ポリシー3: AWSサービス許可
```

#### 解決内容
- **単一責任原則**: 各ポリシーが1つの目的のみ担当
- **明確な意図**: 人間ユーザーとAWSサービスを明確に分離
- **保守性向上**: 理解しやすく、修正しやすい構造

### 🎯 **解決3: 完全なARN制限**

#### 修正されたコード
```json
"ArnLike": {
    "aws:SourceArn": [
        "arn:aws:firehose:ap-northeast-1:007773581311:deliverystream/*",
        "arn:aws:lambda:ap-northeast-1:007773581311:function/*"
    ]
}
```

#### 解決内容
- **包括的ARN制限**: FirehoseとLambda両方のARNパターンを明示
- **一貫したセキュリティ**: 全サービスに対して同等の制限

### 🎯 **解決4: 拡張されたIP許可リスト**

#### 追加されたIP範囲
```
元: 6個のIP範囲
修正版: 12個のIP範囲（VDI、オフィス環境を包含）
```

#### 解決内容
- **VDI環境対応**: `153.254.171.0/28`, `203.138.153.247/32`
- **オフィス環境対応**: `153.143.181.0/28`, `153.143.181.16/28`
- **追加企業ネットワーク**: `155.190.0.0/16`

---

## 📊 修正前後の比較

| 項目 | s3_raw.yaml (問題版) | S3_raw_fix.yaml (修正版) |
|------|---------------------|------------------------|
| **IP制限の実効性** | ❌ 機能しない | ✅ 適切に機能 |
| **セキュリティレベル** | ❌ 実質無制限 | ✅ 厳格な制限 |
| **AWSサービスアクセス** | ✅ 許可（偶然） | ✅ 適切に許可 |
| **人間ユーザーアクセス** | ❌ 無制限許可 | ✅ IP制限適用 |
| **ポリシー可読性** | ❌ 複雑で分かりにくい | ✅ 明確で理解しやすい |
| **保守性** | ❌ 修正が困難 | ✅ 修正が容易 |

---

## 🛡️ セキュリティ効果

### 修正前（s3_raw.yaml）
- **IP `167.103.16.84`**: ✅ アクセス可能（セキュリティホール）
- **任意IP**: ✅ アクセス可能（実質無制限）
- **AWSサービス**: ✅ アクセス可能

### 修正後（S3_raw_fix.yaml）
- **IP `167.103.16.84`**: ❌ アクセス拒否（IP制限が適切に機能）
- **許可IP範囲**: ✅ アクセス可能
- **AWSサービス**: ✅ アクセス可能（IP制限回避）

---

## 🎯 推奨事項

1. **本番環境適用**: `S3_raw_fix.yaml`を本番環境に適用することを推奨
2. **IP範囲の定期見直し**: 企業ネットワーク変更に応じてIP範囲を更新
3. **CloudTrailでの監視**: ポリシー適用後のアクセスログを監視
4. **段階的適用**: 重要度の低いリソースで先行テストを実施

---

## 📝 結論

`s3_raw.yaml`は設計上の根本的な問題により、意図したIP制限が全く機能していませんでした。`S3_raw_fix.yaml`では、適切な条件演算子の使用、明確な責任分離、完全なARN制限により、これらの問題を解決しました。

修正版では、人間ユーザーには厳格なIP制限を適用し、AWSサービスには適切なアクセス制御を提供する、セキュリティと運用性を両立したポリシーとなっています。
