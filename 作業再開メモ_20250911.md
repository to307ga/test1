# ä½œæ¥­å†é–‹ãƒ¡ãƒ¢ - 2025å¹´9æœˆ11æ—¥

## ç¾åœ¨ã®çŠ¶æ³
AWS SES BYODKIM productionç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ä½œæ¥­ä¸­ã€‚Phase 1-5ã¯å®Œäº†æ¸ˆã¿ã€ç¾åœ¨Phase 7ï¼ˆDKIMè¨¼æ˜æ›¸ä½œæˆï¼‰ã§cryptographyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å•é¡Œã«å¯¾å‡¦ä¸­ã€‚

## å•é¡Œã®çµŒç·¯
1. **cryptographyãƒ©ã‚¤ãƒ–ãƒ©ãƒªå•é¡Œ**: Lambda Layerä½œæˆæ™‚ã«Rustãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
   - ã‚¨ãƒ©ãƒ¼: `module 'cryptography.hazmat.bindings._rust.openssl' has no attribute 'hashes'`
   - è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³è©¦è¡Œï¼ˆ45.0.7 â†’ 41.0.7ï¼‰ã‚‚è§£æ±ºã›ãš

2. **è§£æ±ºç­–**: OpenSSLã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…ã¸ã®å¤‰æ›´ã‚’æ±ºå®š
   - cryptographyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ãªãsubprocessã§OpenSSLã‚³ãƒãƒ³ãƒ‰ã‚’ç›´æ¥å®Ÿè¡Œ
   - Lambdaç’°å¢ƒã«ã¯OpenSSLãŒæ¨™æº–ã§åˆ©ç”¨å¯èƒ½

## ä»Šæ—¥å®Ÿæ–½ã—ãŸä¿®æ­£å†…å®¹
### ãƒ•ã‚¡ã‚¤ãƒ«: `sceptre/templates/dkim-manager-lambda.yaml`

**ä¿®æ­£å‰ï¼ˆcryptographyãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨ï¼‰:**
```python
# Import cryptography library for proper RSA key generation
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.primitives import serialization

# Generate proper RSA key pair for DKIM
private_key = rsa.generate_private_key(
    public_exponent=65537,
    key_size=2048,
)
```

**ä¿®æ­£å¾Œï¼ˆOpenSSLä½¿ç”¨ï¼‰:**
```python
import subprocess
import tempfile
import os

# Generate proper RSA key pair for DKIM using OpenSSL
with tempfile.TemporaryDirectory() as tmpdir:
    private_key_path = os.path.join(tmpdir, f'private_{i}.pem')
    
    # Generate 2048-bit RSA private key in PKCS#8 format for SES BYODKIM
    subprocess.run([
        'openssl', 'genpkey', 
        '-algorithm', 'RSA',
        '-pkcs8',
        '-out', private_key_path,
        '-pkeyopt', 'rsa_keygen_bits:2048'
    ], check=True, capture_output=True, text=True)
```

## å®Œäº†æ¸ˆã¿ä½œæ¥­
- âœ… Phase 1-5 CloudFormationã‚¹ã‚¿ãƒƒã‚¯å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤
- âœ… EasyDKIMç„¡åŠ¹åŒ–æˆåŠŸ
- âœ… SSLè¨¼æ˜æ›¸å•é¡Œã®è§£æ±ºï¼ˆ--no-verify-sslï¼‰
- âœ… Lambda Layerã®ç›´æ¥ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- âœ… OpenSSLãƒ™ãƒ¼ã‚¹ã®DKIMå®Ÿè£…ã¸ã®ä¿®æ­£

## æ˜æ—¥ã®ä½œæ¥­äºˆå®š
1. **ä¿®æ­£ã•ã‚ŒãŸLambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
   ```bash
   cd "c:\Users\H3070146\OneDrive - NTT DOCOMO, INC\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\Projects\AWS_SES_BYODKIM"
   source .venv/Scripts/activate
   sceptre update --no-verify-ssl prod/phase7-dev.yaml
   ```

2. **DKIMè¨¼æ˜æ›¸ä½œæˆãƒ†ã‚¹ãƒˆ**
   ```bash
   aws lambda invoke --function-name aws-ses-migration-prod-dkim-manager --payload fileb://create-dkim-dev-payload.json --no-verify-ssl response-create-dkim-dev-new.json
   ```

3. **æˆåŠŸç¢ºèªå¾Œã€æœ¬ç’°å¢ƒã§ã®DKIMè¨¼æ˜æ›¸ä½œæˆ**
   ```bash
   aws lambda invoke --function-name aws-ses-migration-prod-dkim-manager --payload fileb://create-dkim-payload.json --no-verify-ssl response-create-dkim-final.json
   ```

## é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: `sceptre/templates/dkim-manager-lambda.yaml` â†OpenSSLå®Ÿè£…æ¸ˆã¿
- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«**: `sceptre/config/prod/phase7-dev.yaml`
- **ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰**: `create-dkim-dev-payload.json`, `create-dkim-payload.json`
- **Layerä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `scripts/create-layer-direct.sh` â†ã‚‚ã†ä¸è¦

## æŠ€è¡“çš„è©³ç´°
### OpenSSLå®Ÿè£…ã®ç‰¹å¾´
1. **PKCS#8å½¢å¼**: SES BYODKIMè¦ä»¶ã«æº–æ‹ 
2. **2048bit RSA**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨™æº–
3. **DERå½¢å¼å…¬é–‹éµ**: DNS TXTè¨˜éŒ²ç”¨
4. **Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰**: æ­£ã—ã„DKIMå½¢å¼

### SSLå›é¿è¨­å®š
ä¼æ¥­ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®ãŸã‚ã€ã™ã¹ã¦ã®AWS CLIã‚³ãƒãƒ³ãƒ‰ã«`--no-verify-ssl`ãŒå¿…è¦ã€‚

## æ¬¡å›ä½œæ¥­æ™‚ã®ç¢ºèªäº‹é …
1. ãƒ•ã‚¡ã‚¤ãƒ« `sceptre/templates/dkim-manager-lambda.yaml` ã®OpenSSLå®Ÿè£…ãŒæ­£ã—ãæ®‹ã£ã¦ã„ã‚‹ã‹
2. ä»®æƒ³ç’°å¢ƒã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³: `source .venv/Scripts/activate`
3. cryptography Layerã®å‚ç…§ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## ç’°å¢ƒæƒ…å ±
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹**: `c:\Users\H3070146\OneDrive - NTT DOCOMO, INC\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\Projects\AWS_SES_BYODKIM`
- **ãƒ‰ãƒ¡ã‚¤ãƒ³**: goo.ne.jp
- **ç’°å¢ƒ**: prodï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: NTT DOCOMO AWSæœ¬ç•ªã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

## ä½œæ¥­è€…ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
æ˜æ—¥ã¯OpenSSLå®Ÿè£…ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„ã€‚cryptographyãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å•é¡Œã¯å®Œå…¨ã«å›é¿ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

ä½œæ¥­ãŒæˆåŠŸã—ãŸã‚‰ã€æœ€çµ‚çš„ã«Phase 7ã®BYODKIMæœ‰åŠ¹åŒ–ï¼ˆput_email_identity_dkim_signing_attributesï¼‰ã¾ã§å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚

é ‘å¼µã£ã¦ï¼ğŸš€
