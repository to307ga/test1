# è¨¼æ˜Žæ›¸æ›´æ–°ãƒ»DNSé€šçŸ¥ãƒ†ã‚¹ãƒˆã®å®Ÿç¾å¯èƒ½æ€§åˆ†æž

## ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
1. **è¨¼æ˜Žæ›¸ç›£è¦–æ©Ÿèƒ½**: `monitor_certificate_expiration()`é–¢æ•°ãŒå®Ÿè£…æ¸ˆã¿
2. **è‡ªå‹•æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯**: æœ‰åŠ¹æœŸé™å‰ã®è¨¼æ˜Žæ›¸è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ã‚ã‚Š
3. **è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**: 
   - `CertificateValidityDays`: 365æ—¥ï¼ˆè¨¼æ˜Žæ›¸æœ‰åŠ¹æœŸé–“ï¼‰
   - `RenewalAlertDays`: 30æ—¥ï¼ˆæ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ï¼‰

### ç¾åœ¨ã®è¨­å®šå€¤ï¼ˆdevç’°å¢ƒï¼‰
- **è¨¼æ˜Žæ›¸ä½œæˆæ—¥**: 2025-09-09T11:21:15
- **è¨¼æ˜Žæ›¸æœ‰åŠ¹æœŸé™**: 2026-09-09T11:21:15ï¼ˆ365æ—¥å¾Œï¼‰
- **æ›´æ–°é–¾å€¤**: 30æ—¥å‰ï¼ˆ2026-08-10é ƒï¼‰

## ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã®å®Ÿç¾å¯èƒ½æ€§

### âœ… **å®Ÿç¾å¯èƒ½ - è¨­å®šå¤‰æ›´ã®ã¿ã§å¯¾å¿œ**

ã‚ãªãŸãŒå¸Œæœ›ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã¯ã€**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´ã®ã¿ã§å®Ÿç¾å¯èƒ½**ã§ã™ã€‚

### å¿…è¦ãªå¤‰æ›´å†…å®¹

#### 1. è¨¼æ˜Žæ›¸æœ‰åŠ¹æœŸé–“ã®çŸ­ç¸®
**ãƒ•ã‚¡ã‚¤ãƒ«**: `sceptre/config/dev/phase-2-dkim-system.yaml`
```yaml
# ç¾åœ¨ã®è¨­å®š
CertificateValidityDays: 365  # 1 year validity
RenewalAlertDays: 30  # Alert 30 days before expiration

# ãƒ†ã‚¹ãƒˆç”¨è¨­å®šä¾‹
CertificateValidityDays: 2    # 2æ—¥é–“ã®æœ‰åŠ¹æœŸé™
RenewalAlertDays: 1           # 1æ—¥å‰ã«ã‚¢ãƒ©ãƒ¼ãƒˆ
```

#### 2. è‡ªå‹•ç›£è¦–ã®æœ‰åŠ¹åŒ–ï¼ˆEventBridgeè¨­å®šï¼‰
ç¾åœ¨ã¯æ‰‹å‹•å®Ÿè¡Œã®ã¿ãªã®ã§ã€EventBridgeãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## è©³ç´°ãƒ†ã‚¹ãƒˆæ‰‹é †ï¼ˆdev + prodç’°å¢ƒï¼‰

### äº‹å‰æº–å‚™: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´

#### 1. devç’°å¢ƒã®è¨­å®šå¤‰æ›´
**ãƒ•ã‚¡ã‚¤ãƒ«**: `sceptre/config/dev/phase-2-dkim-system.yaml`
```yaml
# å¤‰æ›´å‰
CertificateValidityDays: 365  # 1 year validity
RenewalAlertDays: 30  # Alert 30 days before expiration

# å¤‰æ›´å¾Œ
CertificateValidityDays: 2    # 2æ—¥é–“æœ‰åŠ¹æœŸé™ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
RenewalAlertDays: 1           # 1æ—¥å‰æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
```

#### 2. prodç’°å¢ƒã®è¨­å®šå¤‰æ›´
**ãƒ•ã‚¡ã‚¤ãƒ«**: `sceptre/config/prod/phase-2-dkim-system.yaml`
```yaml
# å¤‰æ›´å‰
CertificateValidityDays: 365  # 1 year validity
RenewalAlertDays: 30  # Alert 30 days before expiration

# å¤‰æ›´å¾Œ
CertificateValidityDays: 2    # 2æ—¥é–“æœ‰åŠ¹æœŸé™ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
RenewalAlertDays: 1           # 1æ—¥å‰æ›´æ–°ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
```

### Phase 1: çŸ­æœŸè¨¼æ˜Žæ›¸ã®ä½œæˆ

#### 1.1 Lambdaé–¢æ•°ã®æ›´æ–°ï¼ˆä¸¡ç’°å¢ƒï¼‰
```bash
# devç’°å¢ƒ
cd /path/to/AWS_SES_BYODKIM/sceptre
uv run sceptre update dev/phase-2-dkim-system.yaml

# prodç’°å¢ƒ
uv run sceptre update prod/phase-2-dkim-system.yaml
```

#### 1.2 çŸ­æœŸè¨¼æ˜Žæ›¸ã®ä½œæˆï¼ˆä¸¡ç’°å¢ƒï¼‰ - **è¤‡æ•°ã®é¸æŠžè‚¢ã‚ã‚Š**

**é¸æŠžè‚¢ã®æ¯”è¼ƒï¼š**

| æ–¹æ³• | æ™‚é–“ | ç¢ºå®Ÿæ€§ | è¤‡é›‘åº¦ | æŽ¨å¥¨åº¦ |
|------|------|--------|--------|--------|
| **D. ã‚¹ã‚¿ãƒƒã‚¯å…¨å†ä½œæˆ** | 30-45åˆ† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜†â˜†â˜† | **æœ€æŽ¨å¥¨** |
| A. Phase-4å®Ÿè¡Œ | 15-20åˆ† | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† | æŽ¨å¥¨ |
| B. ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°ã®ã¿ | 10åˆ† | â˜…â˜†â˜†â˜†â˜† | â˜…â˜†â˜†â˜†â˜† | éžæŽ¨å¥¨ |
| C. Secrets Managerç·¨é›† | 20åˆ† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | éžæŽ¨å¥¨ |

**ãªãœã‚¹ã‚¿ãƒƒã‚¯å…¨å†ä½œæˆãŒæœ€æŽ¨å¥¨ã‹ï¼š**
- æ–°ã—ã„è¨­å®šå€¤ã§æœ€åˆã‹ã‚‰è¨¼æ˜Žæ›¸ä½œæˆ
- è¨­å®šã®ä¸æ•´åˆãŒç™ºç”Ÿã—ãªã„
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã¨ã—ã¦å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹
- Phase-4æ‰‹å‹•å®Ÿè¡ŒãŒä¸è¦

#### é¸æŠžè‚¢D: ã‚¹ã‚¿ãƒƒã‚¯å…¨å†ä½œæˆï¼ˆæœ€æŽ¨å¥¨ï¼‰

```bash
# 1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«å¤‰æ›´
# devç’°å¢ƒè¨­å®š: CertificateValidityDays=2, RenewalAlertDays=1
# prodç’°å¢ƒè¨­å®š: CertificateValidityDays=2, RenewalAlertDays=1

# 2. devç’°å¢ƒã®å…¨ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
uv run sceptre delete dev/monitoring.yaml
uv run sceptre delete dev/security.yaml  
uv run sceptre delete dev/enhanced-kinesis.yaml
uv run sceptre delete dev/phase-8-monitoring-system.yaml
uv run sceptre delete dev/phase-7-dns-validation-dkim-activation.yaml
uv run sceptre delete dev/phase-6-dns-setup.yaml
uv run sceptre delete dev/phase-5-dns-team-collaboration.yaml
uv run sceptre delete dev/phase-4-dns-preparation.yaml
uv run sceptre delete dev/phase-3-ses-byodkim.yaml
uv run sceptre delete dev/phase-2-dkim-system.yaml
uv run sceptre delete dev/phase-1-infrastructure-foundation.yaml

# 3. prodç’°å¢ƒã®å…¨ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤  
uv run sceptre delete prod/monitoring.yaml
uv run sceptre delete prod/security.yaml
uv run sceptre delete prod/enhanced-kinesis.yaml
uv run sceptre delete prod/phase-8-monitoring-system.yaml
uv run sceptre delete prod/phase-7-dns-validation-dkim-activation.yaml
uv run sceptre delete prod/phase-6-dns-setup.yaml
uv run sceptre delete prod/phase-5-dns-team-collaboration.yaml
uv run sceptre delete prod/phase-4-dns-preparation.yaml
uv run sceptre delete prod/phase-3-ses-byodkim.yaml
uv run sceptre delete prod/phase-2-dkim-system.yaml
uv run sceptre delete prod/phase-1-infrastructure-foundation.yaml

# 4. æ–°ã—ã„è¨­å®šã§ã‚¹ã‚¿ãƒƒã‚¯å†ä½œæˆ
# devç’°å¢ƒ
uv run sceptre launch dev/phase-1-infrastructure-foundation.yaml
uv run sceptre launch dev/phase-2-dkim-system.yaml
uv run sceptre launch dev/phase-3-ses-byodkim.yaml
uv run sceptre launch dev/phase-4-dns-preparation.yaml
uv run sceptre launch dev/phase-5-dns-team-collaboration.yaml
uv run sceptre launch dev/phase-6-dns-setup.yaml
uv run sceptre launch dev/phase-7-dns-validation-dkim-activation.yaml
uv run sceptre launch dev/phase-8-monitoring-system.yaml
uv run sceptre launch dev/enhanced-kinesis.yaml
uv run sceptre launch dev/security.yaml
uv run sceptre launch dev/monitoring.yaml

# prodç’°å¢ƒ
uv run sceptre launch prod/phase-1-infrastructure-foundation.yaml
uv run sceptre launch prod/phase-2-dkim-system.yaml
uv run sceptre launch prod/phase-3-ses-byodkim.yaml
uv run sceptre launch prod/phase-4-dns-preparation.yaml
uv run sceptre launch prod/phase-5-dns-team-collaboration.yaml
uv run sceptre launch prod/phase-6-dns-setup.yaml
uv run sceptre launch prod/phase-7-dns-validation-dkim-activation.yaml
uv run sceptre launch prod/phase-8-monitoring-system.yaml
uv run sceptre launch prod/enhanced-kinesis.yaml
uv run sceptre launch prod/security.yaml
uv run sceptre launch prod/monitoring.yaml

# 5. EventBridgeç›£è¦–ãƒ«ãƒ¼ãƒ«è¿½åŠ 
uv run sceptre launch dev/certificate-monitoring.yaml
uv run sceptre launch prod/certificate-monitoring.yaml
```

**âœ… ã“ã®æ–¹æ³•ã®åˆ©ç‚¹ï¼š**
- å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ãƒ†ã‚¹ãƒˆé–‹å§‹
- è¨­å®šå€¤ã®ä¸æ•´åˆãªã—
- Phase-4æ‰‹å‹•å®Ÿè¡Œä¸è¦
- è‡ªå‹•ã§Phase-4ãŒå®Ÿè¡Œã•ã‚Œã¦2æ—¥æœ‰åŠ¹æœŸé™ã®è¨¼æ˜Žæ›¸ä½œæˆ
- DNSé€šçŸ¥ã‚‚è‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹

**âš ï¸ æ³¨æ„ç‚¹ï¼š**
- 30-45åˆ†ç¨‹åº¦ã®æ™‚é–“ãŒå¿…è¦
- æ—¢å­˜ã®S3ãƒ‡ãƒ¼ã‚¿ãƒ»Secrets Managerãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã•ã‚Œã‚‹
- å†ä½œæˆå¾Œã«SNSè³¼èª­ã®å†è¨­å®šãŒå¿…è¦

**devç’°å¢ƒç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ**:
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«: invoke_phase4_test_dev.py
cat > invoke_phase4_test_dev.py << 'EOF'
#!/usr/bin/env python3
import boto3
import json

lambda_client = boto3.client('lambda', region_name='ap-northeast-1')

payload = {
    "action": "phase_manager",
    "phase": "4",
    "domain": "goo.ne.jp",
    "environment": "dev",
    "projectName": "aws-ses-migration",
    "dkimSeparator": "gooid-21-dev"
}

print("Creating short-term certificate for DEV environment...")
try:
    response = lambda_client.invoke(
        FunctionName='aws-ses-migration-dev-dkim-manager',
        Payload=json.dumps(payload)
    )
    
    response_payload = response['Payload'].read()
    result = json.loads(response_payload)
    
    print("DEV Response:")
    print(json.dumps(result, indent=2))
    
    with open('response-dev-phase4-test.json', 'w') as f:
        json.dump(result, f, indent=2)
    
    print("Response saved to response-dev-phase4-test.json")
    
except Exception as e:
    print(f"Error: {e}")
EOF

uv run python invoke_phase4_test_dev.py
```

**prodç’°å¢ƒç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ**:
```bash
# ãƒ•ã‚¡ã‚¤ãƒ«: invoke_phase4_test_prod.py
cat > invoke_phase4_test_prod.py << 'EOF'
#!/usr/bin/env python3
import boto3
import json

lambda_client = boto3.client('lambda', region_name='ap-northeast-1')

payload = {
    "action": "phase_manager",
    "phase": "4",
    "domain": "goo.ne.jp",
    "environment": "prod",
    "projectName": "aws-ses-migration",
    "dkimSeparator": "gooid-21-pro"
}

print("Creating short-term certificate for PROD environment...")
try:
    response = lambda_client.invoke(
        FunctionName='aws-ses-migration-prod-dkim-manager',
        Payload=json.dumps(payload)
    )
    
    response_payload = response['Payload'].read()
    result = json.loads(response_payload)
    
    print("PROD Response:")
    print(json.dumps(result, indent=2))
    
    with open('response-prod-phase4-test.json', 'w') as f:
        json.dump(result, f, indent=2)
    
    print("Response saved to response-prod-phase4-test.json")
    
except Exception as e:
    print(f"Error: {e}")
EOF

uv run python invoke_phase4_test_prod.py
```

#### é¸æŠžè‚¢B: ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°ã®ã¿ï¼ˆPhase-4ã‚¹ã‚­ãƒƒãƒ—ï¼‰

```bash
# Lambdaé–¢æ•°ã®æ›´æ–°ã®ã¿å®Ÿè¡Œ
# devç’°å¢ƒ
uv run sceptre update dev/phase-2-dkim-system.yaml

# prodç’°å¢ƒ  
uv run sceptre update prod/phase-2-dkim-system.yaml

# æ³¨æ„: æ—¢å­˜è¨¼æ˜Žæ›¸ã¯365æ—¥æœ‰åŠ¹ã®ãŸã‚ã€å³åº§ã®ãƒ†ã‚¹ãƒˆã¯ä¸å¯
# EventBridgeè¨­å®šå¾Œã€æ‰‹å‹•ã§monitor_certificateå®Ÿè¡Œã—ã¦å‹•ä½œç¢ºèªã®ã¿å¯èƒ½
```

#### é¸æŠžè‚¢C: Secrets Managerç›´æŽ¥ç·¨é›†ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰

```bash
# ç¾åœ¨ã®è¨¼æ˜Žæ›¸æœŸé™ã‚’ç¢ºèª
aws secretsmanager get-secret-value \
  --secret-id "aws-ses-migration/dev/dkim-config" \
  --region ap-northeast-1

# expires_atã‚’æ‰‹å‹•ã§æ˜Žæ—¥ã®æ—¥ä»˜ã«å¤‰æ›´
# WARNING: é«˜åº¦ãªæ“ä½œã®ãŸã‚æŽ¨å¥¨ã—ã¾ã›ã‚“
```

**ðŸŽ¯ æŽ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: é¸æŠžè‚¢Aï¼ˆPhase-4å®Ÿè¡Œï¼‰**
- å®Œå…¨ãªãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¯èƒ½
- æ–°ã—ã„è¨­å®šå€¤ã§ã®è¨¼æ˜Žæ›¸ä½œæˆç¢ºèª
- DNSé€šçŸ¥æ©Ÿèƒ½ã‚‚åŒæ™‚ã«ãƒ†ã‚¹ãƒˆ

### Phase 2: è‡ªå‹•ç›£è¦–ã®è¨­å®šï¼ˆEventBridgeãƒ«ãƒ¼ãƒ«è¿½åŠ ï¼‰

**ãªãœEventBridgeãŒå¿…è¦ã‹ï¼Ÿ**
ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã¯æ‰‹å‹•å®Ÿè¡Œã®ã¿ã«å¯¾å¿œã—ã¦ãŠã‚Šã€å®šæœŸçš„ãªè‡ªå‹•ç›£è¦–æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨¼æ˜Žæ›¸ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã«ã¯ã€EventBridgeãƒ«ãƒ¼ãƒ«ã§Lambdaé–¢æ•°ã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

#### 2.1 EventBridgeãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `sceptre/templates_dev/certificate-monitoring.yaml`
```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: 'DKIM Certificate Monitoring with EventBridge'

Parameters:
  ProjectName:
    Type: String
    Description: Project name
  Environment:
    Type: String
    Description: Environment name
  DKIMManagerFunctionArn:
    Type: String
    Description: ARN of the DKIM Manager Lambda function

Resources:
  # EventBridge Rule for daily certificate monitoring
  DKIMCertificateMonitoringRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub "${ProjectName}-${Environment}-certificate-monitoring"
      Description: "Daily DKIM certificate expiration monitoring"
      ScheduleExpression: "cron(0 12 * * ? *)"  # æ¯Žæ—¥12:00 UTC (21:00 JST)
      State: ENABLED
      Targets:
        - Arn: !Ref DKIMManagerFunctionArn
          Id: "DKIMMonitoringTarget"
          Input: |
            {
              "action": "monitor_certificate"
            }

  # Lambda permission for EventBridge
  DKIMMonitoringLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref DKIMManagerFunctionArn
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt DKIMCertificateMonitoringRule.Arn

Outputs:
  MonitoringRuleArn:
    Description: ARN of the certificate monitoring rule
    Value: !GetAtt DKIMCertificateMonitoringRule.Arn
    Export:
      Name: !Sub "${ProjectName}-${Environment}-monitoring-rule-arn"
```

**prodç’°å¢ƒç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: `sceptre/templates/certificate-monitoring.yaml`
ï¼ˆä¸Šè¨˜ã¨åŒã˜å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼‰

#### 2.2 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**devç’°å¢ƒç”¨**: `sceptre/config/dev/certificate-monitoring.yaml`
```yaml
template:
  type: file
  path: ../templates_dev/certificate-monitoring.yaml

dependencies:
  - dev/phase-2-dkim-system.yaml

parameters:
  ProjectName: !stack_output dev/phase-1-infrastructure-foundation.yaml::ProjectName
  Environment: !stack_output dev/phase-1-infrastructure-foundation.yaml::Environment
  DKIMManagerFunctionArn: !stack_output dev/phase-2-dkim-system.yaml::DKIMManagerFunctionArn

tags:
  Phase: "monitoring"
  Purpose: "Certificate monitoring"
  Environment: dev
```

**prodç’°å¢ƒç”¨**: `sceptre/config/prod/certificate-monitoring.yaml`
```yaml
template:
  type: file
  path: certificate-monitoring.yaml

dependencies:
  - prod/phase-2-dkim-system.yaml

parameters:
  ProjectName: !stack_output prod/phase-1-infrastructure-foundation.yaml::ProjectName
  Environment: !stack_output prod/phase-1-infrastructure-foundation.yaml::Environment
  DKIMManagerFunctionArn: !stack_output prod/phase-2-dkim-system.yaml::DKIMManagerFunctionArn

tags:
  Phase: "monitoring"
  Purpose: "Certificate monitoring"
  Environment: prod
```

#### 2.3 EventBridgeãƒ«ãƒ¼ãƒ«ã®ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# devç’°å¢ƒ
uv run sceptre launch dev/certificate-monitoring.yaml

# prodç’°å¢ƒ
uv run sceptre launch prod/certificate-monitoring.yaml
```

### Phase 3: æ¤œè¨¼å®Ÿè¡Œ

**ãªãœæ‰‹å‹•å®Ÿè¡ŒãŒå¿…è¦ã‹ï¼Ÿ**
EventBridgeãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ã‚‚ã€ä»¥ä¸‹ã®ç†ç”±ã§æ‰‹å‹•æ¤œè¨¼ãŒé‡è¦ã§ã™ï¼š

1. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ**: EventBridgeã¯æ¯Žæ—¥12:00 UTCã«å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ããªã„
2. **å³åº§ã®æ¤œè¨¼**: è¨­å®šãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ã‚’å¾…ãŸãšã«ç¢ºèªã—ãŸã„
3. **ãƒ‡ãƒãƒƒã‚°ã®å¿…è¦æ€§**: å•é¡ŒãŒã‚ã£ãŸå ´åˆã€ãƒ­ã‚°ã‚’å³åº§ã«ç¢ºèªã—ã¦ä¿®æ­£ã—ãŸã„
4. **è¨¼æ˜Žæ›¸æœŸé™ã®ç¢ºèª**: 2æ—¥å¾Œã®è‡ªå‹•å®Ÿè¡Œã‚’å¾…ãŸãšã€ç¾åœ¨ã®æœŸé™ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’æ¤œè¨¼ã—ãŸã„

#### 3.1 è¨¼æ˜Žæ›¸æœŸé™ã®ç¢ºèª
```bash
# devç’°å¢ƒã®è¨¼æ˜Žæ›¸æœŸé™ç¢ºèª
aws secretsmanager get-secret-value \
  --secret-id "aws-ses-migration/dev/dkim-config" \
  --region ap-northeast-1 \
  --query SecretString --output text | \
  grep -E "expires_at|created_at"

# prodç’°å¢ƒã®è¨¼æ˜Žæ›¸æœŸé™ç¢ºèª
aws secretsmanager get-secret-value \
  --secret-id "aws-ses-migration/prod/dkim-config" \
  --region ap-northeast-1 \
  --query SecretString --output text | \
  grep -E "expires_at|created_at"
```

#### 3.2 æ‰‹å‹•ç›£è¦–å®Ÿè¡Œï¼ˆè¨¼æ˜Žæ›¸æœŸé™ãƒã‚§ãƒƒã‚¯ï¼‰
```bash
# devç’°å¢ƒã®ç›£è¦–å®Ÿè¡Œ
cat > monitor_test_dev.py << 'EOF'
#!/usr/bin/env python3
import boto3
import json

lambda_client = boto3.client('lambda', region_name='ap-northeast-1')

payload = {
    "action": "monitor_certificate"
}

print("Testing certificate monitoring for DEV environment...")
try:
    response = lambda_client.invoke(
        FunctionName='aws-ses-migration-dev-dkim-manager',
        Payload=json.dumps(payload)
    )
    
    response_payload = response['Payload'].read()
    result = json.loads(response_payload)
    
    print("DEV Monitoring Response:")
    print(json.dumps(result, indent=2))
    
    with open('response-dev-monitoring-test.json', 'w') as f:
        json.dump(result, f, indent=2)
    
    print("Response saved to response-dev-monitoring-test.json")
    
except Exception as e:
    print(f"Error: {e}")
EOF

uv run python monitor_test_dev.py

# prodç’°å¢ƒã®ç›£è¦–å®Ÿè¡Œ
cat > monitor_test_prod.py << 'EOF'
#!/usr/bin/env python3
import boto3
import json

lambda_client = boto3.client('lambda', region_name='ap-northeast-1')

payload = {
    "action": "monitor_certificate"
}

print("Testing certificate monitoring for PROD environment...")
try:
    response = lambda_client.invoke(
        FunctionName='aws-ses-migration-prod-dkim-manager',
        Payload=json.dumps(payload)
    )
    
    response_payload = response['Payload'].read()
    result = json.loads(response_payload)
    
    print("PROD Monitoring Response:")
    print(json.dumps(result, indent=2))
    
    with open('response-prod-monitoring-test.json', 'w') as f:
        json.dump(result, f, indent=2)
    
    print("Response saved to response-prod-monitoring-test.json")
    
except Exception as e:
    print(f"Error: {e}")
EOF

uv run python monitor_test_prod.py
```

#### 3.3 EventBridgeè‡ªå‹•å®Ÿè¡Œã®ç¢ºèª
```bash
# EventBridgeãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
aws events list-rules \
  --name-prefix "aws-ses-migration" \
  --region ap-northeast-1

# Lambdaé–¢æ•°ã®CloudWatchãƒ­ã‚°ã‚’ç¢ºèªï¼ˆè‡ªå‹•å®Ÿè¡Œã®ãƒ­ã‚°ï¼‰
aws logs describe-log-groups \
  --log-group-name-prefix "/aws/lambda/aws-ses-migration" \
  --region ap-northeast-1
```

#### 3.4 1æ—¥å¾Œã®è‡ªå‹•æ›´æ–°ãƒ†ã‚¹ãƒˆ
**1æ—¥å¾Œï¼ˆRenewalAlertDaysã®é–¾å€¤ï¼‰ã«è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ï¼š**
```bash
# 1æ—¥å¾Œã®ãƒ­ã‚°ç¢ºèª
aws logs get-log-events \
  --log-group-name "/aws/lambda/aws-ses-migration-dev-dkim-manager" \
  --log-stream-name "æœ€æ–°ã®ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ å" \
  --region ap-northeast-1

aws logs get-log-events \
  --log-group-name "/aws/lambda/aws-ses-migration-prod-dkim-manager" \
  --log-stream-name "æœ€æ–°ã®ãƒ­ã‚°ã‚¹ãƒˆãƒªãƒ¼ãƒ å" \
  --region ap-northeast-1
```

## ä¿®æ­£é›£æ˜“åº¦

### ðŸŸ¢ **ä½Žé›£æ˜“åº¦ï¼ˆæŽ¨å¥¨ï¼‰**
**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´ + EventBridgeè¿½åŠ **
- **æ™‚é–“**: 1-2æ™‚é–“
- **ãƒªã‚¹ã‚¯**: ä½Ž
- **ä½œæ¥­å†…å®¹**:
  1. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´
  2. EventBridgeãƒ«ãƒ¼ãƒ«ã®è¿½åŠ 
  3. Lambdaé–¢æ•°ã®æ›´æ–°

### ðŸŸ¡ **ä¸­é›£æ˜“åº¦ï¼ˆä»£æ›¿æ¡ˆï¼‰**
**ãƒ†ã‚¹ãƒˆå°‚ç”¨ç’°å¢ƒã®æ§‹ç¯‰**
- **æ™‚é–“**: 4-6æ™‚é–“
- **ãƒªã‚¹ã‚¯**: ä¸­
- **ä½œæ¥­å†…å®¹**:
  1. testç’°å¢ƒç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
  2. ç‹¬ç«‹ã—ãŸã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  3. ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®è¨­å®šå€¤é©ç”¨

## ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹æ¡ä»¶

```python
# monitor_certificate_expiration()é–¢æ•°ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
days_until_expiration = (expires_at - current_time).days
renewal_alert_days = int(os.environ.get('RENEWAL_ALERT_DAYS', 30))

if days_until_expiration <= renewal_alert_days:
    # è‡ªå‹•æ›´æ–°å®Ÿè¡Œ
    renewal_result = create_dkim_certificate(secret_arn, bucket_name, dkim_separator)
    # DNSé€šçŸ¥ã¯ create_dkim_certificate å†…ã§è‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹
```

## DNSé€šçŸ¥ã®è‡ªå‹•åŒ–ç¢ºèª

è¨¼æ˜Žæ›¸æ›´æ–°æ™‚ã®DNSé€šçŸ¥ã¯ **æ—¢ã«å®Ÿè£…æ¸ˆã¿** ã§ã™ï¼š
- `create_dkim_certificate()`é–¢æ•°å†…ã§S3ä¿å­˜ã¨Secrets Manageræ›´æ–°
- Phase-5ã®`execute_phase_5()`ãŒDNSé€šçŸ¥ã‚’é€ä¿¡
- æ›´æ–°æ™‚ã«æ–°ã—ã„DNSãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹

## æŽ¨å¥¨å®Ÿè£…ãƒ—ãƒ©ãƒ³

### å³æ™‚å®Ÿè£…å¯èƒ½ï¼ˆä»Šæ—¥ä¸­ï¼‰
1. **è¨­å®šå¤‰æ›´**: CertificateValidityDays=2, RenewalAlertDays=1
2. **æ–°è¨¼æ˜Žæ›¸ä½œæˆ**: Phase-4ã®å†å®Ÿè¡Œ
3. **æ‰‹å‹•ç›£è¦–ãƒ†ã‚¹ãƒˆ**: monitor_certificate_expiration ã®å®Ÿè¡Œ

### æ¬¡å›žå®Ÿè£…ï¼ˆæ˜Žæ—¥ä»¥é™ï¼‰
1. **EventBridgeè¿½åŠ **: è‡ªå‹•Dailyå®Ÿè¡Œã®è¨­å®š
2. **å®Œå…¨è‡ªå‹•åŒ–ãƒ†ã‚¹ãƒˆ**: æ”¾ç½®ãƒ†ã‚¹ãƒˆã§è‡ªå‹•æ›´æ–°ç¢ºèª

## çµè«–

âœ… **å®Ÿç¾å¯èƒ½æ€§**: é«˜  
âœ… **ä¿®æ­£é›£æ˜“åº¦**: ä½Ž  
âœ… **å¿…è¦ãªå¤‰æ›´**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´ + EventBridgeè¿½åŠ ã®ã¿  
âœ… **ãƒ†ã‚¹ãƒˆæœŸé–“**: 2æ—¥é–“ã§å®Œäº†  

ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã¯è¨¼æ˜Žæ›¸æ›´æ–°ãƒ»DNSé€šçŸ¥æ©Ÿèƒ½ãŒæ—¢ã«å®Ÿè£…æ¸ˆã¿ãªã®ã§ã€è¨­å®šå€¤ã®å¤‰æ›´ã ã‘ã§å¸Œæœ›ã•ã‚Œã¦ã„ã‚‹ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

---
**æŽ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¤‰æ›´ã«ã‚ˆã‚‹ä½Žãƒªã‚¹ã‚¯ãƒ†ã‚¹ãƒˆã‹ã‚‰é–‹å§‹
**å®Œäº†äºˆæƒ³æ™‚é–“**: è¨­å®šå¤‰æ›´ 30åˆ† + 2æ—¥é–“ã®æ¤œè¨¼æœŸé–“

## 2æ—¥é–“ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

### ä»Šæ—¥ï¼ˆ9/10ï¼‰
- âœ… è¨­å®šå¤‰æ›´ï¼ˆCertificateValidityDays=2, RenewalAlertDays=1ï¼‰
- âœ… Lambdaé–¢æ•°æ›´æ–°
- âœ… çŸ­æœŸè¨¼æ˜Žæ›¸ä½œæˆï¼ˆPhase-4å®Ÿè¡Œï¼‰
- âœ… EventBridgeè¨­å®š
- âœ… æ‰‹å‹•ç›£è¦–ãƒ†ã‚¹ãƒˆ

### æ˜Žæ—¥ï¼ˆ9/11ï¼‰
- ðŸ”„ EventBridgeè‡ªå‹•å®Ÿè¡Œï¼ˆæ¯Žæ—¥21:00 JSTï¼‰
- ðŸ”„ **è‡ªå‹•æ›´æ–°å®Ÿè¡Œ**ï¼ˆRenewalAlertDays=1é–¾å€¤åˆ°é”ï¼‰
- ðŸ”„ DNSé€šçŸ¥è‡ªå‹•é€ä¿¡
- âœ… ãƒ­ã‚°ç¢ºèªãƒ»æ¤œè¨¼

### æ˜Žå¾Œæ—¥ï¼ˆ9/12ï¼‰
- âœ… è¨¼æ˜Žæ›¸æœŸé™åˆ°é”ç¢ºèª
- âœ… å®Œå…¨ãƒ†ã‚¹ãƒˆå®Œäº†

## 2æ—¥è¨­å®šã®åˆ©ç‚¹

âœ… **è¿…é€Ÿãªãƒ†ã‚¹ãƒˆ**: 1æ—¥ã§è‡ªå‹•æ›´æ–°å®Œäº†  
âœ… **å®Œå…¨æ¤œè¨¼**: è¨­å®šâ†’æ›´æ–°â†’æœŸé™åˆ‡ã‚Œã®å…¨ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª  

## å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¯”è¼ƒè¡¨

| é …ç›® | é¸æŠžè‚¢A: Phase-4å®Ÿè¡Œ | é¸æŠžè‚¢B: è¨­å®šæ›´æ–°ï¼‹æ‰‹å‹•å®Ÿè¡Œ | é¸æŠžè‚¢C: EventBridgeå®Ÿè£… | é¸æŠžè‚¢D: ã‚¹ã‚¿ãƒƒã‚¯å…¨å†ä½œæˆï¼ˆæœ€æŽ¨å¥¨ï¼‰ |
|------|---------------------|-------------------------|-------------------------|----------------------------------|
| å®Ÿè£…é›£æ˜“åº¦ | ðŸŸ¡ ä¸­ | ðŸ”´ é«˜ | ðŸ”´ é«˜ | ðŸŸ¢ ä½Ž |
| æ‰€è¦æ™‚é–“ | 15-20åˆ† | 25-30åˆ† | 25-30åˆ† | 30-45åˆ† |
| ä¿¡é ¼æ€§ | ðŸŸ¡ ä¸­ | ðŸ”´ ä½Ž | ðŸŸ¢ é«˜ | ðŸŸ¢ é«˜ |
| è‡ªå‹•åŒ–åº¦ | ðŸ”´ ä½Ž | ðŸ”´ ä½Ž | ðŸŸ¢ é«˜ | ðŸŸ¢ é«˜ |
| è¨­å®šæ•´åˆæ€§ | ðŸ”´ æ³¨æ„è¦ | ðŸ”´ æ³¨æ„è¦ | ðŸŸ¡ è¦ç¢ºèª | ðŸŸ¢ ä¿è¨¼ |
| ãƒªã‚¹ã‚¯ | ä½Ž | ä¸­ | ä½Ž | ä½Ž |

## æœ€çµ‚æŽ¨å¥¨äº‹é …

**é¸æŠžè‚¢D: ã‚¹ã‚¿ãƒƒã‚¯å…¨å†ä½œæˆ**ãŒæœ€ã‚‚ç¢ºå®Ÿã§ç°¡æ½”ãªæ–¹æ³•ã§ã™ã€‚

### ç†ç”±ï¼š
1. **è¨­å®šæ•´åˆæ€§ä¿è¨¼**: æ–°è¨­å®šã§å®Œå…¨ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¹ã‚¿ãƒ¼ãƒˆ
2. **è‡ªå‹•å®Ÿè¡Œ**: Phase-4ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¦2æ—¥è¨¼æ˜Žæ›¸ãŒä½œæˆã•ã‚Œã‚‹
3. **DNSé€šçŸ¥è‡ªå‹•é€ä¿¡**: Phase-5ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¦DNSé€šçŸ¥é€ä¿¡
4. **EventBridgeç›£è¦–**: æœ€å¾Œã«è¿½åŠ ã™ã‚Œã°è‡ªå‹•ç›£è¦–é–‹å§‹
5. **ãƒˆãƒ©ãƒ–ãƒ«å›žé¿**: æ—¢å­˜è¨­å®šã¨ã®ä¸æ•´åˆã‚’å®Œå…¨ã«å›žé¿

### âš ï¸ **æ³¨æ„ï¼šå‰Šé™¤æ™‚ã®æ®‹å­˜ãƒªã‚¹ã‚¯ãƒªã‚½ãƒ¼ã‚¹**
- **EventBridgeãƒ«ãƒ¼ãƒ«**: ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤å¾Œã‚‚æ®‹å­˜ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
- **S3ãƒã‚±ãƒƒãƒˆå†…å®¹**: æ‰‹å‹•ã§ç©ºã«ã™ã‚‹å¿…è¦ã‚ã‚Š
- **Secrets Manager**: å¼·åˆ¶å‰Šé™¤ãŒå¿…è¦ãªå ´åˆã‚ã‚Š

è©³ç´°ã¯ `ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤æ™‚ã®æ®‹å­˜ãƒªã‚¹ã‚¯ãƒªã‚½ãƒ¼ã‚¹åˆ†æž.md` ã‚’å‚ç…§ã€‚

### å®Ÿè¡Œæ™‚é–“ï¼š
- **å‰Šé™¤**: 15åˆ†
- **æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹æ‰‹å‹•å‰Šé™¤**: 10-15åˆ†
- **å†ä½œæˆ**: 25-30åˆ†  
- **EventBridgeè¿½åŠ **: 5åˆ†
- **åˆè¨ˆ**: 55-65åˆ†  
âœ… **ä½Žãƒªã‚¹ã‚¯**: çŸ­æœŸé–“ãƒ†ã‚¹ãƒˆã§æœ¬ç•ªå½±éŸ¿æœ€å°  
âœ… **å®Ÿç”¨çš„**: å®Ÿéš›ã®é‹ç”¨ãƒ—ãƒ­ã‚»ã‚¹ã‚’çŸ­æœŸé–“ã§æ¤œè¨¼
