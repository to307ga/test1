# ä½œæ¥­å†é–‹ãƒ¡ãƒ¢_20250918.md

## ä½œæ¥­æ—¥
- **é–‹å§‹æ—¥**: 2025å¹´9æœˆ17æ—¥
- **çµ‚äº†æ—¥**: 2025å¹´9æœˆ17æ—¥  
- **ä½œæ¥­æ™‚é–“**: ç´„2æ™‚é–“

## æœ¬æ—¥ã®ä½œæ¥­å®Œäº†å†…å®¹

### 1. âœ… v2ã‚·ã‚¹ãƒ†ãƒ ã«SNSçµ±åˆæ©Ÿèƒ½ã‚’è¿½åŠ å®Œäº†
**å®Ÿæ–½å†…å®¹:**
- `dkim-manager-lambda-v2-clean.yaml`ã«Phase 8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®SNSçµ±åˆæ©Ÿèƒ½ã‚’è¿½åŠ 
- v1ã‹ã‚‰ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’ç§»æ¤:
  - SNSãƒ¬ã‚³ãƒ¼ãƒ‰å—ä¿¡å‡¦ç† (`Records` ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†)
  - è¨¼æ˜æ›¸æœŸé™åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆè‡ªå‹•å—ä¿¡ (`certificate_expiring`)
  - SNSãƒˆãƒªã‚¬ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•è¨¼æ˜æ›¸æ›´æ–°æ©Ÿèƒ½
- SNS Lambdaæ¨©é™ã‚’è¿½åŠ  (`DKIMManagerSNSInvokePermissionV2`)

**æŠ€è¡“è©³ç´°:**
```yaml
# è¿½åŠ ã—ãŸä¸»è¦æ©Ÿèƒ½
if 'Records' in event and event['Records']:
    for record in event['Records']:
        if record.get('EventSource') == 'aws:sns':
            sns_message = json.loads(record['Sns']['Message'])
            if sns_message.get('alert_type') == 'certificate_expiring':
                # è‡ªå‹•è¨¼æ˜æ›¸æ›´æ–°å‡¦ç†å®Ÿè¡Œ
```

### 2. âœ… ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†
**å®Ÿæ–½å†…å®¹:**
- v2ã‚·ã‚¹ãƒ†ãƒ ï¼ˆSNSçµ±åˆç‰ˆï¼‰ã‚’æ­£å¸¸ãƒ‡ãƒ—ãƒ­ã‚¤
- v1ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ1,089è¡Œï¼‰ã‚’å®Œå…¨å‰Šé™¤
- ä¾å­˜é–¢ä¿‚ã®ã‚ã‚‹Phase 3-8ã€Securityã‚¹ã‚¿ãƒƒã‚¯ã‚‚æ¸…æƒå®Œäº†
- `security.yaml`ã®ä¾å­˜é–¢ä¿‚ã‚’Phase 8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã«æ›´æ–°

**å‰Šé™¤ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒã‚¯:**
- `prod/phase-2-dkim-system` (v1 - å‰Šé™¤æ¸ˆã¿)
- `prod/phase-3-ses-byodkim` (å‰Šé™¤æ¸ˆã¿)
- `prod/phase-4-dns-preparation` (å‰Šé™¤æ¸ˆã¿)
- `prod/phase-5-dns-team-collaboration` (å‰Šé™¤æ¸ˆã¿)
- `prod/phase-7-dns-validation-dkim-activation` (å‰Šé™¤æ¸ˆã¿)
- `prod/security` (å‰Šé™¤æ¸ˆã¿)

### 3. âœ… çµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèªå®Œäº†
**ç¢ºèªçµæœ:**
- v2ã‚·ã‚¹ãƒ†ãƒ Lambdaé–¢æ•°å: `aws-ses-migration-prod-dkim-manager-v2`
- OpenSSLãƒ†ã‚¹ãƒˆæˆåŠŸ: `OpenSSL 3.2.2 4 Jun 2024`
- Phase 8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®SNSçµ±åˆæº–å‚™å®Œäº†

## ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ã‚¿ãƒƒã‚¯
```
prod/base                                    âœ… UPDATE_COMPLETE
prod/phase-1-infrastructure-foundation       âœ… CREATE_COMPLETE
prod/enhanced-kinesis                        âœ… CREATE_COMPLETE
prod/phase-2-dkim-system-v2                 âœ… UPDATE_COMPLETE (çµ±åˆç‰ˆ)
```

### çµ±åˆæ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
1. **Phase 2 DKIM Manager V2 çµ±åˆç‰ˆ**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `sceptre/templates/dkim-manager-lambda-v2-clean.yaml`
   - æ©Ÿèƒ½: AWSå…¬å¼OpenSSLå®Ÿè£… + Phase 8 SNSçµ±åˆ
   - è¡Œæ•°: 585è¡Œï¼ˆv1: 1,089è¡Œã‹ã‚‰æœ€é©åŒ–ï¼‰

2. **Phase 8 Monitoring çµ±åˆç‰ˆ**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `sceptre/templates/phase-8-monitoring.yaml`  
   - æ©Ÿèƒ½: çµ±åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ7ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„æ¸ˆã¿ï¼‰
   - ç›£è¦–ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«: **æ¯æ—¥9æ™‚** (æœˆæ¬¡ã‹ã‚‰å¤‰æ›´æ¸ˆã¿)

## æ˜æ—¥ï¼ˆ2025å¹´9æœˆ18æ—¥ï¼‰ã®ä½œæ¥­è¨ˆç”»

### ğŸ¯ ä¸»è¦ç›®æ¨™
**æœ‰åŠ¹æœŸé™2æ—¥ã®è¨¼æ˜æ›¸ã§è‡ªå‹•æ›´æ–°ãƒ•ãƒ­ãƒ¼ã®å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿç¾**
- è¨¼æ˜æ›¸ä½œæˆ â†’ 1æ—¥å¾Œã‚¢ãƒ©ãƒ¼ãƒˆ â†’ è‡ªå‹•æ›´æ–° â†’ é€šçŸ¥ç¢ºèª

### ğŸ“‹ æ˜æ—¥ã®ä½œæ¥­æ‰‹é †

#### Phase 1: ç’°å¢ƒãƒªã‚»ãƒƒãƒˆã¨ãƒ™ãƒ¼ã‚¹æ§‹ç¯‰ (30åˆ†)
1. **æ—¢å­˜ã‚¹ã‚¿ãƒƒã‚¯å®Œå…¨å‰Šé™¤**
   ```bash
   cd /c/Temp/AWS_SES_BYODKIM/sceptre
   uv run sceptre delete prod --yes  # å…¨ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
   ```

2. **æ‰‹é †æ›¸ã«åŸºã¥ãæ®µéšçš„æ§‹ç¯‰**
   ```bash
   # Phase 1: ã‚¤ãƒ³ãƒ•ãƒ©åŸºç›¤
   uv run sceptre launch prod/phase-1-infrastructure-foundation.yaml --yes
   
   # Phase 2: DKIM Manager V2 (çµ±åˆç‰ˆ)  
   uv run sceptre launch prod/phase-2-dkim-system-v2.yaml --yes
   ```

#### Phase 2: ãƒ†ã‚¹ãƒˆç”¨è¨¼æ˜æ›¸è¨­å®š (30åˆ†)
3. **çŸ­æœŸé–“è¨¼æ˜æ›¸ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š**
   - `phase-2-dkim-system-v2.yaml`è¨­å®šç¢ºèª:
     ```yaml
     CertificateValidityDays: 2    # 2æ—¥é–“æœ‰åŠ¹æœŸé™
     RenewalAlertDays: 1          # 1æ—¥å‰ã«ã‚¢ãƒ©ãƒ¼ãƒˆ
     ```

4. **åˆå›è¨¼æ˜æ›¸ä½œæˆ**
   ```bash
   # ãƒ†ã‚¹ãƒˆç”¨è¨¼æ˜æ›¸ä½œæˆ
   aws lambda invoke --function-name aws-ses-migration-prod-dkim-manager-v2 \
     --cli-binary-format raw-in-base64-out \
     --payload file://test-v2-certificate-creation.json \
     response-initial-certificate.json
   ```

#### Phase 3: Phase 8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰ã¨é€£æº (45åˆ†)
5. **Phase 8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ å†æ§‹ç¯‰**
   ```bash
   # Phase 8: çµ±åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  (æ¯æ—¥9æ™‚å®Ÿè¡Œ)
   uv run sceptre launch prod/phase-8-monitoring.yaml --yes
   ```

6. **SNSçµ±åˆãƒ†ã‚¹ãƒˆ**
   - Phase 8ã‹ã‚‰v2ã¸ã®SNSé€šçŸ¥ç¢ºèª
   - EventBridgeâ†’SNSâ†’Lambda v2ã®çµŒè·¯ç¢ºèª

#### Phase 4: è‡ªå‹•æ›´æ–°ãƒ•ãƒ­ãƒ¼å®Ÿè¨¼ (45åˆ†)
7. **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ**
   - è¨¼æ˜æ›¸ã®æœŸé™åˆ‡ã‚Œ1æ—¥å‰ã«ãªã‚‹ã¾ã§å¾…æ©Ÿï¼ˆã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—èª¿æ•´ï¼‰
   - Phase 8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«ç¢ºèª
   - v2ã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå‹•è¨¼æ˜æ›¸æ›´æ–°ç¢ºèª

8. **å®Œå…¨ãƒ•ãƒ­ãƒ¼ç¢ºèª**
   - æ–°ã—ã„è¨¼æ˜æ›¸ã®ç”Ÿæˆç¢ºèª
   - DNSé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèª  
   - S3ã¸ã®è¨¼æ˜æ›¸ä¿å­˜ç¢ºèª

### ğŸ›  ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™
```json
// test-v2-certificate-creation.json
{
  "action": "create_dkim_certificate",
  "domain": "goo.ne.jp", 
  "environment": "prod",
  "project_name": "aws-ses-migration",
  "certificate_validity_days": 2,
  "triggered_by": "manual_test"
}

// test-sns-trigger.json  
{
  "Records": [{
    "EventSource": "aws:sns",
    "Sns": {
      "Message": "{\"alert_type\": \"certificate_expiring\", \"domain\": \"goo.ne.jp\", \"environment\": \"prod\", \"project_name\": \"aws-ses-migration\"}"
    }
  }]
}
```

### ğŸ“Š æˆåŠŸåˆ¤å®šåŸºæº–
- [ ] 2æ—¥æœ‰åŠ¹æœŸé™ã®è¨¼æ˜æ›¸ãŒæ­£å¸¸ä½œæˆã•ã‚Œã‚‹
- [ ] 1æ—¥å¾Œã«Phase 8ã‹ã‚‰æœŸé™åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç«ã•ã‚Œã‚‹  
- [ ] SNSçµŒç”±ã§v2ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹
- [ ] æ–°ã—ã„è¨¼æ˜æ›¸ãŒç”Ÿæˆã•ã‚Œã€DNSãƒãƒ¼ãƒ ã«é€šçŸ¥ã•ã‚Œã‚‹
- [ ] å…¨ãƒ—ãƒ­ã‚»ã‚¹ãŒCloudWatchãƒ­ã‚°ã§è¿½è·¡å¯èƒ½ã§ã‚ã‚‹

### ğŸš¨ æ³¨æ„äº‹é …
1. **å®Ÿéš›ã®è¨¼æ˜æ›¸æœŸé™å¾…ã¡**: 2æ—¥é–“è¨¼æ˜æ›¸ã®å ´åˆã€å®Ÿéš›ã«ã‚¢ãƒ©ãƒ¼ãƒˆã¾ã§24æ™‚é–“å¿…è¦
2. **ä»£æ›¿ãƒ†ã‚¹ãƒˆæ–¹æ³•**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ“ä½œã¾ãŸã¯æ‰‹å‹•SNSãƒˆãƒªã‚¬ãƒ¼ã§ãƒ†ã‚¹ãƒˆçŸ­ç¸®
3. **æœ¬ç•ªç’°å¢ƒå½±éŸ¿**: ãƒ†ã‚¹ãƒˆã¯prodç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã€goo.ne.jpã¸ã®å½±éŸ¿ã«æ³¨æ„
4. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™**: å•é¡Œç™ºç”Ÿæ™‚ã¯æ—¢å­˜ã®å‹•ä½œä¸­ã‚·ã‚¹ãƒ†ãƒ ã«å³åº§ã«æˆ»ã›ã‚‹æº–å‚™

### ğŸ”„ ç¶™ç¶šä½œæ¥­ãŒå¿…è¦ãªå ´åˆ
æ˜æ—¥ä¸­ã«å®Œäº†ã—ãªã„å ´åˆã®å„ªå…ˆé †ä½:
1. **é«˜å„ªå…ˆ**: Phase 8â†’v2ã®SNSçµ±åˆç¢ºèªï¼ˆæ‰‹å‹•SNSãƒˆãƒªã‚¬ãƒ¼ï¼‰
2. **ä¸­å„ªå…ˆ**: è¨¼æ˜æ›¸è‡ªå‹•æ›´æ–°ã®å‹•ä½œç¢ºèª
3. **ä½å„ªå…ˆ**: å®Œå…¨ãªæ™‚ç³»åˆ—ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ

## ãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³
- **ç·¨é›†æ¸ˆã¿**: `dkim-manager-lambda-v2-clean.yaml` (SNSçµ±åˆæ©Ÿèƒ½è¿½åŠ æ¸ˆã¿)
- **ãƒ†ã‚¹ãƒˆç”¨**: `test-v2-sns-integration.json` (å‹•ä½œç¢ºèªæ¸ˆã¿)
- **ç¾çŠ¶**: v2ã‚·ã‚¹ãƒ†ãƒ ãŒSNSçµ±åˆã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã€å‹•ä½œç¢ºèªå®Œäº†

## æŠ€è¡“ãƒ¡ãƒ¢
- OpenSSL 3.2.2å‹•ä½œç¢ºèªæ¸ˆã¿
- Phase 8çµ±åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ : æ¯æ—¥9æ™‚å®Ÿè¡Œ 
- v2 Lambdaé–¢æ•°: 575è¡Œï¼ˆv1ã‹ã‚‰å¤§å¹…ç°¡ç•¥åŒ–ï¼‰
- SNS ARN: `arn:aws:sns:ap-northeast-1:${AWS::AccountId}:${ProjectName}-${Environment}-certificate-expiring`
