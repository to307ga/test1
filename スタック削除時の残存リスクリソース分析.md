# ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤æ™‚ã®æ®‹å­˜ãƒªã‚¹ã‚¯ãƒªã‚½ãƒ¼ã‚¹åˆ†æ

## ç¾åœ¨ã®EventBridgeãƒ«ãƒ¼ãƒ«ç¢ºèªçµæœ

```
|                                Name                                |  State   |
+--------------------------------------------------------------------+----------+
|  aws-ses-migration-dev-certificate-monitoring                      |  ENABLED |
|  aws-ses-migration-dev-dev-phas-DKIMPhaseManagerRule-8zn1KUpvk0Qq  |  ENABLED |
|  aws-ses-migration-dev-layer-setup-rule                            |  ENABLED |
|  aws-ses-migration-dev-phase-4-trigger                             |  ENABLED |
```

## âš ï¸ CloudFormationã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤æ™‚ã«æ®‹å­˜ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãƒªã‚½ãƒ¼ã‚¹

### 1. **EventBridge Rulesï¼ˆé«˜ãƒªã‚¹ã‚¯ï¼‰**
- **å•é¡Œ**: EventBridgeãƒ«ãƒ¼ãƒ«ã¯ä»–ã®ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹å ´åˆã€å‰Šé™¤æ™‚ã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
- **ç¢ºèªæ¸ˆã¿è©²å½“ãƒ«ãƒ¼ãƒ«**:
  - `aws-ses-migration-dev-certificate-monitoring`
  - `aws-ses-migration-dev-layer-setup-rule`
  - `aws-ses-migration-dev-phase-4-trigger`
  - `aws-ses-migration-dev-dev-phas-DKIMPhaseManagerRule-*`

#### å‰Šé™¤æ‰‹é †
```bash
# æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦ãªå ´åˆ
aws events delete-rule --name "aws-ses-migration-dev-certificate-monitoring" --region ap-northeast-1
aws events delete-rule --name "aws-ses-migration-dev-layer-setup-rule" --region ap-northeast-1
aws events delete-rule --name "aws-ses-migration-dev-phase-4-trigger" --region ap-northeast-1
aws events list-rules --region ap-northeast-1 --query 'Rules[?contains(Name, `aws-ses-migration-dev`)].Name' --output text | xargs -I {} aws events delete-rule --name {} --region ap-northeast-1
```

### 2. **Lambda Permissionsï¼ˆä¸­ãƒªã‚¹ã‚¯ï¼‰**
- **å•é¡Œ**: EventBridgeã‹ã‚‰Lambdaã¸ã®æ¨©é™ã¯å€‹åˆ¥ã«å‰Šé™¤ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹
- **å¯¾è±¡**: `AWS::Lambda::Permission`ãƒªã‚½ãƒ¼ã‚¹

#### ç¢ºèªãƒ»å‰Šé™¤æ‰‹é †
```bash
# Lambdaé–¢æ•°ã®ãƒãƒªã‚·ãƒ¼ç¢ºèª
aws lambda get-policy --function-name aws-ses-migration-dev-dkim-manager --region ap-northeast-1 || echo "No policy found"
```

### 3. **S3ãƒã‚±ãƒƒãƒˆå†…ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆé«˜ãƒªã‚¹ã‚¯ï¼‰**
- **å•é¡Œ**: ãƒã‚±ãƒƒãƒˆå†…ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã€ãƒã‚±ãƒƒãƒˆå‰Šé™¤ãŒå¤±æ•—ã™ã‚‹
- **å¯¾è±¡ãƒã‚±ãƒƒãƒˆ**:
  - `aws-ses-migration-dev-dkim-storage-*`
  - `aws-ses-migration-dev-lambda-layers-*`
  - `aws-ses-migration-dev-logs-*`

#### å‰Šé™¤æ‰‹é †
```bash
# ãƒã‚±ãƒƒãƒˆå†…å®¹ã®å®Œå…¨å‰Šé™¤
aws s3 rm s3://aws-ses-migration-dev-dkim-storage-ap-northeast-1-* --recursive
aws s3 rm s3://aws-ses-migration-dev-lambda-layers-ap-northeast-1-* --recursive  
aws s3 rm s3://aws-ses-migration-dev-logs-ap-northeast-1-* --recursive
```

### 4. **Secrets Managerï¼ˆä¸­ãƒªã‚¹ã‚¯ï¼‰**
- **å•é¡Œ**: `DeletionPolicy: Retain`è¨­å®šã‚„å¾©æ—§æœŸé–“ã«ã‚ˆã‚Šå³åº§ã«å‰Šé™¤ã•ã‚Œãªã„
- **å¯¾è±¡ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ**:
  - `aws-ses-migration/dev/dkim-config`
  - `aws-ses-migration/dev/dns-notification-config`

#### å‰Šé™¤æ‰‹é †
```bash
# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å¼·åˆ¶å‰Šé™¤ï¼ˆå¾©æ—§æœŸé–“ãªã—ï¼‰
aws secretsmanager delete-secret --secret-id "aws-ses-migration/dev/dkim-config" --force-delete-without-recovery --region ap-northeast-1
aws secretsmanager delete-secret --secret-id "aws-ses-migration/dev/dns-notification-config" --force-delete-without-recovery --region ap-northeast-1
```

### 5. **CloudWatch Log Groupsï¼ˆä½ãƒªã‚¹ã‚¯ï¼‰**
- **å•é¡Œ**: é€šå¸¸ã¯è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ãŒã€ç¨€ã«æ®‹å­˜ã™ã‚‹å ´åˆãŒã‚ã‚‹
- **å¯¾è±¡**: `/aws/lambda/aws-ses-migration-dev-*`

#### å‰Šé™¤æ‰‹é †
```bash
# ãƒ­ã‚°ç¾¤ã®æ‰‹å‹•å‰Šé™¤
aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/aws-ses-migration-dev" --query 'logGroups[].logGroupName' --output text | xargs -I {} aws logs delete-log-group --log-group-name {}
```

### 6. **SNS Topics & Subscriptionsï¼ˆä½ãƒªã‚¹ã‚¯ï¼‰**
- **å•é¡Œ**: å¤–éƒ¨ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã€å‰Šé™¤ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å¯èƒ½æ€§
- **å¯¾è±¡**: `aws-ses-migration-dev-dns-notifications`

## ğŸš¨ **å®Œå…¨å‰Šé™¤ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ**

### ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤å‰ã®æº–å‚™
```bash
#!/bin/bash
# 1. S3ãƒã‚±ãƒƒãƒˆå†…å®¹ã‚’ç©ºã«ã™ã‚‹
echo "Emptying S3 buckets..."
aws s3api list-buckets --query 'Buckets[?contains(Name, `aws-ses-migration-dev`)].Name' --output text | while read bucket; do
    echo "Emptying bucket: $bucket"
    aws s3 rm s3://$bucket --recursive
done

# 2. EventBridgeãƒ«ãƒ¼ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå‰Šé™¤
echo "Removing EventBridge rule targets..."
aws events list-rules --region ap-northeast-1 --query 'Rules[?contains(Name, `aws-ses-migration-dev`)].Name' --output text | while read rule; do
    echo "Removing targets for rule: $rule"
    aws events list-targets-by-rule --rule $rule --region ap-northeast-1 --query 'Targets[].Id' --output text | while read target; do
        aws events remove-targets --rule $rule --ids $target --region ap-northeast-1
    done
done
```

### ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤å¾Œã®æ®‹å­˜ç¢ºèª
```bash
#!/bin/bash
echo "=== æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª ==="

# EventBridgeãƒ«ãƒ¼ãƒ«
echo "EventBridge Rules:"
aws events list-rules --region ap-northeast-1 --query 'Rules[?contains(Name, `aws-ses-migration-dev`)].Name' --output text

# S3ãƒã‚±ãƒƒãƒˆ  
echo "S3 Buckets:"
aws s3api list-buckets --query 'Buckets[?contains(Name, `aws-ses-migration-dev`)].Name' --output text

# Secrets Manager
echo "Secrets:"
aws secretsmanager list-secrets --region ap-northeast-1 --query 'SecretList[?contains(Name, `aws-ses-migration/dev`)].Name' --output text

# CloudWatch Log Groups
echo "Log Groups:"
aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/aws-ses-migration-dev" --query 'logGroups[].logGroupName' --output text

# SNS Topics
echo "SNS Topics:"
aws sns list-topics --region ap-northeast-1 --query 'Topics[?contains(TopicArn, `aws-ses-migration-dev`)].TopicArn' --output text
```

## ğŸ¯ **æ¨å¥¨å‰Šé™¤æ‰‹é †ï¼ˆå®Œå…¨ç‰ˆï¼‰**

### Phase 1: äº‹å‰æº–å‚™
1. âœ… S3ãƒã‚±ãƒƒãƒˆå†…å®¹ã®å®Œå…¨å‰Šé™¤
2. âœ… EventBridgeãƒ«ãƒ¼ãƒ«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å‰Šé™¤
3. âœ… Lambdaæ¨©é™ã®ç¢ºèª

### Phase 2: Sceptreã«ã‚ˆã‚‹ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
```bash
# é€šå¸¸ã®Sceptreå‰Šé™¤
uv run sceptre delete dev/monitoring.yaml
uv run sceptre delete dev/security.yaml  
# ... å…¨ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
```

### Phase 3: æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹ã®æ‰‹å‹•å‰Šé™¤
1. âœ… EventBridgeãƒ«ãƒ¼ãƒ«ã®æ‰‹å‹•å‰Šé™¤
2. âœ… Secrets Managerã®å¼·åˆ¶å‰Šé™¤
3. âœ… CloudWatch Log Groupsã®å‰Šé™¤
4. âœ… æ®‹å­˜S3ãƒã‚±ãƒƒãƒˆã®å‰Šé™¤

### Phase 4: å®Œå…¨å‰Šé™¤ç¢ºèª
```bash
# æ®‹å­˜ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
./check_remaining_resources.sh
```

## çµè«–

âš ï¸ **EventBridgeãƒ«ãƒ¼ãƒ«ãŒæœ€ã‚‚ãƒªã‚¹ã‚¯ãŒé«˜ã„**æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹ã§ã™ã€‚

âœ… **å¯¾ç­–**: ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤å‰ã«EventBridgeãƒ«ãƒ¼ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ‰‹å‹•å‰Šé™¤
âœ… **ç¢ºèª**: å‰Šé™¤å¾Œã«æ®‹å­˜ãƒªã‚½ãƒ¼ã‚¹ç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ¤œè¨¼
âœ… **æ‰€è¦æ™‚é–“**: è¿½åŠ ã§10-15åˆ†ç¨‹åº¦å¿…è¦

**åˆè¨ˆå‰Šé™¤æ™‚é–“**: 25-30åˆ†ï¼ˆæ‰‹å‹•å‰Šé™¤å«ã‚€ï¼‰
