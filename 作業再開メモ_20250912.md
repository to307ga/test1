# AWS SES BYODKIM ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæ¥­å†é–‹ãƒ¡ãƒ¢ - 2025å¹´09æœˆ12æ—¥

## ğŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå**: AWS SES BYODKIM (Bring Your Own DKIM) å®Ÿè£…
- **ç›®çš„**: goo.ne.jpãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã®ç‹¬è‡ªDKIMè¨¼æ˜æ›¸ã«ã‚ˆã‚‹é›»å­ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰
- **ç’°å¢ƒ**: æœ¬ç•ªç’°å¢ƒ (prod)
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: ap-northeast-1
- **ãƒ‰ãƒ¡ã‚¤ãƒ³**: goo.ne.jp

## ğŸ—ï¸ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç¾çŠ¶ (2025/09/12 15:00æ™‚ç‚¹)

### âœ… å®Œäº†æ¸ˆã¿ã‚¹ã‚¿ãƒƒã‚¯
```bash
# ç¾åœ¨ç¨¼åƒä¸­ã®CloudFormationã‚¹ã‚¿ãƒƒã‚¯ (CREATE_COMPLETE)
aws-ses-migration-prod-prod-phase-1-infrastructure-foundation  # Phase 1: åŸºç›¤ã‚¤ãƒ³ãƒ•ãƒ©
aws-ses-migration-prod-prod-phase-3-ses-byodkim               # Phase 3: SES BYODKIMè¨­å®š
aws-ses-migration-prod-prod-phase-4-dns-preparation           # Phase 4: DNSæº–å‚™
aws-ses-migration-prod-prod-phase-5-dns-team-collaboration    # Phase 5: DNSãƒãƒ¼ãƒ é€£æº
aws-ses-migration-prod-prod-phase-7-dns-validation-dkim-activation # Phase 7: DKIMæœ‰åŠ¹åŒ–
aws-ses-migration-prod-prod-phase-8-monitoring-system         # Phase 8: ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  (ç°¡ç•¥ç‰ˆ)
aws-ses-migration-prod-prod-enhanced-kinesis                  # æ‹¡å¼µKinesisãƒ‡ãƒ¼ã‚¿å‡¦ç†
aws-ses-migration-prod-prod-monitoring                        # ç·åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
aws-ses-migration-prod-prod-security                          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ 
```

### ğŸŸ¡ éƒ¨åˆ†å®Œäº†ãƒ»å•é¡Œã‚ã‚Š
```bash
aws-ses-migration-prod-prod-base                    # UPDATE_COMPLETE (åŸºç›¤æ›´æ–°å®Œäº†)
aws-ses-migration-prod-prod-phase-2-dkim-system     # UPDATE_ROLLBACK_COMPLETE (cryptography Layerå•é¡Œ)
```

### âš ï¸ é‡è¦ãªå•é¡Œ
- **Phase-2**: cryptography Layerä½œæˆå¤±æ•— (Windowsç’°å¢ƒã§Linuxç”¨ãƒã‚¤ãƒŠãƒªä½œæˆå›°é›£)
- **ç¾åœ¨ã®å¯¾å‡¦**: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆ `fix_byodkim_final.py` ã§ãƒ†ã‚¹ãƒˆéµä½¿ç”¨ä¸­

## ğŸ¯ BYODKIMç™»éŒ²çŠ¶æ³

### âœ… æˆåŠŸäº‹é …
```json
{
  "IdentityType": "DOMAIN",
  "DkimAttributes": {
    "SigningEnabled": true,
    "Status": "PENDING",
    "Tokens": ["gooid-21-pro-20250912-1"],
    "SigningAttributesOrigin": "EXTERNAL"
  },
  "VerifiedForSendingStatus": false,
  "VerificationStatus": "PENDING"
}
```

### ğŸ“§ DNSè¨­å®šä¾é ¼çŠ¶æ³
- **DNSãƒãƒ¼ãƒ é€šçŸ¥**: å®Œäº† (Phase-5 Managerå®Ÿè¡Œæ¸ˆã¿)
- **TXTãƒ¬ã‚³ãƒ¼ãƒ‰**: `gooid-21-pro-20250912-1._domainkey.goo.ne.jp`
- **DKIMå…¬é–‹éµ**: `v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA4f5wg5l2hKsTeNem/V41fGnJm6gOdrj8ym3rFkEjWT2BTq2by8bg5Ho61qIw3QVp+2ZNtNqYqYemgrXfJ8Kd4WZ2ROr8J5q1234+oZBiGE9lp9B4L1GekpMQa9ub0cKyDFeL2qIxD6HGPnY2+MA8y9WOJ8fj234gKluU1qfnyxUiZo5r2ImlqNe+jpvyCUgq2F5q0JZfZDnwtGU3Zp+2vgYlc`

## ğŸ“ é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

### ğŸ”‘ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (sceptre/config/prod/)
- `base.yaml` - åŸºç›¤è¨­å®š
- `phase-1-infrastructure-foundation.yaml` - Phase 1è¨­å®š
- `phase-2-dkim-system.yaml` - Phase 2è¨­å®š (å•é¡Œã‚ã‚Š)
- `phase-3-ses-byodkim.yaml` - Phase 3è¨­å®š
- `phase-4-dns-preparation.yaml` - Phase 4è¨­å®š
- `phase-5-dns-team-collaboration.yaml` - Phase 5è¨­å®š
- `phase-7-dns-validation-dkim-activation.yaml` - Phase 7è¨­å®š
- `phase-8-monitoring-system.yaml` - Phase 8è¨­å®š (ä¿®æ­£æ¸ˆã¿)
- `enhanced-kinesis.yaml` - æ‹¡å¼µKinesisè¨­å®š
- `monitoring.yaml` - ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
- `security.yaml` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### ğŸ—ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (sceptre/templates/)
- `dkim-manager-lambda.yaml` - DKIMç®¡ç†Lambda (ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ)
- `phase-8-simple-monitoring.yaml` - Phase 8ç°¡ç•¥ç‰ˆç›£è¦– (æ–°è¦ä½œæˆ)
- `enhanced-kinesis.yaml` - æ‹¡å¼µKinesisãƒ‡ãƒ¼ã‚¿å‡¦ç†
- `monitoring.yaml` - ç·åˆç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
- `security.yaml` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ 

### ğŸ Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `fix_byodkim_final.py` - BYODKIMç™»éŒ²æˆåŠŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ (é‡è¦!)
- `invoke_phase7.py` - Phase 7å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `main.py` - ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ğŸ“„ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«
- `phase5-manager-payload.json` - DNSãƒãƒ¼ãƒ é€šçŸ¥ç”¨
- `phase7-*-payload.json` - Phase 7å®Ÿè¡Œç”¨å„ç¨®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰

### ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- `BYODKIMå®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸.md` - å®Œå…¨æ‰‹é †æ›¸ (é‡è¦!)
- `DNSè¨­å®šä¾é ¼æ›¸_20250912_143000.md` - DNSãƒãƒ¼ãƒ ä¾é ¼æ›¸
- `DNSè¨­å®šè¦æ±‚_ç°¡æ½”ç‰ˆ.md` - ç°¡æ½”ç‰ˆä¾é ¼æ›¸

## ğŸ”§ Linuxç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç§»è¡Œ
```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’Linuxç’°å¢ƒã«è¤‡è£½
rsync -av /path/to/AWS_SES_BYODKIM/ ~/projects/aws-ses-byodkim/
cd ~/projects/aws-ses-byodkim/
```

### 2. Pythonç’°å¢ƒæ§‹ç¯‰
```bash
# uvã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (æ¨å¥¨)
curl -LsSf https://astral.sh/uv/install.sh | sh
source ~/.bashrc

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
uv sync

# AWS CLIè¨­å®šç¢ºèª
aws configure list
aws sts get-caller-identity
```

### 3. Sceptreç’°å¢ƒç¢ºèª
```bash
cd sceptre/
uv run sceptre list stacks prod
```

## ğŸš¨ æœ€å„ªå…ˆå¯¾å¿œäº‹é …

### 1. cryptography Layerå•é¡Œè§£æ±º
```bash
# Linuxç’°å¢ƒã§cryptography Layerã‚’æ­£ã—ãä½œæˆ
cd scripts/
./create-layer.sh prod aws-ses-migration

# ã¾ãŸã¯æ‰‹å‹•ã§Layerä½œæˆ
pip install cryptography --target python/
zip -r cryptography-layer.zip python/
aws s3 cp cryptography-layer.zip s3://BUCKET_NAME/cryptography-layer.zip
```

### 2. Phase-2ã‚¹ã‚¿ãƒƒã‚¯ä¿®å¾©
```bash
# cryptography Layerå•é¡Œã‚’è§£æ±ºå¾Œ
uv run sceptre launch prod/phase-2-dkim-system.yaml -y
```

### 3. DNSè¨­å®šç¢ºèª
```bash
# DNSè¨­å®šçŠ¶æ³ç¢ºèª
aws sesv2 get-email-identity --email-identity goo.ne.jp --region ap-northeast-1
nslookup -type=TXT gooid-21-pro-20250912-1._domainkey.goo.ne.jp
```

## ğŸ“Š ç›£è¦–ãƒ»é‹ç”¨

### CloudWatch ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- Phase-8ç›£è¦–: https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=aws-ses-migration-prod-phase8-monitoring
- ç·åˆç›£è¦–: æ—¢å­˜monitoring.yamlã‹ã‚‰ä½œæˆæ¸ˆã¿

### é‡è¦ãªLambdaé–¢æ•°
```bash
aws-ses-migration-prod-dkim-manager  # ãƒ¡ã‚¤ãƒ³DKIMç®¡ç†é–¢æ•°
```

### S3ãƒªã‚½ãƒ¼ã‚¹
```bash
aws-ses-migration-prod-dkim-certificates  # DKIMè¨¼æ˜æ›¸ä¿å­˜ãƒã‚±ãƒƒãƒˆ
```

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãä½¿ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
```bash
# ã‚¹ã‚¿ãƒƒã‚¯çŠ¶æ³ç¢ºèª
uv run sceptre list stacks prod
aws cloudformation list-stacks --region ap-northeast-1 --query "StackSummaries[?contains(StackName, 'aws-ses-migration-prod')].{Name:StackName,Status:StackStatus}"

# BYODKIMçŠ¶æ³ç¢ºèª
aws sesv2 get-email-identity --email-identity goo.ne.jp --region ap-northeast-1

# Lambdaé–¢æ•°å®Ÿè¡Œ
aws lambda invoke --function-name aws-ses-migration-prod-dkim-manager --payload fileb://PAYLOAD.json response.json

# S3ç¢ºèª
aws s3 ls s3://aws-ses-migration-prod-dkim-certificates/ --recursive
```

### ã‚¨ãƒ©ãƒ¼å¯¾å‡¦
- **cryptography Layer**: Linuxç’°å¢ƒã§å†ä½œæˆãŒå¿…è¦
- **YAMLæ§‹æ–‡ã‚¨ãƒ©ãƒ¼**: OneDriveã®æ–‡å­—ã‚³ãƒ¼ãƒ‰å•é¡ŒãŒåŸå›  (Linuxç’°å¢ƒã§è§£æ±º)
- **Unicodeæ–‡å­—**: Phase-8ã§ä¿®æ­£æ¸ˆã¿ (âœ…âŒ â†’ [SUCCESS][ERROR])

## ğŸ“ˆ æˆåŠŸäº‹ä¾‹

### fix_byodkim_final.py ã®é‡è¦æ€§
```python
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§BYODKIMç™»éŒ²ã«æˆåŠŸ
# PEMå½¢å¼ã‹ã‚‰Base64å¤‰æ›ã‚’æ­£ã—ãå®Ÿè¡Œ
# SigningAttributesOrigin=EXTERNAL ã«å¤‰æ›´æˆåŠŸ
```

### Phaseå®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
```bash
# åŸºæœ¬çš„ãª Phase Manager å®Ÿè¡Œãƒ‘ã‚¿ãƒ¼ãƒ³
aws lambda invoke --function-name aws-ses-migration-prod-dkim-manager \
  --payload '{"action":"phase_manager","phase":"N","domain":"goo.ne.jp","environment":"prod","projectName":"aws-ses-migration"}' \
  response.json
```

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— (Linuxç’°å¢ƒã§ã®ç¶™ç¶šä½œæ¥­)

1. **ç’°å¢ƒç§»è¡Œ**: âœ… ã“ã®ãƒ¡ãƒ¢ä½œæˆå®Œäº†
2. **cryptography Layerä¿®æ­£**: Linuxç’°å¢ƒã§Layeræ­£å¸¸ä½œæˆ
3. **Phase-2ä¿®å¾©**: UPDATE_ROLLBACK_COMPLETE â†’ CREATE_COMPLETE
4. **DNSè¨­å®šå®Œäº†å¾…ã¡**: DNSãƒãƒ¼ãƒ ã‹ã‚‰ã®å›ç­”å¾…ã¡
5. **æœ€çµ‚æ¤œè¨¼**: å…¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ

## ğŸ’¡ é‡è¦ãªå­¦ç¿’äº‹é …

1. **æ‰‹é †æ›¸å³å®ˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹é †æ›¸ã‹ã‚‰ã®é€¸è„±ã‚’å³ã—ãæŒ‡æ‘˜
2. **BYODKIMæˆåŠŸ**: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ã‚ˆã‚‹å›é¿ãŒæœ‰åŠ¹
3. **Unicodeå•é¡Œ**: Windows+OneDriveã®æ–‡å­—ã‚³ãƒ¼ãƒ‰å•é¡Œ
4. **æ§‹é€ åŒ–å¯¾å¿œ**: Todoç®¡ç†ã«ã‚ˆã‚‹æ®µéšçš„é€²è¡ŒãŒåŠ¹æœçš„

## ğŸ“ ç·Šæ€¥é€£çµ¡å…ˆãƒ»å‚è€ƒæƒ…å ±
- AWS SESç§»è¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ãƒ 
- DNSè¨­å®šãƒãƒ¼ãƒ : DNSè¨­å®šä¾é ¼æ›¸_20250912_143000.md å‚ç…§
- æŠ€è¡“æ–‡æ›¸: BYODKIMå®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †æ›¸.md

---

**ä½œæˆæ—¥æ™‚**: 2025å¹´09æœˆ12æ—¥ 15:00  
**ä½œæˆç†ç”±**: Windowsç’°å¢ƒã‹ã‚‰Linuxç’°å¢ƒã¸ã®ç§»è¡Œå¯¾å¿œ  
**æ¬¡å›ä½œæ¥­é–‹å§‹æ™‚**: ã“ã®ãƒ¡ãƒ¢ã‹ã‚‰ç¾çŠ¶æŠŠæ¡ã—ã¦ç¶™ç¶šä½œæ¥­å¯èƒ½
