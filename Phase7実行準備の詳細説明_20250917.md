# Phase-7å®Ÿè¡Œæº–å‚™ã®è©³ç´°èª¬æ˜Ž
## å®Ÿè¡Œæ—¥: 2025å¹´9æœˆ17æ—¥

## ðŸŽ¯ Phase-7ã¨ã¯ä½•ã‹ï¼Ÿ

**Phase-7: DNSè¨­å®šå®Œäº†å¾Œã®BYODKIMæœ‰åŠ¹åŒ–ãƒ•ã‚§ãƒ¼ã‚º**

Phase-7ã¯ã€DNSãƒãƒ¼ãƒ ãŒTXTãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šå®Œäº†ã—ãŸå¾Œã«å®Ÿè¡Œã™ã‚‹ã€**BYODKIMã®æœ€çµ‚æœ‰åŠ¹åŒ–æ®µéšŽ**ã§ã™ã€‚

---

## ðŸ“‹ Phase-7ã®å…·ä½“çš„ãªå‡¦ç†å†…å®¹

### **Step 22: BYODKIMè¨­å®šã®SESã¸ã®é©ç”¨**
1. **ç§˜å¯†éµã®å–å¾—**: S3ã‹ã‚‰æœ€æ–°ã®ã‚»ãƒ¬ã‚¯ã‚¿ã®ç§˜å¯†éµï¼ˆPEMå½¢å¼ï¼‰ã‚’å–å¾—
2. **å½¢å¼å¤‰æ›**: PEM â†’ Base64 DERå½¢å¼ã«å¤‰æ›ï¼ˆSES APIè¦æ±‚ï¼‰
3. **SES BYODKIMè¨­å®š**: `put_email_identity_dkim_signing_attributes` APIå®Ÿè¡Œ
   ```python
   sesv2_client.put_email_identity_dkim_signing_attributes(
       EmailIdentity=domain,  # goo.ne.jp
       SigningAttributesOrigin='EXTERNAL',  # BYODKIMãƒ¢ãƒ¼ãƒ‰
       SigningAttributes={
           'DomainSigningSelector': custom_selector,  # gooid-21-pro-20250917-3
           'DomainSigningPrivateKey': private_key_base64  # å¤‰æ›æ¸ˆã¿ç§˜å¯†éµ
       }
   )
   ```

### **Step 23: DKIMç½²åã®æœ‰åŠ¹åŒ–**
1. **ç½²åæœ‰åŠ¹åŒ–**: `put_email_identity_dkim_attributes` APIå®Ÿè¡Œ
   ```python
   sesv2_client.put_email_identity_dkim_attributes(
       EmailIdentity=domain,  # goo.ne.jp
       SigningEnabled=True  # DKIMç½²åã‚’æœ‰åŠ¹åŒ–
   )
   ```

### **å®Œäº†å‡¦ç†**
- **è¨­å®šæ›´æ–°**: Secrets Managerã«å®Œäº†çŠ¶æ…‹ã‚’è¨˜éŒ²
- **ãƒ­ã‚°å‡ºåŠ›**: æˆåŠŸãƒ­ã‚°ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡
- **çŠ¶æ…‹é·ç§»**: Phase-7å®Œäº† â†’ Phase-8ç›£è¦–é–‹å§‹

---

## ðŸ”§ Phase-7å®Ÿè¡Œæº–å‚™ã®å…·ä½“çš„ä½œæ¥­

### 1. **å‰ææ¡ä»¶ã®ç¢ºèª**
```bash
# ç¾åœ¨ã®SESçŠ¶æ…‹ç¢ºèªï¼ˆDNSè¨­å®šå®Œäº†å¾Œã«PENDING â†’ SUCCESSã«ãªã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
aws sesv2 get-email-identity --email-identity goo.ne.jp --region ap-northeast-1

# æœŸå¾…å€¤ï¼ˆDNSè¨­å®šå®Œäº†å¾Œï¼‰:
# "Status": "SUCCESS"  â† é‡è¦ï¼
# "Tokens": ["gooid-21-pro-20250917-3"]
```

### 2. **DNSè¨­å®šå®Œäº†ã®ç¢ºèª**
```bash
# DNS TXTãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
nslookup -type=TXT gooid-21-pro-20250917-3._domainkey.goo.ne.jp

# æœŸå¾…å€¤:
# v=DKIM1; k=rsa; p=MIIBIjANBgk... â† æ­£ã—ã„å…¬é–‹éµ
```

### 3. **Phase-7å®Ÿè¡Œãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ**
```json
{
  "action": "phase_manager",
  "phase": "7",
  "domain": "goo.ne.jp",
  "environment": "prod",
  "projectName": "aws-ses-migration",
  "dkimSeparator": "gooid-21-pro"
}
```

### 4. **Phase-7å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰**
```bash
# ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cat > phase7-final-execution-payload.json << EOF
{
  "action": "phase_manager",
  "phase": "7",
  "domain": "goo.ne.jp",
  "environment": "prod",
  "projectName": "aws-ses-migration",
  "dkimSeparator": "gooid-21-pro"
}
EOF

# Phase-7å®Ÿè¡Œ
aws lambda invoke --function-name aws-ses-migration-prod-dkim-manager --payload fileb://phase7-final-execution-payload.json --region ap-northeast-1 response-phase7-final-execution.json

# çµæžœç¢ºèª
cat response-phase7-final-execution.json
```

### 5. **Phase-7å®Œäº†å¾Œã®ç¢ºèª**
```bash
# SES BYODKIMè¨­å®šç¢ºèª
aws sesv2 get-email-identity --email-identity goo.ne.jp --region ap-northeast-1

# æœŸå¾…å€¤:
# "SigningEnabled": true
# "SigningAttributesOrigin": "EXTERNAL"
# "Status": "SUCCESS"

# Secrets Managerè¨­å®šç¢ºèª
aws secretsmanager get-secret-value --secret-id "aws-ses-migration/prod/dkim-config" --region ap-northeast-1
```

---

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

### **å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°**
1. **DNSè¨­å®šå®Œäº†å¿…é ˆ**: DNSãƒãƒ¼ãƒ ãŒTXTãƒ¬ã‚³ãƒ¼ãƒ‰è¨­å®šå®Œäº†ã‚’é€šçŸ¥å¾Œ
2. **DNSä¼æ’­å¾…ã¡**: è¨­å®šå¾Œ15-30åˆ†ç¨‹åº¦ã®ä¼æ’­æ™‚é–“ã‚’è€ƒæ…®
3. **SESçŠ¶æ…‹ç¢ºèª**: Status ãŒ "PENDING" â†’ "SUCCESS" ã«å¤‰åŒ–ã—ã¦ã‹ã‚‰å®Ÿè¡Œ

### **ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ å¯¾å¿œ**
1. **æ‰‹å‹•å®Ÿè¡Œ**: è‡ªå‹•å®Ÿè¡Œã§ã¯ãªãã€ç¢ºèªå¾Œã®æ‰‹å‹•å®Ÿè¡Œã‚’æŽ¨å¥¨
2. **æ®µéšŽçš„åˆ‡ã‚Šæ›¿ãˆ**: æ—¢å­˜DKIM â†’ BYODKIM ã®æ®µéšŽçš„ç§»è¡Œ
3. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™**: å•é¡Œç™ºç”Ÿæ™‚ã®æ—§è¨­å®šå¾©æ—§æ‰‹é †ã‚’æº–å‚™

### **å®Ÿè¡Œå¾Œã®æ¤œè¨¼**
1. **DKIMç½²åãƒ†ã‚¹ãƒˆ**: å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã§DKIMç½²åç¢ºèª
2. **é…ä¿¡ãƒ†ã‚¹ãƒˆ**: ä¸»è¦ãƒ¡ãƒ¼ãƒ«ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®é…ä¿¡ãƒ†ã‚¹ãƒˆ
3. **ç›£è¦–ç¢ºèª**: Phase-8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ã®æ­£å¸¸æ€§ç¢ºèª

---

## ðŸ“Š Phase-7å®Ÿè¡Œã®æˆåŠŸæŒ‡æ¨™

### **SESè¨­å®š**
- âœ… `SigningEnabled`: true
- âœ… `SigningAttributesOrigin`: "EXTERNAL"  
- âœ… `Status`: "SUCCESS"
- âœ… `Tokens`: ["gooid-21-pro-20250917-3"]

### **Secrets Manager**
- âœ… `current_phase`: "7"
- âœ… `byodkim_enabled`: true
- âœ… `signing_enabled`: true
- âœ… `phase_7_completed_at`: [å®Ÿè¡Œæ—¥æ™‚]

### **CloudWatchç›£è¦–**
- âœ… Phase-7å®Ÿè¡Œãƒ­ã‚°æ­£å¸¸è¨˜éŒ²
- âœ… BYODKIMæ¤œè¨¼ã‚¢ãƒ©ãƒ¼ãƒ è§£é™¤ï¼ˆALARM â†’ OKï¼‰
- âœ… Lambdaå®Ÿè¡Œãƒ¡ãƒˆãƒªã‚¯ã‚¹æ­£å¸¸

---

## ðŸ”„ Phase-7å¾Œã®æµã‚Œ

### **Phase-8è‡ªå‹•é–‹å§‹**
- Phase-7å®Œäº†ã¨åŒæ™‚ã«Phase-8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ãŒæœ¬æ ¼ç¨¼åƒ
- CloudWatchãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
- ç•°å¸¸æ¤œçŸ¥æ™‚ã®è‡ªå‹•é€šçŸ¥

### **é‹ç”¨ç›£è¦–**
- DKIMç½²åçŽ‡ã®ç¶™ç¶šç›£è¦–
- ãƒ¡ãƒ¼ãƒ«é…ä¿¡æˆåŠŸçŽ‡ã®è¿½è·¡
- è¨¼æ˜Žæ›¸æœ‰åŠ¹æœŸé™ã®äº‹å‰é€šçŸ¥

### **å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**
- æœˆæ¬¡DKIMè¨¼æ˜Žæ›¸ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- å¹´æ¬¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- è¨­å®šæœ€é©åŒ–ãƒ¬ãƒ“ãƒ¥ãƒ¼

---

## ðŸš€ å®Ÿè¡Œæº–å‚™ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### **äº‹å‰ç¢ºèª**
- [ ] DNSãƒãƒ¼ãƒ ã‹ã‚‰è¨­å®šå®Œäº†é€šçŸ¥å—é ˜
- [ ] DNS TXTãƒ¬ã‚³ãƒ¼ãƒ‰æ­£å¸¸å¿œç­”ç¢ºèª
- [ ] SES Status: SUCCESS ç¢ºèª
- [ ] Phase-8ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸å‹•ä½œç¢ºèª
- [ ] CloudWatch ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª

### **å®Ÿè¡Œæº–å‚™**
- [ ] Phase-7å®Ÿè¡Œãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½œæˆ
- [ ] å®Ÿè¡Œã‚³ãƒžãƒ³ãƒ‰æº–å‚™
- [ ] çµæžœç¢ºèªæ‰‹é †æº–å‚™
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ç¢ºèª
- [ ] é–¢ä¿‚è€…ã¸ã®å®Ÿè¡Œé€šçŸ¥æº–å‚™

### **å®Ÿè¡Œå¾Œç¢ºèª**
- [ ] SES BYODKIMè¨­å®šç¢ºèª
- [ ] Secrets Manageræ›´æ–°ç¢ºèª
- [ ] CloudWatch ãƒ­ã‚°ç¢ºèª
- [ ] ã‚¢ãƒ©ãƒ¼ãƒ çŠ¶æ…‹ç¢ºèª
- [ ] ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

---

## ðŸ“ž Phase-7å®Ÿè¡Œæ™‚ã®ä½“åˆ¶

### **å®Ÿè¡Œè²¬ä»»è€…**
- æŠ€è¡“æ‹…å½“è€…ï¼ˆAWSæ“ä½œå®Ÿè¡Œï¼‰
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆé€²æ—ç®¡ç†ï¼‰
- DNSãƒãƒ¼ãƒ ï¼ˆè¨­å®šçŠ¶æ³ç¢ºèªï¼‰

### **ç·Šæ€¥é€£çµ¡å…ˆ**
- DNSç®¡ç†ãƒãƒ¼ãƒ : goo-idpay-sys@ml.nttdocomo.com
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ‹…å½“è€…: [é€£çµ¡å…ˆ]
- æŠ€è¡“ã‚µãƒãƒ¼ãƒˆ: [é€£çµ¡å…ˆ]

---

**Phase-7å®Ÿè¡Œæº–å‚™ã¯ã€DNSãƒãƒ¼ãƒ ã®è¨­å®šä½œæ¥­å®Œäº†å¾Œã«ã€æ…Žé‡ã‹ã¤æ®µéšŽçš„ã«BYODKIMã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é‡è¦ãªãƒ•ã‚§ãƒ¼ã‚ºã§ã™ã€‚ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€æ‰‹å‹•å®Ÿè¡Œã¨ååˆ†ãªæ¤œè¨¼ãŒå¿…è¦ã§ã™ã€‚**
