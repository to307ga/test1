# This logname can be set in /etc/my.cnf
# by setting the variable "log-error"
# in the [mysqld] section as follows:
#
# [mysqld]
# log-error=/var/lib/mysql/mysqld.log
#
# If the root user has a password you have to create a
# /root/.my.cnf configuration file with the following
# content:
#
# [mysqladmin]
# password = <secret> 
# user= root
#
# where "<secret>" is the password. 
#
# ATTENTION: This /root/.my.cnf should be readable ONLY
# for root !

{#
    ### edb は mysqldを3つ起動しているので区別します。
#}
{% if inventory_hostname_short is regex("-edb-\d{3}") %}
/var/log/mariadb/mariadb1.log
/var/log/mariadb/mariadb-slow1.log
{
        create 644 mysql mysql
        notifempty
        daily
        rotate 30
        missingok
        compress
        sharedscripts
    postrotate
        # just if mariadbd is really running
        if test -x /usr/bin/mysqladmin && \
           /usr/bin/mysqladmin -S /var/lib/mysql/mysql1.sock ping &>/dev/null
        then
           /usr/bin/mysqladmin -S /var/lib/mysql/mysql1.sock --local flush-error-log \
              flush-engine-log flush-general-log flush-slow-log
        fi
    endscript
}


/var/log/mariadb/mariadb11.log
/var/log/mariadb/mariadb-slow11.log
{
        create 644 mysql mysql
        notifempty
        daily
        rotate 30
        missingok
        compress
        sharedscripts
    postrotate
        # just if mariadbd is really running
        if test -x /usr/bin/mysqladmin && \
           /usr/bin/mysqladmin -S /var/lib/mysql/mysql11.sock ping &>/dev/null
        then
           /usr/bin/mysqladmin -S /var/lib/mysql/mysql11.sock --local flush-error-log \
              flush-engine-log flush-general-log flush-slow-log
        fi
    endscript
}


/var/log/mariadb/mariadb12.log
/var/log/mariadb/mariadb-slow12.log
{
        create 644 mysql mysql
        notifempty
        daily
        rotate 30
        missingok
        compress
        sharedscripts
    postrotate
        # just if mariadbd is really running
        if test -x /usr/bin/mysqladmin && \
           /usr/bin/mysqladmin -S /var/lib/mysql/mysql12.sock ping &>/dev/null
        then
           /usr/bin/mysqladmin -S /var/lib/mysql/mysql12.sock --local flush-error-log \
              flush-engine-log flush-general-log flush-slow-log
        fi
    endscript
}
{#
    ### 一般的な（edb以外の）DBサーバ
#}
{% else %}
/var/log/mariadb/*.log {
        create 644 mysql mysql
        notifempty
        daily
        rotate 30
        missingok
        compress
        sharedscripts
    postrotate
        # just if mariadbd is really running
        if test -x /usr/bin/mysqladmin && \
           /usr/bin/mysqladmin ping &>/dev/null
        then
           /usr/bin/mysqladmin --local flush-error-log flush-engine-log flush-general-log flush-slow-log
        fi
    endscript
}
{% endif %}
