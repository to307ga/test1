#!/usr/bin/bash

# 商用環境はダウンロードしたrpmファイルを/opt/dnf-automatic-downloadsへ集約と古いもののバックアップ(1世代のみ)
# 開発環境はインストールまではすんでいるので再起動。通常のサーバは一斉に再起動するが、GaleraClusterに組み込まれているサーバとfgwは3グループに分かれて時間をずらしながら再起動

# 以下商用環境用

{% if release_env == "pro" %}
/usr/bin/rm /opt/dnf-automatic-downloads/old/*.rpm
/usr/bin/mv -if /opt/dnf-automatic-downloads/*.rpm /opt/dnf-automatic-downloads/old/
/usr/bin/find /var/cache/dnf/ -type f -name "*.rpm" -exec cp {} /opt/dnf-automatic-downloads \;
{% endif %}

# 以下開発環境用

{% if release_env == "dev" %}
host=`hostname`

/usr/sbin/sendmail -t <<EOL
From: toshimitsu.tomonaga.zd@s1.nttdocomo.com
To: goo-idpay-sys@ml.nttdocomo.com
Subject: OS Reboot Notification from ${host}
OS will reboot after 5 minutes for updating.
This email is being executed by cron of dnf-automatic.
...
EOL

{% endif %}

# 開発環境は4つのグループに分かれて時間をずらしながら再起動 最初の3グループはGaleraClusterとfgw(drbd) 残りの1つは通常のサーバ

{% if release_env == "dev" and inventory_hostname in ["idhub-21-dev-mdb-303","idhub-21-dev-sdb-301","gooid-21-dev-mdb-303","gooid-21-dev-sdb-302","gooid-30-dev-mdb-103","gooid-30-dev-sdb-102","idhub-30-dev-mdb-103","idhub-30-dev-sdb-102","idhub-30-dev-mdb-201","gooid-30-dev-mdb-503","gooid-30-dev-mdb-603","idhub-30-dev-mdb-401"] %}
/usr/sbin/shutdown -r +5
{% elif release_env == "dev" and inventory_hostname in ["idhub-21-dev-mdb-302","idhub-21-dev-sdb-302","gooid-21-dev-mdb-302","gooid-21-dev-sdb-301","gooid-30-dev-mdb-102","gooid-30-dev-sdb-101","idhub-30-dev-mdb-102","idhub-30-dev-sdb-101","gooid-30-dev-mdb-301","gooid-30-dev-mdb-502","gooid-30-dev-mdb-602","idhub-30-dev-mdb-301","gooid-30-dev-mdb-502","gooid-30-dev-mdb-602"] %}
/usr/sbin/shutdown -r +25
{% elif release_env == "dev" and inventory_hostname in ["gooid-21-dev-fgw-102","idhub-21-dev-mdb-301","gooid-21-dev-mdb-301","gooid-30-dev-mdb-101","idhub-30-dev-mdb-101","gooid-30-dev-mdb-401","gooid-30-dev-mdb-501","gooid-30-dev-mdb-601","gooid-30-dev-mdb-201","gooid-30-dev-mdb-501","gooid-30-dev-mdb-601","gooid-30-dev-fgw-002"] %}
/usr/sbin/shutdown -r +45
{% elif release_env == "dev" %}
/usr/sbin/shutdown -r +5
{% endif %}
