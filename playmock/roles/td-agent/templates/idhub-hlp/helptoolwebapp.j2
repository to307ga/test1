<worker {{td_agent_worker2}}>
  <filter idhub*hlp*.var.log.app.idhub.helptoolwebapp.log>
    @type record_transformer
    enable_ruby
    <record>
      host_groups_name ${tag_parts[0].split(/-[0-9]{3}$/)[0]}
    </record>
    <buffer tag>
    </buffer>
  </filter>
  
  <match idhub*hlp*.var.log.app.idhub.helptoolwebapp.log>
    @type                   forest
    subtype                 copy
    <template>
      <store>
        @type               file
        format              single_value
        append              true
        buffer_path         /db0/tdlogs/buffer/${tag} 
        path                /db0/tdlogs/${tag_parts[0]}/${tag_parts[1..-3]}/${tag_parts[-2]}
        time_slice_format   %Y-%m-%d
        time_slice_wait     10m  
        buffer_chunk_limit  512m
        flush_mode          interval
        flush_interval      {{ gzip_flush_interval }}
        flush_at_shutdown   true
        compress            gzip
      </store>
      <store>
        @type               rewrite_tag_filter
        <rule>
          key               host_groups_name
          pattern           /(goo.*|id.*)$/
          tag               idhub-hlp-helptoolwebapp.$1.${tag}
        </rule>
      </store>
    </template>
  </match>

  <filter idhub-hlp-helptoolwebapp.**>
    @type                   concat
    flush_interval          0
    key                     message
    separator               "### NEW LINE ###"
    multiline_start_regexp  /^[A-Za-z_-]{2,30},\d{4}/\d{1,2}/\d{1,2} \d{1,2}:\d{1,2}:\d{1,2}.\d{3}/
  </filter>

  <match idhub-hlp-helptoolwebapp.**>
    @type                   rewrite_tag_filter
    <rule>
      key                   host_groups_name
      pattern               /.+/
      tag                   merged.${tag}
    </rule>
  </match>

  # parsed_logに全て格納する
  <filter merged.idhub-hlp-helptoolwebapp.**>
    @type                   parser
    key_name                message
    <parse>
      @type                 regexp
      time_format           %Y/%m/%d %H:%M:%S.%L
      expression            /(?<parsed_log>.+)/
      keep_time_key         true
    </parse>
  </filter>


  # マージ用のログにホスト名を付ける
  <filter merged.idhub-hlp-helptoolwebapp.**>
    @type                   record_transformer
    <record>
      hostname              ${tag_parts[3]}
    </record>
    <buffer tag>
    </buffer>
  </filter>


  <match merged.idhub-hlp-helptoolwebapp.**>
    @type                   forest
    subtype                 file
    <template>
      format                hostname_and_message
      append                true
      path                  /db0/tdlogs/merged/${tag_parts[2]}/${tag_parts[4..-3]}/${tag_parts[-2]}
      # path はほとんど上記であっているが違う場合もあるので下にある既存部分を確認する
      time_slice_format     %Y-%m-%d
      buffer_path           /db0/tdlogs/merge-buffer/${tag}
      buffer_chunk_limit    512m
      flush_mode            interval
      flush_interval        {{ merged_flush_interval }}
      flush_at_shutdown     true
    </template>
  </match>


  ###変更対象はここまで###
  {#
    <filter rewritten.idhub-hlp-helptoolwebapp.**>
      @type                   parser
      key_name                message
      <parse>
        @type                 regexp
        time_format           %Y/%m/%d %H:%M:%S.%L
        expression            /^(?<parsed_log>(?<logger>[A-Za-z_-]{2,30}),(?<log-time>\d{4}/\d{1,2}/\d{1,2} \d{1,2}:\d{1,2}:\d{1,2}.\d{3}),(?<file>.*.java):(?<method>[a-zA-Z0-9_<>]{1,300}):(?<line>[0-9]{1,10000}),(?<level>[A-Z]{1,20}),(?<msg>.+))/
        keep_time_key         true
      </parse>
    </filter>

    <filter rewritten.idhub-hlp-helptoolwebapp.**>
      @type                   record_transformer
      <record>
        hostname              ${tag_parts[3]}
      </record>
      <buffer tag>
      </buffer>
    </filter>


    <match rewritten.idhub-hlp-helptoolwebapp.**>
      @type                   forest
      subtype                 copy
      <template>
        # fgwサーバの台数に応じてstoreを作成する
    {% for val in fgw_servers %}
        <store ignore_error> 
          @type                   forward
          format                  hostname_and_message
          buffer_type             file
          buffer_path             /db0/tdlogs/forward-buffer/{{val.server}}/${tag}
          buffer_chunk_limit      32m
          buffer_queue_limit      64
          flush_interval          1s
          flush_at_shutdown       true
          send_timeout            60s
          recover_wait            10s
          heartbeat_interval      1s
          phi_threshold           8
          hard_timeout            300s
          require_ack_response 	  true
          ack_response_timeout	  220
          <server>
            name                  {{val.server}}
            host                  {{val.ip}}
          </server> 
        </store> 
    {% endfor %}
        #<store>
          #@type              stdout
        #</store>
        #<store>
          #@type elasticsearch
          #host 172.17.178.27
          #port 9200
          #index_name fluentd.${tag[1]}.${tag[3]}.${tag[-2]}.%Y-%m-%d
          #<buffer tag, time>
            #timekey 300
          #</buffer>
        #</store>
      </template>
    </match>
  #}

  <match rewritten.idhub-hlp-helptoolwebapp.**>
    @type null
  </match>

  <match merged.idhub-hlp-helptoolwebapp.**>
    @type null
  </match>
</worker>
