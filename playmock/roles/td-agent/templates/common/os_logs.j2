<worker {{td_agent_worker0}}>
  <filter {goo*,id*}.**.{messages,secure,yum.log}>
    @type record_transformer
    enable_ruby
    <record>
      host_groups_name ${tag_parts[0].split(/-[0-9]{3}$/)[0]}
    </record>
    <buffer tag>
    </buffer>
  </filter>
  
  <match {goo*,id*}.**.{messages,secure,yum.log}>
    @type                   forest
    subtype                 copy
    <template>
      <store>
        @type               file
        format              single_value
        append              true
        buffer_path         /db0/tdlogs/buffer/${tag} 
        path                /db0/tdlogs/${tag_parts[0]}/${tag_parts[-3..-2]}/${tag_parts[-1]}
        time_slice_format   %Y-%m-%d
        time_slice_wait     10m  
        buffer_chunk_limit  512m
        flush_mode          interval
        flush_interval      {{ gzip_flush_interval }}
        flush_at_shutdown   true
        compress            gzip
      </store>
      <store>
        @type               rewrite_tag_filter
        <rule>
          key               host_groups_name
          pattern           /(goo.*|id.*)$/
          tag               oslogs.$1.${tag}
        </rule>
      </store>
    </template>
  </match>

  ###マージログを優先処理するため変更###
  <match oslogs.**>
    # マージログ出力優先
    @type                   rewrite_tag_filter
    <rule>
      key                   host_groups_name
      pattern               /.+/
      tag                   merged.${tag}
    </rule>
  </match>

  # parsed_logに全て格納する
  <filter merged.oslogs.**>
    @type                   parser
    key_name                message
    <parse>
      @type                 regexp
      time_format           %Y/%m/%d %H:%M:%S.%L
      expression            /(?<parsed_log>.+)/
      keep_time_key         true
    </parse>
  </filter>

  # マージ用のログにホスト名を付ける
  # <filter merged.oslogs.**>
  <filter merged.oslogs.**.yum.log>
    @type                   record_transformer
    <record>
      hostname              ${tag_parts[3]}
    </record>
    <buffer tag>
    </buffer>
  </filter>

  <match merged.oslogs.**.yum.log>
    @type                   forest
    subtype                 file
    <template>
      format                hostname_and_message
      append                true
      # path                  /db0/tdlogs/merged/${tag_parts[2]}/${tag_parts[4..-3]}/${tag_parts[-2]}
      path                  /db0/tdlogs/merged/common/${tag_parts[4..-3]}/${tag_parts[-2]}
      # path はほとんど上記であっているが違う場合もあるので下にある既存部分を確認する
      time_slice_format     %Y-%m-%d
      buffer_path           /db0/tdlogs/merge-buffer/${tag}
      buffer_chunk_limit    512m
      flush_mode            interval
      flush_interval        {{ merged_flush_interval }}
      flush_at_shutdown     true
    </template>
  </match>

  <match merged.oslogs.**.{messages,secure}>
    @type                   forest
    subtype                 file
    <template>
      format                hostname_and_message
      append                true
      # path                  /db0/tdlogs/merged/${tag_parts[2]}/${tag_parts[4..-2]}/${tag_parts[-1]}
      path                  /db0/tdlogs/merged/common/${tag_parts[4..-2]}/${tag_parts[-1]}
      # path はほとんど上記であっているが違う場合もあるので下にある既存部分を確認する
      time_slice_format     %Y-%m-%d
      buffer_path           /db0/tdlogs/merge-buffer/${tag}
      buffer_chunk_limit    512m
      flush_mode            interval
      flush_interval        {{ merged_flush_interval }}
      flush_at_shutdown     true
    </template>
  </match>

  <match {goo*,id*}.**.{messages,secure,yum.log}>
    @type null
  </match>
</worker>
