<worker {{td_agent_worker0}}>
  <source>
    @type tail
    path                          /db0/tdlogs/merged/gooid-{{ project_id_number_env }}-web/var.log.httpd/modsec_performance.%Y-%m-%d.log
    pos_file                      /var/log/td-agent/elastic-sender_modsec_performance.pos
    pos_file_compaction_interval  240h 
    rotate_wait                   60
    tag                           gooid-web_modsec_performance_log
    <parse>
      @type         regexp
      time_format   %d/%b/%Y:%H:%M:%S %z
      expression    /^(?<host>[^\s]*)\s(?<virtual-host>[^\s]*)\s(?<remotehost>[^\s]*)\s(\[(?<log-time>[^\]]*)\])\s(?<unique_id>[^\s]*)\s"(?<first_line_of_request>.*)"\s(?<status_code>[^\s]*)\s(?<status_of_connection>[^\s]*)\s\| (?<bytes_received>[^\s]*)\s(?<bytes_send>[^\s]*)\s\|\s(?<mod_security-time1>[^\s]*)\s(?<mod_security-time2>[^\s]*)\s(?<mod_security-time3>[^\s]*)\s(?<processing_times>.*)$/
      # keep_time_key true
    </parse>
  </source>

  <match gooid-web_modsec_performance_log.**>
    @type 	              elasticsearch
    scheme	              https
    ssl_version           {{ elasticsearch.ssl_version }}
    # Copy from /etc/elasticsearch/certs/http_ca.crt on the els server
    ca_file               {{ elasticsearch.ca_file }}
    # host 	                {{ elasticsearch.hostname }}
    # hosts https://customhost.com:443/path,https://username:password@host-failover.com:443
    # port 9200
    hosts                 {{ elasticsearch.hosts }}
    user                  {{ elasticsearch.user }}
    password              {{ elasticsearch.pwd }}
    # Does not work with elasticsearch_dynamic
    # index_name            fluentd.${tag}-%Y%m%d
    logstash_format       true
    include_timestamp     true
    logstash_prefix       fluentd.${tag}
    logstash_dateformat   %Y%m%d
    time_key_format %Y-%m-%dT%H:%M:%S.%N%z
    # include_tag_key      true
    pipeline              remotehost-geoip
    with_transporter_log  true
    @log_level            {{ plugin_log_level.elasticsearch }}
    # utc_index             false
    # time_key created_at
    # time_key_format     %a %b %d %H:%M:%S %z %Y
    <buffer tag,time>
      timekey             1d
      # flush_interval      1m
    </buffer>
    flush_interval        1m
  </match>  
</worker>
