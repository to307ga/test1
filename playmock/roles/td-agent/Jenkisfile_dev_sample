
pipeline {
  agent any // 環境の指定(anyなので指定なし)
  environment{
    ANSIBLE_CONFIG='roles/common/files/ansible.cfg'
    PYTHONUNBUFFERED=1
  }
  stages{
    stage('clean-pre') {
      steps {
        deleteDir()
      }
    }
    stage("checkout"){
      steps{
        git branch: "feature_td-agent", url: 'https://container.wbo110.goo.ne.jp/repo/nttr/playbook.git', credentialsId: '10a597ce-b3f6-49b5-8b42-fa1d32a294ea'
      }
      //ステップ終了処理
      post{
        //常に実行
        always{
          sh "ls -ltr"
        }
        //成功時
        success{
          sh "pwd"
          sh "hostname"
          sh "whoami"
          sh "ls -ltr roles/td-agent/templates/zabbix-sender/oidc_request_count.j2"
        }
      }
    }
    stage('ansible-playbook Dry run'){
      steps{
        // sh: 'ansible-playbook -i inventories/virtualbox/hosts -l web00.test.internal td-agent.yml --check -u gooscp --private-key $gooscp' 
        // gooscp
        // ansiblePlaybook become: true, credentialsId: '971c11e6-fe26-4fda-bce2-974ccb410cfa', extras: '--check --diff -vvvvv', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: 'gooid-30-dev-log-002', playbook: 'gooid_log_server.yml', tags: 'td-agent'
        //g-gooid_ansible
        // ansiblePlaybook become: true, credentialsId: '1f2886ac-2aaa-473f-ad26-44051e37e89b', extras: '--check --diff', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
        ansiblePlaybook become: true, credentialsId: 'd1328d97-13c3-44c0-8bb3-cd465a140e7c', disableHostKeyChecking: true, extras: '--check --diff ', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
      }
    }
    stage('ansible-playbook'){
      steps{
        // sh: 'ansible-playbook -i inventories/virtualbox/hosts -l web00.test.internal td-agent.yml --check -u gooscp --private-key $gooscp' 
        // ansiblePlaybook become: true, credentialsId: '1f2886ac-2aaa-473f-ad26-44051e37e89b', extras: '--diff ', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
        ansiblePlaybook become: true, credentialsId: 'd1328d97-13c3-44c0-8bb3-cd465a140e7c', disableHostKeyChecking: true, extras: '--check --diff ', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
      }
    }
    stage("Artifact"){
      steps{
        archiveArtifacts "**/*.*"
      }
    }
  }
}
