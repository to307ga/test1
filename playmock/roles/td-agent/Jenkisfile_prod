
pipeline {
  agent any // 環境の指定(anyなので指定なし)
  environment{
    ANSIBLE_CONFIG='roles/common/files/ansible.cfg'
    PYTHONUNBUFFERED=1
  }
  stages{
    stage('clean-pre') {
      steps {
        deleteDir()
      }
    }
    stage("checkout"){
      steps{
        git branch: "feature_td-agent", url: 'https://container.wbo110.goo.ne.jp/repo/nttr/playbook.git', credentialsId: 'gitea'
      }
      //ステップ終了処理
      post{
        //常に実行
        always{
          sh "ls -ltr"
        }
        //成功時
        success{
          sh "pwd"
          sh "hostname"
          sh "whoami"
          sh "ls -ltr roles/td-agent/templates/zabbix-sender/oidc_request_count.j2"
        }
      }
    }
    stage('ansible-playbook Dry run'){
      steps{
        // sh: 'ansible-playbook -i inventories/virtualbox/hosts -l web00.test.internal td-agent.yml --check -u gooscp --private-key $gooscp' 
        // gooscp
        // ansiblePlaybook become: true, credentialsId: '971c11e6-fe26-4fda-bce2-974ccb410cfa', extras: '--check --diff -vvvvv', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: 'gooid-30-dev-log-002', playbook: 'gooid_log_server.yml', tags: 'td-agent'
        //g-gooid_ansible
        ansiblePlaybook become: true, credentialsId: 'ce7c7c2f-d4e1-45b3-bd9c-ee0d502fb473', extras: '--check --start-at-task="debug ansible_hostname" --diff -vvv', installation: 'Jenkins_Ansible', inventory: 'inventories/production/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
      }
    }
    stage('ansible-playbook'){
      steps{
        // sh: 'ansible-playbook -i inventories/virtualbox/hosts -l web00.test.internal td-agent.yml --check -u gooscp --private-key $gooscp' 
        // ansiblePlaybook become: true, credentialsId: '1f2886ac-2aaa-473f-ad26-44051e37e89b', extras: '--diff ', installation: 'Jenkins_Ansible', inventory: 'inventories/development/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
        ansiblePlaybook become: true, credentialsId: 'ce7c7c2f-d4e1-45b3-bd9c-ee0d502fb473', extras: '--diff --start-at-task="debug ansible_hostname" ', installation: 'Jenkins_Ansible', inventory: 'inventories/production/inventory.ini', limit: "${SERVER_NAME}", playbook: 'gooid_log_server.yml', tags: 'td-agent'
      }
    }
    stage("Artifact"){
      steps{
        archiveArtifacts "**/*.*"
      }
    }
  }
}
