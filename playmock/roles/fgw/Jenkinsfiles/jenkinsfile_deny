
pipeline {
  agent any // 環境の指定(anyなので指定なし)
  environment{
    ANSIBLE_CONFIG='roles/common/files/ansible.cfg'
    PYTHONUNBUFFERED=1
  }
  stages{
    stage('clean-pre') {
      steps {
        deleteDir()
      }
    }
    stage("checkout"){
      steps{
        git branch: "master", url: 'https://container.wbo110.goo.ne.jp/repo/nttr/playbook.git', credentialsId: 'gitea'
      }
      //ステップ終了処理
      post{
        //常に実行
        always{
          sh "ls -ltr"
        }
        //成功時
        success{
          sh "pwd"
          sh "hostname"
          sh "whoami"
        }
      }
    }
    stage('ansible-playbook Dry run'){
      steps{
        ansiblePlaybook become: true, credentialsId: 'ce7c7c2f-d4e1-45b3-bd9c-ee0d502fb473', extras: '--check --diff --vault-password-file ~/.vault-password ', installation: 'Jenkins_Ansible', inventory: 'inventories/production/jenkins.ini', limit: "${SERVER_NAME}", playbook: 'goldzone_settings.yml', tags: 'deny'
      }
    }
    stage('ansible-playbook'){
      steps{
        ansiblePlaybook become: true, credentialsId: 'ce7c7c2f-d4e1-45b3-bd9c-ee0d502fb473', extras: '--diff --vault-password-file ~/.vault-password ', installation: 'Jenkins_Ansible', inventory: 'inventories/production/jenkins.ini', limit: "${SERVER_NAME}", playbook: 'goldzone_settings.yml', tags: 'deny'
      }
    }
    stage("Artifact"){
      steps{
        archiveArtifacts "**/*.*"
      }
    }
  }
}
