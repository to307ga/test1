<VirtualHost *:443>
    DocumentRoot "/var/www/html/"
    ServerName idhub.wbo110.goo.ne.jp:443

    SSLEngine on
    SSLProtocol -ALL +TLSv1.2
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256
    SSLHonorCipherOrder Off

    #SSLCertificateFile /etc/httpd/conf/ssl/idhub.wbo110.goo.ne.jp.crt
    SSLCertificateFile /etc/letsencrypt/live/idhub.wbo110.goo.ne.jp/cert.pem
    #SSLCertificateKeyFile /etc/httpd/conf/ssl/idhub.wbo110.goo.ne.jp.key
    SSLCertificateKeyFile /etc/letsencrypt/live/idhub.wbo110.goo.ne.jp/privkey.pem

    SSLProxyEngine on
    ProxyRequests off
    ProxyPreserveHost on
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off
    SSLProxyCheckPeerExpire off

    RequestHeader set X-Forwarded-Proto https

    # （親切リダイレクト）"/" (root) は ヘルプツールのTopへ
    RedirectMatch permanent ^/$ /d_help/apl/visitor/login

    <Location />
        <RequireAny>
            AuthName "User / (Password+NNNNNN)"
            AuthType Basic
            AuthBasicProvider OTP
            Require valid-user

            {#- フルパスでないと動作しないのかもしれない +#}
            AuthUserFile /etc/httpd/otp/users.pin
            OTPAuthUsersFile /etc/httpd/otp/users.token
            OTPAuthPINAuthProvider file
            # 6 hours
            OTPAuthMaxLinger 21600
            # アクセス元IPが変わっても認証状態を有効
            OTPAuthLogoutOnIPChange Off
            
            Include conf/acl-no-otp-servers.conf
        </RequireAny>
    </Location>

    ProxyRequests off


    ProxyPass / balancer://idhub-21-pro-hlp-000/
    ProxyPassReverse / balancer://idhub-21-pro-hlp-000/

    # Active/Standbyの設定
    #
    # "[proxy_balancer:emerg] [pid 11045] (22)Invalid argument: AH01185: worker slotmem_create failed"
    # といったエラーメッセージでHTTPDが起動できない場合、 /var/run/httpd/slotmem-* ファイルを削除してください。
    <Proxy balancer://idhub-21-pro-hlp-000>
        BalancerMember https://idhub-21-pro-hlp-001 loadfactor=1
        BalancerMember https://idhub-21-pro-hlp-002 status=+H
    </Proxy>
</VirtualHost>
