---
# Tomcatのconfig設定を行う

# ディレクトリの権限変更
- name: apache-tomcat-{{ tomcat_version }}の権限変更
  file:
    state: directory
    path: /opt/apache-tomcat-{{ tomcat_version }}
    mode: 0755
    owner: root
    group: root

- name: Link /opt/tomcat -> /opt/apache-tomcat-{{ tomcat_version }}
  file:
    state: link
    src: /opt/apache-tomcat-{{ tomcat_version }}
    dest: /opt/tomcat
    follow: no     # symbolic linkのオーナーとグループを変更する
    owner: tomcat
    group: tomcat
  when: not ansible_check_mode

- name: Make directories
  file: path={{ item }} state=directory owner=tomcat group=tomcat
  with_items:
  - /var/log/tomcat
  - /var/log/app
  - /usr/local/tomcat
  - /var/log/app/idc
  - /usr/local/tomcat/lib
  - /usr/local/tomcat/temp
  - /usr/local/tomcat/webapps
  - /usr/local/tomcat/work
  - /usr/local/tomcat/conf
  - /usr/local/tomcat/conf/Catalina
  - /usr/local/tomcat/conf/Catalina/localhost

- name: Link /usr/local/tomcat/logs -> /var/log/tomcat
  file:
    state: link
    src: /var/log/tomcat
    dest: /usr/local/tomcat/logs
    owner: tomcat
    group: tomcat
    follow: no    # symbolic linkのオーナーとグループを変更する
  when: not ansible_check_mode

- name: Tomcatのオリジナルファイルをコピー in /usr/local/tomcat/bin/
  copy:
    src: /opt/tomcat/bin/
    dest: /usr/local/tomcat/bin/
    owner: tomcat
    group: tomcat
    remote_src: yes

- name: Copy setenv.sh
  template:
    src: ../templates/setenv.sh.j2
    dest: /usr/local/tomcat/bin/setenv.sh
    backup: yes 
    owner: tomcat
    group: tomcat
    mode: 0755

- name: Copy context.xml
  template:
    src: ../templates/context.xml.j2
    dest: /usr/local/tomcat/conf/context.xml
    backup: yes 
    owner: tomcat
    group: tomcat
    mode: 0600
  notify:
    - tomcat_msg_restart_msg

- name: Copy tomcat.service
  template:
    src: ../templates/tomcat.service.j2
    dest: /etc/systemd/system/tomcat.service
    backup: yes 
    owner: tomcat
    group: tomcat
    mode: 0644

- name: Copy server.xml
  template:
    src: ../templates/server.xml.j2
    dest: /usr/local/tomcat/conf/server.xml
    backup: yes 
    owner: tomcat
    group: tomcat
    mode: 0644
  notify:
    - tomcat_msg_restart_msg

- name: Copy to /usr/local/tomcat/conf/Catalina/localhost/g_web.xml
  template:
    src: templates/g_web.xml.j2
    dest: /usr/local/tomcat/conf/Catalina/localhost/g_web.xml
    backup: yes
    owner: tomcat
    group: tomcat
    mode: 0644
  notify:
    - tomcat_msg_restart_msg

- name: Copy tomcat-users.xml
  template:
    src: templates/tomcat-users.xml.j2
    dest: /usr/local/tomcat/conf/tomcat-users.xml
    backup: yes
    owner: tomcat
    group: tomcat
    mode: 0600
  notify:
    - tomcat_msg_restart_msg

- name: Copy tomcat-users.xsd
  template:
    src: templates/tomcat-users.xsd.j2
    dest: /usr/local/tomcat/conf/tomcat-users.xsd
    backup: yes
    owner: tomcat
    group: tomcat
    mode: 0600
  notify:
    - tomcat_msg_restart_msg

- name: Copy web.xml
  template:
    src: templates/web.xml.j2
    dest: /usr/local/tomcat/conf/web.xml
    owner: tomcat
    group: tomcat
    mode: 0644
  notify:
    - tomcat_msg_restart_msg