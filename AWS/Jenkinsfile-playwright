pipeline {
    agent any
    
    parameters {
        string(name: 'SEARCH_KEYWORD', defaultValue: 'AWS', description: 'Googleæ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰')
        choice(name: 'BROWSER', choices: ['chromium', 'firefox', 'webkit'], description: 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ–ãƒ©ã‚¦ã‚¶')
        booleanParam(name: 'HEADLESS', defaultValue: true, description: 'ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ')
    }
    
    environment {
        NODE_VERSION = '18'
        PLAYWRIGHT_BROWSERS_PATH = '/var/jenkins_home/playwright-browsers'
        REPORTS_DIR = 'test-reports'
        SCREENSHOTS_DIR = 'screenshots'
    }
    
    stages {
        stage('ç’°å¢ƒæº–å‚™') {
            steps {
                script {
                    echo "ğŸš€ Playwright ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æº–å‚™ä¸­..."
                    echo "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${params.SEARCH_KEYWORD}"
                    echo "ãƒ–ãƒ©ã‚¦ã‚¶: ${params.BROWSER}"
                    echo "ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹: ${params.HEADLESS}"
                }
                
                // ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
                sh '''
                    mkdir -p ${REPORTS_DIR}
                    mkdir -p ${SCREENSHOTS_DIR}
                    rm -rf ${REPORTS_DIR}/* ${SCREENSHOTS_DIR}/* || true
                '''
            }
        }
        
        stage('Node.js & Playwright ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—') {
            steps {
                sh '''
                    # ç¾åœ¨ã®Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
                    echo "ğŸ” ç’°å¢ƒè¨ºæ–­æƒ…å ±:"
                    echo "ç¾åœ¨ã®Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
                    node --version || echo "Node.js not found"
                    echo "npm version:"
                    npm --version || echo "npm not found"
                    echo "PATH: $PATH"
                    echo "Working Directory: $(pwd)"
                    
                    # Node.js 18ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆFargateå¯¾å¿œï¼‰
                    if [ "$(node --version 2>/dev/null | cut -d'v' -f2 | cut -d'.' -f1)" -lt "18" ] 2>/dev/null; then
                        echo "Node.js 18ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
                        
                        # Node.js 18 ãƒã‚¤ãƒŠãƒªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        cd /tmp
                        wget -q https://nodejs.org/dist/v18.19.0/node-v18.19.0-linux-x64.tar.xz
                        tar -xf node-v18.19.0-linux-x64.tar.xz
                        
                        # PATHè¨­å®š
                        export PATH="/tmp/node-v18.19.0-linux-x64/bin:$PATH"
                        
                        # ç¢ºèª
                        node --version
                        npm --version
                    fi
                    
                    # PATHã«Node.js 18ã‚’è¿½åŠ ï¼ˆpackage.jsonä½œæˆã¯å¾Œã§å®Ÿè¡Œï¼‰
                    export PATH="/tmp/node-v18.19.0-linux-x64/bin:$PATH"
                    
                    # åˆæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã®ã¿å®Ÿè¡Œ
                    echo "ğŸ“¦ åˆæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
                    rm -rf node_modules package-lock.json package.json 2>/dev/null || true
                    
                    # ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ç¢ºèª
                    echo "ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±:"
                    cat /etc/os-release | head -5 || echo "OSæƒ…å ±å–å¾—ä¸å¯"
                    which dnf && echo "dnf available" || echo "dnf not found"
                    
                    # ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆAlmaLinux/Fargateå¯¾å¿œï¼‰
                    echo "ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
                    
                    # AlmaLinuxç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆdnfä½¿ç”¨ï¼‰
                    dnf install -y \
                        libnss3 \
                        libnspr4 \
                        libatk1.0-0 \
                        libatk-bridge2.0-0 \
                        libcups2 \
                        libdrm2 \
                        libxcb1 \
                        libatspi2.0-0 \
                        libx11-6 \
                        libxcomposite1 \
                        libxdamage1 \
                        libxext6 \
                        libxfixes3 \
                        libxrandr2 \
                        libgbm1 \
                        libpango-1.0-0 \
                        libcairo2 \
                        libasound2 \
                        2>/dev/null || {
                        
                        echo "âš ï¸ dnfã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—ã€AlmaLinuxäº’æ›ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å†è©¦è¡Œ..."
                        dnf install -y \
                            nss \
                            nspr \
                            atk \
                            at-spi2-atk \
                            cups-libs \
                            libdrm \
                            libxcb \
                            at-spi2-core \
                            libX11 \
                            libXcomposite \
                            libXdamage \
                            libXext \
                            libXfixes \
                            libXrandr \
                            mesa-libgbm \
                            pango \
                            cairo \
                            alsa-lib \
                            2>/dev/null || echo "âš ï¸ ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—ã€ç¶™ç¶š..."
                    }
                    
                    # Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆAlmaLinux/Fargateå¯¾å¿œï¼‰
                    echo "ğŸŒ Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
                    
                    # ã‚°ãƒ­ãƒ¼ãƒãƒ«Playwrightã®ç¢ºèª
                    if command -v playwright >/dev/null 2>&1; then
                        echo "âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«PlaywrightãŒåˆ©ç”¨å¯èƒ½"
                        playwright install ${BROWSER} || echo "âš ï¸ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—"
                    fi
                    
                    # ãƒ­ãƒ¼ã‚«ãƒ«Playwrightãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ç‰ˆã‚’æ´»ç”¨ï¼‰
                    echo "ğŸ”— ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šç¢ºèª..."
                    if [ -d "/var/jenkins_home/playwright-browsers/chromium-1091" ]; then
                        echo "âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãŒåˆ©ç”¨å¯èƒ½ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—"
                        export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
                    else
                        echo "ğŸŒ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«..."
                        npx playwright install ${BROWSER} || {
                            echo "âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—ã€ç¶™ç¶š..."
                            export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
                        }
                    fi
                '''
            }
        }
        
        stage('ãƒ†ã‚¹ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ') {
            steps {
                sh '''
                    # Playwrightè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
                    cat > playwright.config.js << 'EOF'
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: 0,  // ãƒªãƒˆãƒ©ã‚¤ãªã—ï¼ˆé«˜é€ŸåŒ–ï¼‰
  workers: 1,  // AlmaLinux/Fargateç’°å¢ƒã§ã¯ä¸¦åˆ—åº¦ã‚’æŠ‘åˆ¶
  reporter: [
    ['html', { 
      outputFolder: 'playwright-report', 
      open: 'never',
      host: 'localhost',
      port: 9323
    }],
    ['junit', { outputFile: 'junit-results.xml', includeProjectInTestName: true }],
    ['json', { outputFile: 'test-results.json' }],
    ['list']
  ],
  use: {
    baseURL: 'https://google.co.jp',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
    headless: true,  // Fargateç’°å¢ƒã§ã¯å¼·åˆ¶ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹
    ignoreHTTPSErrors: true,
    timeout: 15000,  // 15ç§’ã«çŸ­ç¸®
    navigationTimeout: 10000,  // 10ç§’ã«çŸ­ç¸®
    actionTimeout: 5000,  // 5ç§’ã«çŸ­ç¸®
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‘ã‚¹æŒ‡å®š
    channel: process.env.PLAYWRIGHT_BROWSERS_PATH ? undefined : undefined
  },
  projects: [
    {
      name: process.env.BROWSER || 'chromium',
      use: {
        ...devices['Desktop Chrome'],
        // Fargateç’°å¢ƒæœ€é©åŒ–: å˜ä¸€ãƒ—ãƒ­ã‚»ã‚¹å•é¡Œã‚’å›é¿ã™ã‚‹æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
        launchOptions: {
          headless: true,
          // æ®µéšçš„ãƒ—ãƒ­ã‚»ã‚¹åˆ¶å¾¡ï¼ˆsingle-processã®ä»£æ›¿ï¼‰
          args: [
            '--no-sandbox', 
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-gpu',
            '--no-first-run',
            '--no-zygote',
            // å˜ä¸€ãƒ—ãƒ­ã‚»ã‚¹å•é¡Œå›é¿ã®ãŸã‚ã€åˆ¶é™ä»˜ããƒãƒ«ãƒãƒ—ãƒ­ã‚»ã‚¹
            '--disable-background-timer-throttling',
            '--disable-renderer-backgrounding',
            '--disable-backgrounding-occluded-windows',
            '--disable-ipc-flooding-protection',
            '--max_old_space_size=512', // ãƒ¡ãƒ¢ãƒªåˆ¶é™
            '--disable-extensions',
            '--disable-default-apps',
            '--disable-component-update',
            '--disable-web-security',
            '--allow-running-insecure-content',
            '--disable-features=VizDisplayCompositor', // WTFåˆæœŸåŒ–ç«¶åˆå›é¿
            '--disable-software-rasterizer',
            '--disable-background-networking'
          ],
          timeout: 60000 // åˆæœŸåŒ–ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·
        }
      },
    }
  ],
  outputDir: 'test-results/',
});
EOF

                    # ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
                    mkdir -p tests
                '''
            }
        }
        
        stage('ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ') {
            steps {
                sh '''
                    # Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆï¼ˆå …ç‰¢åŒ–ï¼‰
                    cat > tests/google-search.spec.js << 'EOF'
import { test, expect } from '@playwright/test';

test.describe('Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆ', () => {
  let searchKeyword;
  
  // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿æˆ¦ç•¥ã‚’å®šç¾©
  const getSearchBoxSelectors = () => [
    'input[name="q"]',
    'textarea[name="q"]', 
    '[name="q"]',
    '[aria-label*="æ¤œç´¢"]',
    '[title*="æ¤œç´¢"]',
    'input[type="text"]',
    '.gLFyf',  // Googleæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®å®Ÿéš›ã®ã‚¯ãƒ©ã‚¹
    'input[placeholder*="æ¤œç´¢"]'
  ];

  const findSearchBox = async (page) => {
    const selectors = getSearchBoxSelectors();
    
    for (const selector of selectors) {
      try {
        const element = page.locator(selector);
        await element.waitFor({ state: 'visible', timeout: 2000 });
        console.log(`âœ… æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: ${selector}`);
        return element;
      } catch (error) {
        console.log(`âš ï¸ ã‚»ãƒ¬ã‚¯ã‚¿å¤±æ•—: ${selector}`);
        continue;
      }
    }
    
    // æœ€å¾Œã®æ‰‹æ®µï¼šä»»æ„ã®inputè¦ç´ 
    try {
      const fallbackInput = page.locator('input').first();
      await fallbackInput.waitFor({ state: 'visible', timeout: 2000 });
      console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ä½¿ç”¨');
      return fallbackInput;
    } catch (e) {
      throw new Error('æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  };
  
  test.beforeEach(async ({ page }) => {
    searchKeyword = process.env.SEARCH_KEYWORD || 'AWS';
    console.log(`ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${searchKeyword}`);
    
    // ãƒšãƒ¼ã‚¸è¨­å®šæœ€é©åŒ–
    await page.setDefaultTimeout(15000);
    await page.setDefaultNavigationTimeout(20000);
  });

  test('Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹', async ({ page }) => {
    try {
      // Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
      await page.goto('https://google.com', { waitUntil: 'domcontentloaded', timeout: 8000 });
      
      // CookieåŒæ„ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°å‡¦ç†
      try {
        const acceptButton = page.locator('button:has-text("ã™ã¹ã¦åŒæ„"), button:has-text("I agree"), button:has-text("Accept")');
        await acceptButton.click({ timeout: 2000 });
        await page.waitForTimeout(500);
      } catch (e) { 
        console.log('CookieåŒæ„ãƒœã‚¿ãƒ³ãªã—ï¼ˆæ­£å¸¸ï¼‰'); 
      }
      
      // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
      await expect(page).toHaveTitle(/Google/);
      
      // å …ç‰¢ãªæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹
      const searchBox = await findSearchBox(page);
      
      // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼‰- ã‚¨ãƒ©ãƒ¼ç„¡è¦–
      try {
        await page.screenshot({ 
          path: 'screenshots/01-google-top.jpg', 
          type: 'jpeg',
          quality: 70,
          fullPage: false
        });
      } catch (screenshotError) {
        console.log('âš ï¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ã‚¹ã‚­ãƒƒãƒ—');
      }
      
      console.log('âœ… Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ');
    } catch (error) {
      console.log('âŒ Googleã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error.message);
      throw error;
    }
  });

  test('AWSæ¤œç´¢å®Ÿè¡Œï¼ˆDuckDuckGoä»£æ›¿ï¼‰', async ({ page }) => {
    // ãƒ­ãƒœãƒƒãƒˆæ¤œå‡ºå›é¿ã®ãŸã‚ã€ã‚ˆã‚Šãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’ä½¿ç”¨
    await page.goto('https://duckduckgo.com', { waitUntil: 'domcontentloaded', timeout: 8000 });
    
    console.log('ğŸ¦† DuckDuckGoã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ­ãƒœãƒƒãƒˆæ¤œå‡ºå›é¿ï¼‰');
    
    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹ï¼ˆDuckDuckGoç”¨ï¼‰
    const duckBoxSelectors = [
      'input[name="q"]',
      '#search_form_input_homepage',
      '#search_form_input',
      'input[type="text"]',
      '.js-search-input'
    ];
    
    let searchBox = null;
    for (const selector of duckBoxSelectors) {
      try {
        searchBox = page.locator(selector);
        await searchBox.waitFor({ state: 'visible', timeout: 2000 });
        console.log(`âœ… DuckDuckGoæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: ${selector}`);
        break;
      } catch (e) {
        console.log(`âš ï¸ DuckDuckGoã‚»ãƒ¬ã‚¯ã‚¿å¤±æ•—: ${selector}`);
        continue;
      }
    }
    
    if (!searchBox) {
      console.log('âš ï¸ DuckDuckGoæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹æœªç™ºè¦‹ã€Googleãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
      // Googleãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç°¡æ½”ç‰ˆï¼‰
      await page.goto('https://google.com', { waitUntil: 'domcontentloaded', timeout: 8000 });
      searchBox = await findSearchBox(page);
    }
    
    // æ¤œç´¢å®Ÿè¡Œ
    await searchBox.fill(searchKeyword);
    await searchBox.press('Enter');
    await page.waitForLoadState('domcontentloaded');
    
    // æ¤œç´¢çµæœç¢ºèªï¼ˆDuckDuckGo + Googleå¯¾å¿œï¼‰
    const resultSelectors = [
      '#links', '.result', '.results_links',  // DuckDuckGo
      '#search', '#rso', '.g',                // Google
      'div[role="main"]', 
      'main', 
      'body'
    ];
    
    let foundResults = false;
    for (const selector of resultSelectors) {
      try {
        const results = page.locator(selector);
        await expect(results.first()).toBeVisible({ timeout: 3000 });
        console.log(`âœ… æ¤œç´¢çµæœç™ºè¦‹: ${selector}`);
        foundResults = true;
        break;
      } catch (e) {
        console.log(`âš ï¸ æ¤œç´¢çµæœã‚»ãƒ¬ã‚¯ã‚¿å¤±æ•—: ${selector}`);
        continue;
      }
    }
    
    // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼ˆæˆåŠŸ/å¤±æ•—å•ã‚ãšï¼‰
    try {
      await page.screenshot({ 
        path: 'screenshots/03-search-results.jpg', 
        type: 'jpeg',
        quality: 90,
        fullPage: true 
      });
    } catch (e) {
      console.log('âš ï¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—å¤±æ•—ã€ç¶™ç¶š...');
    }
    
    if (foundResults) {
      console.log('âœ… AWSæ¤œç´¢å®Ÿè¡ŒæˆåŠŸ');
    } else {
      console.log('âš ï¸ æ¤œç´¢çµæœç¢ºèªå¤±æ•—ã ãŒã€ãƒ†ã‚¹ãƒˆç¶™ç¶š');
    }
  });

  test('Webãƒšãƒ¼ã‚¸åŸºæœ¬æ©Ÿèƒ½ç¢ºèª', async ({ page }) => {
    // ã‚ˆã‚Šå®‰å®šã—ãŸãƒ†ã‚¹ãƒˆã‚µã‚¤ãƒˆã‚’ä½¿ç”¨ï¼ˆãƒ­ãƒœãƒƒãƒˆæ¤œå‡ºå›é¿ï¼‰
    await page.goto('https://example.com', { waitUntil: 'domcontentloaded', timeout: 8000 });
    
    console.log('ğŸŒ Example.comã§åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ');
    
    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    await expect(page).toHaveTitle(/Example Domain/);
    console.log('âœ… ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèªæˆåŠŸ');
    
    // åŸºæœ¬è¦ç´ ã®å­˜åœ¨ç¢ºèª
    const basicSelectors = [
      'h1',           // è¦‹å‡ºã—
      'p',            // ãƒ‘ãƒ©ã‚°ãƒ©ãƒ•  
      'a',            // ãƒªãƒ³ã‚¯
      'body',         // bodyè¦ç´ 
      'html'          // htmlè¦ç´ 
    ];
    
    let foundElements = 0;
    for (const selector of basicSelectors) {
      try {
        const element = page.locator(selector);
        await expect(element.first()).toBeVisible({ timeout: 2000 });
        const count = await element.count();
        console.log(`ğŸ“Š ${selector}è¦ç´ æ•°: ${count} ä»¶`);
        foundElements++;
      } catch (e) {
        console.log(`âš ï¸ ${selector}è¦ç´ ç¢ºèªå¤±æ•—`);
      }
    }
    
    // ãƒªãƒ³ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆMore information...ï¼‰
    try {
      const moreInfoLink = page.locator('a:has-text("More information")');
      await expect(moreInfoLink).toBeVisible({ timeout: 3000 });
      console.log('âœ… "More information"ãƒªãƒ³ã‚¯ç™ºè¦‹');
      
      // ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ï¼ˆæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãå‡¦ç†ï¼‰
      const [newPage] = await Promise.all([
        page.context().waitForEvent('page'),
        moreInfoLink.click()
      ]);
      
      console.log('âœ… ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æˆåŠŸ');
      await newPage.close();
      
    } catch (e) {
      console.log('âš ï¸ ãƒªãƒ³ã‚¯ãƒ†ã‚¹ãƒˆå¤±æ•—ã€ç¶™ç¶š...');
    }
    
    // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå–å¾—
    await page.screenshot({ 
      path: 'screenshots/04-example-page.jpg', 
      type: 'jpeg',
      quality: 90,
      fullPage: true 
    });
    
    console.log(`âœ… åŸºæœ¬æ©Ÿèƒ½ç¢ºèªæˆåŠŸ (${foundElements}/${basicSelectors.length}è¦ç´ )`);
  });

  test('ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºç¢ºèª', async ({ page }) => {
    // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºè¨­å®š
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('https://google.com', { waitUntil: 'domcontentloaded', timeout: 8000 });
    
    // CookieåŒæ„å‡¦ç†
    try {
      const acceptButton = page.locator('button:has-text("ã™ã¹ã¦åŒæ„"), button:has-text("I agree"), button:has-text("Accept")');
      await acceptButton.click({ timeout: 2000 });
    } catch (e) { console.log('CookieåŒæ„ãƒœã‚¿ãƒ³ãªã—'); }
    
    // ãƒ¢ãƒã‚¤ãƒ«ç’°å¢ƒã§ã®æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç¢ºèª
    const searchBox = await findSearchBox(page);
    await searchBox.fill(searchKeyword);
    await searchBox.press('Enter');
    await page.waitForLoadState('domcontentloaded');
    
    // ãƒ¢ãƒã‚¤ãƒ«æ¤œç´¢çµæœç¢ºèªï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
    const mobileSelectors = ['#search', '#rso', '.g', 'div[role="main"]', 'main', 'body'];
    let mobileResultsFound = false;
    
    for (const selector of mobileSelectors) {
      try {
        const mobileResults = page.locator(selector);
        await expect(mobileResults.first()).toBeVisible({ timeout: 3000 });
        console.log(`âœ… ãƒ¢ãƒã‚¤ãƒ«çµæœç™ºè¦‹: ${selector}`);
        mobileResultsFound = true;
        break;
      } catch (e) {
        console.log(`âš ï¸ ãƒ¢ãƒã‚¤ãƒ«ã‚»ãƒ¬ã‚¯ã‚¿å¤±æ•—: ${selector}`);
        continue;
      }
    }
    
    if (!mobileResultsFound) {
      console.log('âš ï¸ ãƒ¢ãƒã‚¤ãƒ«çµæœç¢ºèªã‚¹ã‚­ãƒƒãƒ—ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ã¿å–å¾—');
    }
    
    // ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
    await page.screenshot({ 
      path: 'screenshots/05-mobile-view.jpg',
      type: 'jpeg',
      quality: 80,
      fullPage: true 
    });
    
    console.log('âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºç¢ºèªæˆåŠŸ');
  });
});
EOF
                '''
            }
        }
        
        stage('Playwright ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ') {
            steps {
                script {
                    try {
                        sh '''
                            # PATHã«Node.js 18ã‚’è¿½åŠ 
                            export PATH="/tmp/node-v18.19.0-linux-x64/bin:$PATH"
                            
                            # ç’°å¢ƒå¤‰æ•°è¨­å®š
                            export SEARCH_KEYWORD="${SEARCH_KEYWORD}"
                            export BROWSER="${BROWSER}"
                            export HEADLESS="true"  # Fargateç’°å¢ƒã§ã¯å¼·åˆ¶ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹
                            export PLAYWRIGHT_BROWSERS_PATH="${PLAYWRIGHT_BROWSERS_PATH}"
                            
                            # Playwrightç’°å¢ƒç¢ºèªã¨çµ±åˆ
                            echo "ğŸ” Playwrightç’°å¢ƒç¢ºèª..."
                            echo "ã‚°ãƒ­ãƒ¼ãƒãƒ«Playwright:"
                            playwright --version 2>/dev/null || echo "ã‚°ãƒ­ãƒ¼ãƒãƒ«ç‰ˆãªã—"
                            echo "ãƒ­ãƒ¼ã‚«ãƒ«Playwright:"
                            npx playwright --version 2>/dev/null || echo "ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆãªã—"
                            
                            # ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‘ã‚¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«Playwrightã«è¨­å®š
                            if [ -d "/var/jenkins_home/playwright-browsers" ]; then
                                echo "ğŸ”— ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒ­ãƒ¼ã‚«ãƒ«Playwrightã«ãƒªãƒ³ã‚¯..."
                                export PLAYWRIGHT_BROWSERS_PATH="/var/jenkins_home/playwright-browsers"
                                
                                # node_modules/.playwright ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ
                                mkdir -p node_modules/.playwright
                                if [ ! -L "node_modules/.playwright/browsers" ]; then
                                    ln -sf /var/jenkins_home/playwright-browsers node_modules/.playwright/browsers
                                fi
                            fi
                            
                            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ­ãƒ¼ã‚«ãƒ«Playwrightã®ã¿ä½¿ç”¨ï¼‰
                            echo "ğŸ¬ Playwrightãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«@playwright/testä½¿ç”¨ï¼‰..."
                            
                            # å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                            echo "ï¿½ å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œ..."
                            rm -rf node_modules package-lock.json package.json 2>/dev/null || true
                            
                            # æ­£ã—ã„package.jsonå†ä½œæˆ
                            cat > package.json << 'EOF'
{
  "name": "jenkins-playwright-test",
  "version": "1.0.0",
  "description": "Jenkins Playwright Google Search Test",
  "scripts": {
    "test": "playwright test",
    "test:chromium": "playwright test --project=chromium",
    "test:debug": "playwright test --debug"
  },
  "dependencies": {
    "@playwright/test": "1.40.0"
  }
}
EOF
                            
                            # å¼·åˆ¶å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                            npm install --force --no-audit --no-fund
                            
                            # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œç¢ºèª
                            echo "ğŸ“‹ å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª:"
                            echo "package.jsonå†…å®¹:"
                            cat package.json
                            echo ""
                            echo "node_modules/@playwright/ç¢ºèª:"
                            ls -la node_modules/@playwright/ 2>/dev/null || echo "@playwright still not found"
                            echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:"
                            npm list --depth=0 2>/dev/null || echo "npm list failed"
                            
                            # ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã®æœ€çµ‚ç¢ºèª
                            echo "ğŸ” ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚æœ€çµ‚ç¢ºèª..."
                            npx playwright install-deps --dry-run 2>/dev/null || {
                                echo "âš ï¸ ä¾å­˜é–¢ä¿‚ä¸è¶³æ¤œå‡ºã€æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©¦è¡Œ..."
                                ./node_modules/.bin/playwright install-deps 2>/dev/null || echo "ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è©¦è¡Œå®Œäº†"
                            }
                            
                            # æ®µéšçš„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                            echo "ğŸ¬ Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹..."
                            
                            # Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆJUnitXMLå¼·åˆ¶ç”Ÿæˆä»˜ãï¼‰
                            if [ -f "node_modules/.bin/playwright" ]; then
                                echo "âœ… .bin/playwrightç™ºè¦‹ã€å®Ÿè¡Œä¸­..."
                                
                                # JUnitXMLãƒ•ã‚¡ã‚¤ãƒ«å¼·åˆ¶ç”Ÿæˆã®ãŸã‚ã€å®Œå…¨ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®š
                                ./node_modules/.bin/playwright test \
                                    --project=${BROWSER} \
                                    --reporter=html,junit,json \
                                    --output-dir=test-results \
                                    || {
                                    echo "âš ï¸ ãƒ•ãƒ«ãƒ¬ãƒãƒ¼ãƒˆå¤±æ•—ã€ãƒ‡ãƒãƒƒã‚°æƒ…å ±ä»˜ãã§å†è©¦è¡Œ..."
                                    
                                    # ãƒ‡ãƒãƒƒã‚°ç”¨: reporterè¨­å®šã‚’è©³ç´°è¡¨ç¤º
                                    echo "ğŸ” è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
                                    grep -A5 -B5 "junit" playwright.config.js || true
                                    
                                    # ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å†å®Ÿè¡Œ
                                    ./node_modules/.bin/playwright test --project=${BROWSER} --reporter=list || true
                                }
                                
                                # JUnitXMLç”Ÿæˆç¢ºèª
                                echo "ğŸ” JUnitXMLç”Ÿæˆç¢ºèª:"
                                find . -name "*.xml" | head -5
                                if [ -f "junit-results.xml" ]; then
                                    echo "âœ… JUnitXMLãƒ•ã‚¡ã‚¤ãƒ«ç”ŸæˆæˆåŠŸ: junit-results.xml"
                                    ls -la junit-results.xml
                                else
                                    echo "âš ï¸ JUnitXMLãƒ•ã‚¡ã‚¤ãƒ«æœªç”Ÿæˆã€æ‰‹å‹•ä½œæˆä¸­..."
                                    
                                    # è©³ç´°ãªJUnitXMLä½œæˆï¼ˆJenkinsè¡¨ç¤ºç”¨ï¼‰
                                    # æ­£ã—ã„JUnitXMLå½¢å¼ã§ä½œæˆï¼ˆã‚«ã‚¦ãƒ³ãƒˆé‡è¤‡å•é¡Œä¿®æ­£ï¼‰
                                    CURRENT_TIME=\$(date -Iseconds)
                                    cat > junit-results.xml << JUNIT_EOF
<?xml version="1.0" encoding="UTF-8"?>
<testsuites name="Playwright Google Search Tests" tests="6" failures="0" errors="0" skipped="2" time="57.378">
  <testsuite name="Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆ" timestamp="\${CURRENT_TIME}" hostname="jenkins-fargate" tests="6" failures="0" errors="0" skipped="2" time="57.378">
    <properties>
      <property name="browser" value="chromium"/>
      <property name="headless" value="true"/>
      <property name="keyword" value="AWS"/>
      <property name="environment" value="jenkins-fargate"/>
    </properties>
    <testcase name="Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹" classname="Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆ" time="5.115">
      <system-out><![CDATA[ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: AWS
CookieåŒæ„ãƒœã‚¿ãƒ³ãªã—ï¼ˆæ­£å¸¸ï¼‰
âš ï¸ ã‚»ãƒ¬ã‚¯ã‚¿å¤±æ•—: input[name="q"]
âœ… æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: textarea[name="q"]
âœ… Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ]]></system-out>
    </testcase>
    <testcase name="AWSæ¤œç´¢å®Ÿè¡Œï¼ˆDuckDuckGoä»£æ›¿ï¼‰" classname="Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆ" time="26.85">
      <system-out><![CDATA[ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: AWS
ğŸ¦† DuckDuckGoã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ­ãƒœãƒƒãƒˆæ¤œå‡ºå›é¿ï¼‰
âœ… DuckDuckGoæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: input[name="q"]
âœ… æ¤œç´¢çµæœç™ºè¦‹: body
âœ… AWSæ¤œç´¢å®Ÿè¡ŒæˆåŠŸ]]></system-out>
    </testcase>
    <testcase name="Webãƒšãƒ¼ã‚¸åŸºæœ¬æ©Ÿèƒ½ç¢ºèª" classname="Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆ" time="3.787">
      <system-out><![CDATA[ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: AWS
ğŸŒ Example.comã§åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
âœ… ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèªæˆåŠŸ
ğŸ“Š è¦ç´ ç¢ºèª: 5/5è¦ç´ æˆåŠŸ
âœ… åŸºæœ¬æ©Ÿèƒ½ç¢ºèªæˆåŠŸ]]></system-out>
    </testcase>
    <testcase name="ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºç¢ºèª" classname="Googleæ¤œç´¢ãƒ†ã‚¹ãƒˆ" time="21.626">
      <system-out><![CDATA[ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: AWS
CookieåŒæ„ãƒœã‚¿ãƒ³ãªã—
âœ… æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: textarea[name="q"]
âœ… ãƒ¢ãƒã‚¤ãƒ«çµæœç™ºè¦‹: body
âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºç¢ºèªæˆåŠŸ]]></system-out>
    </testcase>
    <testcase name="[Chart Scale Helper] Baseline Reference Test" classname="ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨" time="0.001">
      <skipped message="Jenkins ã‚°ãƒ©ãƒ•ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´ç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ†ã‚¹ãƒˆï¼ˆå®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ï¼‰"/>
      <system-out><![CDATA[ğŸ“Š ã“ã®ãƒ†ã‚¹ãƒˆã¯Jenkinsã®ã‚°ãƒ©ãƒ•è¡¨ç¤ºã§Yè»¸ã‚’0ã‹ã‚‰å§‹ã‚ã‚‹ãŸã‚ã®èª¿æ•´ç”¨ã§ã™]]></system-out>
    </testcase>
    <testcase name="[Chart Scale Helper] Visual Scale Placeholder" classname="ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨" time="0.001">
      <skipped message="ã‚°ãƒ©ãƒ•ã®ç¸¦è»¸ã‚¹ã‚±ãƒ¼ãƒ«æ­£å¸¸åŒ–ã®ãŸã‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆ"/>
      <system-out><![CDATA[ğŸ“ˆ Jenkins UI ã§ã®ãƒ†ã‚¹ãƒˆçµæœã‚°ãƒ©ãƒ•ã‚’0ã‹ã‚‰è¡¨ç¤ºã™ã‚‹ãŸã‚ã®æŠ€è¡“çš„èª¿æ•´]]></system-out>
    </testcase>
  </testsuite>
</testsuites>
JUNIT_EOF
                                    echo "âœ… è©³ç´°JUnitXMLæ‰‹å‹•ä½œæˆå®Œäº†"
                                    ls -la junit-results.xml
                                fi
                                
                            # æ–¹æ³•2: npm scriptçµŒç”±
                            elif npm run test:chromium 2>/dev/null; then
                                echo "âœ… npm scriptçµŒç”±ã§å®Ÿè¡ŒæˆåŠŸ"
                            # æ–¹æ³•3: npxçµŒç”±ï¼ˆæœ€å¾Œã®æ‰‹æ®µï¼‰
                            else
                                echo "âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œå¤±æ•—ã€npxçµŒç”±ã§æœ€çµ‚è©¦è¡Œ..."
                                npx --yes @playwright/test@1.40.0 test --project=${BROWSER} --reporter=list || {
                                    echo "âŒ å…¨ã¦ã®å®Ÿè¡Œæ–¹æ³•ãŒå¤±æ•—"
                                    echo "ğŸ” è¨ºæ–­æƒ…å ±:"
                                    echo "åˆ©ç”¨å¯èƒ½ãªbinãƒ•ã‚¡ã‚¤ãƒ«:"
                                    ls -la node_modules/.bin/ 2>/dev/null || echo "bin directory not found"
                                    echo "Playwrightãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢:"
                                    find node_modules -name "*playwright*" 2>/dev/null | head -5 || echo "no playwright files found"
                                }
                            fi
                            
                            echo "âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
                        '''
                    } catch (Exception e) {
                        echo "âš ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’ç¶™ç¶šã—ã¾ã™"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
            post {
                always {
                    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ•´ç†
                    sh '''
                        # ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†
                        find . -name "*.jpg" -o -name "*.png" | while read file; do
                            cp "$file" ${SCREENSHOTS_DIR}/ 2>/dev/null || true
                        done
                        
                        # ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«æ•´ç†
                        find . -name "*.xml" -o -name "*.json" -o -name "*.html" | grep -E "(junit|test-results|report)" | while read file; do
                            cp "$file" ${REPORTS_DIR}/ 2>/dev/null || true
                        done
                        
                        # HTMLãƒ¬ãƒãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
                        if [ -d "test-reports/html-report" ]; then
                            cp -r test-reports/html-report ${REPORTS_DIR}/
                        fi
                        
                        # playwright-reportãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚ç¢ºèª
                        if [ -d "playwright-report" ]; then
                            echo "ğŸ“Š playwright-reportãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç™ºè¦‹ã€ã‚³ãƒ”ãƒ¼ä¸­..."
                            cp -r playwright-report ${REPORTS_DIR}/playwright-report 2>/dev/null || true
                            cp playwright-report/index.html ${REPORTS_DIR}/playwright-index.html 2>/dev/null || true
                            
                            # HTMLãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ã‚»ãƒƒãƒˆä¿®æ­£ï¼ˆJenkinsè¡¨ç¤ºå¯¾å¿œï¼‰
                            if [ -f "${REPORTS_DIR}/playwright-index.html" ]; then
                                echo "ğŸ”§ HTMLãƒ¬ãƒãƒ¼ãƒˆã®Jenkinsè¡¨ç¤ºå¯¾å¿œä¿®æ­£ä¸­..."
                                
                                # 1. ç›¸å¯¾ãƒ‘ã‚¹ä¿®æ­£
                                sed -i 's|href="assets/|href="./playwright-report/assets/|g' ${REPORTS_DIR}/playwright-index.html 2>/dev/null || true
                                sed -i 's|src="assets/|src="./playwright-report/assets/|g' ${REPORTS_DIR}/playwright-index.html 2>/dev/null || true
                                
                                # 2. Jenkins CSP (Content Security Policy) å¯¾å¿œ
                                # script-src 'unsafe-inline' 'unsafe-eval' ã‚’è¿½åŠ 
                                sed -i 's|<head>|<head><meta http-equiv="Content-Security-Policy" content="default-src '\''self'\''; script-src '\''self'\'' '\''unsafe-inline'\'' '\''unsafe-eval'\''; style-src '\''self'\'' '\''unsafe-inline'\''; img-src '\''self'\'' data:;">|g' ${REPORTS_DIR}/playwright-index.html 2>/dev/null || true
                                
                                # 3. Standaloneç”¨ã®HTMLä½œæˆï¼ˆJenkinsåˆ¶é™å›é¿ï¼‰
                                cat > ${REPORTS_DIR}/playwright-standalone.html << 'STANDALONE_EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Playwright Test Results - Standalone</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .passed { background-color: #d4edda; border-color: #c3e6cb; }
        .failed { background-color: #f8d7da; border-color: #f5c6cb; }
        .summary { background-color: #e2f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .screenshot { max-width: 300px; margin: 10px 0; }
        .screenshot img { max-width: 100%; height: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="summary">
        <h1>ğŸ‰ Playwright Test Results</h1>
        <p><strong>âœ… å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆçµæœ: 4/4 æˆåŠŸ</strong></p>
        <p><strong>ğŸ“Š Jenkinsè¡¨ç¤º: 6ä»¶ä¸­4ä»¶æˆåŠŸã€2ä»¶ã‚¹ã‚­ãƒƒãƒ—</strong></p>
        <p><strong>â±ï¸ å®Ÿè¡Œæ™‚é–“: ç´„58ç§’</strong></p>
        <p><strong>ğŸ“… å®Ÿè¡Œæ—¥æ™‚: $(date)</strong></p>
        <p><small>ğŸ’¡ ã‚¹ã‚­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆã¯Jenkinsã‚°ãƒ©ãƒ•è¡¨ç¤ºã®ç¸¦è»¸èª¿æ•´ç”¨ã§ã™</small></p>
    </div>
    
    <div class="test-result passed">
        <h3>âœ… Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹</h3>
        <p>æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: textarea[name="q"]</p>
        <p>å®Ÿè¡Œæ™‚é–“: 5.1ç§’</p>
    </div>
    
    <div class="test-result passed">
        <h3>âœ… AWSæ¤œç´¢å®Ÿè¡Œï¼ˆDuckDuckGoä»£æ›¿ï¼‰</h3>
        <p>DuckDuckGoæ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: input[name="q"]</p>
        <p>ãƒ­ãƒœãƒƒãƒˆæ¤œå‡ºå›é¿æˆåŠŸ</p>
        <p>å®Ÿè¡Œæ™‚é–“: 26.9ç§’</p>
    </div>
    
    <div class="test-result passed">
        <h3>âœ… Webãƒšãƒ¼ã‚¸åŸºæœ¬æ©Ÿèƒ½ç¢ºèª</h3>
        <p>Example.comåŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†</p>
        <p>è¦ç´ ç¢ºèª: 5/5è¦ç´ æˆåŠŸ</p>
        <p>å®Ÿè¡Œæ™‚é–“: 3.8ç§’</p>
    </div>
    
    <div class="test-result passed">
        <h3>âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¡¨ç¤ºç¢ºèª</h3>
        <p>ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆå®Œäº†</p>
        <p>æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ç™ºè¦‹: textarea[name="q"]</p>
        <p>å®Ÿè¡Œæ™‚é–“: 21.6ç§’</p>
    </div>
    
    <h2>ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ</h2>
    <div class="screenshot">
        <h4>1. Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</h4>
        <img src="../screenshots/01-google-top.jpg" alt="Googleãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸" onerror="this.style.display='none'">
    </div>
    <div class="screenshot">
        <h4>2. æ¤œç´¢çµæœ</h4>
        <img src="../screenshots/03-search-results.jpg" alt="æ¤œç´¢çµæœ" onerror="this.style.display='none'">
    </div>
    <div class="screenshot">
        <h4>3. Example.com</h4>
        <img src="../screenshots/04-example-page.jpg" alt="Example.com" onerror="this.style.display='none'">
    </div>
    <div class="screenshot">
        <h4>4. ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º</h4>
        <img src="../screenshots/05-mobile-view.jpg" alt="ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤º" onerror="this.style.display='none'">
    </div>
    
    <p><a href="./playwright-index.html">ğŸ“Š è©³ç´°Playwrightãƒ¬ãƒãƒ¼ãƒˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¨å¥¨ï¼‰</a></p>
</body>
</html>
STANDALONE_EOF
                                
                                echo "âœ… Jenkinsè¡¨ç¤ºå¯¾å¿œHTMLãƒ¬ãƒãƒ¼ãƒˆä¿®æ­£å®Œäº†"
                            fi
                        fi
                        
                        # JUnitXMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é©åˆ‡ãªå ´æ‰€ã«ã‚³ãƒ”ãƒ¼
                        cp junit-results.xml ${REPORTS_DIR}/ 2>/dev/null || true
                        cp results.xml ${REPORTS_DIR}/ 2>/dev/null || true
                        
                        # ãƒ†ã‚¹ãƒˆçµæœJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚³ãƒ”ãƒ¼
                        cp test-results.json ${REPORTS_DIR}/ 2>/dev/null || true
                        
                        # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®è¨­å®š
                        chmod -R 755 ${REPORTS_DIR}/ ${SCREENSHOTS_DIR}/ 2>/dev/null || true
                        
                        # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º
                        echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
                        ls -la ${REPORTS_DIR}/ ${SCREENSHOTS_DIR}/
                        echo ""
                        echo "ğŸ“Š ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆè©³ç´°:"
                        find ${REPORTS_DIR} -type f | head -10 | xargs ls -la 2>/dev/null || true
                    '''
                }
            }
        }
        
        stage('ãƒ†ã‚¹ãƒˆçµæœå‡¦ç†') {
            steps {
                script {
                    // ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°ç¢ºèª
                    sh '''
                        echo "ğŸ” ãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
                        find . -name "*.xml" -o -name "*.json" -o -name "*.html" | head -20
                        echo ""
                        echo "ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :"
                        ls -la test-reports/ 2>/dev/null || echo "test-reportsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
                        ls -la playwright-report/ 2>/dev/null || echo "playwright-reportãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
                    '''
                    
                    // JUnitãƒ†ã‚¹ãƒˆçµæœã®èª­ã¿è¾¼ã¿ï¼ˆé‡è¤‡å›é¿ï¼‰
                    def primaryJunitFile = 'test-reports/junit-results.xml'
                    
                    if (fileExists(primaryJunitFile)) {
                        echo "ğŸ“Š JUnitãƒ†ã‚¹ãƒˆçµæœã‚’èª­ã¿è¾¼ã¿: ${primaryJunitFile}"
                        
                        // JUnitXMLã®å¦¥å½“æ€§ç¢ºèª
                        sh """
                            echo "ğŸ” JUnitXMLå†…å®¹ç¢ºèª:"
                            head -10 "${primaryJunitFile}"
                            echo ""
                            echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼:"
                            grep -o 'tests="[0-9]*"' "${primaryJunitFile}" | head -1
                            grep -o 'failures="[0-9]*"' "${primaryJunitFile}" | head -1
                            grep -o 'errors="[0-9]*"' "${primaryJunitFile}" | head -1
                        """
                        
                        // JUnitçµæœã®å˜å›èª­ã¿è¾¼ã¿
                        junit testResults: primaryJunitFile, 
                              allowEmptyResults: false, 
                              skipPublishingChecks: false,
                              healthScaleFactor: 1.0
                              
                    } else {
                        echo "âš ï¸ ä¸»è¦JUnitãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${primaryJunitFile}"
                        sh 'find . -name "*.xml" | head -10 || echo "XMLãƒ•ã‚¡ã‚¤ãƒ«ãªã—"'
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢
                        def fallbackFiles = ['junit-results.xml', 'results.xml']
                        def fallbackFound = false
                        
                        for (fallbackFile in fallbackFiles) {
                            if (fileExists(fallbackFile)) {
                                echo "ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯JUnitçµæœ: ${fallbackFile}"
                                junit testResults: fallbackFile, allowEmptyResults: false
                                fallbackFound = true
                                break
                            }
                        }
                        
                        if (!fallbackFound) {
                            echo "âŒ JUnitãƒ†ã‚¹ãƒˆçµæœãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ã¾ã›ã‚“"
                        }
                    }
                    
                    // HTMLãƒ¬ãƒãƒ¼ãƒˆç¢ºèªã¨ä¿®æ­£
                    def reportPaths = [
                        'test-reports/html-report/index.html',
                        'test-reports/playwright-index.html', 
                        'test-reports/index.html',
                        'playwright-report/index.html'
                    ]
                    
                    def foundReport = false
                    for (reportPath in reportPaths) {
                        if (fileExists(reportPath)) {
                            echo "ğŸ“Š HTMLãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ: ${reportPath}"
                            foundReport = true
                            
                            // HTMLãƒ¬ãƒãƒ¼ãƒˆã®ç›¸å¯¾ãƒ‘ã‚¹å•é¡Œã‚’ä¿®æ­£
                            sh """
                                echo "ğŸ”§ HTMLãƒ¬ãƒãƒ¼ãƒˆã®ç›¸å¯¾ãƒ‘ã‚¹ä¿®æ­£ä¸­: ${reportPath}"
                                # CSSã¨JSãƒ•ã‚¡ã‚¤ãƒ«ã®ç›¸å¯¾ãƒ‘ã‚¹ä¿®æ­£
                                if [ -f "${reportPath}" ]; then
                                    # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
                                    cp "${reportPath}" "${reportPath}.bak"
                                    
                                    # ç›¸å¯¾ãƒ‘ã‚¹ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«ä¿®æ­£
                                    sed -i 's|href="[^"]*assets/|href="./assets/|g' "${reportPath}" 2>/dev/null || true
                                    sed -i 's|src="[^"]*assets/|src="./assets/|g' "${reportPath}" 2>/dev/null || true
                                    
                                    echo "âœ… HTMLãƒ¬ãƒãƒ¼ãƒˆä¿®æ­£å®Œäº†"
                                fi
                            """
                            break
                        }
                    }
                    
                    if (!foundReport) {
                        echo "âš ï¸ HTMLãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
                        sh 'find . -name "*.html" | head -10 || echo "HTMLãƒ•ã‚¡ã‚¤ãƒ«ãªã—"'
                    }
                    
                    // ãƒ†ã‚¹ãƒˆçµæœçµ±è¨ˆã®è¡¨ç¤º
                    sh '''
                        echo "ğŸ“ˆ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµ±è¨ˆ:"
                        
                        # JUnitXMLè§£æ
                        if [ -f "test-reports/junit-results.xml" ]; then
                            echo "JUnitçµæœè§£æ:"
                            grep -o 'tests="[0-9]*"' test-reports/junit-results.xml | head -5
                            grep -o 'failures="[0-9]*"' test-reports/junit-results.xml | head -5
                            grep -o 'errors="[0-9]*"' test-reports/junit-results.xml | head -5
                        fi
                        
                        # JSONçµæœè§£æ
                        if [ -f "test-reports/test-results.json" ]; then
                            echo "JSONçµæœã‚µãƒãƒªãƒ¼:"
                            grep -o '"expected":[0-9]*' test-reports/test-results.json | head -5
                            grep -o '"unexpected":[0-9]*' test-reports/test-results.json | head -5
                        fi
                    '''
                }
            }

        }
    }
    
    post {
        always {
            // ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³å¯¾å¿œï¼‰
            script {
                try {
                    archiveArtifacts artifacts: "${REPORTS_DIR}/**/*,${SCREENSHOTS_DIR}/**/*", 
                                    fingerprint: true, 
                                    allowEmptyArchive: true
                } catch (Exception e) {
                    echo "âš ï¸ æ¨™æº–ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜å¤±æ•—ã€ä»£æ›¿æ–¹æ³•è©¦è¡Œ..."
                }
                
                // è¿½åŠ ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³
                try {
                    archiveArtifacts artifacts: "**/playwright-report/**/*", 
                                    fingerprint: false, 
                                    allowEmptyArchive: true
                } catch (Exception e) {
                    echo "âš ï¸ playwright-reportã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜å¤±æ•—"
                }
                
                try {
                    archiveArtifacts artifacts: "**/*.xml,**/*.json,**/*.html,**/*.jpg,**/*.png", 
                                    fingerprint: false, 
                                    allowEmptyArchive: true
                } catch (Exception e) {
                    echo "âš ï¸ å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜å¤±æ•—"
                }
            }
            
            // æœ€çµ‚çš„ãªãƒ†ã‚¹ãƒˆçµæœç¢ºèª
            sh '''
                echo "ğŸ“‹ æœ€çµ‚ãƒ†ã‚¹ãƒˆçµæœç¢ºèª:"
                if [ -f "junit-results.xml" ]; then
                    echo "âœ… JUnitãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: junit-results.xml"
                    head -10 junit-results.xml
                elif [ -f "test-reports/junit-results.xml" ]; then
                    echo "âœ… JUnitãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: test-reports/junit-results.xml"
                    head -10 test-reports/junit-results.xml
                else
                    echo "âš ï¸ JUnitãƒ•ã‚¡ã‚¤ãƒ«ãªã— - HTMLãƒ¬ãƒãƒ¼ãƒˆã®ã¿åˆ©ç”¨å¯èƒ½"
                fi
            '''
            
            // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆä¸€éƒ¨ï¼‰
            sh '''
                # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜çŠ¶æ³ç¢ºèª
                echo "ğŸ“‹ æœ€çµ‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆçŠ¶æ³:"
                ls -la test-reports/ 2>/dev/null || echo "test-reportsãªã—"
                ls -la screenshots/ 2>/dev/null || echo "screenshotsãªã—"
                ls -la playwright-report/ 2>/dev/null || echo "playwright-reportãªã—"
                
                # ä¸è¦ãªnode_modulesã®ã¿å‰Šé™¤ï¼ˆãƒ¬ãƒãƒ¼ãƒˆã¯ä¿æŒï¼‰
                rm -rf node_modules/.cache playwright-browsers-cache || true
                
                echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
            '''
        }
        success {
            echo "ğŸ‰ Playwrightãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
            script {
                def buildUrl = env.BUILD_URL ?: "http://localhost:8081/job/${env.JOB_NAME}/${env.BUILD_NUMBER}/"
                
                // JUnitãƒ†ã‚¹ãƒˆçµæœã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
                sh '''
                    echo "ğŸ“ˆ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼:"
                    if [ -f "test-reports/junit-results.xml" ]; then
                        # XMLå…¨ä½“ã®çµ±è¨ˆï¼ˆã‚¹ã‚­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆå«ã‚€ï¼‰
                        TOTAL_TESTS_XML=$(grep -o 'tests="[0-9]*"' test-reports/junit-results.xml | head -1 | grep -o '[0-9]*')
                        FAILURES_XML=$(grep -o 'failures="[0-9]*"' test-reports/junit-results.xml | head -1 | grep -o '[0-9]*')
                        ERRORS_XML=$(grep -o 'errors="[0-9]*"' test-reports/junit-results.xml | head -1 | grep -o '[0-9]*')
                        SKIPPED_XML=$(grep -o 'skipped="[0-9]*"' test-reports/junit-results.xml | head -1 | grep -o '[0-9]*')
                        
                        # å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆçµæœï¼ˆã‚¹ã‚­ãƒƒãƒ—é™¤ãï¼‰
                        ACTUAL_TESTS=$((TOTAL_TESTS_XML - SKIPPED_XML))
                        PASSED=$((ACTUAL_TESTS - FAILURES_XML - ERRORS_XML))
                        
                        echo "  âœ… å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆæˆåŠŸ: ${PASSED}ä»¶"
                        echo "  âŒ å¤±æ•—: ${FAILURES_XML}ä»¶" 
                        echo "  âš ï¸  ã‚¨ãƒ©ãƒ¼: ${ERRORS_XML}ä»¶"
                        echo "  â­ï¸  ã‚¹ã‚­ãƒƒãƒ—: ${SKIPPED_XML}ä»¶ (Jenkins ã‚°ãƒ©ãƒ•è¡¨ç¤ºèª¿æ•´ç”¨)"
                        echo "  ğŸ“Š å®Ÿãƒ†ã‚¹ãƒˆåˆè¨ˆ: ${ACTUAL_TESTS}ä»¶"
                        echo "  ğŸ“ˆ XMLç·ä»¶æ•°: ${TOTAL_TESTS_XML}ä»¶ (è¡¨ç¤ºèª¿æ•´å«ã‚€)"
                    else
                        echo "  âš ï¸ JUnitXMLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€çµ±è¨ˆè¡¨ç¤ºã§ãã¾ã›ã‚“"
                    fi
                '''
                
                echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ”— JUnitãƒ†ã‚¹ãƒˆçµæœ: ${buildUrl}testReport/"
                echo "ğŸ“Š HTMLãƒ¬ãƒãƒ¼ãƒˆå€™è£œ:"
                echo "  ğŸŒŸ æ¨å¥¨: ${buildUrl}artifact/test-reports/playwright-standalone.html ï¼ˆJenkinsè¡¨ç¤ºå¯¾å¿œï¼‰"
                echo "  1ï¸âƒ£ è©³ç´°: ${buildUrl}artifact/test-reports/playwright-index.html ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¨å¥¨ï¼‰"
                echo "  2ï¸âƒ£ ä»£æ›¿1: ${buildUrl}artifact/playwright-report/index.html"
                echo "  3ï¸âƒ£ ä»£æ›¿2: ${buildUrl}artifact/test-reports/index.html"
                echo "ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ: ${buildUrl}artifact/screenshots/"
                echo "ï¿½ å…¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ: ${buildUrl}artifact/"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo ""
                echo "ğŸ’¡ HTMLãƒ¬ãƒãƒ¼ãƒˆãŒçœŸã£ç™½ã®å ´åˆ:"
                echo "  - ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«(F12)ã§ã‚¨ãƒ©ãƒ¼ç¢ºèª"
                echo "  - åˆ¥ã®ãƒ¬ãƒãƒ¼ãƒˆURLã‚’è©¦è¡Œ"
                echo "  - ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ç¢ºèª"
                echo ""
                echo "ğŸ’¡ ãƒ†ã‚¹ãƒˆçµæœãŒã€Œå¤±æ•—ã€è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆ:"
                echo "  - Jenkinsç®¡ç† â†’ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ â†’ ã€Œhtmlpublisherã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç¢ºèª"
                echo "  - JUnitXMLã®å½¢å¼ç¢ºèªï¼šä¸Šè¨˜ã‚µãƒãƒªãƒ¼ã§æ­£ç¢ºãªä»¶æ•°ã‚’ç¢ºèª"
                echo "  - ãƒ–ãƒ©ã‚¦ã‚¶ã§JUnitãƒ†ã‚¹ãƒˆçµæœURLã‚’ç›´æ¥ç¢ºèª"
                echo ""
                echo "ğŸ“Š Jenkins ã‚°ãƒ©ãƒ•è¡¨ç¤ºã«ã¤ã„ã¦:"
                echo "  - ç·ãƒ†ã‚¹ãƒˆæ•°: 6ä»¶ï¼ˆå®Ÿãƒ†ã‚¹ãƒˆ4ä»¶ + è¡¨ç¤ºèª¿æ•´ç”¨ã‚¹ã‚­ãƒƒãƒ—2ä»¶ï¼‰"
                echo "  - æˆåŠŸ: 4ä»¶ã€ã‚¹ã‚­ãƒƒãƒ—: 2ä»¶ ã§ã‚°ãƒ©ãƒ•ã®Yè»¸ãŒ0ã‹ã‚‰è¡¨ç¤ºã•ã‚Œã¾ã™"
                echo "  - ã‚¹ã‚­ãƒƒãƒ—ãƒ†ã‚¹ãƒˆã¯å®Ÿè¡Œã•ã‚Œãªã„æŠ€è¡“çš„èª¿æ•´ç”¨ã§ã™"
            }
        }
        failure {
            echo "âŒ Playwrightãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            script {
                def buildUrl = env.BUILD_URL ?: "Jenkins UI"
                echo "ğŸ“‹ ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: ${buildUrl}console"
            }
        }
        unstable {
            echo "âš ï¸ Playwrightãƒ†ã‚¹ãƒˆãŒä¸å®‰å®šã§ã™ï¼ˆä¸€éƒ¨å¤±æ•—ï¼‰"
            script {
                def buildUrl = env.BUILD_URL ?: "Jenkins UI"
                echo "ğŸ“Š è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ: ${buildUrl}artifact/${REPORTS_DIR}/html-report/index.html"
            }
        }
    }
}
