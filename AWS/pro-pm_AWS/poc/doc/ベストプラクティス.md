# POCç’°å¢ƒã«ãŠã‘ã‚‹AWS Well-Architectedãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹æ”¹å–„ææ¡ˆ

## æ¦‚è¦
ç¾åœ¨ã®POCç’°å¢ƒã‚’AWS Well-Architectedãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®6ã¤ã®æŸ±ï¼ˆé‹ç”¨ä¸Šã®å„ªç§€æ€§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ä¿¡é ¼æ€§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ¹ç‡ã€ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã€æŒç¶šå¯èƒ½æ€§ï¼‰ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã€POCç’°å¢ƒã¨ã—ã¦é©ç”¨å¯èƒ½ãªæ”¹å–„ç‚¹ã‚’ææ¡ˆã—ã¾ã™ã€‚

## 1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (Security Pillar)

### ğŸ”’ æš—å·åŒ–ã®å¼·åŒ–

**ç¾çŠ¶èª²é¡Œ:**
- Aurora MySQLã¨ElastiCacheã®æš—å·åŒ–è¨­å®šãŒæ˜ç¤ºçš„ã§ãªã„
- S3ãƒã‚±ãƒƒãƒˆã®æš—å·åŒ–è¨­å®šãŒä¸æ˜

**æ¨å¥¨æ”¹å–„:**
```yaml
# Auroraæš—å·åŒ–æœ‰åŠ¹åŒ–
Aurora:
  StorageEncrypted: true
  KmsKeyId: !Ref DatabaseKMSKey

# ElastiCacheæš—å·åŒ–æœ‰åŠ¹åŒ–
ElastiCache:
  AtRestEncryptionEnabled: true
  TransitEncryptionEnabled: true
  AuthToken: !Ref ElastiCacheAuthToken

# S3ãƒã‚±ãƒƒãƒˆæš—å·åŒ–
S3Bucket:
  BucketEncryption:
    ServerSideEncryptionConfiguration:
      - ServerSideEncryptionByDefault:
          SSEAlgorithm: aws:kms
          KMSMasterKeyID: !Ref S3KMSKey
```

### ğŸ” IAMæ¨©é™ã®æœ€å°åŒ–

**ç¾çŠ¶èª²é¡Œ:**
- IAMãƒ­ãƒ¼ãƒ«ã®æ¨©é™ãŒåºƒç¯„å›²ã®å¯èƒ½æ€§
- ãƒªã‚½ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®ç´°ã‹ã„æ¨©é™åˆ¶å¾¡ãŒä¸ååˆ†

**æ¨å¥¨æ”¹å–„:**
- ECSã‚¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«ãƒªã‚½ãƒ¼ã‚¹å›ºæœ‰ã®ãƒãƒªã‚·ãƒ¼ã‚’é©ç”¨
- ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚`test-admin`ã¨ã—ã¦åˆ¶é™
- å®šæœŸçš„ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿè£…

### ğŸ›¡ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

**ç¾çŠ¶èª²é¡Œ:**
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«ã®æœ€å°æ¨©é™åŸå‰‡é©ç”¨
- WAFãƒ«ãƒ¼ãƒ«ã®è©³ç´°è¨­å®šãŒå¿…è¦

**æ¨å¥¨æ”¹å–„:**
```yaml
# ã‚ˆã‚Šå³å¯†ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«
ECSSecurityGroup:
  SecurityGroupIngress:
    - IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      SourceSecurityGroupId: !Ref ALBSecurityGroup
      Description: "ALB to ECS (HTTP only)"

# WAFè©³ç´°è¨­å®š
WAFWebACL:
  Rules:
    - Name: "RateLimitRule"
      Priority: 100
      Statement:
        RateBasedStatement:
          Limit: 1000  # POCç”¨ã«ä½ã‚ã«è¨­å®š
          AggregateKeyType: IP
```

## 2. ä¿¡é ¼æ€§ (Reliability Pillar)

### ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒ‡ã‚£ã‚¶ã‚¹ã‚¿ãƒªã‚«ãƒãƒª

**ç¾çŠ¶èª²é¡Œ:**
- Auroraè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒ1æ—¥ä¿æŒã®ã¿
- ã‚¯ãƒ­ã‚¹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—
- éšœå®³å¾©æ—§æ‰‹é †ãŒæœªå®šç¾©

**æ¨å¥¨æ”¹å–„:**
```yaml
# Aurora ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šæ”¹å–„
Aurora:
  BackupRetentionPeriod: 7  # POCã§ã‚‚1é€±é–“ã¯ä¿æŒ
  DeleteAutomatedBackups: false
  CopyTagsToSnapshot: true

# S3ãƒã‚±ãƒƒãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–
S3Bucket:
  VersioningConfiguration:
    Status: Enabled
  LifecycleConfiguration:
    Rules:
      - Id: DeleteOldVersions
        Status: Enabled
        NoncurrentVersionExpirationInDays: 30
```

### ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

**ç¾çŠ¶èª²é¡Œ:**
- ALBãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®šãŒåŸºæœ¬çš„
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒä¸ååˆ†

**æ¨å¥¨æ”¹å–„:**
```yaml
# ALBè©³ç´°ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
TargetGroup:
  HealthCheckPath: "/health"
  HealthCheckIntervalSeconds: 15
  HealthCheckTimeoutSeconds: 5
  HealthyThresholdCount: 2
  UnhealthyThresholdCount: 3
  Matcher:
    HttpCode: "200,204"
```

### ğŸ”„ è‡ªå‹•å¾©æ—§ã®å®Ÿè£…

**æ¨å¥¨æ”¹å–„:**
- ECSã‚µãƒ¼ãƒ“ã‚¹ã§è‡ªå‹•ã‚¿ã‚¹ã‚¯å¾©æ—§è¨­å®š
- Auroraè‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼æœ‰åŠ¹åŒ–
- CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ã«ã‚ˆã‚‹è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

## 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ¹ç‡ (Performance Efficiency)

### âš¡ ãƒªã‚½ãƒ¼ã‚¹æœ€é©åŒ–

**ç¾çŠ¶èª²é¡Œ:**
- ECS Fargateãƒªã‚½ãƒ¼ã‚¹ï¼ˆ0.25 vCPU + 0.5 GBï¼‰ãŒæœ€å°è¨­å®š
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚µã‚¤ã‚¸ãƒ³ã‚°

**æ¨å¥¨æ”¹å–„:**
```yaml
# ECS ã‚¿ã‚¹ã‚¯å®šç¾©æ”¹å–„
ECSTaskDefinition:
  Cpu: "512"     # 0.5 vCPUï¼ˆPOCè² è·ã«å¿œã˜ã¦èª¿æ•´ï¼‰
  Memory: "1024"  # 1 GB

# Aurora ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¯ãƒ©ã‚¹è¦‹ç›´ã—
Aurora:
  DBInstanceClass: db.t4g.medium  # ARM Graviton2ã§ã‚³ã‚¹ãƒˆåŠ¹ç‡å‘ä¸Š
```

### ğŸ“ˆ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**ç¾çŠ¶èª²é¡Œ:**
- ElastiCacheã®æœ€é©ãªè¨­å®šãŒä¸æ˜
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

**æ¨å¥¨æ”¹å–„:**
- Redisè¨­å®šã®ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
- é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®S3 + CloudFronté…ä¿¡ï¼ˆç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŒå°†æ¥è€ƒæ…®ï¼‰

## 4. ã‚³ã‚¹ãƒˆæœ€é©åŒ– (Cost Optimization)

### ğŸ’° ãƒªã‚½ãƒ¼ã‚¹åˆ©ç”¨åŠ¹ç‡åŒ–

**ç¾çŠ¶èª²é¡Œ:**
- 24æ™‚é–“ç¨¼åƒå‰æã®å›ºå®šã‚³ã‚¹ãƒˆ
- ä½¿ç”¨é »åº¦ã‚’è€ƒæ…®ã—ãŸæœ€é©åŒ–ä½™åœ°

**æ¨å¥¨æ”¹å–„:**

#### ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ
```yaml
# Auroraåœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆPOCç”¨ï¼‰
AuroraStopSchedule:
  Type: AWS::Events::Rule
  Properties:
    ScheduleExpression: "cron(0 18 * * ? *)"  # å¹³æ—¥18æ™‚åœæ­¢
    Targets:
      - Arn: !GetAtt StopAuroraFunction.Arn
        Id: "StopAuroraTarget"

# ECS Desired Count èª¿æ•´
ECSService:
  DesiredCount: !If [WorkingHours, 1, 0]
```

#### ãƒªã‚¶ãƒ¼ãƒ–ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ¤œè¨
- Auroraï¼šé•·æœŸåˆ©ç”¨è¦‹è¾¼ã¿ãŒã‚ã‚Œã°RIæ¤œè¨
- ElastiCacheï¼šRIé©ç”¨ã§20-40%ã‚³ã‚¹ãƒˆå‰Šæ¸›

### ğŸ“Š ã‚³ã‚¹ãƒˆç›£è¦–

**æ¨å¥¨æ”¹å–„:**
```yaml
# äºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
CostBudget:
  Type: AWS::Budgets::Budget
  Properties:
    Budget:
      BudgetName: "POC-Monthly-Budget"
      BudgetLimit:
        Amount: 500  # æœˆé¡500USDä¸Šé™
        Unit: USD
      TimeUnit: MONTHLY
      BudgetType: COST
```

## 5. é‹ç”¨ä¸Šã®å„ªç§€æ€§ (Operational Excellence)

### ğŸ“ Infrastructure as Code æ”¹å–„

**ç¾çŠ¶èª²é¡Œ:**
- ä¸€éƒ¨ã®ãƒªã‚½ãƒ¼ã‚¹ã§ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãŒä¸ååˆ†

**æ¨å¥¨æ”¹å–„:**
```yaml
# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã®æ”¹å–„ä¾‹
Parameters:
  Environment:
    Type: String
    Default: poc
    AllowedValues: [poc, dev, staging, prod]
  
  AutoShutdown:
    Type: String
    Default: "true"
    Description: "Enable automatic shutdown for cost optimization"

# Outputs ã®è¿½åŠ 
Outputs:
  ApplicationURL:
    Description: "Application Load Balancer URL"
    Value: !Sub "http://${InternetALB.DNSName}"
    Export:
      Name: !Sub "${AWS::StackName}-AppURL"
```

### ğŸ“Š ãƒ­ã‚°ç®¡ç†ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

**æ¨å¥¨æ”¹å–„:**
```yaml
# çµ±åˆãƒ­ã‚°ç®¡ç†
ECSTaskDefinition:
  ContainerDefinitions:
    - Name: app
      LogConfiguration:
        LogDriver: awslogs
        Options:
          awslogs-group: !Sub "/ecs/${EnvShort}${SystemName}-app"
          awslogs-region: !Ref "AWS::Region"
          awslogs-stream-prefix: ecs
          awslogs-datetime-format: "%Y-%m-%d %H:%M:%S"

# CloudWatch Alarms
CPUAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmName: !Sub "${EnvShort}${SystemName}-high-cpu"
    MetricName: CPUUtilization
    Namespace: AWS/ECS
    Statistic: Average
    Period: 300
    EvaluationPeriods: 2
    Threshold: 80
    ComparisonOperator: GreaterThanThreshold
```

### ğŸ”„ è‡ªå‹•åŒ–ã®æ¨é€²

**æ¨å¥¨æ”¹å–„:**
- ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
- è¨­å®šå¤‰æ›´ã®è‡ªå‹•åŒ–
- éšœå®³å¯¾å¿œã®Runbookä½œæˆ

## 6. æŒç¶šå¯èƒ½æ€§ (Sustainability)

### ğŸŒ± ç’°å¢ƒè² è·è»½æ¸›

**æ¨å¥¨æ”¹å–„:**
- ARM Graviton2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆdb.t4gç³»ã€cache.r7gç³»ï¼‰ã®æ¡ç”¨
- ä½¿ç”¨æ™‚é–“æœ€é©åŒ–ã«ã‚ˆã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼åŠ¹ç‡å‘ä¸Š
- æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼æ´»ç”¨

## å®Ÿè£…å„ªå…ˆåº¦

### ğŸš€ High Priorityï¼ˆå³åº§ã«å®Ÿè£…æ¨å¥¨ï¼‰
1. **æš—å·åŒ–æœ‰åŠ¹åŒ–** - Aurora, ElastiCache, S3
2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿æŒæœŸé–“å»¶é•·** - 7æ—¥é–“
3. **IAMæ¨©é™æœ€å°åŒ–** - ãƒªã‚½ãƒ¼ã‚¹å›ºæœ‰ãƒãƒªã‚·ãƒ¼
4. **ã‚³ã‚¹ãƒˆç›£è¦–** - äºˆç®—ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

### ğŸ“ˆ Medium Priorityï¼ˆPOCæœŸé–“ä¸­ã«æ¤œè¨ï¼‰
1. **è‡ªå‹•åœæ­¢ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«** - ã‚³ã‚¹ãƒˆæœ€é©åŒ–
2. **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ”¹å–„** - ä¿¡é ¼æ€§å‘ä¸Š
3. **ãƒ­ã‚°çµ±åˆç®¡ç†** - é‹ç”¨æ€§å‘ä¸Š
4. **CloudWatch Alarms** - ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç›£è¦–

### ğŸ”® Low Priorityï¼ˆæœ¬æ ¼é‹ç”¨æ™‚ã«æ¤œè¨ï¼‰
1. **ãƒãƒ«ãƒAZ/ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å±•é–‹** - é«˜å¯ç”¨æ€§
2. **Reserved Instance** - é•·æœŸã‚³ã‚¹ãƒˆæœ€é©åŒ–
3. **CDN (CloudFront)** - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
4. **è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°** - è² è·å¯¾å¿œ

## è¦‹ç©ã‚‚ã‚Šã‚³ã‚¹ãƒˆå½±éŸ¿

ä¸Šè¨˜æ”¹å–„å®Ÿæ–½ã«ã‚ˆã‚‹æœˆé¡ã‚³ã‚¹ãƒˆå¤‰åŒ–ï¼ˆ8æ—¥ä½¿ç”¨ãƒ™ãƒ¼ã‚¹ï¼‰ï¼š

| é …ç›® | ç¾åœ¨ | æ”¹å–„å¾Œ | å·®é¡ |
|------|------|--------|------|
| åŸºæœ¬ã‚¤ãƒ³ãƒ•ãƒ© | ~337 USD | ~380 USD | +43 USD |
| KMSï¼ˆæš—å·åŒ–ï¼‰ | 0 USD | ~5 USD | +5 USD |
| CloudWatchï¼ˆç›£è¦–ï¼‰ | 0 USD | ~10 USD | +10 USD |
| **åˆè¨ˆ** | **~337 USD** | **~395 USD** | **+58 USD** |

**æ”¹å–„å¾Œã®è¿½åŠ ã‚³ã‚¹ãƒˆç´„58 USD/æœˆ**ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ä¿¡é ¼æ€§ãƒ»é‹ç”¨æ€§ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚

## 7. Linuxã‚µãƒ¼ãƒãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç§»è¡Œæˆ¦ç•¥

### ğŸ”§ ç¾è¡Œã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã®èª²é¡Œ

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦ä»¶:**
- **ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: ç§˜åŒ¿æƒ…å ±ã‚’å«ã‚€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã—ã‹å‚ç…§ã•ã›ãŸããªã„
- **å‹•çš„ç’°å¢ƒ**: å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒåŒã˜ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«åã«æ—¥ä»˜ãŒä»˜ãï¼ˆæ‹¡å¼µACLã§æ¯æ—¥ãƒãƒƒãƒå‡¦ç†ï¼‰
- **ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œåˆ¶å¾¡**: ä¸€éƒ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯rbashã‚’ä½¿ç”¨ã—ã€è¨±å¯ã—ãŸã‚³ãƒãƒ³ãƒ‰ã®ã¿å®Ÿè¡Œå¯èƒ½

### ğŸš€ AWSæ¨å¥¨ç§»è¡Œã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: IAM + Systems Manager Session Manager + ABAC
**æ¦‚è¦:** AWS IAMã®Attribute-Based Access Control (ABAC)ã¨Session Managerã‚’çµ„ã¿åˆã‚ã›ãŸæœ€æ–°ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

```yaml
# IAMãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒ­ãƒ¼ãƒ«ã«ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
IAMRole:
  Type: AWS::IAM::Role
  Properties:
    Tags:
      - Key: "Department"
        Value: "Finance"
      - Key: "AccessLevel" 
        Value: "Restricted"
      - Key: "FilePermission"
        Value: "Read"

# Session Manager ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆrbashä»£æ›¿ï¼‰
SessionDocument:
  Type: AWS::SSM::Document
  Properties:
    DocumentType: Session
    Content:
      schemaVersion: "1.0"
      description: "Restricted shell session"
      sessionType: Standard_Stream
      inputs:
        runAsEnabled: true
        runAsDefaultUser: "finance-user"
        shellProfile:
          linux: |
            # è¨±å¯ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã®ã¿ PATH ã«è¨­å®š
            export PATH="/usr/local/restricted-bin:/usr/bin/safe-commands"
            # ç’°å¢ƒå¤‰æ•°ã§ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¨­å®š
            export USER_DEPT=$AWS_SSM_TAG_Department
            export ACCESS_LEVEL=$AWS_SSM_TAG_AccessLevel
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹ã®å‹•çš„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- âœ… IAMçµ±åˆã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨¼è·¡
- âœ… Session Managerã«ã‚ˆã‚‹æ¥ç¶šãƒ­ã‚°è¨˜éŒ²
- âœ… ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§rbashæ©Ÿèƒ½ã‚’ä»£æ›¿
- âœ… Run Asæ©Ÿèƒ½ã§ç‰¹å®šLinuxãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹

#### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: Systems Manager Parameter Store + User Data + Linux ACLçµ±åˆ
**æ¦‚è¦:** æ—¢å­˜ã®Linux ACLçŸ¥è­˜ã‚’æ´»ç”¨ã—ã¤ã¤ã€AWSã‚µãƒ¼ãƒ“ã‚¹ã§ç®¡ç†ã‚’è‡ªå‹•åŒ–

```bash
#!/bin/bash
# EC2 User Data ã§ã®è‡ªå‹•è¨­å®š

# Parameter Store ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå–å¾—
USER_CONFIG=$(aws ssm get-parameter \
  --name "/security/users/finance-team" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text)

# å‹•çš„ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨ACLè¨­å®š
echo "${USER_CONFIG}" | jq -r '.users[]' | while read user; do
  useradd -m "$user"
  
  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å‹•çš„è¨­å®š
  USER_DEPT=$(echo "${USER_CONFIG}" | jq -r --arg u "$user" '.users[] | select(.name==$u) | .department')
  
  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåˆ¥æ¨©é™è¨­å®š
  if [ "$USER_DEPT" = "finance" ]; then
    setfacl -R -m u:${user}:rx /data/finance/
    setfacl -R -m u:${user}:--- /data/hr/
  fi
done

# æ¯æ—¥ã®ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
cat > /usr/local/bin/update-file-permissions.sh <<'EOF'
#!/bin/bash
# Parameter Store ã‹ã‚‰æœ€æ–°ã®æ¨©é™è¨­å®šã‚’å–å¾—
PERMISSION_CONFIG=$(aws ssm get-parameter \
  --name "/security/file-permissions/$(date +%Y-%m-%d)" \
  --query 'Parameter.Value' \
  --output text 2>/dev/null)

if [ $? -eq 0 ]; then
  # æ—¥ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’å‹•çš„æ›´æ–°
  echo "${PERMISSION_CONFIG}" | jq -r '.files[]' | while read file_pattern; do
    find /data/ -name "*$(date +%Y%m%d)*" -type f | while read file; do
      # Parameter Storeè¨­å®šã«åŸºã¥ã„ã¦ACLé©ç”¨
      setfacl -m u:finance-user:r-- "$file"
    done
  done
fi
EOF

# Systems Manager Association ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
aws ssm create-association \
  --name "AWS-RunShellScript" \
  --targets "Key=tag:Environment,Values=production" \
  --schedule-expression "cron(0 2 * * ? *)" \
  --parameters 'commands=["/usr/local/bin/update-file-permissions.sh"]'
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… æ—¢å­˜Linux ACLçŸ¥è­˜ã‚’æ´»ç”¨
- âœ… Parameter Storeã§è¨­å®šã®ä¸€å…ƒç®¡ç†
- âœ… Systems Manager Associationã§ãƒãƒƒãƒå‡¦ç†è‡ªå‹•åŒ–
- âœ… æ®µéšçš„ç§»è¡ŒãŒå¯èƒ½

#### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: S3 + IAM + å®Œå…¨ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–
**æ¦‚è¦:** ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’S3ã«ç§»è¡Œã—ã€IAMã§å®Œå…¨åˆ¶å¾¡

```yaml
# S3ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ï¼ˆABACå¯¾å¿œï¼‰
S3BucketPolicy:
  Type: AWS::S3::BucketPolicy
  Properties:
    Bucket: !Ref SecureDataBucket
    PolicyDocument:
      Statement:
        - Sid: "DepartmentBasedAccess"
          Effect: Allow
          Principal: "*"
          Action:
            - "s3:GetObject"
            - "s3:PutObject"
          Resource: !Sub "${SecureDataBucket}/data/${aws:PrincipalTag/Department}/*"
          Condition:
            StringEquals:
              "aws:PrincipalTag/Department": 
                - "finance"
                - "hr"
        
        - Sid: "RestrictedFileAccess"
          Effect: Allow
          Principal: "*"
          Action: "s3:GetObject"
          Resource: !Sub "${SecureDataBucket}/restricted/*"
          Condition:
            StringEquals:
              "aws:PrincipalTag/AccessLevel": "Sensitive"

# Lambdaé–¢æ•°ï¼ˆæ—¥æ¬¡ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼‰
FileProcessingLambda:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      ZipFile: |
        import boto3
        import json
        from datetime import datetime
        
        def lambda_handler(event, context):
            s3 = boto3.client('s3')
            
            # æ—¥ä»˜ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢
            today = datetime.now().strftime('%Y%m%d')
            
            # S3ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¿ã‚°ä»˜ã‘ã§æ¨©é™åˆ¶å¾¡
            objects = s3.list_objects_v2(
                Bucket=os.environ['BUCKET_NAME'],
                Prefix=f'daily-data/{today}'
            )
            
            for obj in objects.get('Contents', []):
                # ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã«å¿œã˜ã¦ã‚¿ã‚°è¨­å®š
                if 'sensitive' in obj['Key']:
                    s3.put_object_tagging(
                        Bucket=os.environ['BUCKET_NAME'],
                        Key=obj['Key'],
                        Tagging={
                            'TagSet': [
                                {'Key': 'AccessLevel', 'Value': 'Restricted'},
                                {'Key': 'Department', 'Value': 'Finance'}
                            ]
                        }
                    )
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… IAMãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹ç´°ã‹ã„æ¨©é™åˆ¶å¾¡
- âœ… S3ã‚¿ã‚°ã«ã‚ˆã‚‹å‹•çš„ãƒ•ã‚¡ã‚¤ãƒ«åˆ†é¡
- âœ… Lambda/EventBridgeã«ã‚ˆã‚‹è‡ªå‹•åŒ–
- âœ… CloudTrailã«ã‚ˆã‚‹å®Œå…¨ãªç›£æŸ»è¨¼è·¡
- âœ… ç„¡åˆ¶é™ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### ğŸ“Š ç§»è¡Œã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¯”è¼ƒ

| é …ç›® | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1<br/>(IAM+ABAC+SSM) | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2<br/>(Parameter Store+ACL) | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3<br/>(S3+IAMå®Œå…¨ç§»è¡Œ) |
|------|-------------------------------|-----------------------------------|------------------------------|
| **ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶å¾¡ã®ç´°ã‹ã•** | â— ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹å‹•çš„åˆ¶å¾¡ | â—‹ å¾“æ¥ACLãƒ™ãƒ¼ã‚¹ | â— IAMãƒãƒªã‚·ãƒ¼+S3ã‚¿ã‚° |
| **rbashä»£æ›¿** | â— Session Manager Document | â–³ å¾“æ¥rbashç¶™ç¶š | âœ— å¯¾è±¡å¤–ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰ |
| **å­¦ç¿’ã‚³ã‚¹ãƒˆ** | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜…â˜† |
| **ç§»è¡Œå·¥æ•°** | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜…â˜… |
| **é‹ç”¨è² è·** | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜†â˜† | â˜…â˜†â˜†â˜†â˜† |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«** | â— æœ€é«˜ | â—‹ é«˜ | â— æœ€é«˜ |
| **ç›£æŸ»æ€§** | â— CloudTrailçµ±åˆ | â—‹ ä¸€éƒ¨ãƒ­ã‚°åˆ†æ•£ | â— å®Œå…¨çµ±åˆ |
| **ã‚³ã‚¹ãƒˆ** | ä½ï¼ˆæ—¢å­˜EC2æ´»ç”¨ï¼‰ | ä½ï¼ˆæ—¢å­˜EC2æ´»ç”¨ï¼‰ | ä¸­ï¼ˆS3+Lambdaæ–™é‡‘ï¼‰ |

### ğŸ¯ POCç’°å¢ƒã§ã®æ¨å¥¨å®Ÿè£…æˆ¦ç•¥

#### Phase 1: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2ï¼ˆParameter Store + ACLçµ±åˆï¼‰
**ç†ç”±:** æ—¢å­˜çŸ¥è­˜æ´»ç”¨ã€æœ€å°å­¦ç¿’ã‚³ã‚¹ãƒˆã€æ®µéšçš„ç§»è¡Œ

```yaml
# æœ€åˆã®å®Ÿè£…ï¼ˆPOCå‘ã‘ï¼‰
UserManagementAutomation:
  Type: AWS::SSM::Document
  Properties:
    DocumentType: Command
    Content:
      schemaVersion: "2.2"
      description: "Setup user permissions based on Parameter Store config"
      parameters:
        configPath:
          type: String
          default: "/security/users/config"
      mainSteps:
        - action: "aws:runShellScript"
          name: "setupUsers"
          inputs:
            runCommand:
              - |
                # Parameter Store ã‹ã‚‰è¨­å®šå–å¾—
                CONFIG=$(aws ssm get-parameter --name "{{ configPath }}" --with-decryption --query 'Parameter.Value' --output text)
                
                # æ—¢å­˜ACLãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾æ´»ç”¨
                echo "$CONFIG" | jq -r '.filePermissions[]' | while read perm; do
                  USER=$(echo "$perm" | jq -r '.user')
                  FILES=$(echo "$perm" | jq -r '.files[]')
                  PERMISSIONS=$(echo "$perm" | jq -r '.permissions')
                  
                  # å¾“æ¥ã®setfaclã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨
                  setfacl -m u:${USER}:${PERMISSIONS} ${FILES}
                done
```

#### Phase 2: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1ã¸ã®ç§»è¡Œï¼ˆæœ¬æ ¼é‹ç”¨æ™‚ï¼‰
Session Managerã®ABACã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ®µéšçš„ã«å°å…¥

#### Phase 3: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3ã®éƒ¨åˆ†å°å…¥ï¼ˆå°†æ¥çš„ï¼‰
æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã‚’S3ã«ç§»è¡Œã€IAMãƒ™ãƒ¼ã‚¹å®Œå…¨åˆ¶å¾¡

### ğŸ› ï¸ å…·ä½“çš„ãªå®Ÿè£…ä¾‹

**rbashæ©Ÿèƒ½ã®Session Managerç§»è¡Œ:**

```yaml
# åˆ¶é™ä»˜ãã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
RestrictedSessionDocument:
  Type: AWS::SSM::Document
  Properties:
    Name: "RestrictedShell-Finance"
    DocumentType: Session
    Content:
      schemaVersion: "1.0"
      sessionType: Standard_Stream
      inputs:
        runAsEnabled: true
        runAsDefaultUser: "finance-user"
        shellProfile:
          linux: |
            # åˆ¶é™ä»˜ãPATHè¨­å®šï¼ˆrbashä»£æ›¿ï¼‰
            export PATH="/usr/local/bin/allowed-commands"
            
            # è¨±å¯ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ã®ã¿ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ
            mkdir -p /usr/local/bin/allowed-commands
            ln -sf /bin/ls /usr/local/bin/allowed-commands/
            ln -sf /bin/cat /usr/local/bin/allowed-commands/
            ln -sf /usr/bin/grep /usr/local/bin/allowed-commands/
            
            # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§å±é™ºãªã‚³ãƒãƒ³ãƒ‰ã‚’ç„¡åŠ¹åŒ–
            alias rm='echo "Command not allowed"'
            alias sudo='echo "Sudo access restricted"'
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éƒ¨ç½²ã«åŸºã¥ãã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
            export USER_DEPARTMENT="${aws:PrincipalTag/Department}"
            
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
            if [ "$USER_DEPARTMENT" = "finance" ]; then
              cd /data/finance
              export HOME=/data/finance/users/$(whoami)
            fi

# IAMãƒãƒªã‚·ãƒ¼ï¼ˆABACå¯¾å¿œï¼‰
RestrictedSessionPolicy:
  Type: AWS::IAM::Policy
  Properties:
    PolicyDocument:
      Statement:
        - Effect: Allow
          Action: "ssm:StartSession"
          Resource: 
            - !Sub "arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*"
            - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:document/RestrictedShell-Finance"
          Condition:
            StringEquals:
              "aws:PrincipalTag/Department": "finance"
              "ssm:resourceTag/Environment": "production"
```

**å‹•çš„ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ç®¡ç†:**

```bash
# Systems Manager Automation Document
cat > dynamic-file-permissions.yaml <<'EOF'
schemaVersion: "0.3"
description: "Dynamic file permission management"
assumeRole: "{{ AutomationAssumeRole }}"
parameters:
  InstanceId:
    type: String
    description: "EC2 Instance ID"
mainSteps:
  - name: UpdateFilePermissions
    action: "aws:runCommand"
    inputs:
      DocumentName: "AWS-RunShellScript"
      InstanceIds: 
        - "{{ InstanceId }}"
      Parameters:
        commands:
          - |
            # ä»Šæ—¥ã®æ—¥ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
            TODAY=$(date +%Y%m%d)
            
            # Parameter Store ã‹ã‚‰éƒ¨ç½²åˆ¥ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å–å¾—
            DEPT_CONFIG=$(aws ssm get-parameter \
              --name "/security/departments/access-rules" \
              --with-decryption \
              --query 'Parameter.Value' \
              --output text)
            
            # æ—¥ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã«å‹•çš„æ¨©é™é©ç”¨
            find /data/logs -name "*${TODAY}*" -type f | while read file; do
              # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‹ã‚‰æ©Ÿå¯†ãƒ¬ãƒ™ãƒ«åˆ¤å®š
              if grep -q "CONFIDENTIAL\|SECRET" "$file"; then
                # æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã¯é™å®šçš„ãªã‚¢ã‚¯ã‚»ã‚¹
                echo "$DEPT_CONFIG" | jq -r '.restricted_users[]' | while read user; do
                  setfacl -m u:${user}:r-- "$file"
                done
                # ãã®ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
                setfacl -m o::--- "$file"
              else
                # é€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«ã¯éƒ¨ç½²ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
                echo "$DEPT_CONFIG" | jq -r '.standard_users[]' | while read user; do
                  setfacl -m u:${user}:r-- "$file"
                done
              fi
              
              # ACLè¨­å®šã‚’ãƒ­ã‚°ã«è¨˜éŒ²
              getfacl "$file" >> /var/log/file-permissions.log
            done
EOF

# EventBridge Rule ã§æ¯æ—¥å®Ÿè¡Œ
aws events put-rule \
  --name "DailyFilePermissionUpdate" \
  --schedule-expression "cron(0 1 * * ? *)" \
  --description "Update file permissions daily"

aws events put-targets \
  --rule "DailyFilePermissionUpdate" \
  --targets "Id"="1","Arn"="arn:aws:ssm:region:account:automation-definition/DynamicFilePermissions","RoleArn"="arn:aws:iam::account:role/EventBridgeExecutionRole"
```

### ğŸ“ˆ ç§»è¡ŒåŠ¹æœã¨ãƒ¡ãƒªãƒƒãƒˆ

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š:**
- IAMçµ±åˆã«ã‚ˆã‚‹ä¸€å…ƒç®¡ç†
- CloudTrailã«ã‚ˆã‚‹å®Œå…¨ãªç›£æŸ»è¨¼è·¡
- ã‚¿ã‚°ãƒ™ãƒ¼ã‚¹å‹•çš„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- Session Manageræ¥ç¶šã«ã‚ˆã‚‹SSHã‚­ãƒ¼ä¸è¦

**é‹ç”¨åŠ¹ç‡å‘ä¸Š:**
- Parameter Storeã«ã‚ˆã‚‹è¨­å®šã®ä¸€å…ƒç®¡ç†
- Systems Manager Automationã«ã‚ˆã‚‹å®šæœŸå‡¦ç†è‡ªå‹•åŒ–
- äººçš„ãƒŸã‚¹ã®å‰Šæ¸›
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã®æ¨©é™å¤‰æ›´

**ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹å¼·åŒ–:**
- ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒAWS CloudTrailã«è¨˜éŒ²
- IAMãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹ç´°ã‹ã„æ¨©é™åˆ¶å¾¡
- Session Manageræ¥ç¶šãƒ­ã‚°
- è‡ªå‹•åŒ–ã«ã‚ˆã‚‹ä¸€è²«ã—ãŸæ¨©é™é©ç”¨

## POCè¦ä»¶ã‹ã‚‰ã®è¿½åŠ æ”¹å–„ç‚¹

### ğŸ“‹ POCè¦ä»¶åˆ†æçµæœ

**POCè¦ä»¶ã‹ã‚‰ç‰¹ã«æ³¨ç›®ã™ã¹ãæ”¹å–„ææ¡ˆ:**

#### 1. EC2ç®¡ç†æ–¹å¼ã®æœ€é©åŒ–
**ç¾çŠ¶:** æ‰‹å‹•ç®¡ç†ã¨Auto Scaling Groupï¼ˆå›ºå®šå°æ•°ï¼‰ã®æ¯”è¼ƒæ¤œè¨äºˆå®š
**ææ¡ˆ:** Auto Scaling Groupï¼ˆå›ºå®šå°æ•°ï¼‰æ¡ç”¨ã‚’å¼·ãæ¨å¥¨

**ç†ç”±:**
- ãƒ‘ãƒƒãƒé©ç”¨ã®è‡ªå‹•åŒ–ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰
- éšœå®³æ™‚ã®è‡ªå‹•å¾©æ—§ï¼ˆ24æ™‚é–“365æ—¥ï¼‰
- ãƒ’ãƒ¥ãƒ¼ãƒãƒ³ã‚¨ãƒ©ãƒ¼å‰Šæ¸›
- é‹ç”¨å·¥æ•°80%å‰Šæ¸›åŠ¹æœ

#### 2. Fargate CI/CDç’°å¢ƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
**ç¾çŠ¶:** ECS Fargateä¸Šã§Gitea/Jenkinsæ§‹ç¯‰äºˆå®š
**è¿½åŠ ææ¡ˆ:**

```yaml
# Fargate ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–
FargateTaskDefinition:
  Properties:
    NetworkMode: awsvpc
    RequiresCompatibilities: [FARGATE]
    ExecutionRoleArn: !Ref ECSExecutionRole
    TaskRoleArn: !Ref ECSTaskRole
    ContainerDefinitions:
      - Name: gitea
        Image: gitea/gitea:latest
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨­å®š
        ReadonlyRootFilesystem: true
        User: "1000:1000"  # non-rootå®Ÿè¡Œ
        LinuxParameters:
          Capabilities:
            Drop: ["ALL"]  # ä¸è¦ãªæ¨©é™å‰Šé™¤
        Secrets:
          - Name: GITEA_DATABASE_PASSWORD
            ValueFrom: !Ref GiteaDBSecret
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Sub "/ecs/${EnvShort}${SystemName}-gitea"
            awslogs-region: !Ref "AWS::Region"
            awslogs-stream-prefix: "container"
```

#### 3. Systems Managerçµ±åˆå¼·åŒ–
**ææ¡ˆ:** POCã§æ¤œè¨¼äºˆå®šã®SSM Session Manageræ©Ÿèƒ½ã‚’æœ€å¤§æ´»ç”¨

```yaml
# VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­å®šï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆæ¥ç¶šï¼‰
SSMVPCEndpoint:
  Type: AWS::EC2::VPCEndpoint
  Properties:
    VpcId: !Ref VPC
    ServiceName: !Sub "com.amazonaws.${AWS::Region}.ssm"
    VpcEndpointType: Interface
    SubnetIds: 
      - !Ref PrivateSubnet1
      - !Ref PrivateSubnet2
    SecurityGroupIds:
      - !Ref SSMEndpointSecurityGroup
    PrivateDnsEnabled: true

# Session Managerè¨­å®šï¼ˆæš—å·åŒ–ï¼‹ãƒ­ã‚°è¨˜éŒ²ï¼‰
SessionManagerSettings:
  Type: AWS::SSM::Document
  Properties:
    Name: "SSM-SessionManagerRunShell"
    DocumentType: Session
    Content:
      schemaVersion: "1.0"
      description: "Document to configure Session Manager preferences"
      sessionType: Standard_Stream
      inputs:
        s3BucketName: !Ref SessionLogsBucket
        s3KeyPrefix: "session-logs/"
        s3EncryptionEnabled: true
        cloudWatchLogGroupName: !Ref SessionLogsGroup
        cloudWatchEncryptionEnabled: true
        kmsKeyId: !Ref SessionManagerKMSKey
        runAsEnabled: true
        runAsDefaultUser: "ssm-user"
        idleSessionTimeout: 60
        maxSessionDuration: 120
```

#### 4. Golden AMIæˆ¦ç•¥ã®å®Ÿè£…
**ææ¡ˆ:** POCã§æ¤œè¨ã•ã‚Œã¦ã„ã‚‹Golden AMIç®¡ç†ã‚’ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ã¦å®Ÿè£…

```yaml
# AMIè‡ªå‹•ä½œæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
AMIBuildPipeline:
  Type: AWS::CodePipeline::Pipeline
  Properties:
    RoleArn: !GetAtt CodePipelineRole.Arn
    Stages:
      - Name: Source
        Actions:
          - Name: SourceAction
            ActionTypeId:
              Category: Source
              Owner: ThirdParty
              Provider: GitHub
              Version: 1
            Configuration:
              Owner: your-org
              Repo: golden-ami
              Branch: main
              OAuthToken: !Ref GitHubToken
            OutputArtifacts:
              - Name: SourceOutput
      
      - Name: Build
        Actions:
          - Name: PackerBuild
            ActionTypeId:
              Category: Build
              Owner: AWS
              Provider: CodeBuild
              Version: 1
            Configuration:
              ProjectName: !Ref PackerBuildProject
            InputArtifacts:
              - Name: SourceOutput
            OutputArtifacts:
              - Name: BuildOutput

# Parameter Store è‡ªå‹•æ›´æ–°
UpdateParameterLambda:
  Type: AWS::Lambda::Function
  Properties:
    Code:
      ZipFile: |
        import boto3
        import json
        
        def lambda_handler(event, context):
            ssm = boto3.client('ssm')
            
            # CodePipelineå®Œäº†æ™‚ã«Parameter Storeæ›´æ–°
            ami_id = event['detail']['ami_id']
            
            ssm.put_parameter(
                Name='/golden-ami/latest/validated',
                Value=ami_id,
                Type='String',
                Overwrite=True,
                Tags=[
                    {'Key': 'CreatedBy', 'Value': 'automated-pipeline'},
                    {'Key': 'Validated', 'Value': 'true'}
                ]
            )
```

## ã¾ã¨ã‚

POCç’°å¢ƒã§ã‚ã£ã¦ã‚‚ã€åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼ˆæš—å·åŒ–ã€IAMæœ€å°æ¨©é™ï¼‰ã¨é‹ç”¨æ€§æ”¹å–„ï¼ˆç›£è¦–ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ã¯å®Ÿè£…ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ç‰¹ã«ã€ãƒ‡ãƒ¼ã‚¿ä¿è­·ã¨ã‚³ã‚¹ãƒˆç®¡ç†ã¯åˆæœŸæ®µéšã‹ã‚‰ã®å¯¾å¿œãŒé‡è¦ã§ã™ã€‚

**Linuxã‚µãƒ¼ãƒãƒ¼ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ç§»è¡Œ**ã«ã¤ã„ã¦ã¯ã€Parameter Store + Linux ACLçµ±åˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‹ã‚‰é–‹å§‹ã—ã€æ®µéšçš„ã«IAM ABAC + Session Managerã¸ç§»è¡Œã™ã‚‹ã“ã¨ã§ã€æ—¢å­˜çŸ¥è­˜ã‚’æ´»ç”¨ã—ãªãŒã‚‰AWSãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æº–æ‹ ã§ãã¾ã™ã€‚

**POCè¦ä»¶ã§è¨ˆç”»ã•ã‚Œã¦ã„ã‚‹é …ç›®**ï¼ˆAuto Scaling Groupå›ºå®šå°æ•°ã€Session Managerã€Golden AMIæˆ¦ç•¥ï¼‰ã¯ã€Well-Architectedãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®è¦³ç‚¹ã‹ã‚‰ã‚‚å„ªã‚ŒãŸé¸æŠã§ã‚ã‚Šã€å®Ÿè£…ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚

æœ¬æ ¼é‹ç”¨ã¸ã®ç§»è¡Œæ™‚ã«ã¯ã€ä¸Šè¨˜ã® Medium/Low Priority é …ç›®ã‚’æ®µéšçš„ã«å®Ÿè£…ã—ã€Well-Architectedãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«æº–æ‹ ã—ãŸã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
