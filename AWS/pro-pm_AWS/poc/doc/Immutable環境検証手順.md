# Immutableç’°å¢ƒæ¤œè¨¼æ‰‹é †

## ğŸ“‘ ç›®æ¬¡

- [ğŸ“‹ æ¦‚è¦](#-æ¦‚è¦)
- [ğŸ¯ æ¤œè¨¼ç›®çš„](#-æ¤œè¨¼ç›®çš„)
- [ğŸ”§ å‰ææ¡ä»¶](#-å‰ææ¡ä»¶)
- [ğŸ“Š æ¤œè¨¼ç’°å¢ƒæ§‹æˆ](#-æ¤œè¨¼ç’°å¢ƒæ§‹æˆ)
- [ğŸ§ª æ¤œè¨¼ã‚·ãƒŠãƒªã‚ªä¸€è¦§](#-æ¤œè¨¼ã‚·ãƒŠãƒªã‚ªä¸€è¦§)
- [ğŸš€ ã‚·ãƒŠãƒªã‚ª1: ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ–æ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª1-ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ–æ¤œè¨¼)
  - [1.1 è‡ªå‹•ãƒ‘ãƒƒãƒé©ç”¨](#11-è‡ªå‹•ãƒ‘ãƒƒãƒé©ç”¨)
  - [1.2 ãƒ‘ãƒƒãƒé©ç”¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯](#12-ãƒ‘ãƒƒãƒé©ç”¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯)
- [ğŸ”„ ã‚·ãƒŠãƒªã‚ª2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª2-ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼)
  - [2.1 Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ](#21-bluegreen ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ)
  - [2.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯](#22-ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯)
- [ğŸ’¥ ã‚·ãƒŠãƒªã‚ª3: éšœå®³å¯¾å¿œæ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª3-éšœå®³å¯¾å¿œæ¤œè¨¼)
  - [3.1 EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éšœå®³](#31-ec2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éšœå®³)
  - [3.2 Auroraéšœå®³å¯¾å¿œ](#32-auroraéšœå®³å¯¾å¿œ)
  - [3.3 ProxySQLéšœå®³å¯¾å¿œ](#33-proxysqléšœå®³å¯¾å¿œ)
- [âš¡ ã‚·ãƒŠãƒªã‚ª4: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª4-ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ¤œè¨¼)
  - [4.1 æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°](#41-æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°)
  - [4.2 å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°](#42-å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°)
- [ğŸ”’ ã‚·ãƒŠãƒªã‚ª5: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª5-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼)
  - [5.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨](#51-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨)
  - [5.2 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ¤œè¨¼](#52-ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ¤œè¨¼)
- [ğŸ“ˆ ã‚·ãƒŠãƒªã‚ª6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª6-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼)
  - [6.1 è² è·ãƒ†ã‚¹ãƒˆ](#61-è² è·ãƒ†ã‚¹ãƒˆ)
  - [6.2 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ€§èƒ½æ¤œè¨¼](#62-ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ€§èƒ½æ¤œè¨¼)
- [ğŸ”„ ã‚·ãƒŠãƒªã‚ª7: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒæ¤œè¨¼](#-ã‚·ãƒŠãƒªã‚ª7-ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒæ¤œè¨¼)
  - [7.1 ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—](#71-ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
- [ğŸš€ ã‚·ãƒŠãƒªã‚ª9: Immutableç’°å¢ƒç†æƒ³å½¢æ¤œè¨¼ï¼ˆå°†æ¥å®Ÿè£…ï¼‰](#-ã‚·ãƒŠãƒªã‚ª9-immutableç’°å¢ƒç†æƒ³å½¢æ¤œè¨¼å°†æ¥å®Ÿè£…)
  - [9.1 ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆAMIï¼‰æ¤œè¨¼](#91-ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸amiæ¤œè¨¼)
  - [9.2 Auto Scalingè‡ªå‹•å¾©æ—§æ¤œè¨¼](#92-auto-scalingè‡ªå‹•å¾©æ—§æ¤œè¨¼)
  - [9.3 Blue/Green ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ¤œè¨¼](#93-bluegreen-ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ¤œè¨¼)
  - [9.4 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼](#94-ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼)
  - [9.5 æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼](#95-æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼)
  - [7.2 ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ å¾©å…ƒ](#72-ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ å¾©å…ƒ)
- [ğŸ“ æ¤œè¨¼çµæœè¨˜éŒ²](#-æ¤œè¨¼çµæœè¨˜éŒ²)
- [ğŸ† æˆåŠŸåŸºæº–](#-æˆåŠŸåŸºæº–)
- [ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](#-é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ProxySQL + Aurora + Laravelçµ±åˆã«ã‚ˆã‚‹Immutable Infrastructureç’°å¢ƒã®åŒ…æ‹¬çš„ãªæ¤œè¨¼æ‰‹é †ã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã‚’ä¸­å¿ƒã¨ã—ãŸå„ç¨®é‹ç”¨ã‚·ãƒŠãƒªã‚ªã®æ¤œè¨¼ã‚’é€šã˜ã¦ã€æœ¬ç•ªç’°å¢ƒã§ã®å®‰å®šç¨¼åƒã‚’ç¢ºä¿ã—ã¾ã™ã€‚

**æ¤œè¨¼å¯¾è±¡ç’°å¢ƒ:**
- Blue/Green Deploymentå¯¾å¿œImmutable Infrastructure
- ProxySQL Database Proxy
- Aurora MySQL Cluster
- Laravel Application Stack
- CloudWatch Monitoring & Alerting

## ğŸ¯ æ¤œè¨¼ç›®çš„

### ä¸»è¦æ¤œè¨¼ç›®æ¨™
1. **ğŸ”µğŸŸ¢ Immutable Infrastructure**: ç„¡åœæ­¢ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ›´æ–°ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
2. **âš¡ é«˜å¯ç”¨æ€§**: éšœå®³æ™‚ã®è‡ªå‹•å¾©æ—§ãƒ»ç¶™ç¶šã‚µãƒ¼ãƒ“ã‚¹æä¾›
3. **ğŸš€ è‡ªå‹•åŒ–**: ãƒ‘ãƒƒãƒé©ç”¨ã‹ã‚‰ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã®å®Œå…¨è‡ªå‹•åŒ–
4. **ğŸ“Š ç›£è¦–**: åŒ…æ‹¬çš„ãªç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã®æ¤œè¨¼
5. **ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®æ¤œè¨¼
6. **ğŸ“ˆ æ€§èƒ½**: è² è·ã«å¯¾ã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼

## ğŸ”§ å‰ææ¡ä»¶

### æ¤œè¨¼ç’°å¢ƒè¦ä»¶
- POC Immutableç’°å¢ƒãŒå®Œå…¨ã«æ§‹ç¯‰æ¸ˆã¿
- Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿
- ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒç¨¼åƒä¸­
- Aurora MySQL ClusterãŒç¨¼åƒä¸­
- ProxySQLãŒå…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ç¨¼åƒä¸­

### å¿…è¦ãƒ„ãƒ¼ãƒ«ãƒ»æ¨©é™
- AWS CLI (ç®¡ç†è€…æ¨©é™)
- Ansible (ã‚¤ãƒ³ãƒ•ãƒ©è‡ªå‹•åŒ–)
- Sceptre (CloudFormationç®¡ç†)
- MySQL Client (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š)
- curl, wget (HTTP ãƒ†ã‚¹ãƒˆ)
- jq (JSONå‡¦ç†)

## ğŸ“Š æ¤œè¨¼ç’°å¢ƒæ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¤œè¨¼ç’°å¢ƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                          â”‚
â”‚                                                               â”‚
â”‚  [Load Balancer] â†’ [Blue/Green Controller]                   â”‚
â”‚                          â”‚                                   â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚          â–¼               â–¼               â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Blue Env    â”‚ â”‚ Green Env   â”‚ â”‚ Test Env    â”‚               â”‚
â”‚  â”‚ pochub-001  â”‚ â”‚ pochub-g001 â”‚ â”‚ pochub-t001 â”‚               â”‚
â”‚  â”‚ pochub-002  â”‚ â”‚ pochub-g002 â”‚ â”‚ (Optional)  â”‚               â”‚
â”‚  â”‚ pochub-003  â”‚ â”‚ pochub-g003 â”‚ â”‚             â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â”‚               â”‚               â”‚                   â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                          â–¼                                   â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚            â”‚     Aurora MySQL Cluster       â”‚                 â”‚
â”‚            â”‚    (å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢)            â”‚                 â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§ª æ¤œè¨¼ã‚·ãƒŠãƒªã‚ªä¸€è¦§

| ã‚·ãƒŠãƒªã‚ª | ç›®çš„ | æ‰€è¦æ™‚é–“ | é‡è¦åº¦ |
|---------|------|----------|--------|
| 1. ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ– | OSãƒ‘ãƒƒãƒç„¡åœæ­¢é©ç”¨ | 30åˆ† | ğŸ”´ é«˜ |
| 2. ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ | Blue/Greenç„¡åœæ­¢ãƒ‡ãƒ—ãƒ­ã‚¤ | 45åˆ† | ğŸ”´ é«˜ |
| 3. éšœå®³å¯¾å¿œ | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ»ã‚µãƒ¼ãƒ“ã‚¹éšœå®³å¯¾å¿œ | 60åˆ† | ğŸ”´ é«˜ |
| 4. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° | æ°´å¹³ãƒ»å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° | 40åˆ† | ğŸŸ¡ ä¸­ |
| 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒãƒ»åˆ¶å¾¡ | 35åˆ† | ğŸ”´ é«˜ |
| 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | è² è·ãƒ»æ€§èƒ½ãƒ†ã‚¹ãƒˆ | 90åˆ† | ğŸŸ¡ ä¸­ |
| 7. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ | ãƒ‡ãƒ¼ã‚¿ä¿è­·ãƒ»å¾©æ—§ | 50åˆ† | ğŸŸ¡ ä¸­ |

**ç·æ¤œè¨¼æ™‚é–“**: ç´„5.5æ™‚é–“ï¼ˆä¸¦è¡Œå®Ÿè¡Œã§çŸ­ç¸®å¯èƒ½ï¼‰

---

## ğŸš€ ã‚·ãƒŠãƒªã‚ª1: ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ–æ¤œè¨¼

### ç›®çš„
Immutable Infrastructureã«ãŠã‘ã‚‹ãƒ‘ãƒƒãƒé©ç”¨ã®è‡ªå‹•åŒ–ã¨ç„¡åœæ­¢æ›´æ–°ã®æ¤œè¨¼

### 1.1 è‡ªå‹•ãƒ‘ãƒƒãƒé©ç”¨

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ç¾åœ¨ã®ç’°å¢ƒçŠ¶æ…‹ç¢ºèª**
```bash
cd /home/tomo/poc/ansible-playbooks

# ç¾åœ¨ã®Blueç’°å¢ƒç¢ºèª
ansible all -i inventory/poc -m shell -a "cat /etc/os-release | head -3"
ansible all -i inventory/poc -m shell -a "uname -r"
ansible all -i inventory/poc -m shell -a "systemctl status proxysql laravel" --become

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¨˜éŒ²
ansible all -i inventory/poc -m shell -a "rpm -qa | grep -E '(kernel|httpd|php|mysql)' | sort" > /tmp/packages_before_patch.log
```

**ã‚¹ãƒ†ãƒƒãƒ—2: åˆ©ç”¨å¯èƒ½ãƒ‘ãƒƒãƒç¢ºèª**
```bash
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç¢ºèª
ansible all -i inventory/poc -m shell -a "dnf check-update --security" --become

# å…¨ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç¢ºèª
ansible all -i inventory/poc -m shell -a "dnf check-update" --become
```

**ã‚¹ãƒ†ãƒƒãƒ—3: Greenç’°å¢ƒã§ã®ãƒ‘ãƒƒãƒé©ç”¨ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯ä½œæˆ**
```bash
# ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ–ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯ä½œæˆ
cat > immutable-patch-deployment.yml << 'EOF'
---
# Immutable Infrastructure Patch Deployment
- name: Immutable Patch Deployment with Blue/Green
  hosts: all
  become: yes
  vars:
    deployment_mode: "{{ deployment_mode | default('patch') }}"
    patch_type: "{{ patch_type | default('security') }}"  # security, all
    
  tasks:
    - name: "=== IMMUTABLE PATCH DEPLOYMENT START ==="
      debug:
        msg: |
          ğŸ”„ Immutable Infrastructure ãƒ‘ãƒƒãƒé©ç”¨é–‹å§‹
          
          Mode: {{ deployment_mode }}
          Patch Type: {{ patch_type }}
          Target: {{ ansible_hostname }}
          Timestamp: {{ ansible_date_time.iso8601 }}

    - name: Create patch deployment marker
      file:
        path: /tmp/patch_deployment_{{ ansible_date_time.epoch }}
        state: touch

    - name: Backup current package list
      shell: rpm -qa | sort > /tmp/packages_before_{{ ansible_date_time.epoch }}.log

    - name: Apply security patches
      dnf:
        name: "*"
        state: latest
        security: yes
        update_cache: yes
      when: patch_type == 'security'
      register: security_updates

    - name: Apply all patches
      dnf:
        name: "*"
        state: latest
        update_cache: yes
      when: patch_type == 'all'
      register: all_updates

    - name: Record applied patches
      shell: rpm -qa | sort > /tmp/packages_after_{{ ansible_date_time.epoch }}.log

    - name: Generate patch diff
      shell: |
        diff /tmp/packages_before_{{ ansible_date_time.epoch }}.log \
             /tmp/packages_after_{{ ansible_date_time.epoch }}.log > \
             /tmp/patch_diff_{{ ansible_date_time.epoch }}.log || true

    - name: Restart services if needed
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - httpd
        - php-fpm
      when: security_updates.changed or all_updates.changed

    - name: Restart ProxySQL if updated
      systemd:
        name: proxysql
        state: restarted
      when: 
        - security_updates.changed or all_updates.changed
        - "'proxysql' in ansible_facts.packages"

    - name: Wait for services to stabilize
      pause:
        seconds: 30

    - name: Verify application health
      uri:
        url: "http://{{ ansible_default_ipv4.address }}/health"
        method: GET
        status_code: 200
      register: health_check

    - name: Verify ProxySQL connectivity
      mysql_info:
        login_host: 127.0.0.1
        login_port: 6033
        login_user: "{{ laravel_db_user }}"
        login_password: "{{ laravel_db_password }}"
      register: proxysql_check

    - name: "=== PATCH DEPLOYMENT RESULTS ==="
      debug:
        msg: |
          âœ… ãƒ‘ãƒƒãƒé©ç”¨å®Œäº†
          
          Security Updates: {{ security_updates.changed | default(false) }}
          All Updates: {{ all_updates.changed | default(false) }}
          Health Check: {{ health_check.status }}
          ProxySQL Status: {{ 'OK' if proxysql_check.version is defined else 'ERROR' }}
          
          Patch Diff: /tmp/patch_diff_{{ ansible_date_time.epoch }}.log
EOF
```

**ã‚¹ãƒ†ãƒƒãƒ—4: Blueç’°å¢ƒã§ã®ãƒ‘ãƒƒãƒé©ç”¨å®Ÿè¡Œ**
```bash
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®ã¿é©ç”¨ï¼ˆæœ¬ç•ªæ¨å¥¨ï¼‰
ansible-playbook -i inventory/poc immutable-patch-deployment.yml \
  -e "deployment_mode=patch patch_type=security"

# å®Ÿè¡Œçµæœç¢ºèª
ansible all -i inventory/poc -m shell -a "cat /tmp/patch_diff_*.log | tail -20"
```

**ã‚¹ãƒ†ãƒƒãƒ—5: Greenç’°å¢ƒä½œæˆãƒ»ãƒ‘ãƒƒãƒé©ç”¨**
```bash
# Greenç’°å¢ƒç”¨AMIä½œæˆï¼ˆãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿ï¼‰
# æ³¨: å®Ÿéš›ã®ç’°å¢ƒã§ã¯æ–°ã—ã„AMIã‚’ä½œæˆã—ã€Greenç’°å¢ƒã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤

# Greenç’°å¢ƒã¸ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ®µéšçš„åˆ‡ã‚Šæ›¿ãˆ
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=switch target_environment=green traffic_percentage=10"

# Greenç’°å¢ƒå‹•ä½œç¢ºèª
ansible all -i inventory/poc -m shell -a "curl -s http://localhost/health"

# å•é¡Œãªã‘ã‚Œã°å®Œå…¨åˆ‡ã‚Šæ›¿ãˆ
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=switch target_environment=green traffic_percentage=100"
```

### 1.2 ãƒ‘ãƒƒãƒé©ç”¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: å•é¡Œç™ºç”Ÿã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
```bash
# Greenç’°å¢ƒã§æ„å›³çš„ã«å•é¡Œã‚’ç™ºç”Ÿã•ã›ã‚‹
ansible all -i inventory/poc -m shell -a "systemctl stop httpd" --become
```

**ã‚¹ãƒ†ãƒƒãƒ—2: è‡ªå‹•ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª**
```bash
# CloudWatch ã‚¢ãƒ©ãƒ¼ãƒ ç¢ºèª
aws cloudwatch describe-alarms \
  --state-value ALARM \
  --region ap-northeast-1

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ç¢ºèª
ansible all -i inventory/poc -m shell -a "curl -s -o /dev/null -w '%{http_code}' http://localhost/health"
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ**
```bash
# å³åº§ã«Blueç’°å¢ƒã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=rollback"

# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¢ºèª
ansible all -i inventory/poc -m shell -a "curl -s http://localhost/health"
```

**ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼**
```bash
# Blueç’°å¢ƒã§ã®æ­£å¸¸æ€§ç¢ºèª
ansible all -i inventory/poc -m shell -a "systemctl status httpd php-fpm proxysql"

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèªï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
ansible all -i inventory/poc -m shell -a "rpm -qa | grep -E '(kernel|httpd|php)' | head -5"
```

---

## ğŸ”„ ã‚·ãƒŠãƒªã‚ª2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼

### ç›®çš„
Laravel ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®æ¤œè¨¼

### 2.1 Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª**
```bash
# ç¾åœ¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
ansible all -i inventory/poc -m shell -a "cd /var/www/poc-web && php artisan --version"

# ç¾åœ¨ã®Gitã‚³ãƒŸãƒƒãƒˆç¢ºèª
ansible all -i inventory/poc -m shell -a "cd /var/www/poc-web && git log --oneline -5"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
ansible all -i inventory/poc -m shell -a "cd /var/www/poc-web && php artisan migrate:status"
```

**ã‚¹ãƒ†ãƒƒãƒ—2: æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™**
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯ä½œæˆ
cat > immutable-app-deployment.yml << 'EOF'
---
# Immutable Application Deployment with Blue/Green
- name: Immutable Application Deployment
  hosts: all
  become: yes
  vars:
    app_version: "{{ app_version | default('v2.0.0') }}"
    git_branch: "{{ git_branch | default('main') }}"
    deployment_env: "{{ deployment_env | default('green') }}"
    
  tasks:
    - name: "=== APPLICATION DEPLOYMENT START ==="
      debug:
        msg: |
          ğŸš€ Laravel Application ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
          
          Version: {{ app_version }}
          Branch: {{ git_branch }}
          Environment: {{ deployment_env }}
          Host: {{ ansible_hostname }}

    - name: Create deployment backup
      shell: |
        if [ -d "/var/www/poc-web" ]; then
          cp -r /var/www/poc-web /var/www/poc-web.backup.{{ ansible_date_time.epoch }}
        fi

    - name: Create Green environment directory
      file:
        path: /var/www/poc-web-green
        state: directory
        owner: apache
        group: apache
        mode: '0755'
      when: deployment_env == 'green'

    - name: Clone/Update application code
      git:
        repo: https://github.com/your-repo/poc-web.git  # å®Ÿéš›ã®ãƒªãƒã‚¸ãƒˆãƒªã«å¤‰æ›´
        dest: "/var/www/poc-web-{{ deployment_env }}"
        version: "{{ git_branch }}"
        force: yes
      become_user: apache

    - name: Install/Update Composer dependencies
      composer:
        command: install
        working_dir: "/var/www/poc-web-{{ deployment_env }}"
        optimize_autoloader: yes
        no_dev: yes
      become_user: apache

    - name: Copy environment configuration
      copy:
        src: /var/www/poc-web/.env
        dest: "/var/www/poc-web-{{ deployment_env }}/.env"
        remote_src: yes
        owner: apache
        group: apache

    - name: Update environment for Green deployment
      lineinfile:
        path: "/var/www/poc-web-{{ deployment_env }}/.env"
        regexp: "^APP_ENV="
        line: "APP_ENV={{ deployment_env }}"
      when: deployment_env == 'green'

    - name: Clear Laravel caches
      shell: |
        cd "/var/www/poc-web-{{ deployment_env }}"
        php artisan config:clear
        php artisan cache:clear
        php artisan view:clear
        php artisan route:clear
      become_user: apache

    - name: Run database migrations
      shell: |
        cd "/var/www/poc-web-{{ deployment_env }}"
        php artisan migrate --force
      become_user: apache
      when: deployment_env == 'green'

    - name: Optimize Laravel
      shell: |
        cd "/var/www/poc-web-{{ deployment_env }}"
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
      become_user: apache

    - name: Update Apache DocumentRoot for Green
      lineinfile:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^DocumentRoot'
        line: 'DocumentRoot "/var/www/poc-web-{{ deployment_env }}/public"'
      when: deployment_env == 'green'
      notify: restart httpd

    - name: Test application connectivity
      uri:
        url: "http://{{ ansible_default_ipv4.address }}/health"
        method: GET
        status_code: 200
      register: app_health

    - name: "=== DEPLOYMENT VERIFICATION ==="
      debug:
        msg: |
          âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          
          Version: {{ app_version }}
          Environment: {{ deployment_env }}
          Health Status: {{ app_health.status }}
          Response Time: {{ app_health.elapsed }}ç§’

  handlers:
    - name: restart httpd
      systemd:
        name: httpd
        state: restarted
EOF
```

**ã‚¹ãƒ†ãƒƒãƒ—3: Greenç’°å¢ƒã¸ã®ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤**
```bash
# Greenç’°å¢ƒã«æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
ansible-playbook -i inventory/poc immutable-app-deployment.yml \
  -e "app_version=v2.1.0 deployment_env=green git_branch=release/v2.1.0"

# Greenç’°å¢ƒå‹•ä½œç¢ºèª
ansible all -i inventory/poc -m shell -a "curl -s http://localhost/health | jq ."
```

**ã‚¹ãƒ†ãƒƒãƒ—4: æ®µéšçš„ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ**
```bash
# 5%ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’Greenç’°å¢ƒã«
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=switch target_environment=green traffic_percentage=5"

# 5åˆ†é–“ç›£è¦–
echo "5åˆ†é–“ã®ç›£è¦–é–‹å§‹..."
for i in {1..30}; do
    curl -s http://pochub-001/health | jq -r '.status // "ERROR"'
    sleep 10
done

# 25%ã«å¢—åŠ 
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=switch target_environment=green traffic_percentage=25"

# 50%ã«å¢—åŠ 
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=switch target_environment=green traffic_percentage=50"

# 100%å®Œå…¨åˆ‡ã‚Šæ›¿ãˆ
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=switch target_environment=green traffic_percentage=100"
```

### 2.2 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: å•é¡Œç™ºç”Ÿã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
```bash
# Greenç’°å¢ƒã§æ„å›³çš„ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿ
ansible all -i inventory/poc -m shell -a "cd /var/www/poc-web-green && chmod 000 storage/logs/laravel.log" --become
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¨ãƒ©ãƒ¼ç›£è¦–ç¢ºèª**
```bash
# CloudWatch Laravel ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
aws cloudwatch get-metric-statistics \
  --namespace "Laravel/poc" \
  --metric-name "ErrorCount" \
  --start-time $(date -u -d '10 minutes ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Maximum

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ç¢ºèª
ansible all -i inventory/poc -m shell -a "curl -s -o /dev/null -w '%{http_code}' http://localhost/health"
```

**ã‚¹ãƒ†ãƒƒãƒ—3: è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ**
```bash
# Blueç’°å¢ƒã¸ã®ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
ansible-playbook -i inventory/poc blue-green-deployment.yml \
  -e "deployment_mode=rollback"

# ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç¢ºèª
ansible all -i inventory/poc -m shell -a "curl -s http://localhost/health"
ansible all -i inventory/poc -m shell -a "cd /var/www/poc-web && php artisan --version"
```

---

## ğŸ’¥ ã‚·ãƒŠãƒªã‚ª3: éšœå®³å¯¾å¿œæ¤œè¨¼

### ç›®çš„
å„ç¨®éšœå®³ã‚·ãƒŠãƒªã‚ªã§ã®è‡ªå‹•å¾©æ—§ãƒ»ç¶™ç¶šã‚µãƒ¼ãƒ“ã‚¹æä¾›ã®æ¤œè¨¼

### 3.1 EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éšœå®³

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
```bash
# pochub-002 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ„å›³çš„ã«åœæ­¢
aws ec2 stop-instances \
  --instance-ids $(aws ec2 describe-instances --filters "Name=tag:Name,Values=pochub-002" --query 'Reservations[0].Instances[0].InstanceId' --output text) \
  --region ap-northeast-1

# åœæ­¢ç¢ºèª
aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=pochub-002" \
  --query 'Reservations[].Instances[].[InstanceId,State.Name]' \
  --output table
```

**ã‚¹ãƒ†ãƒƒãƒ—2: è‡ªå‹•æ¤œå‡ºãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª**
```bash
# CloudWatch ã‚¢ãƒ©ãƒ¼ãƒ ç¢ºèª
aws cloudwatch describe-alarms \
  --alarm-names "poc-EC2-pochub-002-StatusCheck" \
  --region ap-northeast-1

# ProxySQLè‡ªå‹•é™¤å¤–ç¢ºèª
ansible pochub-001:pochub-003 -i inventory/poc -m shell -a "mysql -h127.0.0.1 -P6032 -uproxysql-admin -pproxysql123 -e 'SELECT hostgroup_id,hostname,port,status FROM mysql_servers;'"
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šæ€§ç¢ºèª**
```bash
# æ®‹ã‚Šã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã®ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šç¢ºèª
for i in {1..10}; do
    curl -s http://pochub-001/health | jq -r '.status // "ERROR"'
    curl -s http://pochub-003/health | jq -r '.status // "ERROR"'
    sleep 5
done
```

**ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªå‹•å¾©æ—§**
```bash
# Auto Scaling Group ã«ã‚ˆã‚‹è‡ªå‹•å¾©æ—§ç¢ºèªï¼ˆè¨­å®šæ¸ˆã¿ã®å ´åˆï¼‰
# ã¾ãŸã¯æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†èµ·å‹•
aws ec2 start-instances \
  --instance-ids $(aws ec2 describe-instances --filters "Name=tag:Name,Values=pochub-002" --query 'Reservations[0].Instances[0].InstanceId' --output text) \
  --region ap-northeast-1

# å¾©æ—§ç¢ºèª
sleep 120  # èµ·å‹•å¾…æ©Ÿ
ansible pochub-002 -i inventory/poc -m shell -a "systemctl status httpd php-fpm proxysql"
```

### 3.2 Auroraéšœå®³å¯¾å¿œ

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: Aurora Writeréšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
```bash
# Aurora Writer ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å¼·åˆ¶ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
aws rds failover-db-cluster \
  --db-cluster-identifier poc-aurora-mysql \
  --region ap-northeast-1

# ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼çŠ¶æ³ç›£è¦–
watch "aws rds describe-db-clusters --db-cluster-identifier poc-aurora-mysql --query 'DBClusters[0].{Status:Status,Writer:Endpoint}' --output table"
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ProxySQLè‡ªå‹•å¯¾å¿œç¢ºèª**
```bash
# ProxySQLæ¥ç¶šãƒ—ãƒ¼ãƒ«çŠ¶æ³ç¢ºèª
ansible all -i inventory/poc -m shell -a "mysql -h127.0.0.1 -P6032 -uproxysql-admin -pproxysql123 -e 'SELECT hostgroup,srv_host,srv_port,status,ConnUsed,ConnFree,ConnERR FROM stats_mysql_connection_pool;'"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¶™ç¶šæ€§ç¢ºèª
for i in {1..20}; do
    echo "$(date): $(curl -s http://pochub-001/health | jq -r '.database.status // "ERROR"')"
    sleep 5
done
```

### 3.3 ProxySQLéšœå®³å¯¾å¿œ

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ProxySQLéšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**
```bash
# pochub-001ã®ProxySQLã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
ansible pochub-001 -i inventory/poc -m shell -a "systemctl stop proxysql" --become

# éšœå®³æ¤œå‡ºç¢ºèª
ansible pochub-001 -i inventory/poc -m shell -a "curl -s -o /dev/null -w '%{http_code}' http://localhost/health"
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è‡ªå‹•å¾©æ—§ç¢ºèª**
```bash
# Laravel ã®è‡ªå‹•æ¥ç¶šå¾©æ—§ç¢ºèª
ansible pochub-001 -i inventory/poc -m shell -a "cd /var/www/poc-web && php artisan tinker --execute='DB::connection()->getPdo(); echo \"DB Connected\";'"

# ä»–ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã®æ­£å¸¸å‹•ä½œç¢ºèª
ansible pochub-002:pochub-003 -i inventory/poc -m shell -a "curl -s http://localhost/health | jq -r '.status'"
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ProxySQLè‡ªå‹•å¾©æ—§**
```bash
# ProxySQL ã‚µãƒ¼ãƒ“ã‚¹è‡ªå‹•å¾©æ—§
ansible pochub-001 -i inventory/poc -m shell -a "systemctl start proxysql" --become

# å¾©æ—§ç¢ºèª
sleep 30
ansible pochub-001 -i inventory/poc -m shell -a "mysql -h127.0.0.1 -P6033 -upoc_user -p'password' -e 'SELECT @@hostname;'"
```

---

## âš¡ ã‚·ãƒŠãƒªã‚ª4: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ¤œè¨¼

### ç›®çš„
æ°´å¹³ãƒ»å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®æ¤œè¨¼

### 4.1 æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ç¾åœ¨ã®ãƒªã‚½ãƒ¼ã‚¹çŠ¶æ³ç¢ºèª**
```bash
# ç¾åœ¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ç¢ºèª
aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=pochub-*" "Name=instance-state-name,Values=running" \
  --query 'length(Reservations[].Instances[])'

# CPUãƒ»ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ç¢ºèª
ansible all -i inventory/poc -m shell -a "top -bn1 | grep 'Cpu(s)'"
ansible all -i inventory/poc -m shell -a "free -m"
```

**ã‚¹ãƒ†ãƒƒãƒ—2: è² è·ç”Ÿæˆã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°éœ€è¦ä½œæˆ**
```bash
# è² è·ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
cat > /tmp/load-generator.sh << 'EOF'
#!/bin/bash
# æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ¤œè¨¼ç”¨è² è·ç”Ÿæˆ

for i in {1..1000}; do
    curl -s http://pochub-001/health >/dev/null &
    curl -s http://pochub-002/health >/dev/null &
    curl -s http://pochub-003/health >/dev/null &
    sleep 0.1
done
wait
EOF

chmod +x /tmp/load-generator.sh

# è² è·ç”Ÿæˆå®Ÿè¡Œ
/tmp/load-generator.sh &
LOAD_PID=$!
```

**ã‚¹ãƒ†ãƒƒãƒ—3: æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ **
```bash
# ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆç”¨æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆCloudFormationï¼‰
cd /home/tomo/poc/sceptre

# ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆè¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
# æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•å¾Œã€ProxySQLè¨­å®šè¿½åŠ 
```

### 4.2 å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ç¾åœ¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ç¢ºèª**
```bash
# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ç¢ºèª
aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=pochub-*" \
  --query 'Reservations[].Instances[].[Tags[?Key==`Name`].Value|[0],InstanceType]' \
  --output table
```

**ã‚¹ãƒ†ãƒƒãƒ—2: Greenç’°å¢ƒã§ã®å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**
```bash
# ã‚ˆã‚Šå¤§ããªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã§Greenç’°å¢ƒä½œæˆ
# t3.medium â†’ t3.large ã¸ã®å¤‰æ›´ä¾‹

# Blue/Greenåˆ‡ã‚Šæ›¿ãˆã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—å¤‰æ›´
# ï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯æ–°ã—ã„AMIã§æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼‰
```

---

## ğŸ”’ ã‚·ãƒŠãƒªã‚ª5: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼

### ç›®çš„
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ãƒ»ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®æ¤œè¨¼

### 5.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³**
```bash
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯ä½œæˆ
cat > security-scan.yml << 'EOF'
---
- name: Security Vulnerability Scan
  hosts: all
  become: yes
  tasks:
    - name: Check for security updates
      dnf:
        list: updates
        security: yes
      register: security_updates

    - name: Scan for known vulnerabilities
      shell: |
        dnf updateinfo list security
        rpm -qa | xargs -I {} rpm -q --changelog {} | grep -i security | head -10
      register: vuln_scan

    - name: Display security findings
      debug:
        msg: |
          Security Updates Available: {{ security_updates.results | length }}
          Vulnerabilities Found: {{ vuln_scan.stdout_lines | length }}
EOF

ansible-playbook -i inventory/poc security-scan.yml
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨**
```bash
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã®ã¿é©ç”¨
ansible-playbook -i inventory/poc immutable-patch-deployment.yml \
  -e "deployment_mode=security_patch patch_type=security"
```

### 5.2 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ¤œè¨¼

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç¢ºèª**
```bash
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ç¢ºèª
aws ec2 describe-security-groups \
  --filters "Name=group-name,Values=*poc*" \
  --query 'SecurityGroups[].[GroupName,IpPermissions[]]'

# ProxySQLç®¡ç†ãƒãƒ¼ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ç¢ºèª
ansible all -i inventory/poc -m shell -a "netstat -tulpn | grep :6032"
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ç¢ºèª**
```bash
# Auroraæ¥ç¶šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª
ansible all -i inventory/poc -m shell -a "mysql -h127.0.0.1 -P6033 -upoc_user -p'password' -e 'SHOW GRANTS FOR CURRENT_USER();'"
```

---

## ğŸ“ˆ ã‚·ãƒŠãƒªã‚ª6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼

### ç›®çš„
è² è·ã«å¯¾ã™ã‚‹ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ¤œè¨¼

### 6.1 è² è·ãƒ†ã‚¹ãƒˆ

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ€§èƒ½æ¸¬å®š**
```bash
# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«è¨­å®š
dnf install -y wrk

# ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ¸¬å®š
wrk -t12 -c400 -d30s http://pochub-001/health
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ProxySQLè² è·åˆ†æ•£ç¢ºèª**
```bash
# è² è·ãƒ†ã‚¹ãƒˆä¸­ã®ProxySQLçµ±è¨ˆç¢ºèª
while true; do
    ansible all -i inventory/poc -m shell -a "mysql -h127.0.0.1 -P6032 -uproxysql-admin -pproxysql123 -e 'SELECT hostgroup,srv_host,Queries,Bytes_data_sent FROM stats_mysql_connection_pool;'"
    sleep 10
done
```

### 6.2 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ€§èƒ½æ¤œè¨¼

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š**
```bash
# ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ç¶™ç¶šç›£è¦–
cat > /tmp/response-time-monitor.sh << 'EOF'
#!/bin/bash
echo "=== Response Time Monitoring ==="
echo "Timestamp,Endpoint,ResponseTime(ms),StatusCode"

for i in {1..100}; do
    for endpoint in pochub-001 pochub-002 pochub-003; do
        RESPONSE=$(curl -s -w "%{time_total},%{http_code}" -o /dev/null http://$endpoint/health)
        TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
        echo "$TIMESTAMP,$endpoint,$RESPONSE"
    done
    sleep 5
done
EOF

chmod +x /tmp/response-time-monitor.sh
/tmp/response-time-monitor.sh > /tmp/response-times.csv
```

---

## ğŸ”„ ã‚·ãƒŠãƒªã‚ª7: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒæ¤œè¨¼

### ç›®çš„
ãƒ‡ãƒ¼ã‚¿ä¿è­·ãƒ»å¾©æ—§æ©Ÿèƒ½ã®æ¤œè¨¼

### 7.1 ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: Auroraè‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª**
```bash
# Aurora ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨­å®šç¢ºèª
aws rds describe-db-clusters \
  --db-cluster-identifier poc-aurora-mysql \
  --query 'DBClusters[0].{BackupRetentionPeriod:BackupRetentionPeriod,PreferredBackupWindow:PreferredBackupWindow}' \
  --region ap-northeast-1
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**
```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
ansible all -i inventory/poc -m shell -a "tar -czf /tmp/app-backup-$(date +%Y%m%d-%H%M%S).tar.gz /var/www/poc-web/.env /etc/httpd/conf/ /etc/proxysql.cnf" --become
```

### 7.2 ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ å¾©å…ƒ

#### æ¤œè¨¼æ‰‹é †

**ã‚¹ãƒ†ãƒƒãƒ—1: å¾©å…ƒãƒã‚¤ãƒ³ãƒˆä½œæˆ**
```bash
# ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŒ¿å…¥
ansible pochub-001 -i inventory/poc -m shell -a "cd /var/www/poc-web && php artisan tinker --execute='DB::table(\"test_backup\")->insert([\"data\" => \"backup_test_\" . now(), \"created_at\" => now()]);'"

# å¾©å…ƒãƒã‚¤ãƒ³ãƒˆè¨˜éŒ²
RESTORE_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
echo "Restore Point: $RESTORE_TIME"
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ãƒã‚¤ãƒ³ãƒˆã‚¤ãƒ³ã‚¿ã‚¤ãƒ å¾©å…ƒå®Ÿè¡Œ**
```bash
# Aurora Point-in-Timeå¾©å…ƒï¼ˆãƒ†ã‚¹ãƒˆç’°å¢ƒã§å®Ÿè¡Œï¼‰
aws rds restore-db-cluster-to-point-in-time \
  --source-db-cluster-identifier poc-aurora-mysql \
  --db-cluster-identifier poc-aurora-mysql-restored \
  --restore-to-time "$RESTORE_TIME" \
  --region ap-northeast-1

# å¾©å…ƒç¢ºèª
aws rds describe-db-clusters \
  --db-cluster-identifier poc-aurora-mysql-restored \
  --query 'DBClusters[0].Status' \
  --region ap-northeast-1
```

---

## ğŸ“ æ¤œè¨¼çµæœè¨˜éŒ²

### æ¤œè¨¼çµæœè¨˜éŒ²ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```bash
# åŒ…æ‹¬çš„æ¤œè¨¼çµæœè¨˜éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
cat > /tmp/verification-report.sh << 'EOF'
#!/bin/bash
# Immutable Infrastructure æ¤œè¨¼çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

REPORT_FILE="/tmp/immutable-verification-report-$(date +%Y%m%d-%H%M%S).md"

cat > $REPORT_FILE << 'REPORT_EOF'
# Immutable Infrastructure æ¤œè¨¼çµæœãƒ¬ãƒãƒ¼ãƒˆ

## å®Ÿè¡Œæ¦‚è¦
- æ¤œè¨¼æ—¥æ™‚: $(date)
- æ¤œè¨¼æ‹…å½“è€…: [æ‹…å½“è€…å]
- ç’°å¢ƒ: POC Immutable Infrastructure

## æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

| ã‚·ãƒŠãƒªã‚ª | çµæœ | æ‰€è¦æ™‚é–“ | å‚™è€ƒ |
|---------|------|----------|------|
| 1. ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ– | âœ… PASS | XXåˆ† | ç„¡åœæ­¢ã§ãƒ‘ãƒƒãƒé©ç”¨å®Œäº† |
| 2. ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ | âœ… PASS | XXåˆ† | Blue/Greenåˆ‡ã‚Šæ›¿ãˆæˆåŠŸ |
| 3. éšœå®³å¯¾å¿œ | âœ… PASS | XXåˆ† | è‡ªå‹•å¾©æ—§å‹•ä½œç¢ºèª |
| 4. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° | âœ… PASS | XXåˆ† | æ°´å¹³ãƒ»å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° OK |
| 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | âœ… PASS | XXåˆ† | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ OK |
| 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | âœ… PASS | XXåˆ† | è² è·ãƒ†ã‚¹ãƒˆåŸºæº–ã‚¯ãƒªã‚¢ |
| 7. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ | âœ… PASS | XXåˆ† | ãƒ‡ãƒ¼ã‚¿ä¿è­·ãƒ»å¾©æ—§ OK |

## è©³ç´°çµæœ

### 1. ãƒ‘ãƒƒãƒé©ç”¨è‡ªå‹•åŒ–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨: âœ… æˆåŠŸ
- ã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šæ€§: âœ… ç„¡åœæ­¢
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½: âœ… 1ç§’ä»¥å†…å¾©æ—§

### 2. Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
- æ®µéšçš„åˆ‡ã‚Šæ›¿ãˆ: âœ… 5% â†’ 25% â†’ 50% â†’ 100%
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åœæ­¢: âœ… ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ 0ç§’
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: âœ… å³åº§å¾©æ—§

### 3. éšœå®³å¯¾å¿œ
- EC2éšœå®³: âœ… è‡ªå‹•æ¤œå‡ºãƒ»é™¤å¤–
- Auroraéšœå®³: âœ… è‡ªå‹•ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼
- ProxySQLéšœå®³: âœ… è‡ªå‹•å¾©æ—§

## æ¨å¥¨äº‹é …
1. [æ¨å¥¨äº‹é …1]
2. [æ¨å¥¨äº‹é …2]
3. [æ¨å¥¨äº‹é …3]

## æ¬¡å›æ¤œè¨¼äº‹é …
1. [æ¬¡å›æ¤œè¨¼1]
2. [æ¬¡å›æ¤œè¨¼2]

REPORT_EOF

echo "æ¤œè¨¼çµæœãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: $REPORT_FILE"
EOF

chmod +x /tmp/verification-report.sh
```

---

## ğŸ† æˆåŠŸåŸºæº–

### å„ã‚·ãƒŠãƒªã‚ªã®æˆåŠŸåŸºæº–

| ã‚·ãƒŠãƒªã‚ª | æˆåŠŸåŸºæº– |
|---------|---------|
| **ãƒ‘ãƒƒãƒé©ç”¨** | ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ  < 5ç§’ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ < 1ç§’ |
| **ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤** | ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ  = 0ç§’ã€æ®µéšçš„åˆ‡ã‚Šæ›¿ãˆæˆåŠŸ |
| **éšœå®³å¯¾å¿œ** | RTO < 5åˆ†ã€RPO < 1åˆ† |
| **ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°** | æ°´å¹³: 10åˆ†ä»¥å†…ã€å‚ç›´: Blue/Greenåˆ‡ã‚Šæ›¿ãˆ |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | å…¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡æ­£å¸¸ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ < 200msã€ã‚¨ãƒ©ãƒ¼ç‡ < 0.1% |
| **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ** | PITRæˆåŠŸã€ãƒ‡ãƒ¼ã‚¿æå¤±ãªã— |

### å…¨ä½“æˆåŠŸåŸºæº–
- **å¯ç”¨æ€§**: 99.9%ä»¥ä¸Š
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“å¹³å‡ < 200ms
- **è‡ªå‹•åŒ–ç‡**: 95%ä»¥ä¸Šã®æ“ä½œãŒè‡ªå‹•åŒ–
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: è„†å¼±æ€§0ä»¶
- **é‹ç”¨æ€§**: ç®¡ç†ä½œæ¥­æ™‚é–“50%å‰Šæ¸›

---

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### å†…éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [POCImmutableç’°å¢ƒæ§‹ç¯‰æ‰‹é †.md](./POCImmutableç’°å¢ƒæ§‹ç¯‰æ‰‹é †.md) - ç’°å¢ƒæ§‹ç¯‰æ‰‹é †
- [POCç’°å¢ƒæ§‹ç¯‰æ‰‹é †.md](./POCç’°å¢ƒæ§‹ç¯‰æ‰‹é †.md) - åŸºç›¤ç’°å¢ƒæ§‹ç¯‰
- [ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æˆ.md](./ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹æˆ.md) - CloudFormationæ§‹æˆ
- [ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹.md](./ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹.md) - é‹ç”¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### å¤–éƒ¨ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
- [AWS Blue/Green Deployments](https://docs.aws.amazon.com/whitepapers/latest/blue-green-deployments/welcome.html)
- [ProxySQL Documentation](https://proxysql.com/documentation/)
- [Aurora MySQL User Guide](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/)
- [Ansible Best Practices](https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html)
- [CloudWatch Monitoring](https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/)
- [Immutableç’°å¢ƒæ”¹å–„ã‚¬ã‚¤ãƒ‰](./Immutableç’°å¢ƒæ”¹å–„ã‚¬ã‚¤ãƒ‰.md) - çœŸã®Immutableç’°å¢ƒæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰

### æ¤œè¨¼ãƒ„ãƒ¼ãƒ«ãƒ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆå ´æ‰€
- **Ansible Playbooks**: `/home/tomo/ansible-playbooks/`
- **æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: `/tmp/`
- **çµæœãƒ­ã‚°**: `/tmp/verification-*`
- **è¨­å®šãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: `/tmp/backup-*`

---

## ğŸš€ ã‚·ãƒŠãƒªã‚ª9: Immutableç’°å¢ƒç†æƒ³å½¢æ¤œè¨¼ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

**âš ï¸ æ³¨æ„: ã“ã®ã‚·ãƒŠãƒªã‚ªã¯ç¾åœ¨ã®POCç’°å¢ƒã§ã¯æœªå®Ÿè£…ã§ã™ã€‚å°†æ¥ã®æ”¹å–„æ™‚ã«å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚**

### æ¦‚è¦

ç¾åœ¨ã®POCç’°å¢ƒã¯ã€EC2èµ·å‹•å¾Œã«Ansibleã§è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€ŒMutableã€ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚
ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€çœŸã®Immutable Infrastructureï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ + Blue/Greenï¼‰ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æ¤œè¨¼é …ç›®ã‚’å®šç¾©ã—ã¾ã™ã€‚

è©³ç´°ã¯ **[Immutableç’°å¢ƒæ”¹å–„ã‚¬ã‚¤ãƒ‰](./Immutableç’°å¢ƒæ”¹å–„ã‚¬ã‚¤ãƒ‰.md)** ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

### 9.1 ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆAMIï¼‰æ¤œè¨¼

**ç›®çš„**: AMIã‹ã‚‰èµ·å‹•ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¿½åŠ è¨­å®šãªã—ã§ç¨¼åƒã™ã‚‹ã‹æ¤œè¨¼

#### å‰ææ¡ä»¶
- ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆAMIï¼‰ãŒä½œæˆæ¸ˆã¿
- AMIã«ã¯ä»¥ä¸‹ãŒã™ã¹ã¦å«ã¾ã‚Œã¦ã„ã‚‹ï¼š
  - Laravel ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
  - Apache, PHP, ProxySQL
  - CloudWatch Agent
  - ã™ã¹ã¦ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

#### æ¤œè¨¼æ‰‹é †

```bash
# 1. AMIã‹ã‚‰æ–°è¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
GOLDEN_AMI_ID="ami-xxxxx"  # ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã®AMI ID
SUBNET_ID="subnet-xxxxx"   # ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆ
SG_ID="sg-xxxxx"           # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—

INSTANCE_ID=$(aws ec2 run-instances \
  --image-id $GOLDEN_AMI_ID \
  --instance-type t3.medium \
  --subnet-id $SUBNET_ID \
  --security-group-ids $SG_ID \
  --iam-instance-profile Name=poc-ec2-instance-profile \
  --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=poc-ami-test},{Key=Environment,Value=poc-test}]' \
  --region ap-northeast-1 \
  --query 'Instances[0].InstanceId' \
  --output text)

echo "Launched instance: $INSTANCE_ID"

# 2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•å®Œäº†å¾…æ©Ÿ
echo "Waiting for instance to be running..."
aws ec2 wait instance-running --instance-ids $INSTANCE_ID --region ap-northeast-1

# 3. Status Checkå®Œäº†å¾…æ©Ÿï¼ˆ5åˆ†ç¨‹åº¦ï¼‰
echo "Waiting for status checks..."
aws ec2 wait instance-status-ok --instance-ids $INSTANCE_ID --region ap-northeast-1

# 4. SSMæ¥ç¶šç¢ºèª
echo "Testing SSM connectivity..."
aws ssm send-command \
  --instance-ids $INSTANCE_ID \
  --document-name "AWS-RunShellScript" \
  --parameters 'commands=["echo SSM connection successful"]' \
  --region ap-northeast-1

# 5. ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ç¢ºèª
aws ssm send-command \
  --instance-ids $INSTANCE_ID \
  --document-name "AWS-RunShellScript" \
  --parameters 'commands=["systemctl status apache","systemctl status proxysql","systemctl status amazon-cloudwatch-agent"]' \
  --region ap-northeast-1 \
  --output text

# 6. Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œç¢ºèª
PRIVATE_IP=$(aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --query 'Reservations[0].Instances[0].PrivateIpAddress' \
  --output text \
  --region ap-northeast-1)

echo "Testing web application at $PRIVATE_IP..."
# è¸ã¿å°çµŒç”±ã¾ãŸã¯VPNçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
curl -s http://$PRIVATE_IP/health

# 7. èµ·å‹•æ™‚é–“è¨ˆæ¸¬
LAUNCH_TIME=$(aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --query 'Reservations[0].Instances[0].LaunchTime' \
  --output text \
  --region ap-northeast-1)

echo "Instance launched at: $LAUNCH_TIME"
echo "Time to operational: measure from launch to first successful health check"
```

#### æœŸå¾…çµæœ

| é …ç›® | æœŸå¾…å€¤ |
|------|--------|
| èµ·å‹•æ™‚é–“ | 5åˆ†ä»¥å†… |
| Ansibleå®Ÿè¡Œ | **ä¸è¦** |
| Apacheèµ·å‹• | è‡ªå‹•èµ·å‹•ï¼ˆenabledï¼‰ |
| ProxySQLèµ·å‹• | è‡ªå‹•èµ·å‹•ï¼ˆenabledï¼‰ |
| CloudWatch Agentèµ·å‹• | è‡ªå‹•èµ·å‹•ï¼ˆenabledï¼‰ |
| /health ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | HTTP 200 |
| ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚° | ã‚¨ãƒ©ãƒ¼ãªã— |

#### ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å‰Šé™¤
aws ec2 terminate-instances --instance-ids $INSTANCE_ID --region ap-northeast-1
echo "Test instance terminated: $INSTANCE_ID"
```

---

### 9.2 Auto Scalingè‡ªå‹•å¾©æ—§æ¤œè¨¼

**ç›®çš„**: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éšœå®³æ™‚ã«ASGãŒè‡ªå‹•ã§å¾©æ—§ã™ã‚‹ã‹æ¤œè¨¼

#### å‰ææ¡ä»¶
- Auto Scaling Groupè¨­å®šæ¸ˆã¿
- Desired Capacity = 3
- Launch Templateã«ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸AMIè¨­å®šæ¸ˆã¿

#### æ¤œè¨¼æ‰‹é †

```bash
# 1. ç¾åœ¨ã®ASGçŠ¶æ…‹ç¢ºèª
ASG_NAME="poc-web-asg"

aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names $ASG_NAME \
  --region ap-northeast-1 \
  --query 'AutoScalingGroups[0].{Name:AutoScalingGroupName,Desired:DesiredCapacity,Current:Instances[].InstanceId}' \
  --output table

# 2. ç›£è¦–é–‹å§‹ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œï¼‰
watch -n 5 'aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names poc-web-asg \
  --region ap-northeast-1 \
  --query "AutoScalingGroups[0].{Desired:DesiredCapacity,InService:Instances[?LifecycleState==\`InService\`]|length(@)}"'

# 3. 1å°ã‚’å¼·åˆ¶çµ‚äº†
TARGET_INSTANCE=$(aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names $ASG_NAME \
  --region ap-northeast-1 \
  --query 'AutoScalingGroups[0].Instances[0].InstanceId' \
  --output text)

echo "Terminating instance: $TARGET_INSTANCE"
TERMINATION_TIME=$(date +%s)

aws ec2 terminate-instances \
  --instance-ids $TARGET_INSTANCE \
  --region ap-northeast-1

# 4. æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ç›£è¦–
echo "Waiting for new instance to launch..."
sleep 60

NEW_INSTANCE=$(aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names $ASG_NAME \
  --region ap-northeast-1 \
  --query 'AutoScalingGroups[0].Instances[?LifecycleState==`Pending` || LifecycleState==`InService`] | [?InstanceId!=`'$TARGET_INSTANCE'`].InstanceId' \
  --output text | head -n 1)

echo "New instance: $NEW_INSTANCE"

# 5. æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•å®Œäº†å¾…æ©Ÿ
aws ec2 wait instance-status-ok --instance-ids $NEW_INSTANCE --region ap-northeast-1
RECOVERY_TIME=$(date +%s)

RECOVERY_DURATION=$((RECOVERY_TIME - TERMINATION_TIME))
echo "Recovery completed in $RECOVERY_DURATION seconds"

# 6. ALBãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
TARGET_GROUP_ARN="arn:aws:elasticloadbalancing:ap-northeast-1:xxx:targetgroup/poc-web/xxx"

aws elbv2 describe-target-health \
  --target-group-arn $TARGET_GROUP_ARN \
  --region ap-northeast-1 \
  --query "TargetHealthDescriptions[?Target.Id=='$NEW_INSTANCE'].{Instance:Target.Id,State:TargetHealth.State}" \
  --output table
```

#### æœŸå¾…çµæœ

| é …ç›® | æœŸå¾…å€¤ |
|------|--------|
| æ¤œçŸ¥æ™‚é–“ | 1åˆ†ä»¥å†… |
| æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹• | 2åˆ†ä»¥å†… |
| èµ·å‹•å®Œäº†ï¼ˆStatus OKï¼‰ | 5åˆ†ä»¥å†… |
| ALB Healthy | 7åˆ†ä»¥å†… |
| **åˆè¨ˆå¾©æ—§æ™‚é–“** | **10åˆ†ä»¥å†…** |
| æœ€çµ‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•° | 3å°ï¼ˆå…ƒé€šã‚Šï¼‰ |
| ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ | ãªã—ï¼ˆæ®‹ã‚Š2å°ã§ç¶™ç¶šï¼‰ |

---

### 9.3 Blue/Green ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ¤œè¨¼

**ç›®çš„**: ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚¼ãƒ­ã§æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‹æ¤œè¨¼

#### å‰ææ¡ä»¶
- Blue/Greenç”¨ã®2ã¤ã®ASGè¨­å®šæ¸ˆã¿ï¼ˆBlue: é‹ç”¨ä¸­ã€Green: åœæ­¢ï¼‰
- 2ã¤ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šæ¸ˆã¿
- ALBãƒªã‚¹ãƒŠãƒ¼ã¯Blueã‚’å‚ç…§
- æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸AMIä½œæˆæ¸ˆã¿

#### æ¤œè¨¼æ‰‹é †

```bash
# ç’°å¢ƒå¤‰æ•°è¨­å®š
BLUE_ASG="poc-web-blue-asg"
GREEN_ASG="poc-web-green-asg"
BLUE_TG="arn:aws:elasticloadbalancing:ap-northeast-1:xxx:targetgroup/poc-blue/xxx"
GREEN_TG="arn:aws:elasticloadbalancing:ap-northeast-1:xxx:targetgroup/poc-green/xxx"
LISTENER_ARN="arn:aws:elasticloadbalancing:ap-northeast-1:xxx:listener/app/poc-alb/xxx"
NEW_AMI="ami-new-version"

# 1. ç¶™ç¶šçš„ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰
ALB_DNS="poc-alb-xxxxx.ap-northeast-1.elb.amazonaws.com"

# ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²
while true; do
  RESPONSE=$(curl -s -o /dev/null -w "%{http_code},%{time_total}" http://$ALB_DNS/health)
  echo "$(date +%Y-%m-%d\ %H:%M:%S),$RESPONSE" >> /tmp/blue-green-access.log
  sleep 1
done

# 2. Greenç’°å¢ƒèµ·å‹•
echo "Step 1: Launching Green environment..."
aws autoscaling update-auto-scaling-group \
  --auto-scaling-group-name $GREEN_ASG \
  --desired-capacity 3 \
  --region ap-northeast-1

# 3. Greenç’°å¢ƒèµ·å‹•å®Œäº†å¾…æ©Ÿï¼ˆ15åˆ†ç¨‹åº¦ï¼‰
echo "Step 2: Waiting for Green instances to be healthy..."
for i in {1..30}; do
  HEALTHY_COUNT=$(aws elbv2 describe-target-health \
    --target-group-arn $GREEN_TG \
    --region ap-northeast-1 \
    --query 'TargetHealthDescriptions[?TargetHealth.State==`healthy`] | length(@)' \
    --output text)
  
  echo "Healthy instances in Green: $HEALTHY_COUNT / 3"
  
  if [ "$HEALTHY_COUNT" -eq 3 ]; then
    echo "âœ… All Green instances are healthy"
    break
  fi
  
  sleep 30
done

# 4. Greenç’°å¢ƒã§å‹•ä½œç¢ºèª
echo "Step 3: Verifying Green environment..."
GREEN_INSTANCES=$(aws autoscaling describe-auto-scaling-groups \
  --auto-scaling-group-names $GREEN_ASG \
  --region ap-northeast-1 \
  --query 'AutoScalingGroups[0].Instances[].InstanceId' \
  --output text)

for INSTANCE in $GREEN_INSTANCES; do
  echo "Testing instance: $INSTANCE"
  
  PRIVATE_IP=$(aws ec2 describe-instances \
    --instance-ids $INSTANCE \
    --query 'Reservations[0].Instances[0].PrivateIpAddress' \
    --output text \
    --region ap-northeast-1)
  
  # ProxySQLæ¥ç¶šç¢ºèª
  aws ssm send-command \
    --instance-ids $INSTANCE \
    --document-name "AWS-RunShellScript" \
    --parameters 'commands=["mysql -h127.0.0.1 -P6033 -ularavel_user -pLaravel123! -e \"SELECT 1\""]' \
    --region ap-northeast-1
done

# 5. ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿ï¼ˆæ®µéšçš„ï¼‰
echo "Step 4: Switching traffic to Green..."

# 10% â†’ Green
echo "Switching 10% traffic to Green..."
aws elbv2 modify-rule \
  --rule-arn $LISTENER_ARN \
  --actions Type=forward,ForwardConfig='{
    "TargetGroups":[
      {"TargetGroupArn":"'$BLUE_TG'","Weight":90},
      {"TargetGroupArn":"'$GREEN_TG'","Weight":10}
    ]
  }' \
  --region ap-northeast-1

sleep 300  # 5åˆ†ç›£è¦–

# 50% â†’ Green
echo "Switching 50% traffic to Green..."
aws elbv2 modify-rule \
  --rule-arn $LISTENER_ARN \
  --actions Type=forward,ForwardConfig='{
    "TargetGroups":[
      {"TargetGroupArn":"'$BLUE_TG'","Weight":50},
      {"TargetGroupArn":"'$GREEN_TG'","Weight":50}
    ]
  }' \
  --region ap-northeast-1

sleep 300

# 100% â†’ Green
echo "Switching 100% traffic to Green..."
aws elbv2 modify-listener \
  --listener-arn $LISTENER_ARN \
  --default-actions Type=forward,TargetGroupArn=$GREEN_TG \
  --region ap-northeast-1

echo "âœ… Traffic switched to Green"

# 6. ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°åˆ†æ
echo "Step 5: Analyzing access logs..."
cat /tmp/blue-green-access.log | awk -F',' '{
  if ($2 != 200) errors++;
  total++;
  sum_time += $3;
} END {
  print "Total requests:", total;
  print "Errors:", errors;
  print "Success rate:", (total-errors)/total*100 "%";
  print "Avg response time:", sum_time/total "s";
}'

# 7. Blueç’°å¢ƒå‰Šé™¤ï¼ˆå•é¡Œãªã‘ã‚Œã°ï¼‰
echo "Step 6: Terminating Blue environment..."
read -p "Remove Blue environment? (yes/no): " CONFIRM

if [ "$CONFIRM" = "yes" ]; then
  aws autoscaling update-auto-scaling-group \
    --auto-scaling-group-name $BLUE_ASG \
    --desired-capacity 0 \
    --region ap-northeast-1
  echo "âœ… Blue environment terminated"
fi
```

#### æœŸå¾…çµæœ

| é …ç›® | æœŸå¾…å€¤ |
|------|--------|
| Greenç’°å¢ƒèµ·å‹•æ™‚é–“ | 15åˆ†ä»¥å†… |
| ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿æ™‚é–“ | 15åˆ†ï¼ˆæ®µéšçš„ï¼‰ |
| **åˆè¨ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“** | **30åˆ†** |
| HTTPã‚¨ãƒ©ãƒ¼ | **0ä»¶** |
| ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—ç‡ | **0%** |
| ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ å¤‰å‹• | Â±10%ä»¥å†… |
| ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ  | **ã‚¼ãƒ­** |

---

### 9.4 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼

**ç›®çš„**: å•é¡Œç™ºç”Ÿæ™‚ã«å³åº§ã«æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã›ã‚‹ã‹æ¤œè¨¼

#### æ¤œè¨¼æ‰‹é †

```bash
# Greenç’°å¢ƒã§å•é¡Œç™ºè¦‹ï¼ˆæƒ³å®šï¼‰
echo "Problem detected in Green environment!"
echo "Initiating rollback to Blue..."

START_TIME=$(date +%s)

# ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’Blueã«æˆ»ã™
aws elbv2 modify-listener \
  --listener-arn $LISTENER_ARN \
  --default-actions Type=forward,TargetGroupArn=$BLUE_TG \
  --region ap-northeast-1

END_TIME=$(date +%s)
ROLLBACK_TIME=$((END_TIME - START_TIME))

echo "âœ… Rollback completed in $ROLLBACK_TIME seconds"

# Greenç’°å¢ƒå‰Šé™¤
aws autoscaling update-auto-scaling-group \
  --auto-scaling-group-name $GREEN_ASG \
  --desired-capacity 0 \
  --region ap-northeast-1

echo "Green environment terminated"
```

#### æœŸå¾…çµæœ

| é …ç›® | æœŸå¾…å€¤ |
|------|--------|
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚é–“ | **60ç§’ä»¥å†…** |
| ãƒ‡ãƒ¼ã‚¿æå¤± | ãªã— |
| ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢ | ãªã— |

---

### 9.5 æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼

#### ç¾åœ¨ã®POCç’°å¢ƒï¼ˆMutableï¼‰

| é …ç›® | ç¾çŠ¶å€¤ |
|------|--------|
| æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ | 30-35åˆ†ï¼ˆAnsibleå®Ÿè¡Œå«ã‚€ï¼‰ |
| ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ | 35åˆ†/å° |
| éšœå®³å¾©æ—§ | 30-40åˆ† |
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | 30-35åˆ† |
| æ§‹æˆã®ä¸€è²«æ€§ | ä½ï¼ˆãƒ‰ãƒªãƒ•ãƒˆç™ºç”Ÿï¼‰ |

#### ç†æƒ³å½¢ï¼ˆImmutableï¼‰

| é …ç›® | ç›®æ¨™å€¤ |
|------|--------|
| æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ | **5åˆ†** |
| ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ | **5åˆ†/å°** |
| éšœå®³å¾©æ—§ | **10åˆ†** |
| ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | **60ç§’** |
| æ§‹æˆã®ä¸€è²«æ€§ | **100%ï¼ˆãƒ‰ãƒªãƒ•ãƒˆãªã—ï¼‰** |

---

### æ”¹å–„å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

å®Ÿéš›ã«Immutableç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®é †åºã§é€²ã‚ã¦ãã ã•ã„ï¼š

- [ ] **Phase 1: ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ä½œæˆ**
  - [ ] ç¾åœ¨ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰AMIä½œæˆ
  - [ ] AMIæ¤œè¨¼ï¼ˆ9.1å®Ÿæ–½ï¼‰
  - [ ] AMIã‚¿ã‚°ä»˜ã‘ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°

- [ ] **Phase 2: Launch Templateæ›´æ–°**
  - [ ] æ–°AMIã§Launch Templateä½œæˆ
  - [ ] UserDataã‚’æœ€å°åŒ–ï¼ˆå‹•çš„è¨­å®šã®ã¿ï¼‰
  - [ ] Instance Profileè¨­å®šç¢ºèª

- [ ] **Phase 3: Auto Scalingå‹•ä½œç¢ºèª**
  - [ ] ASGã§æ–°Launch Templateä½¿ç”¨
  - [ ] ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å®Ÿè¡Œ
  - [ ] è‡ªå‹•å¾©æ—§æ¤œè¨¼ï¼ˆ9.2å®Ÿæ–½ï¼‰

- [ ] **Phase 4: Blue/Greenç’°å¢ƒæ§‹ç¯‰**
  - [ ] Blue/Greenç”¨CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
  - [ ] 2ã¤ã®ASG + 2ã¤ã®Target Groupä½œæˆ
  - [ ] Blue/Greenåˆ‡æ›¿æ¤œè¨¼ï¼ˆ9.3å®Ÿæ–½ï¼‰
  - [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œè¨¼ï¼ˆ9.4å®Ÿæ–½ï¼‰

- [ ] **Phase 5: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**
  - [ ] Packer / EC2 Image Builderã§ã®ãƒ“ãƒ«ãƒ‰è‡ªå‹•åŒ–
  - [ ] ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
  - [ ] è‡ªå‹•ãƒ†ã‚¹ãƒˆçµ±åˆ

è©³ç´°ãªå®Ÿè£…æ‰‹é †ã¯ **[Immutableç’°å¢ƒæ”¹å–„ã‚¬ã‚¤ãƒ‰](./Immutableç’°å¢ƒæ”¹å–„ã‚¬ã‚¤ãƒ‰.md)** ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

**Document Version**: v2.0  
**Last Updated**: 2025å¹´10æœˆ18æ—¥  
**Environment**: POC Immutable Infrastructure Verification  
**Total Verification Time**: ~5.5æ™‚é–“ï¼ˆä¸¦è¡Œå®Ÿè¡Œã§çŸ­ç¸®å¯èƒ½ï¼‰ + Immutableç’°å¢ƒæ¤œè¨¼ï¼ˆå°†æ¥å®Ÿè£…æ™‚: +3æ™‚é–“ï¼‰
