# WEBã‚µãƒ¼ãƒ“ã‚¹EC2æ§‹ç¯‰ãƒ»é‹ç”¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¯”è¼ƒæ¤œè¨

## ğŸ“‹ ç›®æ¬¡

- [è¦ä»¶ã‚µãƒãƒªãƒ¼](#è¦ä»¶ã‚µãƒãƒªãƒ¼)
- [2ã¤ã®è¨­è¨ˆè»¸ã®ç†è§£](#2ã¤ã®è¨­è¨ˆè»¸ã®ç†è§£)
- [æ¤œè¨¼ç’°å¢ƒã¨ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#æ¤œè¨¼ç’°å¢ƒã¨ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
- [ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: Immutable Infrastructure (Golden AMI)](#ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1-immutable-infrastructure-golden-ami)
- [ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: Mutable Infrastructure (In-Place Update)](#ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2-mutable-infrastructure-in-place-update)
- [ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: Hybrid Approach](#ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3-hybrid-approach)
- [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã¨ã®çµ„ã¿åˆã‚ã›](#ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã¨ã®çµ„ã¿åˆã‚ã›)
- [æ¯”è¼ƒãƒãƒˆãƒªã‚¯ã‚¹](#æ¯”è¼ƒãƒãƒˆãƒªã‚¯ã‚¹)
- [æ¨å¥¨åˆ¤æ–­åŸºæº–](#æ¨å¥¨åˆ¤æ–­åŸºæº–)
- [å„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®è©³ç´°å®Ÿè£…](#å„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®è©³ç´°å®Ÿè£…)

---

## 2ã¤ã®è¨­è¨ˆè»¸ã®ç†è§£

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€**2ã¤ã®ç•°ãªã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­è¨ˆåˆ¤æ–­**ã‚’æ‰±ã„ã¾ã™ï¼š

### ğŸ—ï¸ è»¸1: ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç®¡ç†æ–¹å¼ï¼ˆåŸºç›¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰

**è³ªå•:** ã€ŒEC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã©ã†ç®¡ç†ã™ã‚‹ã‹ï¼Ÿã€

| æ–¹å¼ | èª¬æ˜ | ãƒ‘ãƒƒãƒé©ç”¨æ–¹æ³• |
|------|------|--------------|
| **Immutable** | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯èª­ã¿å–ã‚Šå°‚ç”¨ã€‚æ›´æ–°æ™‚ã¯æ–°è¦ä½œæˆâ†’ç½®æ› | æ–°AMIä½œæˆâ†’Instance Refresh |
| **Mutable** | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç›´æ¥å¤‰æ›´ã€‚åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ã„ç¶šã‘ã‚‹ | yum updateå®Ÿè¡Œ |
| **Hybrid** | åŸºç›¤ã¯Immutableã€ã‚¢ãƒ—ãƒªã¯Mutable | åŸºç›¤: AMIæ›´æ–°<br>ã‚¢ãƒ—ãƒª: In-Placeæ›´æ–° |

### ğŸš€ è»¸2: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰

**è³ªå•:** ã€Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã©ã†ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‹ï¼Ÿã€

| æˆ¦ç•¥ | èª¬æ˜ | åˆ‡ã‚Šæˆ»ã—æ–¹æ³• |
|------|------|------------|
| **Blue/Green** | æ–°æ—§2ã¤ã®ç’°å¢ƒã‚’ç”¨æ„ã—ã€ALBã§åˆ‡æ›¿ | ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«å¤‰æ›´ï¼ˆå³åº§ï¼‰ |
| **Rolling Update** | 1å°ãšã¤é †æ¬¡æ›´æ–° | é€†æ–¹å‘ã«Rolling Update |
| **Canary** | ä¸€éƒ¨ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã ã‘æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ | ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ¯”ç‡ã‚’0%ã«æˆ»ã™ |
| **In-Place** | å…¨å°åŒæ™‚æ›´æ–° | å…¨å°ã«æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å†ãƒ‡ãƒ—ãƒ­ã‚¤ |

### ğŸ”— ã“ã‚Œã‚‰ã¯çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã§ãã‚‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†æ–¹å¼ Ã— ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾‹1: Immutable Infrastructure + Blue/Green Deployment
  â†’ OSãƒ‘ãƒƒãƒã‚‚ã‚¢ãƒ—ãƒªã‚‚å®Œå…¨ç„¡åœæ­¢ã€ç¬æ™‚åˆ‡ã‚Šæˆ»ã—

ä¾‹2: Mutable Infrastructure + Rolling Update
  â†’ æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é †æ¬¡é©ç”¨ã€æ®µéšçš„æ›´æ–°

ä¾‹3: Hybrid Approach + Blue/Green Deployment
  â†’ åŸºç›¤ã¯æœˆæ¬¡æ›´æ–°ã€ã‚¢ãƒ—ãƒªã¯é »ç¹ã«Blue/Greenåˆ‡æ›¿
```

---

## è¦ä»¶ã‚µãƒãƒªãƒ¼

### å¿…é ˆè¦ä»¶

| # | è¦ä»¶ | è©³ç´° |
|---|------|------|
| **R1** | **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨** | ç„¡åœæ­¢ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã€è‡ªå‹•åŒ– |
| **R2** | **ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤** | ç„¡åœæ­¢ã€å®¹æ˜“ãªåˆ‡ã‚Šæˆ»ã— |
| **R3** | **ãƒãƒ«ãƒAZæ§‹æˆ** | 3ã¤ã®AZ |
| **R4** | **å°æ•°ç®¡ç†** | å„AZ1å°ãšã¤ç¶­æŒï¼ˆå½“é¢å›ºå®šã€å°†æ¥ASGã®å¯èƒ½æ€§ï¼‰ |
| **R5** | **éšœå®³è‡ªå‹•å¾©æ—§** | HTTPDãƒ—ãƒ­ã‚»ã‚¹æ­»äº¡â†’å†èµ·å‹•â†’å†æ§‹ç¯‰ |
| **R6** | **æ¤œè¨¼ç’°å¢ƒ** | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒãƒ»ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã€æœ¬ç•ªé©ç”¨å‰ã®æ¤œè¨¼ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿæ–½ |
| **R7** | **æ‰‹å‹•ãƒ†ã‚¹ãƒˆ** | AWSä¸Šã®Windowsã‚µãƒ¼ãƒï¼ˆã¾ãŸã¯å¤–éƒ¨ç‰¹å®šIPï¼‰ã‹ã‚‰WEBã‚¢ã‚¯ã‚»ã‚¹ã—ã¦æ‰‹å‹•ãƒ†ã‚¹ãƒˆ |
| **R8** | **è‡ªå‹•E2Eãƒ†ã‚¹ãƒˆ** | Jenkins (ECS)ã«ã‚ˆã‚‹E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ |
| **R9** | **æ‰¿èªãƒ•ãƒ­ãƒ¼** | æ‰‹å‹•ãƒ†ã‚¹ãƒˆ + E2Eãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã€æœ¬ç•ªã¨ã—ã¦å•é¡Œãªã„ã¨ã„ã†æœ€çµ‚åˆ¤æ–­ã‚’çµŒã¦é©ç”¨ |

### é‹ç”¨ãƒ„ãƒ¼ãƒ«
- **Jenkins (ECS)**: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢/ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
- **Gitea (ECS)**: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç†
- **Ansible**: IaCå®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³

### ç¾åœ¨ã®çŠ¶æ³
- âœ… EC2 3å°ï¼ˆå„AZ 1å°ãšã¤ï¼‰ç¨¼åƒä¸­
- âœ… ALBé…ä¸‹ã«é…ç½®æ¸ˆã¿
- âœ… Ansible Playbookã§æ§‹ç¯‰æ¸ˆã¿ï¼ˆMutableæ§‹æˆï¼‰
- âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒˆãƒ«ã¯ã€ŒImmutableã€ã ãŒå®Ÿæ…‹ã¯Mutable

---

## æ¤œè¨¼ç’°å¢ƒã¨ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ğŸ§ª æ¤œè¨¼ç’°å¢ƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¤œè¨¼ãƒ•ãƒ­ãƒ¼ã®å…¨ä½“åƒ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Phase 1: æ¤œè¨¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Load Balancer                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  HTTPS Listener (Port 443)                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Rule 1 (Priority: 1) - æ¤œè¨¼ç”¨IPåˆ¶é™              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ - Condition: Source IP IN [10.0.x.x/32,          â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                            x.x.x.x/32,            â”‚  â”‚    â”‚
â”‚  â”‚  â”‚                            10.0.y.y/32]           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ - Action: Forward to Verification Target Group   â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ Rule 2 (Priority: Default) - æœ¬ç•ªç”¨               â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ - Condition: All other traffic                   â”‚  â”‚    â”‚
â”‚  â”‚  â”‚ - Action: Forward to Production Target Group    â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                 â”‚
          â–¼                                 â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Production     â”‚              â”‚ Verification   â”‚
  â”‚ Target Group   â”‚              â”‚ Target Group   â”‚
  â”‚ (Blue/Stable)  â”‚              â”‚ (Green/Canary) â”‚
  â”‚                â”‚              â”‚ â† æ¤œè¨¼å¯¾è±¡      â”‚
  â”‚ pochub-001/2/3 â”‚              â”‚ pochub-green-* â”‚
  â”‚ (Current)      â”‚              â”‚ (New Version)  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â–²
                                          â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                                   â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Windows Server â”‚                 â”‚ Jenkins (ECS)  â”‚
                â”‚ (æ¤œè¨¼ç”¨)        â”‚                 â”‚ E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ  â”‚
                â”‚ 10.0.x.x       â”‚                 â”‚ 10.0.y.y       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿæ–½                     è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿæ–½
                  â†“
                  åŒä¸€ãƒãƒ¼ãƒˆï¼ˆ443ï¼‰ã§ã‚¢ã‚¯ã‚»ã‚¹
                  æ¥ç¶šå…ƒIPã§è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
```

### ğŸ“‹ æ¤œè¨¼ç’°å¢ƒã®æ§‹æˆè¦ç´ 

#### 1. Windowsæ¤œè¨¼ã‚µãƒ¼ãƒ

**ç›®çš„:** æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿæ–½ç”¨ã®è¸ã¿å°ã‚µãƒ¼ãƒ

**æ§‹æˆ:**
```yaml
# sceptre/templates/verification-windows-server.yaml
Resources:
  VerificationWindowsServer:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      ImageId: !Ref LatestWindowsAMI  # Windows Server 2022
      SubnetId: !Ref PrivateSubnetAZ1
      SecurityGroupIds:
        - !Ref WindowsSecurityGroup
      IamInstanceProfile: !Ref WindowsInstanceProfile
      Tags:
        - Key: Name
          Value: poc-verification-windows
        - Key: Purpose
          Value: manual-testing

  WindowsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Windows verification server
      VpcId: !Ref VPC
      SecurityGroupEgress:
        # ALB Port 443ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ï¼ˆæ¤œè¨¼ç’°å¢ƒãƒ»æœ¬ç•ªç’°å¢ƒä¸¡æ–¹ï¼‰
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          DestinationSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTPS to ALB (Verification/Production)
        # ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç”¨ï¼‰
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: Internet access for browser
```

**ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•:**
- Systems Manager Session ManagerçµŒç”±
- RDPä¸è¦ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢:**
- Chrome/Edge ãƒ–ãƒ©ã‚¦ã‚¶
- Selenium IDEï¼ˆæ‰‹å‹•ãƒ†ã‚¹ãƒˆè¨˜éŒ²ç”¨ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- Gitï¼ˆãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªç®¡ç†ç”¨ï¼‰

#### 2. ALBæ¤œè¨¼ç”¨ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ï¼ˆåŒä¸€ãƒãƒ¼ãƒˆã§IPæŒ¯ã‚Šåˆ†ã‘ï¼‰

**ç›®çš„:** æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã«å½±éŸ¿ã‚’ä¸ãˆãšã«ã€åŒä¸€ãƒãƒ¼ãƒˆï¼ˆHTTPS 443ï¼‰ã§æ¤œè¨¼ç’°å¢ƒã¸ã‚¢ã‚¯ã‚»ã‚¹

**æ§‹æˆ:**
```yaml
# HTTPS Listenerï¼ˆPort 443ã®ã¿ï¼‰
HTTPSListener:
  Type: AWS::ElasticLoadBalancingV2::Listener
  Properties:
    LoadBalancerArn: !Ref ApplicationLoadBalancer
    Port: 443
    Protocol: HTTPS
    Certificates:
      - CertificateArn: !Ref SSLCertificateArn
    DefaultActions:
      # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: æœ¬ç•ªç’°å¢ƒã¸è»¢é€
      - Type: forward
        TargetGroupArn: !Ref ProductionTargetGroup

# æ¤œè¨¼ç”¨ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ï¼ˆå„ªå…ˆåº¦: 1ï¼‰
VerificationListenerRule:
  Type: AWS::ElasticLoadBalancingV2::ListenerRule
  Properties:
    ListenerArn: !Ref HTTPSListener
    Priority: 1
    Conditions:
      # æ¥ç¶šå…ƒIPã§åˆ¤å®š
      - Field: source-ip
        SourceIpConfig:
          Values:
            - 10.0.x.x/32    # Windows Server (Private IP)
            - x.x.x.x/32     # å¤–éƒ¨ç‰¹å®šIP
            - 10.0.y.y/32    # Jenkins ECS (Private IP)
    Actions:
      # æ¤œè¨¼ç’°å¢ƒã¸è»¢é€
      - Type: forward
        TargetGroupArn: !Ref VerificationTargetGroup

# Security Groupï¼ˆPort 443ã®ã¿å…¬é–‹ï¼‰
ALBSecurityGroup:
  Type: AWS::EC2::SecurityGroup
  Properties:
    SecurityGroupIngress:
      # HTTPSï¼ˆå…¨ä½“å…¬é–‹ï¼‰
      - IpProtocol: tcp
        FromPort: 443
        ToPort: 443
        CidrIp: 0.0.0.0/0
        Description: HTTPS for all users
      # HTTPSãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨ï¼ˆPort 80ï¼‰
      - IpProtocol: tcp
        FromPort: 80
        ToPort: 80
        CidrIp: 0.0.0.0/0
        Description: HTTP redirect to HTTPS

# HTTPãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
HTTPListener:
  Type: AWS::ElasticLoadBalancingV2::Listener
  Properties:
    LoadBalancerArn: !Ref ApplicationLoadBalancer
    Port: 80
    Protocol: HTTP
    DefaultActions:
      - Type: redirect
        RedirectConfig:
          Protocol: HTTPS
          Port: 443
          StatusCode: HTTP_301
```

**é‡è¦ãªè¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ:**

1. **åŒä¸€ãƒãƒ¼ãƒˆï¼ˆ443ï¼‰ã§ã®æŒ¯ã‚Šåˆ†ã‘**
   - ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã®å„ªå…ˆåº¦æ©Ÿèƒ½ã‚’ä½¿ç”¨
   - æ¤œè¨¼ç”¨IPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹: Priority 1ï¼ˆVerification Target Groupï¼‰
   - ãã®ä»–ã®ã‚¢ã‚¯ã‚»ã‚¹: Default Actionï¼ˆProduction Target Groupï¼‰

2. **æ¥ç¶šå…ƒIPåˆ¤å®š**
   - Windows Server: Private IPï¼ˆVPCå†…ï¼‰
   - Jenkins (ECS): Private IPï¼ˆVPCå†…ï¼‰
   - å¤–éƒ¨ç‰¹å®šIP: Public IPï¼ˆã‚ªãƒ•ã‚£ã‚¹ç­‰ï¼‰

3. **POCç’°å¢ƒã§ã®æ¤œè¨¼**
   - POCç’°å¢ƒã§ã¯HTTPï¼ˆPort 80ï¼‰ã§ã‚‚æ¤œè¨¼å¯èƒ½
   - æœ¬ç•ªç’°å¢ƒã§ã¯HTTPSï¼ˆPort 443ï¼‰ã®ã¿ã«çµ±ä¸€
   - æ§‹æˆã¯åŒã˜ï¼ˆãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹IPæŒ¯ã‚Šåˆ†ã‘ï¼‰

#### 3. Jenkins E2Eãƒ†ã‚¹ãƒˆ

**ç›®çš„:** è‡ªå‹•åŒ–ã•ã‚ŒãŸE2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

**Jenkins Pipelineä¾‹:**
```groovy
pipeline {
    agent any
    
    parameters {
        string(name: 'VERIFICATION_URL', defaultValue: 'https://your-app.example.com', description: 'æ¤œè¨¼ç’°å¢ƒURLï¼ˆæœ¬ç•ªã¨åŒä¸€URLãƒ»åŒä¸€ãƒãƒ¼ãƒˆï¼‰')
        string(name: 'TEST_SUITE', defaultValue: 'regression', description: 'ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ')
    }
    
    stages {
        stage('E2E Test Execution') {
            steps {
                script {
                    sh '''
                        cd /var/jenkins_home/e2e-tests
                        
                        # Playwright E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                        export TEST_URL=${VERIFICATION_URL}
                        npm run test:e2e -- --suite=${TEST_SUITE}
                        
                        # çµæœã‚’HTMLãƒ¬ãƒãƒ¼ãƒˆã«å‡ºåŠ›
                        npm run test:report
                    '''
                }
            }
        }
        
        stage('Test Result Analysis') {
            steps {
                // ãƒ†ã‚¹ãƒˆçµæœã®è§£æ
                junit 'e2e-tests/test-results/*.xml'
                publishHTML([
                    reportDir: 'e2e-tests/playwright-report',
                    reportFiles: 'index.html',
                    reportName: 'E2E Test Report'
                ])
            }
        }
        
        stage('Approval Gate') {
            steps {
                script {
                    def testsPassed = currentBuild.result == 'SUCCESS'
                    
                    if (testsPassed) {
                        // æ‰‹å‹•æ‰¿èªã‚’å¾…ã¤
                        input message: 'æ¤œè¨¼å®Œäº†ã€‚æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã‹ï¼Ÿ',
                              ok: 'Deploy to Production',
                              submitter: 'admin,release-manager'
                    } else {
                        error('E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚')
                    }
                }
            }
        }
    }
    
    post {
        always {
            // Slackã¸é€šçŸ¥
            slackSend(
                color: currentBuild.result == 'SUCCESS' ? 'good' : 'danger',
                message: """
                    E2Eãƒ†ã‚¹ãƒˆå®Œäº†: ${currentBuild.result}
                    æ¤œè¨¼URL: ${params.VERIFICATION_URL}
                    ãƒ¬ãƒãƒ¼ãƒˆ: ${env.BUILD_URL}E2E_x20Test_x20Report/
                """
            )
        }
    }
}
```

### ğŸ”‘ åŒä¸€ãƒãƒ¼ãƒˆï¼ˆHTTPS 443ï¼‰ã§ã®IPæŒ¯ã‚Šåˆ†ã‘ã®è©³ç´°

#### ãªãœåŒä¸€ãƒãƒ¼ãƒˆã§ã®æŒ¯ã‚Šåˆ†ã‘ãŒå¿…è¦ã‹ï¼Ÿ

**æœ¬ç•ªç’°å¢ƒã®åˆ¶ç´„:**
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã§HTTPSï¼ˆPort 443ï¼‰ã®ã¿è¨±å¯
- æ¤œè¨¼ç”¨ã«åˆ¥ãƒãƒ¼ãƒˆï¼ˆ8080ç­‰ï¼‰ã‚’å…¬é–‹ã™ã‚‹ã“ã¨ã¯ä¸å¯
- æ¥ç¶šå…ƒIPã«ã‚ˆã£ã¦æ¤œè¨¼ç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã‚’è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘ã—ãŸã„

**ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã®å‹•ä½œ:**

```
ã€æ¥ç¶šå…ƒIP: Windows Server (10.0.x.x) ã®å ´åˆã€‘
User â†’ ALB:443 â†’ Rule 1 (Priority: 1) â†’ Verification Target Group
              Source IP: 10.0.x.x ã¨ä¸€è‡´
              â†“
              Green/Canaryç’°å¢ƒï¼ˆæ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã¸è»¢é€

ã€æ¥ç¶šå…ƒIP: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ (ãã®ä»–) ã®å ´åˆã€‘
User â†’ ALB:443 â†’ Default Rule â†’ Production Target Group
              ã©ã®Ruleã«ã‚‚ä¸€è‡´ã—ãªã„
              â†“
              Blue/Stableç’°å¢ƒï¼ˆç¾ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ã¸è»¢é€
```

#### å®Ÿè£…ä¾‹ï¼šAWS CLI ã§ã®ãƒ«ãƒ¼ãƒ«ä½œæˆ

```bash
# 1. æ¤œè¨¼ç”¨ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ä½œæˆï¼ˆå„ªå…ˆåº¦: 1ï¼‰
aws elbv2 create-rule \
  --listener-arn arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/poc-alb/xxxxx/yyyyy \
  --priority 1 \
  --conditions Field=source-ip,SourceIpConfig={Values=[10.0.1.100/32,203.0.113.0/32,10.0.2.200/32]} \
  --actions Type=forward,TargetGroupArn=arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:targetgroup/verification-tg/zzzzz

# 2. ãƒ«ãƒ¼ãƒ«ã®ç¢ºèª
aws elbv2 describe-rules \
  --listener-arn arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener/app/poc-alb/xxxxx/yyyyy

# 3. æ¤œè¨¼å®Œäº†å¾Œã€ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ï¼ˆã¾ãŸã¯ç„¡åŠ¹åŒ–ï¼‰
aws elbv2 delete-rule \
  --rule-arn arn:aws:elasticloadbalancing:ap-northeast-1:123456789012:listener-rule/app/poc-alb/xxxxx/yyyyy/zzzzz
```

#### POCç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®é•ã„

| é …ç›® | POCç’°å¢ƒ | æœ¬ç•ªç’°å¢ƒ |
|------|---------|---------|
| **ãƒ—ãƒ­ãƒˆã‚³ãƒ«** | HTTPï¼ˆPort 80ï¼‰ | HTTPSï¼ˆPort 443ï¼‰ |
| **æ¤œè¨¼ç’°å¢ƒã‚¢ã‚¯ã‚»ã‚¹** | Port 8080 ã‚‚å¯ | Port 443 ã®ã¿ï¼ˆIPæŒ¯ã‚Šåˆ†ã‘ï¼‰ |
| **SSLè¨¼æ˜æ›¸** | ä¸è¦ï¼ˆã¾ãŸã¯ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ï¼‰ | æ­£å¼ãªSSLè¨¼æ˜æ›¸ï¼ˆACMï¼‰å¿…é ˆ |
| **URLä¾‹** | http://alb-xxxx.ap-northeast-1.elb.amazonaws.com | https://your-app.example.com |
| **ã‚¢ã‚¯ã‚»ã‚¹å…ƒIP** | å‹•çš„ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰ | å›ºå®šï¼ˆWindows Serverã€Jenkinsã€ã‚ªãƒ•ã‚£ã‚¹ï¼‰ |

**é‡è¦:** POCç’°å¢ƒã§ã‚‚æœ¬ç•ªã¨åŒã˜ã€ŒALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚‹IPæŒ¯ã‚Šåˆ†ã‘ã€ã‚’æ¤œè¨¼å¯èƒ½ã§ã™ã€‚ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒHTTPã‹HTTPSã‹ã®é•ã„ã®ã¿ã§ã™ã€‚

#### IPæŒ¯ã‚Šåˆ†ã‘ã®ç®¡ç†ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

**ç™»éŒ²IPã®ç®¡ç†æ–¹æ³•:**

1. **Systems Manager Parameter Store ã§ã®ç®¡ç†ï¼ˆæ¨å¥¨ï¼‰**
   ```bash
   # æ¤œè¨¼ç”¨IPç™»éŒ²
   aws ssm put-parameter \
     --name /poc/verification/allowed-ips \
     --type StringList \
     --value "10.0.1.100/32,203.0.113.0/32,10.0.2.200/32"
   
   # Jenkins/Ansible ã‹ã‚‰å–å¾—
   ALLOWED_IPS=$(aws ssm get-parameter --name /poc/verification/allowed-ips --query 'Parameter.Value' --output text)
   ```

2. **IPå¤‰æ›´æ™‚ã®æ‰‹é †**
   - Parameter Store ã®å€¤ã‚’æ›´æ–°
   - Jenkinsã‚¸ãƒ§ãƒ–ã§ ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã‚’è‡ªå‹•æ›´æ–°
   - å¤‰æ›´é€šçŸ¥ï¼ˆSlackç­‰ï¼‰

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹**
   - æ¤œè¨¼å®Œäº†å¾Œã¯é€Ÿã‚„ã‹ã«ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤
   - å®šæœŸçš„ã«ç™»éŒ²IPã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå››åŠæœŸã”ã¨ï¼‰
   - IPå¤‰æ›´å±¥æ­´ã‚’ CloudTrail ã§ç›£æŸ»

#### æ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«ã®é‹ç”¨ç®¡ç†

**ãƒ«ãƒ¼ãƒ«ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«:**

```
ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã€‘
1. Green/Canaryç’°å¢ƒæ§‹ç¯‰
   â†“
2. ALBæ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«è¿½åŠ  (Priority 1-9)
   â†“
3. æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆæ‰‹å‹•ãƒ†ã‚¹ãƒˆ + E2Eãƒ†ã‚¹ãƒˆï¼‰
   â†“
4. æ‰¿èªã‚²ãƒ¼ãƒˆ
   â†“
5. æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿
   â†“
6. ALBæ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«å‰Šé™¤ â† å¿…é ˆï¼
   â†“
7. æ—§ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
```

**Priorityç•ªå·ã®è¨­è¨ˆ:**

| ç¯„å›² | ç”¨é€” | ç®¡ç†æ–¹æ³• |
|------|------|---------|
| **1-9** | æ¤œè¨¼ç”¨ï¼ˆå‹•çš„ï¼‰ | Jenkinsè‡ªå‹•è¿½åŠ /å‰Šé™¤ |
| **10-99** | æœ¬ç•ªç”¨å›ºå®šãƒ«ãƒ¼ãƒ« | IaCç®¡ç†ï¼ˆSceptre/Terraformï¼‰ |
| **100-999** | å°†æ¥æ‹¡å¼µç”¨ | äºˆç´„ |
| **Default** | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ | å¸¸ã«å­˜åœ¨ï¼ˆå‰Šé™¤ä¸å¯ï¼‰ |

**æ—¢å­˜ãƒ«ãƒ¼ãƒ«ã¸ã®å½±éŸ¿:**

```
ã€ãƒ«ãƒ¼ãƒ«è©•ä¾¡é †åºã€‘
Priority 1  â† æ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«è¿½åŠ 
Priority 2  â† æ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«è¿½åŠ ï¼ˆè¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚ï¼‰
Priority 10 â† æ—¢å­˜ãƒ«ãƒ¼ãƒ«ï¼ˆå½±éŸ¿ãªã—ï¼‰
Priority 20 â† æ—¢å­˜ãƒ«ãƒ¼ãƒ«ï¼ˆå½±éŸ¿ãªã—ï¼‰
Default     â† æ—¢å­˜ï¼ˆå½±éŸ¿ãªã—ï¼‰

é‡è¦: PriorityãŒé‡è¤‡ã—ãªã‘ã‚Œã°ã€ä»–ã®ãƒ«ãƒ¼ãƒ«ã«å½±éŸ¿ã—ãªã„
```

**Jenkinsè‡ªå‹•åŒ–ä¾‹:**

```groovy
// æ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«è¿½åŠ 
stage('Add Verification Rule') {
    steps {
        script {
            sh '''
                aws elbv2 create-rule \
                  --listener-arn ${LISTENER_ARN} \
                  --priority 1 \
                  --conditions Field=source-ip,SourceIpConfig={Values=[10.0.1.0/24,10.0.11.0/24]} \
                  --actions Type=forward,TargetGroupArn=${VERIFICATION_TG_ARN} \
                  --tags Key=Session,Value=${BUILD_ID} Key=CreatedAt,Value=$(date -Iseconds)
            '''
            
            env.RULE_ARN = sh(
                script: "aws elbv2 describe-rules --listener-arn ${LISTENER_ARN} --query \"Rules[?Priority=='1'].RuleArn\" --output text",
                returnStdout: true
            ).trim()
        }
    }
}

// å¿…ãšãƒ«ãƒ¼ãƒ«å‰Šé™¤ï¼ˆæˆåŠŸãƒ»å¤±æ•—å•ã‚ãšï¼‰
post {
    always {
        script {
            if (env.RULE_ARN) {
                sh "aws elbv2 delete-rule --rule-arn ${RULE_ARN} || true"
            }
        }
    }
}
```

**ãƒªã‚¹ã‚¯å¯¾ç­–:**

1. **Priorityç«¶åˆå›é¿ï¼ˆè¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³åŒæ™‚å®Ÿè¡Œæ™‚ï¼‰**
   ```bash
   # åˆ©ç”¨å¯èƒ½ãªæœ€å°Priorityã‚’å‹•çš„ã«æ¤œç´¢
   NEXT_PRIORITY=$(aws elbv2 describe-rules --listener-arn ${LISTENER_ARN} \
     --query 'Rules[?Priority!=`default` && Priority<`10`].Priority' \
     --output text | tr '\t' '\n' | sort -n | tail -1)
   VERIFICATION_PRIORITY=$((NEXT_PRIORITY + 1))
   ```

2. **ãƒ«ãƒ¼ãƒ«å‰Šé™¤ã—å¿˜ã‚Œå¯¾ç­–ï¼ˆå®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰**
   ```bash
   # 24æ™‚é–“ä»¥ä¸ŠçµŒéã—ãŸæ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«ã‚’è‡ªå‹•å‰Šé™¤ï¼ˆCronå®Ÿè¡Œï¼‰
   aws elbv2 describe-rules --listener-arn ${LISTENER_ARN} | \
     jq -r '.Rules[] | select(.Priority != "default" and (.Priority|tonumber) < 10) | .RuleArn' | \
     while read RULE_ARN; do
       CREATED_AT=$(aws elbv2 describe-tags --resource-arns ${RULE_ARN} \
         --query "TagDescriptions[0].Tags[?Key=='CreatedAt'].Value" --output text)
       # çµŒéæ™‚é–“ãƒã‚§ãƒƒã‚¯ã¨å‰Šé™¤å‡¦ç†
     done
   ```

3. **æ—¢å­˜ãƒ«ãƒ¼ãƒ«ã¨ã®ç›¸äº’ä½œç”¨**
   ```
   å•é¡Œ: æ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ« (Priority 1) ãŒæ—¢å­˜ãƒ‘ã‚¹ãƒ«ãƒ¼ãƒ« (Priority 10) ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹
   
   å¯¾ç­–: æ¤œè¨¼ç”¨ãƒ«ãƒ¼ãƒ«ã§ã‚‚å¿…è¦ã«å¿œã˜ã¦ãƒ‘ã‚¹æ¡ä»¶ã‚’è¿½åŠ 
   
   ä¾‹:
   Priority 1: source-ip=10.0.1.0/24 AND path-pattern!=(/api/*,/admin/*)
   Priority 10: path-pattern=/api/* (æ—¢å­˜ã€å„ªå…ˆåº¦ä¸‹ã’ã‚‹)
   ```

**é‹ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ:**

- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹æ™‚ã«ãƒ«ãƒ¼ãƒ«è¿½åŠ ã‚’ç¢ºèª
- [ ] æ¤œè¨¼å®Œäº†å¾Œã«ãƒ«ãƒ¼ãƒ«å‰Šé™¤ã‚’ç¢ºèª
- [ ] Priority 1-9 ã®ç¯„å›²å†…ã§è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] æ—¢å­˜ãƒ«ãƒ¼ãƒ«ï¼ˆPriority 10ä»¥ä¸Šï¼‰ã«å½±éŸ¿ãŒãªã„ã‹ç¢ºèª
- [ ] ãƒ«ãƒ¼ãƒ«ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚¿ã‚°ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- [ ] å®šæœŸã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ğŸ”„ æ¤œè¨¼ãƒ•ãƒ­ãƒ¼ã®çµ±åˆ

å„ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ã«æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’çµ„ã¿è¾¼ã¿ã¾ã™ï¼š

#### Blue/Green Deployment + æ¤œè¨¼

```
ã€ãƒ•ãƒ­ãƒ¼ã€‘
1. Greenç’°å¢ƒæ§‹ç¯‰ï¼ˆæ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
2. â†“
3. ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«æ›´æ–°ï¼ˆæ¤œè¨¼ç”¨IPã‚’Green Target Groupã¸ï¼‰
   â€»æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯å¼•ãç¶šãBlue Target Groupã¸
4. â†“
5. ã€æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã€‘
   - Windows Serverã‹ã‚‰æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆhttps://your-app.example.comï¼‰
   - Jenkins E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆåŒä¸€URLï¼‰
   - ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
   â€»æ¤œè¨¼ç”¨IPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿Greenç’°å¢ƒã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
6. â†“
7. æ‰¿èªã‚²ãƒ¼ãƒˆï¼ˆæ‰‹å‹•æ‰¿èªï¼‰
8. â†“
9. æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿ï¼ˆæ®µéšçš„ï¼‰
   - ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã§Weightèª¿æ•´ï¼ˆ10% â†’ 50% â†’ 100%ï¼‰
   - æ¤œè¨¼ç”¨IPã‚‚æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¨åŒã˜ãƒ«ãƒ¼ãƒ«ã«çµ±åˆ
10. â†“
11. 24æ™‚é–“ç›£è¦–
12. â†“
13. Blueç’°å¢ƒå‰Šé™¤
```

#### Rolling Update + æ¤œè¨¼

```
ã€ãƒ•ãƒ­ãƒ¼ã€‘
1. æ–°AMIä½œæˆ
2. â†“
3. Devç’°å¢ƒã§æœ€åˆã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ›´æ–°
4. â†“
5. ã€æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã€‘
   - Devç’°å¢ƒã§æ‰‹å‹•ãƒ†ã‚¹ãƒˆ + E2Eãƒ†ã‚¹ãƒˆ
   - ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
6. â†“
7. æ‰¿èªã‚²ãƒ¼ãƒˆï¼ˆæ‰‹å‹•æ‰¿èªï¼‰
8. â†“
9. Prodç’°å¢ƒã§Instance Refreshé–‹å§‹
   - Checkpoint 33%ã§ä¸€æ™‚åœæ­¢
   - å†åº¦æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   - Checkpoint 66%, 100%ã¨é€²è¡Œ
```

#### Canary Deployment + æ¤œè¨¼

```
ã€ãƒ•ãƒ­ãƒ¼ã€‘
1. Canaryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ï¼ˆ1å°ï¼‰
2. â†“
3. ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«æ›´æ–°ï¼ˆæ¤œè¨¼ç”¨IPã‚’Canary Target Groupã¸ï¼‰
   â€»æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã¯å¼•ãç¶šãStable Target Groupã¸
4. â†“
5. ã€æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã€‘
   - Windows Serverã‹ã‚‰æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆhttps://your-app.example.comï¼‰
   - Jenkins E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆåŒä¸€URLï¼‰
   - ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
   â€»æ¤œè¨¼ç”¨IPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿Canaryç’°å¢ƒã¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
6. â†“
7. æ‰¿èªã‚²ãƒ¼ãƒˆï¼ˆæ‰‹å‹•æ‰¿èªï¼‰
8. â†“
9. ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ®µéšçš„å¢—åŠ ï¼ˆ5% â†’ 10% â†’ 30% â†’ 50% â†’ 100%ï¼‰
   - ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã§Weightèª¿æ•´
   - å„æ®µéšã§ç›£è¦–
   - å•é¡Œã‚ã‚Œã°å³åº§ã«0%ã¸æˆ»ã™
```

### ğŸ“Š ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªä¾‹

#### æ‰‹å‹•ãƒ†ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

**åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ:**
- [ ] ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
- [ ] ä¸»è¦ç”»é¢ã®è¡¨ç¤ºç¢ºèª
- [ ] ãƒ‡ãƒ¼ã‚¿ç™»éŒ²/æ›´æ–°/å‰Šé™¤
- [ ] æ¤œç´¢æ©Ÿèƒ½
- [ ] ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰/ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

**äº’æ›æ€§ãƒ†ã‚¹ãƒˆ:**
- [ ] æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœç¢ºèª
- [ ] APIãƒãƒ¼ã‚¸ãƒ§ãƒ³äº’æ›æ€§

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆä¸»è¦³çš„è©•ä¾¡ï¼‰:**
- [ ] ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é€Ÿåº¦
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
- [ ] åŒæ™‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ

#### E2Eãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªï¼ˆPlaywrightï¼‰

```javascript
// e2e-tests/tests/critical-path.spec.js
import { test, expect } from '@playwright/test';

test.describe('Critical Path Tests', () => {
  test('User can login and access dashboard', async ({ page }) => {
    await page.goto(process.env.TEST_URL);
    
    // ãƒ­ã‚°ã‚¤ãƒ³
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'password');
    await page.click('button[type="submit"]');
    
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºç¢ºèª
    await expect(page).toHaveURL(/.*dashboard/);
    await expect(page.locator('h1')).toContainText('Dashboard');
    
    // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
    const response = await page.goto(`${process.env.TEST_URL}/health`);
    expect(response.status()).toBe(200);
    const health = await response.json();
    expect(health.status).toBe('healthy');
    expect(health.database).toBe('connected');
  });
  
  test('Database read/write operations work correctly', async ({ page }) => {
    await page.goto(`${process.env.TEST_URL}/data`);
    
    // ãƒ‡ãƒ¼ã‚¿ä½œæˆ
    await page.fill('input[name="title"]', 'Test Data');
    await page.click('button#submit');
    
    // ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆReaderã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ï¼‰
    await page.reload();
    await expect(page.locator('text=Test Data')).toBeVisible();
    
    // ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆWriterã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ï¼‰
    await page.click('button#delete');
    await expect(page.locator('text=Test Data')).not.toBeVisible();
  });
  
  test('ProxySQL read/write splitting works', async ({ page }) => {
    // ProxySQLçµŒç”±ã§ã®DBæ¥ç¶šç¢ºèª
    const response = await page.goto(`${process.env.TEST_URL}/api/db-info`);
    const dbInfo = await response.json();
    
    // Writeræ¥ç¶šç¢ºèª
    expect(dbInfo.writer).toContain('cluster.ckpr71izl4r7');
    
    // Readeræ¥ç¶šç¢ºèª
    expect(dbInfo.reader).toContain('cluster-ro.ckpr71izl4r7');
  });
});
```

### ğŸ¯ æ‰¿èªãƒ•ãƒ­ãƒ¼ã¨æ„æ€æ±ºå®š

**æ‰¿èªåŸºæº–:**

| é …ç›® | åŸºæº– | ç¢ºèªè€… |
|------|------|-------|
| **E2Eãƒ†ã‚¹ãƒˆ** | å…¨ãƒ†ã‚¹ãƒˆPASS | Jenkinsè‡ªå‹•åˆ¤å®š |
| **æ‰‹å‹•ãƒ†ã‚¹ãƒˆ** | ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå®Œäº† | QAæ‹…å½“è€… |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ  < 2ç§’ | QAæ‹…å½“è€… |
| **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°** | é‡å¤§ã‚¨ãƒ©ãƒ¼ãªã— | é‹ç”¨æ‹…å½“è€… |
| **æœ€çµ‚æ‰¿èª** | å…¨é …ç›®ã‚¯ãƒªã‚¢ | ãƒªãƒªãƒ¼ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ |

**æ‰¿èªãƒ•ãƒ­ãƒ¼:**

```
1. E2Eãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ â†’ PASS/FAILåˆ¤å®š
   â†“ PASS
2. Slacké€šçŸ¥ã€Œæ‰‹å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹å¯èƒ½ã€
   â†“
3. QAæ‹…å½“è€…ãŒæ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿæ–½
   â†“
4. ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå®Œäº†ã‚’Jiraã«è¨˜éŒ²
   â†“
5. Jenkinsã€Œæ‰¿èªã‚²ãƒ¼ãƒˆã€ã§å¾…æ©Ÿ
   â†“
6. ãƒªãƒªãƒ¼ã‚¹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒJenkinsã§æ‰¿èª
   â†“
7. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹
```

---

## ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: Immutable Infrastructure (Golden AMI)

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Golden AMI Pipeline                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Packer  â”‚ â†’ â”‚ Base AMI â”‚ â†’ â”‚ Test(Dev) â”‚ â†’ â”‚Prod AMI â”‚â”‚
â”‚  â”‚ Build   â”‚   â”‚ +Patch   â”‚   â”‚ Validate  â”‚   â”‚ Release â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Auto Scaling Group (å›ºå®šå°æ•°)                    â”‚
â”‚   MinSize=3, MaxSize=3, DesiredCapacity=3                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  Launch Template (AMI ID from Parameter Store)     â”‚  â”‚
â”‚   â”‚  - User Data: å‹•çš„è¨­å®šå–å¾—ï¼ˆSecrets Managerç­‰ï¼‰     â”‚  â”‚
â”‚   â”‚  - Instance Refresh: ãƒ­ãƒ¼ãƒªãƒ³ã‚°æ›´æ–°è¨­å®š            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  EC2 (AZ-A)â”‚  â”‚  EC2 (AZ-C)â”‚  â”‚  EC2 (AZ-D)â”‚
        â”‚  (Immutableâ”‚  â”‚  (Immutableâ”‚  â”‚  (Immutableâ”‚
        â”‚   Instance)â”‚  â”‚   Instance)â”‚  â”‚   Instance)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. Golden AMI Pipeline
- **Packer**: è‡ªå‹•AMIä½œæˆ
- **Amazon Inspector**: è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
- **InSpec/ServerSpec**: æ§‹æˆãƒ†ã‚¹ãƒˆ
- **Parameter Store**: AMI IDç®¡ç†

#### 2. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**ãƒ‘ãƒƒãƒé©ç”¨æ™‚:**
```
1. Packer + Ansible ã§æ–°AMIä½œæˆ
2. Devç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
3. æ¤œè¨¼å®Œäº†å¾Œã€Parameter Storeæ›´æ–°
4. Launch Templateè‡ªå‹•æ›´æ–°
5. Instance Refreshå®Ÿè¡Œï¼ˆãƒ­ãƒ¼ãƒªãƒ³ã‚°æ›´æ–°ï¼‰
   - 1å°ãšã¤ç½®æ›
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
   - æ¬¡ã®å°ã¸
6. æ—§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è‡ªå‹•å‰Šé™¤
```

**ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ï¼ˆBlue/Greenï¼‰:**
```
1. æ–°AMIä½œæˆï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰
2. æ–°ã—ã„Target Groupä½œæˆ
3. æ–°ã—ã„ASGã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
4. ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã§æ®µéšçš„åˆ‡æ›¿
   - 10% â†’ 50% â†’ 100%
5. æ—§ç’°å¢ƒå‰Šé™¤
```

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

1. **å®Œå…¨ãªImmutableã‚¤ãƒ³ãƒ•ãƒ©**
   - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯å¸¸ã«èª­ã¿å–ã‚Šå°‚ç”¨
   - è¨­å®šãƒ‰ãƒªãƒ•ãƒˆç™ºç”Ÿãªã—
   - ä¸€è²«æ€§ãŒä¿è¨¼ã•ã‚Œã‚‹

2. **é«˜é€Ÿãªåˆ‡ã‚Šæˆ»ã—**
   - Launch Templateã® AMI ID ã‚’æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´â†’ Instance Refresh
   - æ‰€è¦æ™‚é–“: 3-5åˆ†

3. **24/365 è‡ªå‹•å¾©æ—§**
   - ASGãŒéšœå®³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è‡ªå‹•ç½®æ›
   - äººæ‰‹ä¸è¦

4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
   - å°†æ¥ã®ASGå¯¾å¿œãŒå®¹æ˜“ï¼ˆMaxSizeã‚’å¤‰æ›´ã™ã‚‹ã®ã¿ï¼‰

5. **ç›£æŸ»ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹**
   - AMIãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã§å±¥æ­´è¿½è·¡
   - ç’°å¢ƒã®å†ç¾æ€§ãŒé«˜ã„

### âŒ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **åˆæœŸæ§‹ç¯‰ã®è¤‡é›‘ã•**
   - Packerã€Parameter Storeã€Lambdaç­‰ã®æ§‹ç¯‰ãŒå¿…è¦
   - å­¦ç¿’ã‚³ã‚¹ãƒˆ: **é«˜**

2. **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**
   - AMIä½œæˆ: 10-15åˆ†
   - Instance Refresh: 15-20åˆ†
   - åˆè¨ˆ: **ç´„30-35åˆ†**ï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºä¾å­˜ï¼‰

3. **ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã¨ã‚³ã‚¹ãƒˆ**
   - è¤‡æ•°ä¸–ä»£ã®AMIä¿æŒãŒå¿…è¦
   - AMIã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: ç´„ $0.05/GB/æœˆï¼ˆä¾‹: 20GB Ã— 5ä¸–ä»£ = $5/æœˆï¼‰

4. **å°ã•ãªå¤‰æ›´ã§ã‚‚æ™‚é–“ãŒã‹ã‹ã‚‹**
   - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«1è¡Œå¤‰æ›´ã§ã‚‚å…¨ä½“AMIå†ä½œæˆãŒå¿…è¦

5. **å‹•çš„è¨­å®šã®è¤‡é›‘åŒ–**
   - DBæ¥ç¶šå…ˆç­‰ã¯User Dataã§å‹•çš„å–å¾—ã™ã‚‹è¨­è¨ˆãŒå¿…è¦

### ğŸ’° ã‚³ã‚¹ãƒˆ

| é …ç›® | æœˆé¡ã‚³ã‚¹ãƒˆ | å‚™è€ƒ |
|------|-----------|------|
| EC2 (t3.medium Ã— 3) | $150 | æ—¢å­˜ã¨åŒã˜ |
| AMIã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (5ä¸–ä»£) | $5 | 20GB Ã— 5ä¸–ä»£ |
| Parameter Store | ç„¡æ–™ | Standard |
| Lambdaï¼ˆAMIç®¡ç†ï¼‰ | $1æœªæº€ | æœˆæ•°å›å®Ÿè¡Œ |
| **åˆè¨ˆ** | **$156** | æ—¢å­˜+$6 |

### ğŸ”§ å®Ÿè£…ã®è¤‡é›‘ã•

| é …ç›® | é›£æ˜“åº¦ | å·¥æ•° |
|------|-------|------|
| Packeræ§‹ç¯‰ | â­â­â­â­ | 2æ—¥ |
| AMIç®¡ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ | â­â­â­â­ | 2æ—¥ |
| ASG + Launch Template | â­â­â­ | 1æ—¥ |
| User Dataè¨­è¨ˆ | â­â­â­ | 1æ—¥ |
| **åˆè¨ˆ** | **â­â­â­â­** | **6æ—¥** |

---

### ğŸ¯ Golden AMIã®ç¯„å›²æ±ºå®šï¼šä½•ã‚’å«ã‚ã‚‹ã‹

Golden AMIã‚’ä½œæˆã™ã‚‹éš›ã€**ã©ã“ã¾ã§ã‚’AMIã«ç„¼ãè¾¼ã‚€ã‹**ã¯é‡è¦ãªè¨­è¨ˆåˆ¤æ–­ã§ã™ã€‚

#### ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ

##### ãƒ‘ã‚¿ãƒ¼ãƒ³A: åŸºç›¤ã®ã¿ï¼ˆOS + ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Golden AMI                                                  â”‚
â”‚ â”œâ”€ Amazon Linux 2023                                        â”‚
â”‚ â”œâ”€ Apache 2.4                                               â”‚
â”‚ â”œâ”€ PHP 8.3                                                  â”‚
â”‚ â”œâ”€ ProxySQL                                                 â”‚
â”‚ â””â”€ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ EC2èµ·å‹•å¾Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Data / CodeDeploy ã§è¿½åŠ ãƒ‡ãƒ—ãƒ­ã‚¤                        â”‚
â”‚ â”œâ”€ Laravel ã‚³ãƒ¼ãƒ‰ï¼ˆ5-10åˆ†ï¼‰                                 â”‚
â”‚ â”œâ”€ composer installï¼ˆ3-5åˆ†ï¼‰                                â”‚
â”‚ â”œâ”€ .envè¨­å®š                                                 â”‚
â”‚ â””â”€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸  èµ·å‹•ï½ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹: 8-15åˆ†
âš ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®ãƒªã‚¹ã‚¯: ã‚ã‚Š
â“ å‹•ä½œç¢ºèª: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«åˆã‚ã¦ç¢ºèª
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- AMIä½œæˆãŒé«˜é€Ÿï¼ˆåŸºç›¤ã®ã¿ãªã®ã§5-7åˆ†ï¼‰
- ã‚¢ãƒ—ãƒªæ›´æ–°ã§AMIå†ä½œæˆä¸è¦
- åŸºç›¤ã¨ã‚¢ãƒ—ãƒªã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’åˆ†é›¢

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- **EC2èµ·å‹•å¾Œã«å‹•ä½œç¢ºèªæ¸ˆã¿ã§ãªã„çŠ¶æ…‹ãŒå­˜åœ¨**
- ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®ãƒªã‚¹ã‚¯
- èµ·å‹•ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹ã¾ã§æ™‚é–“ãŒã‹ã‹ã‚‹
- ASGã§ã®è‡ªå‹•å¾©æ—§ãŒé…ã„

##### ãƒ‘ã‚¿ãƒ¼ãƒ³B: å®Œå…¨ç‰ˆï¼ˆOS + ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ + ã‚¢ãƒ—ãƒªï¼‰â† **æ¨å¥¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Golden AMIï¼ˆå‹•ä½œç¢ºèªæ¸ˆã¿ã®å®Œå…¨ãªçŠ¶æ…‹ï¼‰                       â”‚
â”‚ â”œâ”€ Amazon Linux 2023                                        â”‚
â”‚ â”œâ”€ Apache 2.4                                               â”‚
â”‚ â”œâ”€ PHP 8.3                                                  â”‚
â”‚ â”œâ”€ ProxySQL                                                 â”‚
â”‚ â”œâ”€ Laravel ã‚³ãƒ¼ãƒ‰ï¼ˆv1.2.3ï¼‰                                 â”‚
â”‚ â”œâ”€ composerä¾å­˜é–¢ä¿‚ï¼ˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ï¼‰                      â”‚
â”‚ â””â”€ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼ˆå®Œå…¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ EC2èµ·å‹•å¾Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Data ã§ç’°å¢ƒå›ºæœ‰ã®è¨­å®šã®ã¿                               â”‚
â”‚ â”œâ”€ .envç”Ÿæˆï¼ˆSecrets Manager ã‹ã‚‰å–å¾—ï¼‰                     â”‚
â”‚ â”œâ”€ AZæƒ…å ±è¨­å®š                                               â”‚
â”‚ â””â”€ ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸  èµ·å‹•ï½ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹: 1-2åˆ† â† 7-13åˆ†çŸ­ç¸®ï¼
âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®ãƒªã‚¹ã‚¯: ãªã—ï¼ˆæ—¢ã«å‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
âœ… å‹•ä½œç¢ºèª: AMIä½œæˆå‰ã«å®Œå…¨ç¢ºèª
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿ã®çŠ¶æ…‹ã‚’AMIåŒ–** â† æœ€é‡è¦
- âœ… èµ·å‹•å¾Œå³åº§ã«ã‚µãƒ¼ãƒ“ã‚¹æä¾›å¯èƒ½
- âœ… ASGã§ã®è‡ªå‹•å¾©æ—§ãŒé«˜é€Ÿï¼ˆ1-2åˆ†ï¼‰
- âœ… ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ãŒé«˜é€Ÿ
- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ãƒªã‚¹ã‚¯ãªã—
- âœ… å®Œå…¨ãªå†ç¾æ€§

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚¢ãƒ—ãƒªæ›´æ–°ã®åº¦ã«AMIä½œæˆãŒå¿…è¦ï¼ˆ10-15åˆ†ï¼‰
- AMIã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒè‹¥å¹²å¢—åŠ 

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¸ã®å¯¾å¿œ:**
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§è‡ªå‹•åŒ– â†’ å¾…ã¡æ™‚é–“ã‚’æ„è­˜ã—ãªã„
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ã§5-7åˆ†ã«çŸ­ç¸®å¯èƒ½
- POCè¦æ¨¡ãªã‚‰ã‚¢ãƒ—ãƒªæ›´æ–°é »åº¦ã‚‚é«˜ããªã„

#### ğŸ¢ å®Ÿéš›ã®ä¼æ¥­ã§ã®æ¡ç”¨ä¾‹

| ä¼æ¥­/çµ„ç¹” | ãƒ‘ã‚¿ãƒ¼ãƒ³ | ç†ç”± |
|----------|---------|------|
| **Netflix** | å®Œå…¨ç‰ˆï¼ˆFull Baked AMIï¼‰ | "We bake everything into the AMI"<br>- å®Œå…¨ãªå†ç¾æ€§ã¨ä¿¡é ¼æ€§<br>- æ•°åƒå°è¦æ¨¡ã®ã‚¹ã‚±ãƒ¼ãƒ«<br>- èµ·å‹•å¾Œå³åº§ã«ã‚µãƒ¼ãƒ“ã‚¹æä¾› |
| **å¤§æ‰‹é‡‘èæ©Ÿé–¢** | Hybridï¼ˆåŸºç›¤AMI + ã‚¢ãƒ—ãƒªCodeDeployï¼‰ | - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒã¯å³æ ¼ã«ç®¡ç†<br>- ã‚¢ãƒ—ãƒªã¯é »ç¹ã«ãƒªãƒªãƒ¼ã‚¹<br>- ç›£æŸ»è¦ä»¶ã§AMIå±¥æ­´ç®¡ç† |
| **ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—** | å®Œå…¨ç‰ˆ â†’ Hybrid ã¸ç§»è¡Œ | - åˆæœŸã¯ç¢ºå®Ÿæ€§é‡è¦–ï¼ˆå®Œå…¨ç‰ˆï¼‰<br>- æˆé•·å¾Œã«æœ€é©åŒ–ï¼ˆHybridï¼‰ |

#### ğŸ¯ ç¾åœ¨ã®POCç’°å¢ƒã¸ã®æ¨å¥¨

**æ¨å¥¨: ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼ˆå®Œå…¨ç‰ˆ: OS + ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ + Laravelï¼‰**

**ç†ç”±:**

1. **å‹•ä½œç¢ºèªã®é‡è¦æ€§**
   - OS+ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã ã‘ã§ã¯å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹å‹•ä½œã‚’ç¢ºèªã§ããªã„
   - å‹•ä½œç¢ºèªæ¸ˆã¿ã®çŠ¶æ…‹ã‚’AMIåŒ–ã™ã‚‹æ–¹ãŒç¢ºå®Ÿ
   - ASGè‡ªå‹•å¾©æ—§æ™‚ã‚‚ç¢ºå®Ÿã«å‹•ä½œã™ã‚‹

2. **å¾©æ—§æ™‚é–“ã®å¤§å¹…çŸ­ç¸®**
   ```
   ç¾çŠ¶ï¼ˆMutable + æ‰‹å‹•Ansibleï¼‰:
     EC2èµ·å‹•: 51ç§’
     Ansibleå®Ÿè¡Œ: 5-10åˆ†ï¼ˆæ‰‹å‹•ï¼‰
     åˆè¨ˆ: ç´„6-11åˆ† â† äººæ‰‹å¿…è¦ã€å¤±æ•—ãƒªã‚¹ã‚¯ã‚ã‚Š
   
   æ”¹å–„å¾Œï¼ˆFull Baked AMI + User Dataï¼‰:
     EC2èµ·å‹•: 51ç§’
     User Dataå®Ÿè¡Œ: 30-60ç§’ï¼ˆè‡ªå‹•ï¼‰
     åˆè¨ˆ: ç´„1.5-2åˆ† â† å®Œå…¨è‡ªå‹•ã€å¤±æ•—ãƒªã‚¹ã‚¯ä½
   
   åŠ¹æœ: 5-9åˆ†çŸ­ç¸®ã€é‹ç”¨å·¥æ•°ã‚¼ãƒ­ã€ä¿¡é ¼æ€§å¤§å¹…å‘ä¸Š
   ```

3. **POCç’°å¢ƒã®ç‰¹æ€§**
   - æ›´æ–°é »åº¦ãŒãã“ã¾ã§é«˜ããªã„
   - ç¢ºå®Ÿæ€§ãŒæœ€å„ªå…ˆ
   - Blue/Greenãƒ‡ãƒ—ãƒ­ã‚¤ã®åŸºç›¤ã¨ã—ã¦æœ€é©

### ğŸ”§ ã‚¢ãƒ—ãƒªå«ã‚€å ´åˆã®å®Ÿè£…èª²é¡Œã¨è§£æ±ºç­–

#### èª²é¡Œ1: ç’°å¢ƒå›ºæœ‰ã®è¨­å®šï¼ˆAZã€DBæ¥ç¶šå…ˆãªã©ï¼‰

**å•é¡Œ:**
- AMIä½œæˆå…ƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¨­å®šï¼ˆ.envãªã©ï¼‰ãŒç„¼ãè¾¼ã¾ã‚Œã‚‹
- ä»–ã®AZã§èµ·å‹•ã™ã‚‹ã¨è¨­å®šãŒåˆã‚ãªã„

**è§£æ±ºç­–: User Data + Secrets Manager / Parameter Store**

```bash
#!/bin/bash
set -e

# ãƒ­ã‚°å‡ºåŠ›
exec > >(tee /var/log/user-data.log)
exec 2>&1

echo "=== User Data Execution Start ==="
date

# 1. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
REGION=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/placement/region)
AZ=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/placement/availability-zone)
INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id)

# 2. Secrets Manager ã‹ã‚‰æ©Ÿå¯†æƒ…å ±å–å¾—
DB_PASSWORD=$(aws secretsmanager get-secret-value \
  --secret-id poc/db/password \
  --region $REGION \
  --query SecretString \
  --output text)

APP_KEY=$(aws secretsmanager get-secret-value \
  --secret-id poc/laravel/app-key \
  --region $REGION \
  --query SecretString \
  --output text)

# 3. .envç”Ÿæˆï¼ˆç’°å¢ƒå›ºæœ‰ã®è¨­å®šï¼‰
cat > /var/www/poc-web/.env << ENVEOF
APP_NAME=POC-Web
APP_ENV=production
APP_KEY=$APP_KEY
APP_DEBUG=false

# ProxySQLçµŒç”±ã§DBæ¥ç¶šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ›ã‚¹ãƒˆï¼‰
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=6033
DB_DATABASE=poc_db
DB_USERNAME=poc_user
DB_PASSWORD=$DB_PASSWORD

# Instance Metadata
AWS_DEFAULT_REGION=$REGION
AWS_AVAILABILITY_ZONE=$AZ
INSTANCE_ID=$INSTANCE_ID
ENVEOF

chown apache:apache /var/www/poc-web/.env
chmod 600 /var/www/poc-web/.env

# 4. Laravel ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”Ÿæˆ
cd /var/www/poc-web
sudo -u apache php artisan config:cache
sudo -u apache php artisan route:cache
sudo -u apache php artisan view:cache

# 5. ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
systemctl enable httpd proxysql
systemctl restart httpd
systemctl restart proxysql

# 6. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¾…æ©Ÿ
for i in {1..30}; do
  HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' \
    http://localhost/health || echo "000")
  if [ "$HTTP_CODE" = "200" ]; then
    echo "âœ… Health check passed"
    break
  fi
  sleep 2
done

echo "=== User Data Execution Complete ==="
date
```

#### èª²é¡Œ2: æ©Ÿå¯†æƒ…å ±ã®æ‰±ã„

**å•é¡Œ:**
- DBãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„API keyã‚’AMIã«ç„¼ãè¾¼ã‚€ã®ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯

**è§£æ±ºç­–: æ©Ÿå¯†æƒ…å ±ã¯çµ¶å¯¾ã«AMIã«å«ã‚ãªã„**

**AMIã«å«ã‚ã‚‹ã‚‚ã®:**
- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
- âœ… composerä¾å­˜é–¢ä¿‚
- âœ… ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- âœ… ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆsystemdï¼‰

**AMIã«å«ã‚ãªã„ã‚‚ã®ï¼ˆUser Dataã§å–å¾—ï¼‰:**
- âŒ DBãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ â†’ Secrets Manager
- âŒ APP_KEY â†’ Secrets Manager
- âŒ APIãƒˆãƒ¼ã‚¯ãƒ³ â†’ Secrets Manager
- âŒ ç’°å¢ƒå›ºæœ‰ã®è¨­å®š â†’ Parameter Store

**AMIä½œæˆå‰ã®æº–å‚™:**
```bash
# AMIä½œæˆå…ƒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å®Ÿè¡Œ

# 1. .envå‰Šé™¤ï¼ˆæ©Ÿå¯†æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ï¼‰
rm /var/www/poc-web/.env

# 2. ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªã‚¢
find /var/log -type f -exec truncate -s 0 {} \;

# 3. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm -rf /tmp/*
rm -rf /var/tmp/*

# 4. SSHãƒ›ã‚¹ãƒˆéµã‚’èµ·å‹•æ™‚å†ç”Ÿæˆã™ã‚‹ã‚ˆã†è¨­å®š
rm -f /etc/ssh/ssh_host_*
cat >> /etc/rc.local << 'EOF'
if [ ! -f /etc/ssh/ssh_host_rsa_key ]; then
  ssh-keygen -A
fi
EOF
chmod +x /etc/rc.local

# 5. ãƒã‚·ãƒ³IDå†ç”Ÿæˆãƒ•ãƒ©ã‚°
truncate -s 0 /etc/machine-id
```

#### èª²é¡Œ3: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**å•é¡Œ:**
- è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåŒæ™‚èµ·å‹•ã™ã‚‹ã¨ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç«¶åˆ

**è§£æ±ºç­–1: Blue/Greenåˆ‡æ›¿å‰ã«1å›ã ã‘å®Ÿè¡Œ**
```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å†…ã§å®Ÿè¡Œ
# æ–°ç’°å¢ƒç«‹ã¡ä¸Šã’å‰ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
php artisan migrate --force
```

**è§£æ±ºç­–2: User Dataã§ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã‚’å®Ÿè£…ï¼ˆDynamoDBä½¿ç”¨ï¼‰**
```bash
# User Dataå†…ã«è¿½åŠ 
LOCK_ACQUIRED=$(aws dynamodb put-item \
  --table-name migration-locks \
  --item '{"lock_key":{"S":"poc-migration"},"instance_id":{"S":"'$INSTANCE_ID'"}}' \
  --condition-expression "attribute_not_exists(lock_key)" \
  --region $REGION 2>&1)

if [ $? -eq 0 ]; then
  # ãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸ â†’ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
  cd /var/www/poc-web
  sudo -u apache php artisan migrate --force
  
  # ãƒ­ãƒƒã‚¯è§£æ”¾
  aws dynamodb delete-item \
    --table-name migration-locks \
    --key '{"lock_key":{"S":"poc-migration"}}' \
    --region $REGION
else
  # ä»–ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå®Ÿè¡Œä¸­ â†’ ã‚¹ã‚­ãƒƒãƒ—
  echo "Migration already running on another instance"
fi
```

#### èª²é¡Œ4: ã‚¢ãƒ—ãƒªæ›´æ–°ã®åº¦ã«AMIä½œæˆã¯æ™‚é–“ãŒã‹ã‹ã‚‹

**å•é¡Œ:**
- ã‚¢ãƒ—ãƒªæ›´æ–°é »åº¦ãŒé«˜ã„å ´åˆã€AMIä½œæˆï¼ˆ10-15åˆ†ï¼‰ãŒé…ã„

**è§£æ±ºç­–1: Packer + CI/CD ã§è‡ªå‹•åŒ–ï¼ˆå¾…ã¡æ™‚é–“ã‚’æ„è­˜ã—ãªã„ï¼‰**
```
git push â†’ Jenkins â†’ Packer Build â†’ AMIä½œæˆ â†’ è‡ªå‹•ãƒ†ã‚¹ãƒˆ
           â†“ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
        é–‹ç™ºè€…ã¯æ¬¡ã®ä½œæ¥­ã¸
           â†“
        æ‰¿èª â†’ æœ¬ç•ªLaunch Templateæ›´æ–°
```

**è§£æ±ºç­–2: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ï¼ˆå®Ÿéš›ã¯5-7åˆ†ã§å®Œäº†ï¼‰**
- Ansible playbookå®Ÿè¡Œæ¸ˆã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- composerä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- npmãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥

å®Ÿæ¸¬: 10-15åˆ† â†’ 5-7åˆ†ã«çŸ­ç¸®å¯èƒ½

### ğŸ“‹ å®Ÿè£…æ‰‹é †ï¼ˆPhase 1: æ‰‹å‹•Golden AMIä½œæˆï¼‰

ç¾åœ¨ã®POCç’°å¢ƒã§å³åº§ã«å®Ÿæ–½å¯èƒ½ãªæ‰‹é †ï¼š

```bash
# ã‚¹ãƒ†ãƒƒãƒ—1: å‹•ä½œç¢ºèª
# pochub-001ã§å®Œå…¨ãªå‹•ä½œç¢ºèª
curl http://localhost/health  # {"status":"healthy","database":"connected"}

# ã‚¹ãƒ†ãƒƒãƒ—2: AMIä½œæˆæº–å‚™
ssh pochub-001
sudo su -

# .envå‰Šé™¤
rm /var/www/poc-web/.env

# ãƒ­ã‚°ã‚¯ãƒªã‚¢
find /var/log -type f -exec truncate -s 0 {} \;

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
rm -rf /tmp/* /var/tmp/*

# ã‚¹ãƒ†ãƒƒãƒ—3: AMIä½œæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç«¯æœ«ã‹ã‚‰ï¼‰
INSTANCE_ID=$(aws ec2 describe-instances \
  --filters "Name=tag:Name,Values=pochub-001" \
  --region ap-northeast-1 \
  --query 'Reservations[0].Instances[0].InstanceId' \
  --output text)

aws ec2 create-image \
  --instance-id $INSTANCE_ID \
  --name "poc-web-golden-v1.0.0-$(date +%Y%m%d-%H%M)" \
  --description "Laravel 11 + ProxySQL + Amazon Linux 2023" \
  --no-reboot \
  --region ap-northeast-1

# ã‚¹ãƒ†ãƒƒãƒ—4: User Dataã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆï¼ˆä¸Šè¨˜å‚ç…§ï¼‰

# ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
# æ–°AMI + User Dataã§èµ·å‹•ã—ã¦å‹•ä½œç¢ºèª

# ã‚¹ãƒ†ãƒƒãƒ—6: Launch Templateä½œæˆ & ASGæ›´æ–°
# æ¤œè¨¼å®Œäº†å¾Œã€æœ¬ç•ªç’°å¢ƒã«é©ç”¨
```

### ğŸ“Š åŠ¹æœæ¸¬å®š

| é …ç›® | ç¾çŠ¶ï¼ˆMutableï¼‰ | æ”¹å–„å¾Œï¼ˆFull Baked AMIï¼‰ | åŠ¹æœ |
|------|----------------|------------------------|------|
| **EC2å¾©æ—§æ™‚é–“** | 6-11åˆ†ï¼ˆæ‰‹å‹•ï¼‰ | 1.5-2åˆ†ï¼ˆè‡ªå‹•ï¼‰ | **5-9åˆ†çŸ­ç¸®** |
| **é‹ç”¨å·¥æ•°** | æ‰‹å‹•Ansibleå®Ÿè¡Œå¿…è¦ | å®Œå…¨è‡ªå‹• | **å·¥æ•°ã‚¼ãƒ­** |
| **ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ãƒªã‚¹ã‚¯** | ã‚ã‚Š | ãªã— | **ä¿¡é ¼æ€§å‘ä¸Š** |
| **å‹•ä½œç¢ºèª** | ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œ | AMIä½œæˆå‰ | **ç¢ºå®Ÿæ€§å‘ä¸Š** |
| **ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é€Ÿåº¦** | 8-15åˆ† | 1.5-2åˆ† | **7-13åˆ†çŸ­ç¸®** |

---

## ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: Mutable Infrastructure (In-Place Update)

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Jenkins (ECS Fargate)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ansible Playbookå®Ÿè¡Œ                                â”‚   â”‚
â”‚  â”‚  - setup-laravel-environment.yml                    â”‚   â”‚
â”‚  â”‚  - install-proxysql-existing-aurora.yml             â”‚   â”‚
â”‚  â”‚  - apply-security-patches.yml (æ–°è¦)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ SSM Session ManagerçµŒç”±
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼           â–¼           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ EC2     â”‚ â”‚ EC2     â”‚ â”‚ EC2     â”‚
   â”‚ (AZ-A)  â”‚ â”‚ (AZ-C)  â”‚ â”‚ (AZ-D)  â”‚
   â”‚ Mutable â”‚ â”‚ Mutable â”‚ â”‚ Mutable â”‚
   â”‚ Instanceâ”‚ â”‚ Instanceâ”‚ â”‚ Instanceâ”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²           â–²           â–²
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         CloudWatch Alarms + Lambda
         (ãƒ—ãƒ­ã‚»ã‚¹æ­»äº¡â†’Ansibleå†å®Ÿè¡Œ)
```

### ğŸ“ ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**ãƒ‘ãƒƒãƒé©ç”¨æ™‚:**
```
1. Jenkins JobãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
2. Ansible Playbookã§1å°ãšã¤é †æ¬¡ãƒ‘ãƒƒãƒé©ç”¨
   - ALBã‹ã‚‰ãƒ‡ã‚¿ãƒƒãƒ
   - yum updateå®Ÿè¡Œ
   - å†èµ·å‹•
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
   - ALBã«ã‚¢ã‚¿ãƒƒãƒ
   - æ¬¡ã®å°ã¸
3. CloudWatch Logsã«çµæœè¨˜éŒ²
```

**ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚:**
```
1. Gitã¸ã®Push â†’ Jenkins Webhook
2. Ansible Playbookã§1å°ãšã¤é †æ¬¡ãƒ‡ãƒ—ãƒ­ã‚¤
   - ALBã‹ã‚‰ãƒ‡ã‚¿ãƒƒãƒ
   - git pull
   - composer install
   - php artisan migrate
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
   - ALBã«ã‚¢ã‚¿ãƒƒãƒ
   - æ¬¡ã®å°ã¸
3. å¤±æ•—æ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆgit checkoutï¼‰
```

#### 2. éšœå®³è‡ªå‹•å¾©æ—§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CloudWatch Alarm: httpd process check (å¤±æ•—)   â”‚
â”‚            â†“                                     â”‚
â”‚  SNS Topic                                       â”‚
â”‚            â†“                                     â”‚
â”‚  Lambda Function                                 â”‚
â”‚    - Step 1: systemctl restart httpd           â”‚
â”‚    - Step 2 (5åˆ†å¾Œã‚‚å¤±æ•—): Ansibleå®Ÿè¡Œ          â”‚
â”‚    - Step 3 (å†æ§‹ç¯‰å¤±æ•—): é€šçŸ¥â†’æ‰‹å‹•å¯¾å¿œ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

1. **ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ**
   - æ—¢å­˜ã®Ansible Playbookã‚’ãã®ã¾ã¾æ´»ç”¨
   - æ–°ãŸãªå­¦ç¿’ã‚³ã‚¹ãƒˆ: **æœ€å°**

2. **é«˜é€Ÿãªãƒ‡ãƒ—ãƒ­ã‚¤**
   - å°ã•ãªå¤‰æ›´ãªã‚‰æ•°åˆ†ã§å®Œäº†
   - AMIä½œæˆä¸è¦

3. **æŸ”è»Ÿæ€§**
   - ç·Šæ€¥ã®è¨­å®šå¤‰æ›´ã«å³åº§ã«å¯¾å¿œå¯èƒ½
   - 1å°ã ã‘å…ˆè¡Œé©ç”¨ç­‰ã®ç´°ã‹ã„åˆ¶å¾¡ãŒå¯èƒ½

4. **æ—¢å­˜è³‡ç”£ã®æ´»ç”¨**
   - ã™ã§ã«Ansible PlaybookãŒå­˜åœ¨
   - Jenkins + Giteaã®æ´»ç”¨

5. **ã‚³ã‚¹ãƒˆæœ€å°**
   - è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹ä¸è¦

### âŒ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **è¨­å®šãƒ‰ãƒªãƒ•ãƒˆã®ãƒªã‚¹ã‚¯**
   - å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ãŒå¾®å¦™ã«ç•°ãªã‚‹å¯èƒ½æ€§
   - Ansibleå®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã‚ºãƒ¬ã§ä¸€è²«æ€§ãŒå¤±ã‚ã‚Œã‚‹

2. **åˆ‡ã‚Šæˆ»ã—ã®è¤‡é›‘ã•**
   - git checkout + è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒ + ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - æ‰€è¦æ™‚é–“: **10-20åˆ†** + æ‰‹é †ã®è¤‡é›‘ã•

3. **éšœå®³å¾©æ—§ã®é™ç•Œ**
   - ãƒ‡ã‚£ã‚¹ã‚¯ç ´æã€ã‚«ãƒ¼ãƒãƒ«ãƒ‘ãƒ‹ãƒƒã‚¯ç­‰ã«ã¯å¯¾å¿œä¸å¯
   - Ansibleå†å®Ÿè¡Œã§è§£æ±ºã—ãªã„éšœå®³ã¯æ‰‹å‹•å¯¾å¿œ

4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®èª²é¡Œ**
   - å°†æ¥ã®ASGå¯¾å¿œã«ã¯å¤§å¹…ãªè¨­è¨ˆå¤‰æ›´ãŒå¿…è¦
   - Auto Scalingæ™‚ã«æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã©ã†åˆæœŸæ§‹ç¯‰ã™ã‚‹ã‹ï¼Ÿ

5. **é‹ç”¨è² è·**
   - å¤œé–“ãƒ»ä¼‘æ—¥ã®ãƒ‘ãƒƒãƒé©ç”¨ã§ã‚‚ç›£è¦–ãŒå¿…è¦
   - Ansibleå®Ÿè¡Œå¤±æ•—æ™‚ã®æ‰‹å‹•å¯¾å¿œ

### ğŸ’° ã‚³ã‚¹ãƒˆ

| é …ç›® | æœˆé¡ã‚³ã‚¹ãƒˆ | å‚™è€ƒ |
|------|-----------|------|
| EC2 (t3.medium Ã— 3) | $150 | æ—¢å­˜ã¨åŒã˜ |
| Lambdaï¼ˆéšœå®³å¾©æ—§ï¼‰ | $1æœªæº€ | éšœå®³æ™‚ã®ã¿å®Ÿè¡Œ |
| CloudWatch Alarms | $1 | ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦– |
| **åˆè¨ˆ** | **$152** | æ—¢å­˜+$2 |

### ğŸ”§ å®Ÿè£…ã®è¤‡é›‘ã•

| é …ç›® | é›£æ˜“åº¦ | å·¥æ•° |
|------|-------|------|
| Ansible Playbookæ‹¡å¼µ | â­â­ | 1æ—¥ |
| Jenkins Jobè¨­å®š | â­â­ | 0.5æ—¥ |
| éšœå®³å¾©æ—§Lambda | â­â­â­ | 1æ—¥ |
| CloudWatch Alarms | â­â­ | 0.5æ—¥ |
| **åˆè¨ˆ** | **â­â­** | **3æ—¥** |

---

## ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: Hybrid Approach

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        2å±¤ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: Base AMI + Application Layer          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Layer 1: Base Infrastructure (Immutable)ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Base AMI (æœˆæ¬¡æ›´æ–°)                                         â”‚
â”‚  - OS + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒ                                    â”‚
â”‚  - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ (Apache, PHP, ProxySQLç­‰)                    â”‚
â”‚  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š (CIS Benchmarkæº–æ‹ )                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Auto Scaling Group (å›ºå®šå°æ•°)                   â”‚       â”‚
â”‚  â”‚  - Launch Template: Base AMI                    â”‚       â”‚
â”‚  â”‚  - User Data: Application Layer ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
ã€Layer 2: Application Layer (Mutable)ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Jenkins + Ansible                                          â”‚
â”‚  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ (git pull)                          â”‚
â”‚  - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (Parameter Storeå–å¾—)                        â”‚
â”‚  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³                              â”‚
â”‚  - ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (composer/npm)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“ ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 1. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨æ™‚ (æœˆæ¬¡):**
```
1. Packer + Ansibleã§æ–°Base AMIä½œæˆ
   - OSãƒ‘ãƒƒãƒé©ç”¨
   - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢æ›´æ–°
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šé©ç”¨
2. Devç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
3. Launch Templateæ›´æ–°
4. Instance Refreshï¼ˆãƒ­ãƒ¼ãƒªãƒ³ã‚°æ›´æ–°ï¼‰
   - æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
   - User Dataã§ Application Layer ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
   - æ—§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å‰Šé™¤
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ (é€±æ¬¡/éšæ™‚):**
```
1. Gitã¸ã®Push â†’ Jenkins Webhook
2. Ansible Playbookã§1å°ãšã¤é †æ¬¡ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2ã¨åŒã˜ï¼‰
   - ALBã‹ã‚‰ãƒ‡ã‚¿ãƒƒãƒ
   - git pull
   - composer install
   - php artisan migrate
   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
   - ALBã«ã‚¢ã‚¿ãƒƒãƒ
```

#### 2. éšœå®³å¾©æ—§

**ãƒ—ãƒ­ã‚»ã‚¹éšœå®³:**
```
CloudWatch Alarm â†’ Lambda â†’ systemctl restart httpd
```

**ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éšœå®³:**
```
ASG Auto Recovery â†’ æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹• â†’ User Dataå®Ÿè¡Œ â†’ æœ€æ–°ã‚¢ãƒ—ãƒªè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
```

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

1. **ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè¨­è¨ˆ**
   - ã‚¤ãƒ³ãƒ•ãƒ©å±¤: Immutableï¼ˆä¸€è²«æ€§ï¼‰
   - ã‚¢ãƒ—ãƒªå±¤: Mutableï¼ˆæŸ”è»Ÿæ€§ï¼‰

2. **é©åˆ‡ãªæ›´æ–°é »åº¦**
   - OSãƒ‘ãƒƒãƒ: æœˆæ¬¡ï¼ˆæ™‚é–“ã‚’ã‹ã‘ã¦æ¤œè¨¼ï¼‰
   - ã‚¢ãƒ—ãƒª: éšæ™‚ï¼ˆé«˜é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

3. **åˆ‡ã‚Šæˆ»ã—ã®æŸ”è»Ÿæ€§**
   - ã‚¢ãƒ—ãƒªå±¤ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ•°åˆ†ï¼ˆgit checkoutï¼‰
   - ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: 5åˆ†ï¼ˆLaunch Templateå¤‰æ›´ï¼‰

4. **å°†æ¥ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**
   - ASGå¯¾å¿œæ¸ˆã¿ï¼ˆæ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯è‡ªå‹•çš„ã«æœ€æ–°ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰

5. **æ®µéšçš„ç§»è¡ŒãŒå¯èƒ½**
   - ç¾åœ¨ã®Mutableæ§‹æˆã‹ã‚‰å¾ã€…ã«Immutableã¸ç§»è¡Œ

### âŒ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **2ã¤ã®ç®¡ç†è»¸**
   - Base AMIç®¡ç†ã¨Ansibleç®¡ç†ã®2ã¤ã‚’é‹ç”¨
   - è¤‡é›‘ã•: **ä¸­ç¨‹åº¦**

2. **è²¬å‹™ã®å¢ƒç•ŒãŒæ›–æ˜§ã«ãªã‚Šã‚„ã™ã„**
   - ã©ã“ã¾ã§ã‚’Base AMIã«å«ã‚ã‚‹ã‹ï¼Ÿ
   - ã©ã“ã‹ã‚‰ã‚’Application Layerã«ã™ã‚‹ã‹ï¼Ÿ
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã¨é‹ç”¨ãƒ«ãƒ¼ãƒ«ãŒé‡è¦

3. **User Data ã®è¤‡é›‘åŒ–**
   - Application Layerã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã«ãªã‚‹å¯èƒ½æ€§

4. **åˆæœŸæ§‹ç¯‰ã‚³ã‚¹ãƒˆ**
   - ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1ã¨ã»ã¼åŒç­‰ã®æ§‹ç¯‰ãŒå¿…è¦

### ğŸ’° ã‚³ã‚¹ãƒˆ

| é …ç›® | æœˆé¡ã‚³ã‚¹ãƒˆ | å‚™è€ƒ |
|------|-----------|------|
| EC2 (t3.medium Ã— 3) | $150 | æ—¢å­˜ã¨åŒã˜ |
| AMIã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ (3ä¸–ä»£) | $3 | 20GB Ã— 3ä¸–ä»£ |
| Parameter Store | ç„¡æ–™ | Standard |
| Lambdaï¼ˆAMIç®¡ç†ãƒ»éšœå®³å¾©æ—§ï¼‰ | $1æœªæº€ | æœˆæ•°å›å®Ÿè¡Œ |
| CloudWatch Alarms | $1 | ãƒ—ãƒ­ã‚»ã‚¹ç›£è¦– |
| **åˆè¨ˆ** | **$155** | æ—¢å­˜+$5 |

### ğŸ”§ å®Ÿè£…ã®è¤‡é›‘ã•

| é …ç›® | é›£æ˜“åº¦ | å·¥æ•° |
|------|-------|------|
| Base AMI Pipeline | â­â­â­â­ | 2æ—¥ |
| ASG + Launch Template | â­â­â­ | 1æ—¥ |
| User Dataè¨­è¨ˆ | â­â­â­ | 1æ—¥ |
| Ansible Playbookèª¿æ•´ | â­â­ | 0.5æ—¥ |
| **åˆè¨ˆ** | **â­â­â­â­** | **4.5æ—¥** |

---

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã¨ã®çµ„ã¿åˆã‚ã›

### ğŸ“Š ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†æ–¹å¼ Ã— ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ ãƒãƒˆãƒªã‚¯ã‚¹

| ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†æ–¹å¼ | æ¨å¥¨ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ | çµ„ã¿åˆã‚ã›ã®ç‰¹å¾´ | åˆ‡ã‚Šæˆ»ã—æ™‚é–“ |
|----------------|----------------|----------------|------------|
| **Immutable** | **Blue/Green** | å®Œå…¨ç„¡åœæ­¢ã€ç¬æ™‚åˆ‡ã‚Šæˆ»ã—ã€æœ€é«˜ã®ä¸€è²«æ€§ | **1-5åˆ†** |
| **Immutable** | Rolling Update | æ®µéšçš„æ›´æ–°ã€ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡çš„ | 10-15åˆ† |
| **Mutable** | Rolling Update | ã‚·ãƒ³ãƒ—ãƒ«ã€æ—¢å­˜è³‡ç”£æ´»ç”¨ | 15-30åˆ† |
| **Mutable** | In-Place | æœ€ã‚‚å˜ç´”ã ãŒåœæ­¢æ™‚é–“ã‚ã‚Š | 30åˆ†+ |
| **Hybrid** â­ | **Blue/Green** | ãƒãƒ©ãƒ³ã‚¹å‹ã€åŸºç›¤å®‰å®šãƒ»ã‚¢ãƒ—ãƒªé«˜é€Ÿ | **3-10åˆ†** |
| **Hybrid** â­ | Rolling Update | æœ€ã‚‚å®Ÿç”¨çš„ã€æŸ”è»Ÿæ€§é«˜ã„ | 5-15åˆ† |

### ğŸ¯ è¦ä»¶ã¨ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ã®å¯¾å¿œ

#### R1: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨ï¼ˆç„¡åœæ­¢ãƒ»è‡ªå‹•åŒ–ï¼‰

**æœ€é©ãªçµ„ã¿åˆã‚ã›:**

| çµ„ã¿åˆã‚ã› | é©åˆåº¦ | ç†ç”± |
|-----------|-------|------|
| **Hybrid + Rolling Update** | â— | æœˆæ¬¡æ›´æ–°ã€æ®µéšçš„é©ç”¨ã€ãƒªã‚¹ã‚¯æœ€å° |
| Immutable + Rolling Update | â— | å®Œå…¨è‡ªå‹•åŒ–ã€ä¸€è²«æ€§æœ€é«˜ |
| Immutable + Blue/Green | â—‹ | å®Œç’§ã ãŒã€ãƒ‘ãƒƒãƒé©ç”¨ã«ã¯éå‰° |
| Mutable + Rolling Update | â—‹ | ã‚·ãƒ³ãƒ—ãƒ«ã ãŒè¨­å®šãƒ‰ãƒªãƒ•ãƒˆãƒªã‚¹ã‚¯ |

**æ¨å¥¨:** **Hybrid + Rolling Update**
- Base AMIæ›´æ–°ï¼ˆæœˆæ¬¡ï¼‰
- ASG Instance Refreshã§æ®µéšçš„ç½®æ›
- å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèªå¾Œã«æ¬¡ã¸

#### R2: ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç„¡åœæ­¢ãƒ»å®¹æ˜“ãªåˆ‡ã‚Šæˆ»ã—ï¼‰

**æœ€é©ãªçµ„ã¿åˆã‚ã›:**

| çµ„ã¿åˆã‚ã› | é©åˆåº¦ | ç†ç”± |
|-----------|-------|------|
| **Hybrid + Blue/Green** | â— | å®Œå…¨ç„¡åœæ­¢ã€3åˆ†ã§åˆ‡ã‚Šæˆ»ã— |
| Immutable + Blue/Green | â— | å®Œç’§ã ãŒæ¯å›AMIä½œæˆã§æ™‚é–“ã‹ã‹ã‚‹ |
| Mutable + Rolling Update | â—‹ | å¯èƒ½ã ãŒåˆ‡ã‚Šæˆ»ã—ã«æ™‚é–“ |
| **Hybrid + Rolling Update** | â—‹ | å®Ÿç”¨çš„ã€æŸ”è»Ÿæ€§é«˜ã„ |

**æ¨å¥¨:** **Hybrid + Blue/Green Deployment**
- é€šå¸¸ã®ã‚¢ãƒ—ãƒªæ›´æ–°: Rolling Updateï¼ˆ5åˆ†ï¼‰
- é‡è¦ãªãƒªãƒªãƒ¼ã‚¹: Blue/Greenï¼ˆå®Œå…¨ç„¡åœæ­¢ï¼‰
- åˆ‡ã‚Šæˆ»ã—: ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«å¤‰æ›´ï¼ˆ1åˆ†ï¼‰

### ğŸ—ï¸ Blue/Green Deployment ã®è©³ç´°

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Load Balancer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Listener Rule: Path /* â†’ Target Group Selection  â”‚    â”‚
â”‚  â”‚  - Weight: Blue 100%, Green 0% (åˆæœŸçŠ¶æ…‹)          â”‚    â”‚
â”‚  â”‚  - Weight: Blue 50%, Green 50% (ç§»è¡Œä¸­)            â”‚    â”‚
â”‚  â”‚  - Weight: Blue 0%, Green 100% (å®Œäº†)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                 â–¼     â–¼                 â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Target Group   â”‚ â”‚ Target Group   â”‚ â”‚                â”‚
  â”‚    BLUE        â”‚ â”‚    GREEN       â”‚ â”‚                â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                â”‚
  â”‚ â”‚ pochub-001 â”‚ â”‚ â”‚ â”‚ pochub-    â”‚ â”‚ â”‚                â”‚
  â”‚ â”‚ (v1.0)     â”‚ â”‚ â”‚ â”‚ green-001  â”‚ â”‚ â”‚                â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ (v2.0)     â”‚ â”‚ â”‚                â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                â”‚
  â”‚ â”‚ pochub-002 â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                â”‚
  â”‚ â”‚ (v1.0)     â”‚ â”‚ â”‚ â”‚ pochub-    â”‚ â”‚ â”‚                â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ green-002  â”‚ â”‚ â”‚                â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                â”‚
  â”‚ â”‚ pochub-003 â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                â”‚
  â”‚ â”‚ (v1.0)     â”‚ â”‚ â”‚ â”‚ pochub-    â”‚ â”‚ â”‚                â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ green-003  â”‚ â”‚ â”‚                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”‚
                                        â”‚                â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                     â–¼                                   â”‚
              åˆ‡ã‚Šæˆ»ã—: 1åˆ†                               â”‚
              - ALB Weightå¤‰æ›´ã®ã¿                       â”‚
              - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ãã®ã¾ã¾                     â”‚
              - Greenã‚’å‰Šé™¤ã™ã‚‹ã®ã¯æ¤œè¨¼å®Œäº†å¾Œ             â”‚
                                                        â”‚
```

#### Blue/Green ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**Phase 1: Greenç’°å¢ƒæ§‹ç¯‰**
```bash
1. æ–°ã—ã„Launch Templateä½œæˆï¼ˆæ–°ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
2. æ–°ã—ã„Auto Scaling Groupä½œæˆï¼ˆGreenï¼‰
   - åŒã˜VPCã€åŒã˜ã‚µãƒ–ãƒãƒƒãƒˆ
   - DesiredCapacity = 3ï¼ˆå„AZ 1å°ï¼‰
3. æ–°ã—ã„Target Groupä½œæˆï¼ˆGreenï¼‰
4. Greenã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•å®Œäº†ã‚’å¾…æ©Ÿ
5. Greenã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç¢ºèª
```

**Phase 2: ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡æ›¿ï¼ˆæ®µéšçš„ï¼‰**
```bash
1. ALBãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã§é‡ã¿ä»˜ã‘å¤‰æ›´
   - Blue: 100% â†’ 90%
   - Green: 0% â†’ 10%
   
2. 5åˆ†é–“ç›£è¦–ï¼ˆCloudWatchã€ã‚¨ãƒ©ãƒ¼ç‡ç¢ºèªï¼‰
   
3. å•é¡Œãªã‘ã‚Œã°ã€ã•ã‚‰ã«åˆ‡æ›¿
   - Blue: 90% â†’ 50%
   - Green: 10% â†’ 50%
   
4. 5åˆ†é–“ç›£è¦–
   
5. å•é¡Œãªã‘ã‚Œã°ã€å®Œå…¨åˆ‡æ›¿
   - Blue: 50% â†’ 0%
   - Green: 50% â†’ 100%
```

**Phase 3: æ¤œè¨¼ã¨å¾Œå‡¦ç†**
```bash
1. 24æ™‚é–“ã®ç›£è¦–æœŸé–“
   - ã‚¨ãƒ©ãƒ¼ç‡ã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
   
2. å•é¡Œãªã‘ã‚Œã°Blueç’°å¢ƒå‰Šé™¤
   aws autoscaling delete-auto-scaling-group \
     --auto-scaling-group-name poc-web-server-asg-blue \
     --force-delete
   
3. Green â†’ Blue ã¸ãƒªãƒãƒ¼ãƒ ï¼ˆæ¬¡å›ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰
```

#### åˆ‡ã‚Šæˆ»ã—æ‰‹é †

**å•é¡Œç™ºè¦‹æ™‚ï¼ˆ10%åˆ‡æ›¿æ™‚ï¼‰:**
```bash
# 1åˆ†ä»¥å†…ã«å®Œäº†
aws elbv2 modify-listener \
  --listener-arn <ARN> \
  --default-actions \
    Type=forward,TargetGroupArn=<Blue-TG-ARN>,Weight=100
```

**å•é¡Œç™ºè¦‹æ™‚ï¼ˆ50%åˆ‡æ›¿æ™‚ï¼‰:**
```bash
# 3åˆ†ä»¥å†…ã«å®Œäº†ï¼ˆé‡ã¿ã‚’æˆ»ã™ã ã‘ï¼‰
aws elbv2 modify-listener \
  --listener-arn <ARN> \
  --default-actions \
    Type=forward,ForwardConfig='{
      "TargetGroups":[
        {"TargetGroupArn":"<Blue-TG-ARN>","Weight":100},
        {"TargetGroupArn":"<Green-TG-ARN>","Weight":0}
      ]
    }'
```

### ğŸ”„ Rolling Update ã®è©³ç´°

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Auto Scaling Group (å›ºå®šå°æ•°: 3)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Instance Refreshè¨­å®š                               â”‚    â”‚
â”‚  â”‚  - MinHealthyPercentage: 66% (æœ€ä½2å°ç¶­æŒ)         â”‚    â”‚
â”‚  â”‚  - InstanceWarmup: 300ç§’                           â”‚    â”‚
â”‚  â”‚  - CheckpointPercentages: [33, 66, 100]            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pochub-001â”‚  â”‚  pochub-002â”‚  â”‚  pochub-003â”‚
        â”‚  (v1.0)    â”‚  â”‚  (v1.0)    â”‚  â”‚  (v1.0)    â”‚
        â”‚  AZ-A      â”‚  â”‚  AZ-C      â”‚  â”‚  AZ-D      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€Phase 1: 1å°ç›®æ›´æ–°ã€‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ (Replacing)â”‚  â”‚  pochub-002â”‚  â”‚  pochub-003â”‚
        â”‚  â†’ v2.0    â”‚  â”‚  (v1.0)    â”‚  â”‚  (v1.0)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        HealthCheck OK â†’ æ¬¡ã¸

ã€Phase 2: 2å°ç›®æ›´æ–°ã€‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pochub-001â”‚  â”‚ (Replacing)â”‚  â”‚  pochub-003â”‚
        â”‚  (v2.0) âœ“  â”‚  â”‚  â†’ v2.0    â”‚  â”‚  (v1.0)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        HealthCheck OK â†’ æ¬¡ã¸

ã€Phase 3: 3å°ç›®æ›´æ–°ã€‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pochub-001â”‚  â”‚  pochub-002â”‚  â”‚ (Replacing)â”‚
        â”‚  (v2.0) âœ“  â”‚  â”‚  (v2.0) âœ“  â”‚  â”‚  â†’ v2.0    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        HealthCheck OK â†’ å®Œäº†

ã€å®Œäº†ã€‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pochub-001â”‚  â”‚  pochub-002â”‚  â”‚  pochub-003â”‚
        â”‚  (v2.0) âœ“  â”‚  â”‚  (v2.0) âœ“  â”‚  â”‚  (v2.0) âœ“  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Rolling Update ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**Phase 1: Launch Templateæ›´æ–°**
```bash
# æ–°ã—ã„AMIã¾ãŸã¯è¨­å®šã§Launch Templateæ›´æ–°
aws ec2 create-launch-template-version \
  --launch-template-name poc-web-server-lt \
  --source-version '$Latest' \
  --launch-template-data '{
    "ImageId": "ami-new-version",
    "UserData": "..."
  }'

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«è¨­å®š
aws ec2 modify-launch-template \
  --launch-template-name poc-web-server-lt \
  --default-version '$Latest'
```

**Phase 2: Instance Refreshé–‹å§‹**
```bash
aws autoscaling start-instance-refresh \
  --auto-scaling-group-name poc-web-server-asg \
  --preferences '{
    "MinHealthyPercentage": 66,
    "InstanceWarmup": 300,
    "CheckpointPercentages": [33, 66, 100],
    "CheckpointDelay": 300
  }'
```

**Phase 3: é€²æ—ç›£è¦–**
```bash
# Instance RefreshçŠ¶æ…‹ç¢ºèª
aws autoscaling describe-instance-refreshes \
  --auto-scaling-group-name poc-web-server-asg

# å‡ºåŠ›ä¾‹:
# Status: InProgress
# PercentageComplete: 33
# InstancesToUpdate: 2
```

**Phase 4: è‡ªå‹•å®Œäº†**
- å„Checkpointï¼ˆ33%, 66%, 100%ï¼‰ã§HealthCheckç¢ºèª
- å•é¡Œãªã‘ã‚Œã°è‡ªå‹•çš„ã«æ¬¡ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸
- å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç½®æ›å®Œäº†ã§çµ‚äº†

#### åˆ‡ã‚Šæˆ»ã—æ‰‹é †

**åˆ‡ã‚Šæˆ»ã—ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¥å¯¾å¿œ:**

**1. æœ€åˆã®Checkpointï¼ˆ33%ï¼‰ã§å•é¡Œç™ºè¦‹**
```bash
# Instance Refreshã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
aws autoscaling cancel-instance-refresh \
  --auto-scaling-group-name poc-web-server-asg

# Launch Templateã‚’æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
aws ec2 modify-launch-template \
  --launch-template-name poc-web-server-lt \
  --default-version <previous-version>

# å•é¡Œã®ã‚ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æ‰‹å‹•çµ‚äº†ï¼ˆASGãŒè‡ªå‹•çš„ã«æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§å†ä½œæˆï¼‰
aws autoscaling terminate-instance-in-auto-scaling-group \
  --instance-id <problem-instance-id> \
  --should-decrement-desired-capacity false
```
**æ‰€è¦æ™‚é–“: 5-10åˆ†**

**2. å®Œäº†å¾Œã«å•é¡Œç™ºè¦‹**
```bash
# Launch Templateã‚’æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™
aws ec2 modify-launch-template \
  --launch-template-name poc-web-server-lt \
  --default-version <previous-version>

# é€†æ–¹å‘ã«Rolling Updateå®Ÿè¡Œ
aws autoscaling start-instance-refresh \
  --auto-scaling-group-name poc-web-server-asg \
  --preferences '{
    "MinHealthyPercentage": 66,
    "InstanceWarmup": 300
  }'
```
**æ‰€è¦æ™‚é–“: 15-20åˆ†**

#### ãƒ¡ãƒªãƒƒãƒˆ

1. **ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡çš„**
   - è¿½åŠ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸è¦ï¼ˆBlue/Greenã¯2å€å¿…è¦ï¼‰
   - ã‚³ã‚¹ãƒˆå¢—åŠ ãªã—

2. **æ®µéšçš„æ›´æ–°**
   - å•é¡Œã®æ—©æœŸç™ºè¦‹
   - Checkpointæ¯ã«æ¤œè¨¼

3. **è‡ªå‹•åŒ–**
   - ASGãŒè‡ªå‹•ç®¡ç†
   - æ‰‹å‹•æ“ä½œæœ€å°é™

4. **ãƒªã‚¹ã‚¯åˆ†æ•£**
   - 1å°ãšã¤æ›´æ–°
   - å…¨å°åŒæ™‚éšœå®³ã‚’å›é¿

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **åˆ‡ã‚Šæˆ»ã—æ™‚é–“**
   - é€†æ–¹å‘Rolling UpdateãŒå¿…è¦ï¼ˆ15-20åˆ†ï¼‰
   - Blue/Greenã®ç¬æ™‚åˆ‡ã‚Šæˆ»ã—ã«ã¯åŠ£ã‚‹

2. **æ›´æ–°æ™‚é–“**
   - å…¨å°å®Œäº†ã¾ã§15-20åˆ†
   - Blue/Greenã®ä¸¦åˆ—èµ·å‹•ã‚ˆã‚Šé…ã„

3. **æ··åœ¨æœŸé–“**
   - æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒæ··åœ¨
   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³é–“ã®äº’æ›æ€§ãŒå¿…è¦

#### é©ç”¨ã‚·ãƒŠãƒªã‚ª

| ã‚·ãƒŠãƒªã‚ª | é©åˆåº¦ | ç†ç”± |
|---------|-------|------|
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒé©ç”¨** | â— | æœˆæ¬¡å®šæœŸæ›´æ–°ã€æ®µéšçš„é©ç”¨ã§ãƒªã‚¹ã‚¯æœ€å° |
| **é€šå¸¸ã®ã‚¢ãƒ—ãƒªæ›´æ–°** | â— | ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡çš„ã€ååˆ†ãªæ¤œè¨¼æœŸé–“ |
| **ç·Šæ€¥åº¦ã®ä½ã„æ›´æ–°** | â— | æ™‚é–“ã‚’ã‹ã‘ã¦æ…é‡ã«é©ç”¨å¯èƒ½ |
| **é‡è¦ãªãƒªãƒªãƒ¼ã‚¹** | â–³ | åˆ‡ã‚Šæˆ»ã—ã«æ™‚é–“ã‹ã‹ã‚‹ |
| **DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´** | â–³ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ··åœ¨ã«æ³¨æ„ |

---

### ğŸ¯ Canary Deployment ã®è©³ç´°

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Application Load Balancer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Listener Rule: æ®µéšçš„ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¢—åŠ               â”‚    â”‚
â”‚  â”‚  Phase 1: Stable 95%, Canary 5%                    â”‚    â”‚
â”‚  â”‚  Phase 2: Stable 90%, Canary 10%                   â”‚    â”‚
â”‚  â”‚  Phase 3: Stable 70%, Canary 30%                   â”‚    â”‚
â”‚  â”‚  Phase 4: Stable 50%, Canary 50%                   â”‚    â”‚
â”‚  â”‚  Phase 5: Stable 0%, Canary 100%                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                        â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                 â–¼     â–¼                 â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Target Group   â”‚       â”‚     â”‚ Target Group   â”‚
  â”‚   STABLE       â”‚       â”‚     â”‚    CANARY      â”‚
  â”‚   (95% traffic)â”‚       â”‚     â”‚   (5% traffic) â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚ â”‚ pochub-001 â”‚ â”‚       â”‚     â”‚ â”‚ pochub-    â”‚ â”‚
  â”‚ â”‚ (v1.0)     â”‚ â”‚       â”‚     â”‚ â”‚ canary-001 â”‚ â”‚
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚     â”‚ â”‚ (v2.0)     â”‚ â”‚
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚ â”‚ pochub-002 â”‚ â”‚       â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚ â”‚ (v1.0)     â”‚ â”‚       â”‚     
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚     ã€ç›£è¦–ã€‘
  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚     - ã‚¨ãƒ©ãƒ¼ç‡
  â”‚ â”‚ pochub-003 â”‚ â”‚       â”‚     - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
  â”‚ â”‚ (v1.0)     â”‚ â”‚       â”‚     - ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚     - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚     
                           â”‚     å•é¡Œãªã— â†’ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯å¢—åŠ 
                           â”‚     å•é¡Œã‚ã‚Š â†’ å³åº§ã«0%ã¸
```

#### Canary Deployment ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**Phase 1: Canaryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•**
```bash
# Canaryç”¨Launch Templateä½œæˆ
aws ec2 create-launch-template-version \
  --launch-template-name poc-web-server-lt \
  --source-version '$Latest' \
  --launch-template-data '{
    "ImageId": "ami-canary-version",
    "TagSpecifications": [{
      "ResourceType": "instance",
      "Tags": [{"Key": "Deployment", "Value": "canary"}]
    }]
  }'

# Canaryç”¨ASGä½œæˆï¼ˆ1å°ã®ã¿ï¼‰
aws autoscaling create-auto-scaling-group \
  --auto-scaling-group-name poc-web-server-asg-canary \
  --launch-template LaunchTemplateName=poc-web-server-lt,Version='$Latest' \
  --min-size 1 \
  --max-size 1 \
  --desired-capacity 1 \
  --vpc-zone-identifier "subnet-1,subnet-2,subnet-3" \
  --target-group-arns arn:aws:elasticloadbalancing:...:targetgroup/canary-tg/...
```

**Phase 2: ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ®µéšçš„å¢—åŠ **
```bash
# Phase 1: 5%ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’Canaryã¸
aws elbv2 modify-listener \
  --listener-arn <ARN> \
  --default-actions Type=forward,ForwardConfig='{
    "TargetGroups":[
      {"TargetGroupArn":"<Stable-TG-ARN>","Weight":95},
      {"TargetGroupArn":"<Canary-TG-ARN>","Weight":5}
    ],
    "TargetGroupStickinessConfig":{"Enabled":false}
  }'

# 10åˆ†é–“ç›£è¦–
# CloudWatch Alarmã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¢ºèª
# - Canaryã®ã‚¨ãƒ©ãƒ¼ç‡ < Stableã®ã‚¨ãƒ©ãƒ¼ç‡
# - Canaryã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· < Stable + 20%

# Phase 2: å•é¡Œãªã‘ã‚Œã°10%ã¸
aws elbv2 modify-listener \
  --listener-arn <ARN> \
  --default-actions Type=forward,ForwardConfig='{
    "TargetGroups":[
      {"TargetGroupArn":"<Stable-TG-ARN>","Weight":90},
      {"TargetGroupArn":"<Canary-TG-ARN>","Weight":10}
    ]
  }'

# ä»¥é™ã€30% â†’ 50% â†’ 100%ã¨æ®µéšçš„ã«å¢—åŠ 
```

**Phase 3: è‡ªå‹•ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ**
```bash
# CloudWatch Alarmã§è‡ªå‹•ç›£è¦–
aws cloudwatch put-metric-alarm \
  --alarm-name canary-error-rate-high \
  --comparison-operator GreaterThanThreshold \
  --evaluation-periods 2 \
  --metric-name ErrorRate \
  --namespace AWS/ApplicationELB \
  --period 300 \
  --statistic Average \
  --threshold 1.0 \
  --dimensions Name=TargetGroup,Value=targetgroup/canary-tg/... \
  --alarm-actions <SNS-Topic-ARN>
```

**Phase 4: å®Œå…¨åˆ‡æ›¿ã¾ãŸã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**
```bash
# æˆåŠŸæ™‚: Canary â†’ Stableæ˜‡æ ¼
# 1. Canaryãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’100%ã¸
# 2. æ—§Stableã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å‰Šé™¤
# 3. Canary Target Groupã‚’Stableã«ãƒªãƒãƒ¼ãƒ 

# å¤±æ•—æ™‚: å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¾Œè¿°ï¼‰
```

#### åˆ‡ã‚Šæˆ»ã—æ‰‹é †

**å•é¡Œç™ºè¦‹æ™‚ï¼ˆ5%æ®µéšï¼‰:**
```bash
# 1åˆ†ä»¥å†…ã«å®Œäº†
aws elbv2 modify-listener \
  --listener-arn <ARN> \
  --default-actions Type=forward,TargetGroupArn=<Stable-TG-ARN>,Weight=100

# Canaryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å‰Šé™¤
aws autoscaling delete-auto-scaling-group \
  --auto-scaling-group-name poc-web-server-asg-canary \
  --force-delete
```
**æ‰€è¦æ™‚é–“: 1-2åˆ†**

**å•é¡Œç™ºè¦‹æ™‚ï¼ˆ30%æ®µéšï¼‰:**
```bash
# 3åˆ†ä»¥å†…ã«å®Œäº†ï¼ˆåŒæ§˜ã®æ‰‹é †ï¼‰
# å½±éŸ¿ã‚’å—ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼: ç´„30%
# é‡è¦: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒã—ã£ã‹ã‚Šã—ã¦ã„ã‚Œã°å½±éŸ¿æœ€å°é™
```

#### ãƒ¡ãƒªãƒƒãƒˆ

1. **ãƒªã‚¹ã‚¯æœ€å°åŒ–**
   - å°‘é‡ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã§æ¤œè¨¼
   - å•é¡Œã®æ—©æœŸç™ºè¦‹

2. **ç¬æ™‚åˆ‡ã‚Šæˆ»ã—**
   - ALBé‡ã¿ä»˜ã‘å¤‰æ›´ã®ã¿ï¼ˆ1-2åˆ†ï¼‰
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿æœ€å°é™

3. **A/Bãƒ†ã‚¹ãƒˆæ´»ç”¨**
   - å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼ã§æ€§èƒ½æ¤œè¨¼
   - ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ¸¬å®š

4. **æŸ”è»Ÿãªæ¤œè¨¼æœŸé–“**
   - å„æ®µéšã§å¿…è¦ãªã ã‘ç›£è¦–å¯èƒ½
   - è‡ªå‹•åŒ–ã‚‚æ‰‹å‹•åˆ¤æ–­ã‚‚å¯èƒ½

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **è¤‡é›‘æ€§**
   - 2ã¤ã®Target Groupç®¡ç†
   - é‡ã¿ä»˜ã‘åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯

2. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**
   - ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹æ¨å¥¨
   - ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹è¨­è¨ˆãŒå¿…è¦

3. **ç›£è¦–è² è·**
   - Canaryå°‚ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹å¿…è¦
   - æ¯”è¼ƒåˆ†æã®è¤‡é›‘ã•

4. **åˆæœŸã‚³ã‚¹ãƒˆ**
   - Canaryã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ï¼ˆä¸€æ™‚çš„ã«å°æ•°å¢—ï¼‰
   - ãŸã ã—1å°ã®ã¿ãªã®ã§æœ€å°é™

#### é©ç”¨ã‚·ãƒŠãƒªã‚ª

| ã‚·ãƒŠãƒªã‚ª | é©åˆåº¦ | ç†ç”± |
|---------|-------|------|
| **é‡è¦ãªãƒªãƒªãƒ¼ã‚¹** | â— | æ®µéšçš„æ¤œè¨¼ã€ãƒªã‚¹ã‚¯æœ€å° |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„** | â— | å®Ÿæ¸¬ã§ã®A/Bæ¯”è¼ƒå¯èƒ½ |
| **æ–°æ©Ÿèƒ½è¿½åŠ ** | â— | ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¿œã‚’è¦‹ãªãŒã‚‰å±•é–‹ |
| **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¤‰æ›´** | â— | æ…é‡ãªæ¤œè¨¼ãŒå¯èƒ½ |
| **ç·Šæ€¥ãƒ‘ãƒƒãƒ** | â–³ | æ®µéšçš„å±•é–‹ãŒé…ã„ |
| **ãƒã‚¤ãƒŠãƒ¼æ›´æ–°** | â–³ | è¤‡é›‘ã™ãã‚‹ï¼ˆRolling Updateã§ååˆ†ï¼‰ |

---

### âš¡ In-Place Deployment ã®è©³ç´°

#### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Application Load Balancer                      â”‚
â”‚         å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒæ™‚æ›´æ–°ï¼ˆçŸ­æ™‚é–“åœæ­¢ã‚ã‚Šï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pochub-001â”‚  â”‚  pochub-002â”‚  â”‚  pochub-003â”‚
        â”‚  (v1.0)    â”‚  â”‚  (v1.0)    â”‚  â”‚  (v1.0)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ï¼ˆå…¨å°åŒæ™‚ï¼‰ã€‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Updating...â”‚  â”‚ Updating...â”‚  â”‚ Updating...â”‚
        â”‚  git pull  â”‚  â”‚  git pull  â”‚  â”‚  git pull  â”‚
        â”‚  composer  â”‚  â”‚  composer  â”‚  â”‚  composer  â”‚
        â”‚  restart   â”‚  â”‚  restart   â”‚  â”‚  restart   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        âš ï¸ 1-3åˆ†ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆã¾ãŸã¯ALBãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—ï¼‰

ã€å®Œäº†ã€‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  pochub-001â”‚  â”‚  pochub-002â”‚  â”‚  pochub-003â”‚
        â”‚  (v2.0) âœ“  â”‚  â”‚  (v2.0) âœ“  â”‚  â”‚  (v2.0) âœ“  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### In-Place Deployment ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

**Phase 1: Ansible Playbookã§å…¨å°åŒæ™‚æ›´æ–°**
```yaml
# ansible-playbooks/deploy-app-inplace.yml
---
- name: In-Place Application Deployment (All Instances Simultaneously)
  hosts: poc_web
  become: yes
  serial: 100%  # å…¨å°åŒæ™‚å®Ÿè¡Œ

  tasks:
    - name: Pull latest code from Git
      ansible.builtin.git:
        repo: https://gitea.example.com/app/laravel.git
        dest: /opt/app/laravel
        version: main
        force: yes

    - name: Install dependencies
      ansible.builtin.shell: composer install --no-dev --optimize-autoloader
      args:
        chdir: /opt/app/laravel

    - name: Run database migrations
      ansible.builtin.shell: php artisan migrate --force
      args:
        chdir: /opt/app/laravel
      run_once: yes  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯1å°ã ã‘ã§å®Ÿè¡Œ

    - name: Clear caches
      ansible.builtin.shell: |
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
      args:
        chdir: /opt/app/laravel

    - name: Restart PHP-FPM
      ansible.builtin.systemd:
        name: php-fpm
        state: restarted

    - name: Restart Apache
      ansible.builtin.systemd:
        name: httpd
        state: restarted

    - name: Wait for health check
      ansible.builtin.uri:
        url: http://localhost/health
        status_code: 200
      register: health_check
      until: health_check.status == 200
      retries: 10
      delay: 3
```

**Phase 2: Jenkins Jobã‹ã‚‰å®Ÿè¡Œ**
```bash
# Jenkins Pipeline
cd /var/jenkins_home/ansible-playbooks
ansible-playbook \
  -i inventory/aws_ec2.yml \
  deploy-app-inplace.yml \
  --extra-vars "deployment_version=${BUILD_NUMBER}"
```

**Phase 3: ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã®æœ€å°åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**
```yaml
# serial: 1 ã‚’ä½¿ã£ãŸé †æ¬¡æ›´æ–°ï¼ˆIn-Placeã ãŒ1å°ãšã¤ï¼‰
---
- name: In-Place Deployment (Sequential)
  hosts: poc_web
  become: yes
  serial: 1  # 1å°ãšã¤å®Ÿè¡Œ
  
  pre_tasks:
    - name: Remove instance from ALB
      community.aws.elb_target:
        target_group_name: poc-web-tg
        target_id: "{{ ec2_instance_id }}"
        state: absent
      delegate_to: localhost
      
  tasks:
    # ... (ä¸Šè¨˜ã¨åŒã˜ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¹ã‚¯)
    
  post_tasks:
    - name: Add instance back to ALB
      community.aws.elb_target:
        target_group_name: poc-web-tg
        target_id: "{{ ec2_instance_id }}"
        state: present
      delegate_to: localhost
```

#### åˆ‡ã‚Šæˆ»ã—æ‰‹é †

**å•é¡Œç™ºè¦‹æ™‚ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œï¼‰:**
```bash
# Gitã§å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
cd /var/jenkins_home/ansible-playbooks
ansible all -i inventory/aws_ec2.yml -m shell -a "
  cd /opt/app/laravel && 
  git checkout <previous-commit-hash> &&
  composer install --no-dev --optimize-autoloader &&
  php artisan migrate:rollback --step=1 &&
  php artisan config:cache &&
  systemctl restart php-fpm &&
  systemctl restart httpd
"
```
**æ‰€è¦æ™‚é–“: 5-10åˆ†**

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚:**
```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
ansible pochub-001 -m shell -a "
  cd /opt/app/laravel && 
  php artisan migrate:rollback --step=1
"

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
# (ä¸Šè¨˜ã¨åŒã˜)
```

#### ãƒ¡ãƒªãƒƒãƒˆ

1. **æœ€é€Ÿãƒ‡ãƒ—ãƒ­ã‚¤**
   - å…¨å°åŒæ™‚æ›´æ–°ã§æœ€çŸ­æ™‚é–“
   - AMIä½œæˆç­‰ã®æº–å‚™ä¸è¦

2. **ã‚·ãƒ³ãƒ—ãƒ«**
   - è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹ä¸è¦
   - è¤‡é›‘ãªåˆ‡æ›¿ãƒ­ã‚¸ãƒƒã‚¯ä¸è¦

3. **ç·Šæ€¥å¯¾å¿œã«æœ€é©**
   - å³åº§ã«å®Ÿè¡Œå¯èƒ½
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒç­‰ã®ç·Šæ€¥æ™‚

4. **ã‚³ã‚¹ãƒˆæœ€å°**
   - æ—¢å­˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã¿ä½¿ç”¨
   - è¿½åŠ ã‚³ã‚¹ãƒˆã‚¼ãƒ­

#### ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

1. **ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **
   - å…¨å°åŒæ™‚æ›´æ–°: 1-3åˆ†ã®ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
   - é †æ¬¡æ›´æ–°: åœæ­¢ãªã—ã ãŒæ™‚é–“ã‹ã‹ã‚‹

2. **åˆ‡ã‚Šæˆ»ã—ã®è¤‡é›‘ã•**
   - å…¨å°ã«å†åº¦ãƒ‡ãƒ—ãƒ­ã‚¤å¿…è¦ï¼ˆ5-10åˆ†ï¼‰
   - DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å«ã‚€å ´åˆã•ã‚‰ã«è¤‡é›‘

3. **ãƒªã‚¹ã‚¯**
   - å…¨å°åŒæ™‚éšœå®³ã®å¯èƒ½æ€§
   - å•é¡Œç™ºè¦‹ãŒé…ã‚Œã‚‹å¯èƒ½æ€§

4. **ãƒ†ã‚¹ãƒˆä¸ååˆ†**
   - æœ¬ç•ªç’°å¢ƒã§åˆã‚ã¦å®Ÿè¡Œ
   - æ®µéšçš„æ¤œè¨¼ãŒã§ããªã„

#### é©ç”¨ã‚·ãƒŠãƒªã‚ª

| ã‚·ãƒŠãƒªã‚ª | é©åˆåº¦ | ç†ç”± |
|---------|-------|------|
| **ç·Šæ€¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒ** | â— | é€Ÿåº¦æœ€å„ªå…ˆã€çŸ­æ™‚é–“åœæ­¢è¨±å®¹ |
| **ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹** | â— | å³åº§ã«é©ç”¨å¿…è¦ |
| **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´** | â—‹ | å°ã•ãªå¤‰æ›´ã€ãƒªã‚¹ã‚¯ä½ |
| **ãƒã‚¤ãƒŠãƒ¼ãƒã‚°ä¿®æ­£** | â—‹ | ä½ãƒªã‚¹ã‚¯ã€é€Ÿåº¦é‡è¦– |
| **ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒªãƒªãƒ¼ã‚¹** | âœ— | ãƒªã‚¹ã‚¯é«˜ã™ãã‚‹ |
| **DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´** | âœ— | æ®µéšçš„æ¤œè¨¼ãŒå¿…è¦ |

---

### ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ã®ç·åˆæ¯”è¼ƒ

| æˆ¦ç•¥ | ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“ | æ¤œè¨¼æ™‚é–“ | åˆ‡ã‚Šæˆ»ã—æ™‚é–“ | ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ  | ãƒªã‚½ãƒ¼ã‚¹ã‚³ã‚¹ãƒˆ | è¤‡é›‘åº¦ | æœ€é©ã‚·ãƒŠãƒªã‚ª |
|------|------------|---------|------------|------------|--------------|--------|------------|
| **Blue/Green** | 15åˆ† | **30-60åˆ†** | **1-3åˆ†** | **ã‚¼ãƒ­** | é«˜ï¼ˆ2å€ï¼‰ | â­â­â­â­ | é‡è¦ãƒªãƒªãƒ¼ã‚¹ |
| **Rolling Update** | 15-20åˆ† | **30-60åˆ†** | 15-20åˆ† | **ã‚¼ãƒ­** | ä½ï¼ˆè¿½åŠ ãªã—ï¼‰ | â­â­â­ | å®šæœŸæ›´æ–° |
| **Canary** | 30-60åˆ† | **30-60åˆ†** | **1-2åˆ†** | **ã‚¼ãƒ­** | ä¸­ï¼ˆ+1å°ï¼‰ | â­â­â­â­â­ | ãƒªã‚¹ã‚¯é«˜ãƒªãƒªãƒ¼ã‚¹ |
| **In-Place** | **2-5åˆ†** | **çœç•¥å¯** | 5-10åˆ† | ã‚ã‚Šï¼ˆ1-3åˆ†ï¼‰ | ä½ï¼ˆè¿½åŠ ãªã—ï¼‰ | â­â­ | ç·Šæ€¥ãƒ‘ãƒƒãƒ |

**æ³¨:** æ¤œè¨¼æ™‚é–“ = E2Eãƒ†ã‚¹ãƒˆï¼ˆ10-20åˆ†ï¼‰ + æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆ20-40åˆ†ï¼‰+ æ‰¿èªå¾…ã¡

### ğŸ“‹ æ¨å¥¨æ§‹æˆã®ã¾ã¨ã‚

#### ğŸ† æœ€çµ‚æ¨å¥¨: **Hybrid Approach + æŸ”è»Ÿãªãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥**

**ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†:**
- Base AMIï¼ˆæœˆæ¬¡æ›´æ–°ã€Rolling Updateï¼‰
- Application Layerï¼ˆAnsibleç®¡ç†ï¼‰

**ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ï¼ˆã‚·ãƒŠãƒªã‚ªåˆ¥ï¼‰:**

| ã‚·ãƒŠãƒªã‚ª | æ¨å¥¨æˆ¦ç•¥ | æ¤œè¨¼æ–¹æ³• | ç†ç”± |
|---------|---------|---------|------|
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒƒãƒï¼ˆæœˆæ¬¡ï¼‰** | **Rolling Update** | Devç’°å¢ƒã§æ¤œè¨¼ | æ®µéšçš„ã€ãƒªã‚¹ã‚¯åˆ†æ•£ã€Devâ†’Prodé †æ¬¡ |
| **é€šå¸¸ã®ã‚¢ãƒ—ãƒªæ›´æ–°** | **Rolling Update** | Devç’°å¢ƒã§æ¤œè¨¼ | ãƒãƒ©ãƒ³ã‚¹å‹ã€å®Ÿç”¨çš„ |
| **é‡è¦ãªãƒªãƒªãƒ¼ã‚¹** | **Blue/Green** | Greenç’°å¢ƒã§å®Œå…¨æ¤œè¨¼ | å®Œå…¨ç„¡åœæ­¢ã€ç¬æ™‚åˆ‡ã‚Šæˆ»ã—ã€æœ¬ç•ªå‰å®Œå…¨ãƒ†ã‚¹ãƒˆ |
| **æ–°æ©Ÿèƒ½A/Bãƒ†ã‚¹ãƒˆ** | **Canary** | Canaryç’°å¢ƒã§æ¤œè¨¼ | æ®µéšçš„æ¤œè¨¼ã€å®Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼åå¿œ |
| **ç·Šæ€¥ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹** | **In-Place** | æ¤œè¨¼çœç•¥ã¾ãŸã¯Devç’°å¢ƒã®ã¿ | æœ€é€Ÿã€çŸ­æ™‚é–“åœæ­¢è¨±å®¹ã€ç·Šæ€¥æ€§å„ªå…ˆ |

**æ¤œè¨¼ç’°å¢ƒã®çµ±åˆ:**
1. âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ã«æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’çµ„ã¿è¾¼ã¿
2. âœ… Windows Server + Jenkins E2Eãƒ†ã‚¹ãƒˆã§äºŒé‡ãƒã‚§ãƒƒã‚¯
3. âœ… æ‰¿èªã‚²ãƒ¼ãƒˆã§æœ€çµ‚åˆ¤æ–­ã‚’å®Ÿæ–½
4. âœ… æœ¬ç•ªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æŠ•å…¥å‰ã«å•é¡Œã‚’ç™ºè¦‹

**ç†ç”±:**
1. âœ… ã™ã¹ã¦ã®è¦ä»¶ï¼ˆR1-R9ï¼‰ã‚’æº€ãŸã™
2. âœ… çŠ¶æ³ã«å¿œã˜ã¦æœ€é©ãªæˆ¦ç•¥ã‚’é¸æŠå¯èƒ½
3. âœ… 4ã¤ã®ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ã™ã¹ã¦ã‚’å®Ÿè£…å¯èƒ½
4. âœ… æ¤œè¨¼ç’°å¢ƒã«ã‚ˆã‚‹å“è³ªä¿è¨¼
5. âœ… å­¦ç¿’ã‚³ã‚¹ãƒˆãƒ»é‹ç”¨è² è·ãŒé©åˆ‡
6. âœ… å°†æ¥ã®ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œæ¸ˆã¿

---

## æ¯”è¼ƒãƒãƒˆãƒªã‚¯ã‚¹

### ğŸ“Š è¦ä»¶é©åˆåº¦

| è¦ä»¶ | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1<br>(Immutable) | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2<br>(Mutable) | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3<br>(Hybrid) |
|------|--------------------------|------------------------|----------------------|
| **R1: ãƒ‘ãƒƒãƒé©ç”¨ï¼ˆç„¡åœæ­¢ãƒ»è‡ªå‹•åŒ–ï¼‰** | â— | â—‹ | â— |
| **R2: ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç„¡åœæ­¢ãƒ»åˆ‡ã‚Šæˆ»ã—ï¼‰** | â—‹ | â— | â— |
| **R3: ãƒãƒ«ãƒAZæ§‹æˆ** | â— | â— | â— |
| **R4: å„AZ1å°ç¶­æŒ** | â— | â— | â— |
| **R5: éšœå®³è‡ªå‹•å¾©æ—§** | â— | â–³ | â— |
| **R6: æ¤œè¨¼ç’°å¢ƒ** | â— | â— | â— |
| **R7: æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆWindows/å¤–éƒ¨IPï¼‰** | â— | â— | â— |
| **R8: è‡ªå‹•E2Eãƒ†ã‚¹ãƒˆï¼ˆJenkinsï¼‰** | â— | â— | â— |
| **R9: æ‰¿èªãƒ•ãƒ­ãƒ¼** | â— | â— | â— |
| **å°†æ¥ã®ASGå¯¾å¿œ** | â— | â–³ | â— |
| **è¨­å®šã®ä¸€è²«æ€§** | â— | â–³ | â—‹ |

**å‡¡ä¾‹:** â—=å®Œå…¨å¯¾å¿œ, â—‹=å¯¾å¿œå¯èƒ½, â–³=éƒ¨åˆ†å¯¾å¿œãƒ»åˆ¶ç´„ã‚ã‚Š

### âš–ï¸ ç·åˆè©•ä¾¡

| é …ç›® | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1 | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2 | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3 |
|------|-----------|-----------|-----------|
| **å­¦ç¿’ã‚³ã‚¹ãƒˆ** | é«˜ (â­â­â­â­â­) | ä½ (â­â­) | ä¸­ (â­â­â­â­) |
| **åˆæœŸæ§‹ç¯‰å·¥æ•°** | 6æ—¥ | 3æ—¥ | 4.5æ—¥ |
| **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“** | OSãƒ‘ãƒƒãƒ: 30åˆ†<br>ã‚¢ãƒ—ãƒª: 30åˆ† | OSãƒ‘ãƒƒãƒ: 45åˆ†<br>ã‚¢ãƒ—ãƒª: 5åˆ† | OSãƒ‘ãƒƒãƒ: 30åˆ†<br>ã‚¢ãƒ—ãƒª: 5åˆ† |
| **åˆ‡ã‚Šæˆ»ã—æ™‚é–“** | 5åˆ† | 15åˆ† | ã‚¤ãƒ³ãƒ•ãƒ©: 5åˆ†<br>ã‚¢ãƒ—ãƒª: 3åˆ† |
| **é‹ç”¨è² è·** | ä½ (â­â­) | é«˜ (â­â­â­â­) | ä¸­ (â­â­â­) |
| **æœˆé¡ã‚³ã‚¹ãƒˆ** | $156 (+$6) | $152 (+$2) | $155 (+$5) |
| **æŸ”è»Ÿæ€§** | ä½ | é«˜ | é«˜ |
| **ä¸€è²«æ€§** | é«˜ | ä½ | ä¸­ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | é«˜ | ä½ | é«˜ |

### ğŸ¯ æ¨å¥¨ã‚¹ã‚³ã‚¢

| ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | åˆè¨ˆç‚¹ | è©•ä¾¡ |
|-----------|-------|------|
| **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3: Hybrid** | **85ç‚¹** | â­â­â­â­â­ |
| **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1: Immutable** | **75ç‚¹** | â­â­â­â­ |
| **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2: Mutable** | **60ç‚¹** | â­â­â­ |

---

## æ¨å¥¨åˆ¤æ–­åŸºæº–

### ğŸ† æ¨å¥¨: **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3 (Hybrid Approach)**

#### ç†ç”±

1. **è¦ä»¶ã¸ã®å®Œå…¨ãªé©åˆ**
   - ã™ã¹ã¦ã®å¿…é ˆè¦ä»¶ã‚’æº€ãŸã™
   - å°†æ¥ã®ASGå¯¾å¿œã‚‚è€ƒæ…®æ¸ˆã¿

2. **ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸè¨­è¨ˆ**
   - OSãƒ‘ãƒƒãƒ: Immutableï¼ˆæœˆæ¬¡ã€æ…é‡ã«ï¼‰
   - ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤: Mutableï¼ˆéšæ™‚ã€é«˜é€Ÿã«ï¼‰

3. **æ®µéšçš„ç§»è¡ŒãŒå¯èƒ½**
   - ç¾åœ¨ã®Mutableæ§‹æˆã‹ã‚‰å¾ã€…ã«ç§»è¡Œã§ãã‚‹
   - ã¾ãšASGæ§‹ç¯‰ â†’ æ¬¡ã«Base AMI Pipelineæ§‹ç¯‰

4. **é‹ç”¨è² è·ã®æœ€é©åŒ–**
   - ãƒ‘ãƒƒãƒé©ç”¨: æœˆ1å›ã®è‡ªå‹•å®Ÿè¡Œï¼ˆå¤œé–“ï¼‰
   - ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤: Jenkins + Ansibleã§æŸ”è»Ÿã«

5. **ã‚³ã‚¹ãƒˆå¯¾åŠ¹æœ**
   - æœˆé¡+$5ã§å¤§å¹…ãªé‹ç”¨æ”¹å–„
   - äººä»¶è²»å‰Šæ¸›åŠ¹æœã®æ–¹ãŒå¤§ãã„

#### æ¬¡ç‚¹: **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ1 (Immutable)**

- ã‚ˆã‚Šç´”ç²‹ãªImmutableã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ±‚ã‚ã‚‹å ´åˆ
- ã™ã¹ã¦ã‚’AMIã§ç®¡ç†ã—ãŸã„å ´åˆ
- ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“ã‚ˆã‚Šã‚‚ä¸€è²«æ€§ã‚’é‡è¦–ã™ã‚‹å ´åˆ

#### éæ¨å¥¨: **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ2 (Mutable)**

- **POCç’°å¢ƒã¨ã—ã¦ã®æ¤œè¨¼ç›®çš„ã«ã¯ä¸é©åˆ‡**
- å°†æ¥ã®ASGå¯¾å¿œãŒå›°é›£
- ã€ŒImmutableã‚¤ãƒ³ãƒ•ãƒ©ã®æ¤œè¨¼ã€ã¨ã„ã†ç›®çš„ã«åˆè‡´ã—ãªã„

---

## å„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®è©³ç´°å®Ÿè£…

### ğŸ“˜ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3 (Hybrid) å®Ÿè£…ã‚¬ã‚¤ãƒ‰

#### Phase 1: ASGæ§‹ç¯‰ (Week 1)

**ç›®æ¨™:** ç¾åœ¨ã®EC2ã‚’ASGç®¡ç†ä¸‹ã«ç§»è¡Œ

```yaml
# sceptre/templates/ec2-asg.yaml
AWSTemplateFormatVersion: '2010-09-09'

Resources:
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${Environment}-web-server-lt'
      LaunchTemplateData:
        ImageId: !Ref CurrentAMI  # ç¾åœ¨ã®AMI IDã‚’æŒ‡å®š
        InstanceType: t3.medium
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            set -e
            
            # Application Layer ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            cd /opt/app/laravel
            git pull origin main
            composer install --no-dev --optimize-autoloader
            php artisan config:cache
            php artisan route:cache
            systemctl restart php-fpm
            systemctl restart httpd

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub '${Environment}-web-server-asg'
      MinSize: 3
      MaxSize: 3
      DesiredCapacity: 3
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      VPCZoneIdentifier:
        - !Ref PrivateSubnetAZ1
        - !Ref PrivateSubnetAZ2
        - !Ref PrivateSubnetAZ3
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      TargetGroupARNs:
        - !Ref ALBTargetGroup
      Tags:
        - Key: Name
          Value: !Sub '${Environment}-web-server'
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref Environment
          PropagateAtLaunch: true
```

**å®Ÿæ–½æ‰‹é †:**

1. ç¾åœ¨ã®ç¨¼åƒä¸­EC2ã®AMIã‚’ä½œæˆ
2. CloudFormation/Sceptreã§ãƒ‡ãƒ—ãƒ­ã‚¤
3. ASGã‹ã‚‰3å°ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒèµ·å‹•ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
4. æ—§EC2ã‚’åœæ­¢ï¼ˆASGã®å‹•ä½œç¢ºèªå¾Œã«å‰Šé™¤ï¼‰

#### Phase 2: Base AMI Pipelineæ§‹ç¯‰ (Week 2-3)

**ç›®æ¨™:** Packerã§è‡ªå‹•AMIä½œæˆ

```hcl
# packer/base-ami.pkr.hcl
packer {
  required_plugins {
    amazon = {
      version = ">= 1.0.0"
      source  = "github.com/hashicorp/amazon"
    }
    ansible = {
      version = ">= 1.0.0"
      source  = "github.com/hashicorp/ansible"
    }
  }
}

source "amazon-ebs" "base" {
  ami_name      = "poc-base-{{timestamp}}"
  instance_type = "t3.medium"
  region        = "ap-northeast-1"
  source_ami_filter {
    filters = {
      name                = "amzn2-ami-hvm-*-x86_64-gp2"
      root-device-type    = "ebs"
      virtualization-type = "hvm"
    }
    most_recent = true
    owners      = ["amazon"]
  }
  ssh_username = "ec2-user"
  
  tags = {
    Name        = "poc-base-ami"
    Environment = "poc"
    BuildDate   = "{{timestamp}}"
  }
}

build {
  sources = ["source.amazon-ebs.base"]

  # OSãƒ‘ãƒƒãƒé©ç”¨
  provisioner "shell" {
    inline = [
      "sudo yum update -y",
      "sudo yum install -y python3 python3-pip",
    ]
  }

  # Ansibleå®Ÿè¡Œï¼ˆãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
  provisioner "ansible" {
    playbook_file = "../ansible-playbooks/base-ami-setup.yml"
    extra_arguments = [
      "--extra-vars",
      "ansible_python_interpreter=/usr/bin/python3"
    ]
  }

  # AMI ID ã‚’ Parameter Store ã«ä¿å­˜
  post-processor "shell-local" {
    inline = [
      "aws ssm put-parameter --name /poc/ami/base/latest --value ${BUILD_ID} --type String --overwrite"
    ]
  }
}
```

**Ansible Playbook (base-ami-setup.yml):**

```yaml
---
- name: Base AMI Setup
  hosts: all
  become: yes
  tasks:
    - name: Install Apache
      yum:
        name:
          - httpd
          - mod_ssl
        state: present

    - name: Install PHP 8.1
      yum:
        name:
          - php8.1
          - php8.1-cli
          - php8.1-fpm
          - php8.1-mysqlnd
          - php8.1-xml
          - php8.1-mbstring
          - php8.1-curl
        state: present

    - name: Install ProxySQL
      # ... (æ—¢å­˜ã®Playbookã‹ã‚‰æµç”¨)

    - name: Configure security settings
      # ... (CIS Benchmarkæº–æ‹ ã®è¨­å®š)

    - name: Install CloudWatch Agent
      # ...
```

#### Phase 3: Jenkinsçµ±åˆ (Week 4)

**ç›®æ¨™:** Jenkins Jobã§AMIä½œæˆã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–

**Jenkins Pipeline (Jenkinsfile):**

```groovy
pipeline {
    agent any
    
    parameters {
        choice(
            name: 'DEPLOY_TYPE',
            choices: ['application', 'infrastructure'],
            description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ'
        )
    }
    
    stages {
        stage('Application Deploy') {
            when {
                expression { params.DEPLOY_TYPE == 'application' }
            }
            steps {
                script {
                    // Ansible Playbookã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
                    sh '''
                        cd /var/jenkins_home/ansible-playbooks
                        ansible-playbook \
                          -i inventory/aws_ec2.yml \
                          setup-laravel-environment.yml \
                          --extra-vars "deployment_version=${BUILD_NUMBER}"
                    '''
                }
            }
        }
        
        stage('Infrastructure Update') {
            when {
                expression { params.DEPLOY_TYPE == 'infrastructure' }
            }
            stages {
                stage('Build Base AMI') {
                    steps {
                        sh '''
                            cd /var/jenkins_home/packer
                            packer build base-ami.pkr.hcl
                        '''
                    }
                }
                
                stage('Dev Environment Test') {
                    steps {
                        // Devç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
                        sh '''
                            # Launch Templateæ›´æ–°ï¼ˆDevç’°å¢ƒï¼‰
                            AMI_ID=$(aws ssm get-parameter --name /poc/ami/base/latest --query 'Parameter.Value' --output text)
                            aws ec2 modify-launch-template \
                              --launch-template-name dev-web-server-lt \
                              --default-version '$Latest' \
                              --launch-template-data "ImageId=${AMI_ID}"
                            
                            # Instance Refreshï¼ˆDevç’°å¢ƒï¼‰
                            aws autoscaling start-instance-refresh \
                              --auto-scaling-group-name dev-web-server-asg
                        '''
                        
                        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                        sh '''
                            cd /var/jenkins_home/tests
                            npm run test:e2e -- --env dev
                        '''
                    }
                }
                
                stage('Approve Production Deploy') {
                    steps {
                        input message: 'æœ¬ç•ªç’°å¢ƒã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã‹ï¼Ÿ', ok: 'Deploy'
                    }
                }
                
                stage('Production Deploy') {
                    steps {
                        sh '''
                            # Launch Templateæ›´æ–°ï¼ˆProdç’°å¢ƒï¼‰
                            AMI_ID=$(aws ssm get-parameter --name /poc/ami/base/latest --query 'Parameter.Value' --output text)
                            aws ec2 modify-launch-template \
                              --launch-template-name poc-web-server-lt \
                              --default-version '$Latest' \
                              --launch-template-data "ImageId=${AMI_ID}"
                            
                            # Instance Refreshï¼ˆProdç’°å¢ƒã€æ®µéšçš„ï¼‰
                            aws autoscaling start-instance-refresh \
                              --auto-scaling-group-name poc-web-server-asg \
                              --preferences '{
                                "MinHealthyPercentage": 66,
                                "InstanceWarmup": 300
                              }'
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            slackSend(
                color: 'good',
                message: "ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
        failure {
            slackSend(
                color: 'danger',
                message: "ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: ${env.JOB_NAME} #${env.BUILD_NUMBER}"
            )
        }
    }
}
```

---

## ã¾ã¨ã‚

### ğŸ¯ çµè«–

**æ¨å¥¨: ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3 (Hybrid Approach)**

#### ç†ç”±:
1. âœ… ã™ã¹ã¦ã®è¦ä»¶ã‚’æº€ãŸã™
2. âœ… OSãƒ‘ãƒƒãƒã¨ã‚¢ãƒ—ãƒªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é©åˆ‡ã«åˆ†é›¢
3. âœ… å°†æ¥ã®ASG/ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œæ¸ˆã¿
4. âœ… Jenkins + Ansible + Giteaã®æ—¢å­˜è³‡ç”£ã‚’æ´»ç”¨
5. âœ… æ®µéšçš„ãªç§»è¡ŒãŒå¯èƒ½

#### å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—:

| ãƒ•ã‚§ãƒ¼ã‚º | å†…å®¹ | å·¥æ•° | å„ªå…ˆåº¦ |
|---------|------|------|-------|
| **Phase 1** | ASGæ§‹ç¯‰ï¼ˆç¾åœ¨ã®AMIä½¿ç”¨ï¼‰ | 1æ—¥ | â­â­â­â­â­ |
| **Phase 2** | Base AMI Pipelineæ§‹ç¯‰ | 2æ—¥ | â­â­â­â­ |
| **Phase 3** | Jenkinsçµ±åˆ | 1æ—¥ | â­â­â­â­ |
| **Phase 4** | éšœå®³å¾©æ—§è‡ªå‹•åŒ– | 0.5æ—¥ | â­â­â­ |
| **Phase 5** | ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆå¼·åŒ– | 0.5æ—¥ | â­â­â­ |
| **Phase 6** | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ | 0.5æ—¥ | â­â­â­ |
| **åˆè¨ˆ** | | **5.5æ—¥** | |

#### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:

1. **ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼ã¨å…±æœ‰**
2. **Phase 1ã®å®Ÿè£…ã‚’é–‹å§‹**ï¼ˆã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹ï¼‰
3. **POCç’°å¢ƒã§å‹•ä½œç¢ºèª**
4. **Base AMI Pipelineã®æ§‹ç¯‰**

---

### ğŸ“ è³ªå•ãƒ»ç›¸è«‡

ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¯”è¼ƒæ¤œè¨ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®ç‚¹ã‚’ã”ç¢ºèªãã ã•ã„ï¼š

1. **ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ3ã§å•é¡Œãªã„ã‹ï¼Ÿ**
2. **Phase 1ã‹ã‚‰é †æ¬¡é€²ã‚ã¦ã‚ˆã„ã‹ï¼Ÿ**
3. **ç‰¹ã«é‡è¦–ã—ãŸã„è¦ä»¶ã¯ã‚ã‚‹ã‹ï¼Ÿ**ï¼ˆä¾‹: ãƒ‡ãƒ—ãƒ­ã‚¤é€Ÿåº¦ã€ä¸€è²«æ€§ã€ã‚³ã‚¹ãƒˆç­‰ï¼‰
4. **ä»–ã«æ¤œè¨ã™ã¹ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯ã‚ã‚‹ã‹ï¼Ÿ**

