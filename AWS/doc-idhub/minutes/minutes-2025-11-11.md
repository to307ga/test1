# 2025-11-11

## 目次

- [1. 直近、やること](#1-直近やること)
  - [1.1. 今できること。 2026-10-29](#11-今できること-2026-10-29)
  - [1.2. 今、やっていること](#12-今やっていること)
  - [1.3. 要件定義書 → 設計書作成 → Cfnテンプレート作成までの流れ](#13-要件定義書--設計書作成--cfnテンプレート作成までの流れ)
- [2. 必要なモノ・武器](#2-必要なモノ武器)
- [3. PoC環境での検証](#3-poc環境での検証)
  - [3.1. PoCでの検証項目を明確にしていきたいよね](#31-pocでの検証項目を明確にしていきたいよね)
  - [3.2. IaC の守備範囲](#32-iac-の守備範囲)
  - [3.3. Sceptre Templateで受け付けるParameter](#33-sceptre-templateで受け付けるparameter)

## 1. 直近、やること

### 1.1. 今できること。 2025-10-26

- Network（「がわ」＝外側）を仕上げ → Batch をその内側に作る。
  - パラメータ設定する。たとえば、Network Firewall。
  - VPC、AZなど「外側」のネットワークのCfnによる構築。
- BatchのPython化、につなげる。
  - これに必要なのはAurora（DB）
  - SESは既に先行案件で完成してる。
- ~~FutureVuls、オンプレにインストール~~
  - 脆弱性出たら、オンプレで解消させる。
  - 三鷹用 Playbookに定義してしまう。
    - FeatureVuls Installの定義
  - (2025-11-04)
    - SpringBoot、ぐらい、か？
    - idhub-oidc ではSpringBoot。本家idhubのJarファイルもFutureVulsに診てもらおう。
    - FutureVuls Agent、深部まで診るとなると、「重い」傾向。
    - AMI って3カ月に一度更新される。
      - Amazon Linux用のDNF（YumRepository）は3カ月に一度、アップデートされる。
      - 緊急パッチの場合は、この限りじゃない、らしい。
        - Golden Image を作り、 `dnf update latest` すれば問題ない。
      - 「最大、3カ月、待たないとならないの？」「経験則的には四半期ごと、は自然な長さ、期間。」
      - 緊急パッチは2週間以内に適用せよ。（ドコモレギュレーション）

### 1.2. 今、やっていること

- 尾岸
  - Amazon Linux 2023 化になることによるパッケージの差異
    - Ansible Controler（EC2）でPlaybook Kickできるまでをゴールにする。
    - 将来的にはSSM経由でPlaybookをKickできるようにする。
    - (2026-10-29) 進捗
      - パッケージの調査
      - Playbookの書き換え
    - (2026-11-12) 進捗
      - Playbook Kick できた！
      - 現状、`Ansible Controler (EC2) -> EC2 （被Playbook）` をSSH経由でKickできた。
      - 次のステップは、 `idhub-web`, `idhub-hlp` をAnsibleで構築。
        - EC2内で、 `idhub-web`, `idhub-db` を **オールインワン的に** 入れてみて、一通り動くようにしてみる。
        - Application のデプロイは、Jenkins OR 手動。
  - Jenkins on Fargate（10/29、やや優先度下げ。後回し）
- 斎藤
  - idhub-hlp構築
    - ~~ここでの、パッケージ差分調査。~~ Perl はIDHUBには用無し。
  - Jenkins on Fargate
    - Jenkinsインスタンスが起動したあと、動作確認＋設定。
  - （別件、Playwright）Jenkins上で動くE2Eテスト。正常に最後まで完了するようにできた。
    - ~~idhub-hlp もシナリオ、E2E化しちゃおうかと。~~ → 完成
      - 課題： 
        - idhub-hlp 自体のパスワードには有効期限があったり。
        - E2EでSMS送信を受信する方法を模索。
  - （2025-11-05）Jenkins on Fargate を先行し進めていく。
- 中川
  - ~~パラメータ定義書 - Done~~
  - Network構築
    - DOCOMO -> CNS : 必要な情報（が分かる限り）渡します。
    - CNS -> DOCOMO ： 何が必要か、わかったら言ってください。
    - 「パラメータ定義書」の「根拠」欄も埋めながら。
    - `sceptre/config` ディレクトリ内のパラメータを設定していく。← Repository鍛えていく。
    - And、実際に `uv run sceptre create xxxx` してネットワーク構築していく。
    - `sceptre` に子慣れる。
      - 「構築しながら設計」ならば、`sceptre/config` ディレクトリを鍛えていく。
      - (2025-11-05) sceptre をローカルから実行可能。
        - `vpc.yaml`, `s3.yaml`, `natgw.yaml`, `fixed-eip-gw.yaml`
        - BPRのテンプレートをそのままほぼ使える。
        - Private SubnetのCIDRが、テンプレ上、 `/25` （128個）になっている。 `/24` （256個）にしよう。
        - パラメータ定義書に `根拠` 欄などをまとめている。
      - (2025-11-11)
        - パラメータ定義書に `根拠` 欄などをまとめている。
          - VPC、WAF、S3がパラメータ定義完了。次はCloudFront。
  - （2025-11-11） 📍アウトバウンドのEIPを、今時点で確定させる。
    - 対向先システムに早い段階で穴をあけてもらうため。
    - 一緒に、要件定義書 <-> 設計書作成 、のイテレーションをまわしてく。
- 伊藤
  - `4. 非機能要件`, `5. 追加要件`（🎈）
    - 一巡目、11/7(金)まで。
  - 足りないInput資料をぶち込むフォルダが必要
    - 暗号危殆化
    - 対向先の一覧
    - ~~ドコモの業務ルール~~
      - BPRのTemplateが内包済み。
      - rbash
      - 緊急性パッチは2w以内に適用せよ。
- 今井
  - FutureVuls on-premise
    - ~~Dev (Prodは伊藤恵吾)~~
  - Datadog、味見
    - 疑問：
      - ログ監視は「どこのログを」監視するの？
  - `3. セキュリティ要件` （🎈）
    - 一巡目、11/7(金)まで。
  - SSMでローカルからPlaybook Kickする。
    - EC2 へのSCP .etc。 (2025-11-04）SSM経由でEC2上リソースにアクセスできるように・・・・の一定のゴールができた。
    - `desktop.md` にまとめる。
- 馬場
  - Batchに頭めぐらせ。
    - （2025-11-11）
      - 手動でLambda起動
        - ジョブスクリプトは、Pythonで書いてもらった。Copilotくん、ありがとう。
        - Pythonスクリプトは、S3に圧縮ファイルとして置いておく。それをLambdaがとる形。
          - Cfn TemplateにPythonジョブスクリプトを埋め込む、という方法もあるが推奨されない。
      - DB見に行く。
      - S3に成果物PUT。
      - 今後
        - メール送ってみる。
        - Event Bridgeで起動してみる。
  - Python-Batch 味見 / Batch-PoC
    - DBもS3もない中。（馬場さんが徐々に必要になったら要求）
  - FutureVulsが指摘している項目に対して
    - 修正・VerUP方針を見極め。
    - 前提として、三鷹On-premiseでは対処させない。AWSに行ってから、身をきれいにする。
- 朝長
  - いろいろ考える。
  - SSM `desktop.md` にまとめる。
  - Jenkins ＋ SSMの「ことはじめ」をCNSさんに渡し、
  - 次はEC2関連について、調査していきたい。

## ブランチ協定

- 😱 課題： Github WEB上のブランチ選択のプルダウン。やたら多くなってきたよね。

- 当座、やること
  - `feature/docs` から生やしたブランチ → とっとと `feature/docs` にマージ。
  - `feature/docs` から生やしたブランチ 削除
  - 以降、 `main` ブランチを、神様。
  
### ブランチ名、命名ルール（当座）

- `feature/{NAME}-{Summary}`


## 2. 必要なモノ・武器

- TODO

## 3. PoC環境での検証

- 下回りは中川さん、完了。
- EC2 インスタンス x 3
- Jenkins, Web, 踏み台。今はJenkinsの「母艦」となるホストに着手。
  - Ansible Playbook を git cloneして ansibleが動くまで。
- 2025-10-22
  - Jenkins でのCI/CDが当初方針だった。
  - コンテナホストは、`Amazon Linux 2023`。そこにPodmanを入れたかった。
  - `Amazon Linux 2023` だと PodmanがPackageとして用意されていない。
  - 方針変更
    - Podman on EC2 は早々にあきらめる。 Fargate上にJenkinsを載せる。
    - Amazon Linuxになることで、Packageの変化・影響がどうあるのか？を洗い出す。

### 3.1. PoCでの検証項目を明確にしていきたいよね

- bprtech提供のCfnテンプレートは検証不要。
  - ただ、EC2に対しては、このTemplateは提供されていない。
  - なので EC2 のCfn Templateは自作する必要がある。
- 検証項目を思いつきで書いてみる。
  - MFA
    - 現状、Reverse Proxy 上で MFA のApache拡張モジュール
  - ......
- おいおい、検証項目を管理していこう。Backlogの出番、か？

### 3.3. Sceptre Templateで受け付けるParameter

- 各Yamlで受け付けるParameterを文書化する。
  - Range
  - Default
  - 意味 (Description)

## 以降はアーカイブ

- 古い記事を押し出したもの。

### 1. Desktop

- デスクトップ環境を鍛える。 **→ Done**
  - セットアップ方法の「画一化」
  - `settings.json`, `projects.toml` といった共通設定ファイルを鍛える。 （朝長）
  - そこに至るまでには `uv`, `awscli` のインストールが完了していることが前提。
    - その手順をまとめる。 （伊藤）
  - `cp932`, SSL が、一生まとわりつく。Windowsとの相性、悪いかも。
    - SSLのWarningは ネイティブの aws-cli 実行時だけかも。
  - `dev` / `prod` の切り替え。
    - 事故りそう。
    - 運用フェーズでは、ローカル（VSCODE）からのCfn実行を避けるのがよいかも。
    - `prod` は、CI/CD的にGithub Actionで実行する、とか。

### 2. コミュニケーション手段

- チャットが見れない。
  - Slackだったり、別テナントのTeamsだったり。
  - へー社の外部ベンダーとのやり取り方法のスタンダードは「Google Workspace」らしい。（伊藤）
    - Google Workspaceはあくまで「文書共有ストレージ」。そのニーズは薄いかも。
    - 当座、Slackだけで乗り切ろう。
  - Slackを公式のチャットツールとしよう。
    - `#x_pjct_goosubsc_cns` チャネル

- 検証環境AWSアカウントの申請（今井 聡史） **→ (完了)**
  - サンドボックス的に、いじり倒せる環境
  - 「PJコード」が必要だが、先走ってAWSアカウントを申請してみる。
  - IAMユーザ、初回儀式
    - Passwd変更
    - MFA設定
      - access_key, secret_code 方式のアクセスだと、12時間ごとにMFA問われて面倒かも。
  - 古いIAM（Ex. `nttdocomo-iam-k5ito` ）は消します。（By 伊藤）

- 三鷹DCアカウント（SSH）
  - 藤本さん、中川さん、分
  - ED25519形式のキーペアファイルを作成いただく。
  - その公開鍵ファイルをSlackにて送付。

## 3. 「idhub とは？」を知りたい

- 10/17(金) 11:00～12:00
- 尾岸さん、朝長さん、CNSの新規2名。
- お客様目線。
と、
- システム構成
- 伊藤 → 尾岸さん、朝長さん、藤本さん、中川さん へレクチャ。
  - ありものの資料、挿絵を、Githubへ。

### 4.1. オンプレからAWS PoC環境へデータ転送したい

- 商用データのマイグレではない。
- VPNの位置づけは？
- PoC環境へデータ転送したい。From: 三鷹DC → To: AWS
- 結論
  - PoC段階では、三鷹 → S3 Putする。
![data-transfer](./images/poc-data-transfer.drawio.svg)

## お試し


- 他のSaaS（FutureVuls、Datadog）を使えるように申請（宮内）
  - AWSと並行して、単独でDatadog等の操作、調査ができるかもね。
  - Datadogは「試用期間」があっていろいろ触れる。
  - 優先度は強いて言うならDatadog。
  - （参考）DOCOMO社 推奨 SaaS、Agent
    - CrowdStrike ー 「振る舞い検知」
    - FutureVuls ー 脆弱性やEOL検知
    - DataDog ー 監視・メトリクス
  - FutureVuls Trial
    - 来週から使える。10/27ぐらい～
    - オンプレで、脆弱性やEOLの「ウミ」を出す。
